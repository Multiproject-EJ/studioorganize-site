<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Character Studio ‚Äî StudioOrganize</title>
  <meta
    name="description"
    content="Character Studio keeps every character's profile, arc, lookbook, and AI prompt in one dedicated workspace."
  />
  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="icon" type="image/webp" href="/assets/img/studioorganizeFavicon.webp" />
</head>
<body>
  <header class="nav">
    <div class="brand-with-logo">
      <a class="brand brand--with-logo" href="/">
        <span class="brand__logo" aria-hidden="true"></span>
        <span class="sr-only">StudioOrganize</span>
      </a>
    </div>
    <nav class="menu">
      <a class="menu__link menu__link--plain menu__link--icon" href="/">
        <span aria-hidden="true">üè†</span>
        <span class="sr-only">Home</span>
      </a>
      <div class="dropdown">
        <button class="dropbtn dropbtn--plain" type="button">Use Cases</button>
        <div class="dropdown-content">
          <a href="/use-cases/">All Use Cases</a>
          <a href="/use-cases/generate-ideas.html">Generate Ideas</a>
          <a href="/use-cases/screenplay.html">Screenplay Script</a>
          <a href="/use-cases/character-design.html">Character Design</a>
          <a href="/use-cases/set-design.html">Set / Production Design</a>
        </div>
      </div>
      <a class="menu__link menu__link--plain" href="https://finishthatstory.com" target="_blank" rel="noopener noreferrer">FinishThatStory.com</a>
      <div class="menu__actions">
        <button class="theme-toggle theme-toggle--icon" type="button" data-theme-toggle aria-pressed="false">
          <span class="sr-only">Toggle theme</span>
          <span class="theme-toggle__icon" aria-hidden="true" data-theme-icon>‚òÄÔ∏è</span>
        </button>
        <a class="menu__cta" href="https://studioorganize.com/supabase-test.html" data-auth-link>Sign up / Log in</a>
        <div class="dropdown" data-account-menu hidden>
          <button class="menu__cta" type="button" data-account-button>Account</button>
          <div class="dropdown-content">
            <a href="/account.html">My Creator Page</a>
            <a href="/product/personal.html">My Subscription</a>
            <a href="#" data-account-logout>Log out</a>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <div class="workspace-launcher" data-workspace-launcher>
    <div class="workspace-launcher__toggle-wrap">
      <button class="workspace-launcher__toggle" type="button" aria-expanded="false" aria-label="Workspace menu" data-workspace-toggle>
        <span class="sr-only">Workspace menu</span>
        <span class="workspace-launcher__icon" aria-hidden="true"></span>
      </button>
      <div class="workspace-launcher__chat" data-workspace-chat hidden aria-hidden="true">
        <div class="workspace-launcher__chat-bubble">
          <div class="workspace-launcher__chat-thread" data-workspace-chat-thread>
            <div class="workspace-launcher__chat-message workspace-launcher__chat-message--assistant">Hi there! Ready to build something great today?</div>
          </div>
            <div class="workspace-launcher__chat-suggestions">
              <button type="button" class="workspace-launcher__chat-chip" data-workspace-chat-suggestion data-workspace-chat-action="continue">Check my progress</button>
              <button type="button" class="workspace-launcher__chat-chip" data-workspace-chat-suggestion data-workspace-chat-action="new">Spin up something new</button>
              <button type="button" class="workspace-launcher__chat-chip" data-workspace-chat-suggestion data-workspace-chat-action="settings">How should you behave?</button>
            </div>
          <form class="workspace-launcher__chat-form" data-workspace-chat-form>
            <div class="workspace-launcher__chat-input">
              <input type="text" placeholder="Ask StudioOrganize‚Ä¶" aria-label="Ask the workspace assistant" data-workspace-chat-input />
              <button type="submit" class="workspace-launcher__chat-send" aria-label="Send chat message">
                <span aria-hidden="true">‚û§</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="workspace-launcher__panel" data-workspace-panel aria-hidden="true" hidden tabindex="-1">
      <div class="workspace-launcher__actions">
        <button type="button" class="workspace-launcher__script" data-workspace-script>
          <span class="workspace-launcher__script-icon" aria-hidden="true">Ôºã</span>
          <span>STORY</span>
        </button>
      </div>
      <nav class="workspace-launcher__modules" aria-label="Workspace modules">
        <a class="workspace-launcher__module" href="/use-cases/screenplay-writing.html" data-label="Screenplay Writing">
          <span class="workspace-launcher__module-icon" aria-hidden="true">
            <img src="/assets/img/screenplay_writer1.webp" alt="" loading="lazy" />
          </span>
          <span class="sr-only">Screenplay Writing</span>
        </a>
        <a class="workspace-launcher__module workspace-launcher__module--active" href="/CharacterStudio.html" data-label="Character Studio">
          <span class="workspace-launcher__module-icon" aria-hidden="true">
            <img src="/assets/img/studioorganize_mock.png" alt="" loading="lazy" />
          </span>
          <span class="sr-only">Character Studio</span>
        </a>
        <a class="workspace-launcher__module" href="/StoryboardPro.html" data-label="Storyboard Pro">
          <span class="workspace-launcher__module-icon" aria-hidden="true">
            <img src="/assets/img/studioorganize_mock.png" alt="" loading="lazy" />
          </span>
          <span class="sr-only">Storyboard Pro</span>
        </a>
        <a class="workspace-launcher__module" href="/use-cases/generate-ideas.html" data-label="Idea Generator">
          <span class="workspace-launcher__module-icon" aria-hidden="true">
            <img src="/assets/img/studioorganize_mock.png" alt="" loading="lazy" />
          </span>
          <span class="sr-only">Idea Generator</span>
        </a>
        <a class="workspace-launcher__module" href="/use-cases/set-design.html" data-label="Set Design">
          <span class="workspace-launcher__module-icon" aria-hidden="true">
            <img src="/assets/img/studioorganize_mock.png" alt="" loading="lazy" />
          </span>
          <span class="sr-only">Set Design</span>
        </a>
        <a class="workspace-launcher__module" href="/creative-hub.html" data-label="Creative Hub">
          <span class="workspace-launcher__module-icon" aria-hidden="true">
            <img src="/assets/img/studioorganize_mock.png" alt="" loading="lazy" />
          </span>
          <span class="sr-only">Creative Hub</span>
        </a>
      </nav>
    </div>
  </div>

  <main class="section">
    <style>
      html, body { height: 100%; font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial; }
      body {
        color: var(--ink);
        background: radial-gradient(circle at top right, rgba(123, 97, 255, 0.1), transparent 35%), var(--surface);
        --nav-height: 72px;
      }
      main.section { flex: 1; display: flex; flex-direction: column; width: 100%; max-width: none; padding: 0; margin: 0; }
      .character-studio-app { flex: 1; display: flex; flex-direction: column; min-height: 0; padding: clamp(18px, 4vw, 32px); gap: 24px; }
      .character-studio-window {
        position: relative;
        width: 100%;
        min-height: 0;
        background: var(--panel);
        border: 1px solid var(--ring);
        border-radius: 24px;
        box-shadow: 0 36px 110px rgba(0, 0, 0, 0.35);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .character-studio-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 18px;
        padding: 26px 30px;
        border-bottom: 1px solid var(--ring);
        background: var(--chip);
      }
      .character-studio-header-primary {
        display: flex;
        align-items: center;
        gap: 18px;
      }
      .brand-with-logo__badge--character {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        letter-spacing: .6px;
        background: linear-gradient(135deg, #7c3aed, #22d3ee);
        color: white;
        box-shadow: 0 8px 24px rgba(124, 58, 237, 0.35);
      }
      .character-studio-header h2 { margin: 0; font-size: 24px; font-weight: 600; }
      .character-studio-header .muted-text { margin: 6px 0 0; max-width: 60ch; font-size: 14px; }
      .character-studio-header-actions { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: flex-end; }
      .character-studio-header-buttons { display: inline-flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
      .character-studio-project { font-size: 12px; color: var(--muted); }
      .character-studio-project[data-state="warning"] { color: #f97316; }
      .character-studio-project[data-state="error"] { color: #ef4444; }
      .character-studio-project[data-state="ready"] { color: var(--acc); }
      .character-studio-tabs { display: flex; flex-direction: column; gap: 18px; }
      .character-studio-tablist { display: flex; flex-wrap: wrap; gap: 8px; padding: 8px; border-radius: 14px; background: var(--card); border: 1px solid var(--ring); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04); overflow-x: auto; }
      .character-studio-tablist::-webkit-scrollbar { height: 6px; }
      .character-studio-tab-button {
        appearance: none;
        border: 1px solid transparent;
        border-radius: 999px;
        background: transparent;
        color: var(--muted);
        font: inherit;
        font-size: 13px;
        padding: 8px 16px;
        cursor: pointer;
        transition: background .2s ease, color .2s ease, box-shadow .2s ease, transform .2s ease;
      }
      .character-studio-tab-button:hover { color: var(--ink); }
      .character-studio-tab-button[aria-selected="true"] {
        background: var(--acc);
        color: var(--active-tab-text);
        box-shadow: 0 14px 36px rgba(62, 114, 255, 0.28);
        border-color: var(--acc);
        transform: translateY(-1px);
      }
      .character-studio-tab-button:focus-visible {
        outline: none;
        box-shadow: 0 0 0 2px rgba(79, 123, 255, 0.45);
      }
      .character-studio-tabpanels { position: relative; }
      .character-studio-header-badge {
        font-size: 11px;
        letter-spacing: .3px;
        text-transform: uppercase;
        background: rgba(123, 97, 255, 0.16);
        border: 1px solid rgba(123, 97, 255, 0.35);
        color: var(--ink);
        border-radius: 999px;
        padding: 6px 12px;
        font-weight: 600;
      }
      .character-studio-add { 
        background: var(--acc);
        border: 1px solid var(--acc);
        color: var(--active-tab-text);
        border-radius: 999px;
        padding: 8px 18px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: transform .2s ease, box-shadow .2s ease;
      }
      .character-studio-add:hover { box-shadow: 0 14px 32px rgba(79, 123, 255, 0.25); transform: translateY(-1px); }
      .character-studio-add:focus-visible { outline: none; box-shadow: 0 0 0 2px rgba(79,123,255,0.25); }
      .character-studio-save {
        background: linear-gradient(135deg, var(--brand-2), var(--brand));
        border: 1px solid transparent;
        color: var(--cta-text);
        border-radius: 999px;
        padding: 8px 20px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 18px 48px rgba(124, 58, 237, 0.28);
        transition: transform .2s ease, box-shadow .2s ease, opacity .2s ease;
      }
      .character-studio-save:hover { box-shadow: 0 20px 52px rgba(124, 58, 237, 0.32); transform: translateY(-1px); }
      .character-studio-save:focus-visible { outline: none; box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.35); }
      .character-studio-save[disabled] { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; }
      .character-studio-body { padding: 26px 30px 32px; flex: 1; overflow: hidden; }
      .character-studio-layout { display: grid; grid-template-columns: 300px 1fr; gap: 24px; height: 100%; min-height: 0; }
      .character-studio-sidebar { display: flex; flex-direction: column; gap: 16px; min-height: 0; }
      .character-studio-sidebar-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
      .character-studio-sidebar h3 { margin: 0; font-size: 12px; letter-spacing: .4px; text-transform: uppercase; color: var(--muted); }
      .character-studio-sidebar-note { font-size: 12px; color: var(--muted); line-height: 1.45; }
      .character-studio-sidebar-list { display: flex; flex-direction: column; gap: 10px; overflow: auto; padding-right: 4px; min-height: 0; }
      .character-studio-list-item {
        background: var(--card);
        border: 1px solid var(--ring);
        border-radius: 14px;
        padding: 12px 14px;
        text-align: left;
        display: flex;
        flex-direction: column;
        gap: 6px;
        cursor: pointer;
        color: inherit;
        font: inherit;
        transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease;
      }
      .character-studio-list-item strong { font-size: 14px; font-weight: 600; }
      .character-studio-list-item span { font-size: 11px; color: var(--muted); letter-spacing: .3px; text-transform: uppercase; }
      .character-studio-list-item:hover { border-color: var(--acc); box-shadow: 0 18px 48px rgba(47, 110, 255, 0.18); transform: translateY(-1px); }
      .character-studio-list-item.active { border-color: var(--acc); box-shadow: 0 18px 48px rgba(47, 110, 255, 0.28); background: var(--acc); color: var(--active-tab-text); }
      .character-studio-list-item.active span { color: var(--active-tab-text); opacity: 0.85; }
      .character-studio-details { display: flex; flex-direction: column; gap: 20px; min-height: 0; overflow: auto; padding-right: 6px; }
      .character-studio-detail-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 18px; flex-wrap: wrap; }
      .character-studio-detail-header h2 { margin: 0; font-size: 26px; font-weight: 600; }
      .character-studio-detail-header .muted-text { margin: 6px 0 0; font-size: 13px; }
      .character-studio-profile-layout { display: flex; flex-wrap: wrap; gap: 18px; align-items: flex-start; }
      .character-studio-profile-portrait { flex: 0 0 220px; max-width: 260px; width: 100%; background: var(--chip); border: 1px solid var(--ring); border-radius: 16px; overflow: hidden; aspect-ratio: 3 / 4; display: flex; align-items: center; justify-content: center; }
      .character-studio-profile-portrait img { width: 100%; height: 100%; object-fit: cover; }
      .character-studio-profile-fields { flex: 1 1 260px; display: flex; flex-direction: column; gap: 16px; }
      .character-studio-tertiary {
        background: none;
        border: 1px solid var(--ring);
        border-radius: 12px;
        padding: 6px 14px;
        font-size: 12px;
        cursor: pointer;
        color: var(--muted);
      }
      .character-studio-tertiary:hover { border-color: var(--acc); color: var(--ink); }
      .character-studio-section {
        background: var(--card);
        border: 1px solid var(--ring);
        border-radius: 18px;
        padding: 22px 24px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }
      .character-studio-section[hidden] { display: none; }
      .character-studio-section h3 { margin: 0; font-size: 14px; font-weight: 600; }
      .character-studio-section p { margin: 0; }
      .character-studio-two-col { display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
      .character-studio-field { display: flex; flex-direction: column; gap: 6px; font-size: 13px; }
      .character-studio-field span { font-size: 11px; color: var(--muted); letter-spacing: .3px; text-transform: uppercase; }
      .character-studio-field input,
      .character-studio-field textarea {
        background: var(--field);
        color: var(--ink);
        border: 1px solid var(--ring);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 14px;
        width: 100%;
      }
      .character-studio-field textarea { min-height: 108px; resize: vertical; }
      .character-studio-field textarea.small { min-height: 78px; }
      .character-studio-stats-grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
      .character-studio-stat { background: var(--chip); border: 1px solid var(--ring); border-radius: 16px; padding: 16px; display: flex; flex-direction: column; gap: 6px; }
      .character-studio-stat-value { font-size: 22px; font-weight: 700; }
      .character-studio-stat-label { font-size: 11px; color: var(--muted); letter-spacing: .3px; text-transform: uppercase; }
      .character-studio-traits-preview { display: flex; flex-wrap: wrap; gap: 8px; min-height: 36px; align-items: flex-start; }
      .character-studio-chip { background: var(--chip); border: 1px solid var(--ring); border-radius: 999px; padding: 4px 10px; font-size: 12px; }
      .character-studio-look-grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
      .character-studio-look-card { position: relative; border: 1px solid var(--ring); border-radius: 16px; overflow: hidden; background: var(--chip); aspect-ratio: 4 / 3; display: flex; align-items: center; justify-content: center; text-align: center; }
      .character-studio-look-card [data-look-content] { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
      .character-studio-look-card img { width: 100%; height: 100%; object-fit: cover; }
      .character-studio-look-empty { padding: 0 16px; font-size: 12px; color: var(--muted); line-height: 1.45; }
      .character-studio-look-label { position: absolute; top: 10px; left: 10px; padding: 4px 8px; border-radius: 999px; font-size: 11px; text-transform: uppercase; letter-spacing: .3px; background: rgba(15, 18, 30, 0.65); color: #fff; }
      .character-studio-ai-actions { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
      .character-studio-ai-actions button { background: var(--acc); border: 1px solid var(--acc); color: var(--active-tab-text); border-radius: 999px; padding: 10px 18px; font-weight: 600; cursor: pointer; }
      .character-studio-status { font-size: 12px; color: var(--muted); min-height: 18px; }
      .character-studio-status[data-state="ready"] { color: var(--acc); }
      .character-studio-status[data-state="warning"] { color: #f97316; }
      .character-studio-save-status { font-size: 12px; color: var(--muted); min-height: 18px; }
      .character-studio-save-status[data-state="ready"] { color: var(--acc); }
      .character-studio-save-status[data-state="warning"] { color: #f97316; }
      .character-studio-save-status[data-state="error"] { color: #ef4444; }
      .character-studio-save-status[data-state="saving"] { color: var(--brand); }
      .character-studio-empty,
      .character-studio-empty-list {
        border: 1px dashed var(--ring);
        border-radius: 16px;
        padding: 28px;
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 10px;
        color: var(--muted);
        align-items: center;
        justify-content: center;
      }
      .character-studio-empty h2 { margin: 0; font-size: 22px; color: var(--ink); }
      .character-studio-empty p { margin: 0; font-size: 14px; }
      .muted-text { color: var(--muted); font-size: 12px; }
      @media (max-width: 1100px) {
        .character-studio-layout { grid-template-columns: 260px 1fr; }
      }
      @media (max-width: 920px) {
        .character-studio-body { padding: 22px 20px 26px; }
        .character-studio-layout { grid-template-columns: 1fr; }
        .character-studio-sidebar { order: 2; }
        .character-studio-details { order: 1; }
      }
      @media (max-width: 640px) {
        .character-studio-app { padding: 16px 12px; }
        .character-studio-header { flex-direction: column; align-items: flex-start; }
        .character-studio-header-primary { width: 100%; }
        .character-studio-header-actions { width: 100%; justify-content: space-between; }
      }
    </style>

    <div class="character-studio-app">
      <div class="character-studio-window">
        <div class="character-studio-header">
          <div class="character-studio-header-primary">
            <span class="topbar__badge brand-with-logo__badge--character" aria-hidden="true">CS</span>
            <div>
              <h2>Character Studio</h2>
              <p class="muted-text">Craft multidimensional characters with dedicated planners, lookbooks, and AI prompts.</p>
            </div>
          </div>
          <div class="character-studio-header-actions">
            <span class="character-studio-header-badge">Cast</span>
            <span class="character-studio-project" data-project-label></span>
            <div class="character-studio-header-buttons">
              <button class="character-studio-add" type="button" id="characterStudioAddBtn">+ New</button>
              <button class="character-studio-save" type="button" id="characterStudioSaveBtn" disabled>Save</button>
            </div>
            <span class="character-studio-save-status" data-save-status aria-live="polite"></span>
          </div>
        </div>
        <div class="character-studio-body">
          <div class="character-studio-layout">
            <aside class="character-studio-sidebar">
              <div class="character-studio-sidebar-header">
                <h3>Characters</h3>
              </div>
              <p class="character-studio-sidebar-note">Keep track of stats, arcs, and visual references for every character in one place.</p>
              <div class="character-studio-sidebar-list" data-character-list></div>
            </aside>
            <section class="character-studio-details" data-character-details></section>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="footer__grid">
      <div>
        <strong>StudioOrganize</strong>
        <p class="muted">Tools for storytellers &amp; focused work.</p>
      </div>
      <div>
        <a href="/about.html">About</a><br />
      </div>
      <div>
        <a href="mailto:support@studioorganize.com">support@studioorganize.com</a><br />
        <span class="muted">¬© <span id="y"></span> StudioOrganize</span>
      </div>
    </div>
  </footer>

  <script>
    (function(){
      const CHARACTER_LOOK_LABELS = {
        portrait: 'Portrait',
        turnaround: 'Turnaround Sheet',
        expression: 'Expression Sheet'
      };

      const CHARACTER_TAB_CONFIG = [
        { id: 'profile', label: 'Profile' },
        { id: 'stats', label: 'Stats & Spotlight' },
        { id: 'traits', label: 'Traits & Personality' },
        { id: 'background', label: 'Background & Family' },
        { id: 'arc', label: 'Character Arc' },
        { id: 'lookbook', label: 'Lookbook' },
        { id: 'ai', label: 'AI Concepting' }
      ];

      const initialCharacters = [];

      function normalizeProjectId(value){
        if (typeof value !== 'string') return null;
        const trimmed = value.trim();
        return trimmed ? trimmed : null;
      }

      function getStoredProjectId(){
        try {
          const raw = localStorage.getItem('SW_LAST_PROJECT_ID');
          return normalizeProjectId(raw);
        } catch (err){
          return null;
        }
      }

      function setStoredProjectId(projectId){
        try {
          if (projectId){
            localStorage.setItem('SW_LAST_PROJECT_ID', projectId);
          } else {
            localStorage.removeItem('SW_LAST_PROJECT_ID');
          }
        } catch (err){
          /* ignore storage errors */
        }
      }

      function getProjectIdFromQuery(){
        try {
          const params = new URLSearchParams(window.location.search);
          const keys = ['projectId', 'project', 'scriptId', 'script'];
          for (const key of keys){
            const value = params.get(key);
            const normalized = normalizeProjectId(value);
            if (normalized) return normalized;
          }
        } catch (err){
          /* ignore malformed query strings */
        }
        return null;
      }

      const queryProjectId = getProjectIdFromQuery();
      if (queryProjectId) setStoredProjectId(queryProjectId);

      const storedProjectId = queryProjectId || getStoredProjectId();

      const state = {
        characters: initialCharacters.map(normalizeCharacter),
        activeId: initialCharacters.length ? initialCharacters[0].id : null,
        activeTabId: 'profile',
        projectId: storedProjectId,
        supabase: null,
        session: null,
        ownerId: null,
        projectLabel: '',
        projectLabelState: '',
        loading: Boolean(storedProjectId),
        saving: false,
        dirty: false,
        saveStatus: '',
        saveStatusState: '',
        remoteIds: new Set(initialCharacters.map(char => char.id))
      };

      const LOCAL_DB_NAME = 'sw_db_v1';
      const LOCAL_DB_STORE = 'projects';
      const LOCAL_PERSIST_DELAY_MS = 400;
      let localDb = null;
      let localPersistTimer = null;

      function openLocalProjectDb(){
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(LOCAL_DB_NAME, 1);
          request.onupgradeneeded = event => {
            const database = event.target.result;
            if (!database.objectStoreNames.contains(LOCAL_DB_STORE)){
              database.createObjectStore(LOCAL_DB_STORE, { keyPath: 'projectId' });
            }
          };
          request.onsuccess = event => {
            localDb = event.target.result;
            resolve();
          };
          request.onerror = event => reject(event);
        });
      }

      async function ensureLocalDb(){
        if (localDb) return true;
        try {
          await openLocalProjectDb();
          return !!localDb;
        } catch (err){
          console.warn('Character Studio failed to open local project database', err);
          return false;
        }
      }

      function loadProjectFromLocalStore(projectId){
        return new Promise((resolve, reject) => {
          if (!localDb){
            resolve(null);
            return;
          }
          const tx = localDb.transaction([LOCAL_DB_STORE], 'readonly');
          const store = tx.objectStore(LOCAL_DB_STORE);
          const request = store.get(projectId);
          request.onsuccess = () => resolve(request.result || null);
          request.onerror = event => reject(event);
        });
      }

      function saveProjectToLocalStore(project){
        return new Promise((resolve, reject) => {
          if (!localDb){
            resolve();
            return;
          }
          const tx = localDb.transaction([LOCAL_DB_STORE], 'readwrite');
          tx.objectStore(LOCAL_DB_STORE).put(project);
          tx.oncomplete = () => resolve();
          tx.onerror = event => reject(event);
        });
      }

      async function persistCharactersToLocal(){
        if (!state.projectId) return;
        localPersistTimer = null;
        const ready = await ensureLocalDb();
        if (!ready) return;
        try {
          const project = await loadProjectFromLocalStore(state.projectId);
          if (!project || typeof project !== 'object') return;
          const nextCharacters = state.characters.map(normalizeCharacter);
          const catalogs = project.catalogs && typeof project.catalogs === 'object'
            ? project.catalogs
            : {};
          const previous = Array.isArray(catalogs.characters) ? catalogs.characters : [];
          const previousJson = JSON.stringify(previous);
          const nextJson = JSON.stringify(nextCharacters);
          if (previousJson === nextJson) return;
          catalogs.characters = nextCharacters;
          project.catalogs = catalogs;
          project.updatedAt = Date.now();
          await saveProjectToLocalStore(project);
        } catch (err){
          console.warn('Character Studio failed to persist characters locally', err);
        }
      }

      function scheduleLocalPersist(){
        if (!state.projectId) return;
        if (localPersistTimer) window.clearTimeout(localPersistTimer);
        localPersistTimer = window.setTimeout(() => {
          persistCharactersToLocal().catch(err => {
            console.warn('Character Studio failed to schedule local character save', err);
          });
        }, LOCAL_PERSIST_DELAY_MS);
      }

      async function hydrateCharactersFromLocal(){
        if (!state.projectId) return;
        const ready = await ensureLocalDb();
        if (!ready) return;
        try {
          const project = await loadProjectFromLocalStore(state.projectId);
          if (!project || typeof project !== 'object') return;
          const list = Array.isArray(project?.catalogs?.characters)
            ? project.catalogs.characters.map(normalizeCharacter)
            : [];
          if (!list.length) return;
          state.characters = list;
          if (!list.some(char => char.id === state.activeId)){
            state.activeId = list.length ? list[0].id : null;
          }
          state.dirty = true;
          renderCharacterList();
          renderCharacterDetails();
          updateSaveButtonState();
          if (state.session && state.projectId){
            setSaveStatus('Unsaved changes', 'warning');
          } else {
            setSaveStatus('Unsaved changes (sign in to sync)', 'warning');
          }
        } catch (err){
          console.warn('Character Studio failed to load characters from the Writer workspace', err);
        }
      }

      function setProjectLabel(text, status = ''){
        state.projectLabel = text || '';
        state.projectLabelState = status || '';
        const labelEl = document.querySelector('[data-project-label]');
        if (!labelEl) return;
        const content = state.projectLabel || '';
        labelEl.textContent = content;
        if (status){
          labelEl.dataset.state = status;
        } else {
          labelEl.removeAttribute('data-state');
        }
        labelEl.hidden = false;
      }

      function setSaveStatus(message, status = ''){
        state.saveStatus = message || '';
        state.saveStatusState = status || '';
        const statusEl = document.querySelector('[data-save-status]');
        if (!statusEl) return;
        statusEl.textContent = state.saveStatus;
        if (status){
          statusEl.dataset.state = status;
        } else {
          statusEl.removeAttribute('data-state');
        }
      }

      function updateSaveButtonState(){
        const btn = document.getElementById('characterStudioSaveBtn');
        if (!btn) return;
        const disabled = state.saving || state.loading || !state.supabase || !state.session || !state.ownerId || !state.projectId || !state.dirty;
        btn.disabled = disabled;
        btn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
        btn.textContent = state.saving ? 'Saving‚Ä¶' : 'Save';
      }

      function markDirty(){
        state.dirty = true;
        updateSaveButtonState();
        scheduleLocalPersist();
        if (state.saving) return;
        if (state.session && state.projectId){
          setSaveStatus('Unsaved changes', 'warning');
        } else {
          setSaveStatus('Unsaved changes (sign in to sync)', 'warning');
        }
      }

      function escapeHtml(value){
        return String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function normalizeList(value){
        if (Array.isArray(value)) return value.map(v => String(v || '').trim()).filter(Boolean);
        if (typeof value === 'string') return value.split(/\r?\n+/).map(v => v.trim()).filter(Boolean);
        return [];
      }

      function createId(){
        if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function'){
          try { return crypto.randomUUID(); }
          catch (err){}
        }
        let d = Date.now();
        let d2 = (typeof performance !== 'undefined' && typeof performance.now === 'function')
          ? performance.now() * 1000
          : 0;
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
          let r = Math.random() * 16;
          if (d > 0){
            r = (d + r) % 16 | 0;
            d = Math.floor(d / 16);
          } else {
            r = (d2 + r) % 16 | 0;
            d2 = Math.floor(d2 / 16);
          }
          return (c === 'x' ? r : (r & 0x3) | 0x8).toString(16);
        });
      }

      function createCharacterData(name = ''){
        return {
          id: createId(),
          name,
          role: '',
          archetype: '',
          pronouns: '',
          age: '',
          summary: '',
          traits: [],
          background: '',
          familyTree: '',
          stats: { scenes: 0, dialogue: 0, screenTime: 0 },
          arc: { setup: '', development: '', resolution: '' },
          looks: { portrait: '', turnarounds: [], expressions: [] },
          ai: { prompt: '', notes: '' }
        };
      }

      function normalizeCharacter(item){
        const base = createCharacterData(item?.name || 'Untitled Character');
        if (!item || typeof item !== 'object') return base;
        const normalized = { ...base, ...item };
        normalized.id = item.id || base.id;
        normalized.name = typeof item.name === 'string' ? item.name : base.name;
        normalized.role = typeof item.role === 'string' ? item.role : '';
        normalized.archetype = typeof item.archetype === 'string' ? item.archetype : '';
        normalized.pronouns = typeof item.pronouns === 'string' ? item.pronouns : '';
        if (typeof item.age === 'number') normalized.age = String(item.age);
        else if (typeof item.age === 'string') normalized.age = item.age;
        normalized.summary = typeof item.summary === 'string' ? item.summary : '';
        normalized.background = typeof item.background === 'string' ? item.background : '';
        normalized.familyTree = typeof item.familyTree === 'string' ? item.familyTree : '';
        normalized.traits = normalizeList(item.traits);
        normalized.stats = { ...base.stats, ...(item.stats || {}) };
        normalized.arc = { ...base.arc, ...(item.arc || {}) };
        normalized.looks = { ...base.looks, ...(item.looks || {}) };
        normalized.looks.turnarounds = normalizeList(normalized.looks.turnarounds);
        normalized.looks.expressions = normalizeList(normalized.looks.expressions);
        normalized.ai = { ...base.ai, ...(item.ai || {}) };
        return normalized;
      }

      function supabaseRowToCharacter(row){
        if (!row || typeof row !== 'object') return createCharacterData('Untitled Character');
        const screenTimeValue = typeof row.stats_screen_time === 'number'
          ? row.stats_screen_time
          : Number(row.stats_screen_time);
        const normalized = {
          id: row.id || createId(),
          name: typeof row.name === 'string' ? row.name : '',
          role: typeof row.role === 'string' ? row.role : '',
          archetype: typeof row.archetype === 'string' ? row.archetype : '',
          pronouns: typeof row.pronouns === 'string' ? row.pronouns : '',
          age: typeof row.age === 'string' ? row.age : (typeof row.age === 'number' ? String(row.age) : ''),
          summary: typeof row.summary === 'string' ? row.summary : '',
          background: typeof row.background === 'string' ? row.background : '',
          familyTree: typeof row.family_tree === 'string' ? row.family_tree : '',
          traits: Array.isArray(row.traits) ? row.traits : [],
          stats: {
            scenes: Number.isFinite(row.stats_scenes) ? row.stats_scenes : 0,
            dialogue: Number.isFinite(row.stats_dialogue) ? row.stats_dialogue : 0,
            screenTime: Number.isFinite(screenTimeValue) ? Number(screenTimeValue) : 0
          },
          arc: {
            setup: typeof row.arc_setup === 'string' ? row.arc_setup : '',
            development: typeof row.arc_development === 'string' ? row.arc_development : '',
            resolution: typeof row.arc_resolution === 'string' ? row.arc_resolution : ''
          },
          looks: {
            portrait: typeof row.look_portrait_url === 'string' ? row.look_portrait_url : '',
            turnarounds: Array.isArray(row.look_turnaround_urls) ? row.look_turnaround_urls : [],
            expressions: Array.isArray(row.look_expression_urls) ? row.look_expression_urls : []
          },
          ai: {
            prompt: typeof row.ai_prompt === 'string' ? row.ai_prompt : '',
            notes: typeof row.ai_notes === 'string' ? row.ai_notes : ''
          }
        };
        return normalizeCharacter(normalized);
      }

      function characterToSupabaseRow(character){
        const normalized = normalizeCharacter(character);
        const traits = normalizeList(normalized.traits);
        const turnarounds = normalizeList(normalized.looks?.turnarounds || []);
        const expressions = normalizeList(normalized.looks?.expressions || []);
        const statsScenes = Number.isFinite(normalized.stats?.scenes) ? normalized.stats.scenes : 0;
        const statsDialogue = Number.isFinite(normalized.stats?.dialogue) ? normalized.stats.dialogue : 0;
        const statsScreenTime = Number.isFinite(normalized.stats?.screenTime)
          ? Number(normalized.stats.screenTime)
          : 0;
        return {
          id: normalized.id,
          owner_id: state.ownerId,
          project_id: state.projectId,
          name: normalized.name || '',
          role: normalized.role || null,
          archetype: normalized.archetype || null,
          pronouns: normalized.pronouns || null,
          age: normalized.age || null,
          summary: normalized.summary || null,
          background: normalized.background || null,
          family_tree: normalized.familyTree || null,
          traits,
          stats_scenes: statsScenes,
          stats_dialogue: statsDialogue,
          stats_screen_time: statsScreenTime,
          arc_setup: normalized.arc?.setup || null,
          arc_development: normalized.arc?.development || null,
          arc_resolution: normalized.arc?.resolution || null,
          look_portrait_url: normalized.looks?.portrait || null,
          look_turnaround_urls: turnarounds,
          look_expression_urls: expressions,
          ai_prompt: normalized.ai?.prompt || null,
          ai_notes: normalized.ai?.notes || null,
          updated_at: new Date().toISOString()
        };
      }

      function getActiveCharacter(){
        if (!state.activeId) return null;
        return state.characters.find(char => char.id === state.activeId) || null;
      }

      function characterSidebarMeta(character){
        if (!character) return '';
        if (character.role) return character.role;
        if (character.archetype) return character.archetype;
        const identity = [character.pronouns, character.age].filter(Boolean).join(' ‚Ä¢ ');
        if (identity) return identity;
        return 'Tap to detail profile';
      }

      function buildCharacterSubheading(character){
        if (!character) return '';
        const parts = [];
        if (character.role) parts.push(character.role);
        const identity = [character.pronouns, character.age].filter(Boolean).join(' ‚Ä¢ ');
        if (identity) parts.push(identity);
        if (character.archetype) parts.push(character.archetype);
        return parts.join(' ‚Äî ');
      }

      function buildTraitsPreviewMarkup(character){
        const traits = Array.isArray(character?.traits) ? character.traits : [];
        if (!traits.length) return '<span class="muted-text">Add traits to see quick reference chips.</span>';
        return traits.map(trait => `<span class="character-studio-chip"><strong>${escapeHtml(trait)}</strong></span>`).join('');
      }

      function characterLookPreviewMarkup(kind, url, character){
        const label = CHARACTER_LOOK_LABELS[kind] || 'Reference';
        const name = character?.name ? character.name : 'Character';
        if (url){
          return `<img src="${escapeHtml(url)}" alt="${escapeHtml(`${name} ${label.toLowerCase()}`)}" />`;
        }
        return `<div class="character-studio-look-empty">Add a ${escapeHtml(label.toLowerCase())} URL to preview.</div>`;
      }

      function parseIntegerInput(value){
        const num = parseInt(value, 10);
        return Number.isFinite(num) && num >= 0 ? num : 0;
      }

      function parseFloatInput(value){
        const num = parseFloat(value);
        return Number.isFinite(num) && num >= 0 ? Number(num.toFixed(2)) : 0;
      }

      function updateCharacterField(id, path, value){
        const character = state.characters.find(c => c.id === id);
        if (!character) return;
        const parts = path.split('.');
        let target = character;
        for (let i = 0; i < parts.length - 1; i++){
          const key = parts[i];
          if (typeof target[key] !== 'object' || target[key] === null) target[key] = {};
          target = target[key];
        }
        const finalKey = parts[parts.length - 1];
        const previous = target[finalKey];
        target[finalKey] = value;
        let changed = previous !== value;
        if (Array.isArray(previous) && Array.isArray(value)){
          changed = previous.length !== value.length || previous.some((entry, index) => entry !== value[index]);
        }
        if (changed) markDirty();
      }

      function renderCharacterList(){
        const listEl = document.querySelector('[data-character-list]');
        if (!listEl) return;
        listEl.innerHTML = '';
        const showMessage = (title, detail) => {
          const empty = document.createElement('div');
          empty.className = 'character-studio-empty-list';
          empty.innerHTML = `<strong>${escapeHtml(title)}</strong><span>${escapeHtml(detail)}</span>`;
          listEl.appendChild(empty);
        };
        if (!state.projectId){
          state.activeId = null;
          showMessage('No story linked', 'Open your story in the Writer to connect Character Studio.');
          return;
        }
        if (!state.characters.length){
          state.activeId = null;
          if (state.loading){
            showMessage('Loading characters‚Ä¶', 'Syncing the cast from Supabase.');
          } else if (!state.supabase){
            showMessage('Connecting to Supabase‚Ä¶', 'One moment while we prepare your workspace.');
          } else if (!state.session){
            showMessage('Sign in to continue', 'Sign in to load and save your cast.');
          } else {
            showMessage('No characters yet', 'Add the first member of your cast to begin planning.');
          }
          return;
        }
        state.characters.forEach(char => {
          const item = document.createElement('button');
          item.type = 'button';
          item.className = 'character-studio-list-item' + (char.id === state.activeId ? ' active' : '');
          item.innerHTML = `<strong>${escapeHtml(char.name || 'Untitled Character')}</strong><span>${escapeHtml(characterSidebarMeta(char))}</span>`;
          item.addEventListener('click', () => {
            if (state.activeId === char.id) return;
            state.activeId = char.id;
            renderCharacterList();
            renderCharacterDetails();
          });
          listEl.appendChild(item);
        });
      }

      function renderCharacterDetails(){
        const container = document.querySelector('[data-character-details]');
        if (!container) return;
        if (!state.projectId){
          container.innerHTML = `
            <div class="character-studio-empty">
              <h2>No story linked</h2>
              <p>Open your story in the Writer to connect Character Studio.</p>
            </div>`;
          return;
        }
        if (!state.characters.length){
          if (state.loading){
            container.innerHTML = `
              <div class="character-studio-empty">
                <h2>Loading characters‚Ä¶</h2>
                <p>Syncing the cast from Supabase.</p>
              </div>`;
          } else if (!state.supabase){
            container.innerHTML = `
              <div class="character-studio-empty">
                <h2>Connecting to Supabase‚Ä¶</h2>
                <p>One moment while we prepare your workspace.</p>
              </div>`;
          } else if (!state.session){
            container.innerHTML = `
              <div class="character-studio-empty">
                <h2>Sign in to continue</h2>
                <p>Sign in to view and save this cast.</p>
              </div>`;
          } else {
            container.innerHTML = `
              <div class="character-studio-empty">
                <h2>No characters yet</h2>
                <p>Use the + New button to start building your cast.</p>
              </div>`;
          }
          return;
        }
        const active = getActiveCharacter();
        if (!active){
          container.innerHTML = `
            <div class="character-studio-empty">
              <h2>No character selected</h2>
              <p>Choose a character from the list to begin planning.</p>
            </div>`;
          return;
        }

        const statsScenes = Number.isFinite(active.stats?.scenes) ? active.stats.scenes : 0;
        const statsDialogue = Number.isFinite(active.stats?.dialogue) ? active.stats.dialogue : 0;
        const statsScreenTime = Number.isFinite(active.stats?.screenTime) ? active.stats.screenTime : 0;
        const traitsText = Array.isArray(active.traits) ? active.traits.join('\n') : '';
        const portraitUrl = active.looks?.portrait || '';
        const turnaroundsText = Array.isArray(active.looks?.turnarounds) ? active.looks.turnarounds.join('\n') : '';
        const expressionsText = Array.isArray(active.looks?.expressions) ? active.looks.expressions.join('\n') : '';
        const turnaroundPreview = Array.isArray(active.looks?.turnarounds) ? active.looks.turnarounds[0] || '' : '';
        const expressionPreview = Array.isArray(active.looks?.expressions) ? active.looks.expressions[0] || '' : '';
        const subheading = buildCharacterSubheading(active);
        const traitsPreview = buildTraitsPreviewMarkup(active);
        const aiPrompt = active.ai?.prompt || '';
        const aiNotes = active.ai?.notes || '';

        if (!CHARACTER_TAB_CONFIG.some(tab => tab.id === state.activeTabId)){
          state.activeTabId = CHARACTER_TAB_CONFIG[0].id;
        }

        const tabButtonsMarkup = CHARACTER_TAB_CONFIG.map(tab => {
          const isActive = tab.id === state.activeTabId;
          return `<button type="button" class="character-studio-tab-button" role="tab" id="character-tab-${tab.id}" data-tab-id="${tab.id}" aria-controls="character-panel-${tab.id}" aria-selected="${isActive ? 'true' : 'false'}" tabindex="${isActive ? '0' : '-1'}">${escapeHtml(tab.label)}</button>`;
        }).join('');

        const panelAttributes = id => {
          const isActive = state.activeTabId === id;
          return `${isActive ? '' : ' hidden'} aria-hidden="${isActive ? 'false' : 'true'}"`;
        };

        container.innerHTML = `
          <div class="character-studio-detail-header">
            <div>
              <h2 data-character-heading>${escapeHtml(active.name || 'Untitled Character')}</h2>
              <p class="muted-text" data-character-subheading>${escapeHtml(subheading || 'Add role, pronouns, or age details.')}</p>
            </div>
            <div class="character-studio-header-actions">
              <button class="character-studio-tertiary" type="button" data-character-delete>Delete Character</button>
            </div>
          </div>
          <div class="character-studio-tabs">
            <div class="character-studio-tablist" role="tablist" aria-label="Character sections" data-character-tablist>
              ${tabButtonsMarkup}
            </div>
            <div class="character-studio-tabpanels">
              <section class="character-studio-section" role="tabpanel" tabindex="0" id="character-panel-profile" aria-labelledby="character-tab-profile" data-tab-panel="profile"${panelAttributes('profile')}>
                <h3>Profile</h3>
                <p class="muted-text">Keep the essentials handy when writing.</p>
                <div class="character-studio-profile-layout">
                  <div class="character-studio-profile-portrait" data-profile-portrait>
                    ${characterLookPreviewMarkup('portrait', portraitUrl, active)}
                  </div>
                  <div class="character-studio-profile-fields">
                    <div class="character-studio-two-col">
                      <label class="character-studio-field">
                        <span>Name</span>
                        <input type="text" value="${escapeHtml(active.name || '')}" data-character-field="name" placeholder="Character name" />
                      </label>
                      <label class="character-studio-field">
                        <span>Role</span>
                        <input type="text" value="${escapeHtml(active.role || '')}" data-character-field="role" placeholder="Protagonist, Antagonist..." />
                      </label>
                      <label class="character-studio-field">
                        <span>Archetype</span>
                        <input type="text" value="${escapeHtml(active.archetype || '')}" data-character-field="archetype" placeholder="e.g. Reluctant hero" />
                      </label>
                      <label class="character-studio-field">
                        <span>Pronouns</span>
                        <input type="text" value="${escapeHtml(active.pronouns || '')}" data-character-field="pronouns" placeholder="They/Them" />
                      </label>
                      <label class="character-studio-field">
                        <span>Age</span>
                        <input type="text" value="${escapeHtml(active.age || '')}" data-character-field="age" placeholder="32" />
                      </label>
                    </div>
                    <label class="character-studio-field">
                      <span>Summary</span>
                      <textarea class="small" data-character-field="summary" placeholder="Logline summary">${escapeHtml(active.summary || '')}</textarea>
                    </label>
                  </div>
                </div>
              </section>
              <section class="character-studio-section" role="tabpanel" tabindex="0" id="character-panel-stats" aria-labelledby="character-tab-stats" data-tab-panel="stats"${panelAttributes('stats')}>
                <h3>Stats &amp; Spotlight</h3>
                <p class="muted-text">Track how often this character appears in the script.</p>
                <div class="character-studio-stats-grid">
                  <div class="character-studio-stat">
                    <span class="character-studio-stat-value" data-character-stat="scenes">${escapeHtml(String(statsScenes))}</span>
                    <span class="character-studio-stat-label">Scenes</span>
                  </div>
                  <div class="character-studio-stat">
                    <span class="character-studio-stat-value" data-character-stat="dialogue">${escapeHtml(String(statsDialogue))}</span>
                    <span class="character-studio-stat-label">Dialogue Lines</span>
                  </div>
                  <div class="character-studio-stat">
                    <span class="character-studio-stat-value" data-character-stat="screenTime">${escapeHtml(String(statsScreenTime))}</span>
                    <span class="character-studio-stat-label">Estimated Minutes</span>
                  </div>
                </div>
                <div class="character-studio-two-col">
                  <label class="character-studio-field">
                    <span>Total scenes</span>
                    <input type="number" min="0" value="${escapeHtml(String(statsScenes))}" data-character-field="stats.scenes" />
                  </label>
                  <label class="character-studio-field">
                    <span>Dialogue lines</span>
                    <input type="number" min="0" value="${escapeHtml(String(statsDialogue))}" data-character-field="stats.dialogue"/>
                  </label>
                  <label class="character-studio-field">
                    <span>Screen time (minutes)</span>
                    <input type="number" min="0" step="0.1" value="${escapeHtml(String(statsScreenTime))}" data-character-field="stats.screenTime" />
                  </label>
                </div>
              </section>
              <section class="character-studio-section" role="tabpanel" tabindex="0" id="character-panel-traits" aria-labelledby="character-tab-traits" data-tab-panel="traits"${panelAttributes('traits')}>
                <h3>Traits &amp; Personality</h3>
                <p class="muted-text">List defining qualities, habits, and secrets.</p>
                <div class="character-studio-traits-preview" data-traits-preview>${traitsPreview}</div>
                <label class="character-studio-field">
                  <span>Traits (one per line)</span>
                  <textarea data-character-field="traits" placeholder="Resilient&#10;Impulsive&#10;Secret romantic">${escapeHtml(traitsText)}</textarea>
                </label>
              </section>
              <section class="character-studio-section" role="tabpanel" tabindex="0" id="character-panel-background" aria-labelledby="character-tab-background" data-tab-panel="background"${panelAttributes('background')}>
                <h3>Background &amp; Family</h3>
                <div class="character-studio-two-col">
                  <label class="character-studio-field">
                    <span>Background story</span>
                    <textarea data-character-field="background" placeholder="Origin story, formative experiences">${escapeHtml(active.background || '')}</textarea>
                  </label>
                  <label class="character-studio-field">
                    <span>Family tree / relationships</span>
                    <textarea data-character-field="familyTree" placeholder="Parents, siblings, key relationships">${escapeHtml(active.familyTree || '')}</textarea>
                  </label>
                </div>
              </section>
              <section class="character-studio-section" role="tabpanel" tabindex="0" id="character-panel-arc" aria-labelledby="character-tab-arc" data-tab-panel="arc"${panelAttributes('arc')}>
                <h3>Character Arc</h3>
                <p class="muted-text">Map how the character transforms across the story.</p>
                <div class="character-studio-two-col">
                  <label class="character-studio-field">
                    <span>Setup</span>
                    <textarea data-character-field="arc.setup" placeholder="Who are they at the beginning?">${escapeHtml(active.arc?.setup || '')}</textarea>
                  </label>
                  <label class="character-studio-field">
                    <span>Development</span>
                    <textarea data-character-field="arc.development" placeholder="Challenges, midpoint, reversals">${escapeHtml(active.arc?.development || '')}</textarea>
                  </label>
                  <label class="character-studio-field">
                    <span>Resolution</span>
                    <textarea data-character-field="arc.resolution" placeholder="Where do they end up?">${escapeHtml(active.arc?.resolution || '')}</textarea>
                  </label>
                </div>
              </section>
              <section class="character-studio-section" role="tabpanel" tabindex="0" id="character-panel-lookbook" aria-labelledby="character-tab-lookbook" data-tab-panel="lookbook"${panelAttributes('lookbook')}>
                <h3>Lookbook</h3>
                <p class="muted-text">Collect portrait, turnaround, and expression references.</p>
                <div class="character-studio-two-col">
                  <label class="character-studio-field">
                    <span>Portrait URL</span>
                    <input type="url" data-character-field="looks.portrait" value="${escapeHtml(portraitUrl)}" placeholder="https://..." />
                  </label>
                  <label class="character-studio-field">
                    <span>Turnarounds (one per line)</span>
                    <textarea data-character-field="looks.turnarounds" class="small" placeholder="Link to turnaround sheets">${escapeHtml(turnaroundsText)}</textarea>
                  </label>
                  <label class="character-studio-field">
                    <span>Expression sheets (one per line)</span>
                    <textarea data-character-field="looks.expressions" class="small" placeholder="Link to expressions">${escapeHtml(expressionsText)}</textarea>
                  </label>
                </div>
                <div class="character-studio-look-grid">
                  <div class="character-studio-look-card" data-look-preview="portrait">
                    <span class="character-studio-look-label">Portrait</span>
                    <div data-look-content>
                      ${characterLookPreviewMarkup('portrait', portraitUrl, active)}
                    </div>
                  </div>
                  <div class="character-studio-look-card" data-look-preview="turnaround">
                    <span class="character-studio-look-label">Turnaround</span>
                    <div data-look-content>
                      ${characterLookPreviewMarkup('turnaround', turnaroundPreview, active)}
                    </div>
                  </div>
                  <div class="character-studio-look-card" data-look-preview="expression">
                    <span class="character-studio-look-label">Expressions</span>
                    <div data-look-content>
                      ${characterLookPreviewMarkup('expression', expressionPreview, active)}
                    </div>
                  </div>
                </div>
              </section>
              <section class="character-studio-section" role="tabpanel" tabindex="0" id="character-panel-ai" aria-labelledby="character-tab-ai" data-tab-panel="ai"${panelAttributes('ai')}>
                <h3>AI Concepting</h3>
                <p class="muted-text">Draft prompts for StudioOrganize AI or export for other tools.</p>
                <label class="character-studio-field">
                  <span>AI prompt</span>
                  <textarea data-character-field="ai.prompt" placeholder="Describe the character's look, vibe, and scene">${escapeHtml(aiPrompt)}</textarea>
                </label>
                <label class="character-studio-field">
                  <span>Notes / references</span>
                  <textarea data-character-field="ai.notes" class="small" placeholder="Shot list, wardrobe callouts, artist references">${escapeHtml(aiNotes)}</textarea>
                </label>
                <div class="character-studio-ai-actions">
                  <button type="button" data-character-ai-generate>Save prompt &amp; prep AI render</button>
                  <span class="character-studio-status" data-ai-status></span>
                </div>
              </section>
            </div>
          </div>
        `;

        setupCharacterTabs(container);
        bindCharacterStudioFields(container, active);
        updateTimelineCharacterMeta();
        updateTimelineHighlights();
      }

      function refreshCharacterMeta(character){
        const heading = document.querySelector('[data-character-heading]');
        if (heading) heading.textContent = character?.name ? character.name : 'Untitled Character';
        const subheading = document.querySelector('[data-character-subheading]');
        if (subheading){
          const text = buildCharacterSubheading(character);
          subheading.textContent = text || 'Add role, pronouns, or age details.';
        }
        updateTimelineCharacterMeta();
        updateTimelineHighlights();
      }

      function refreshTraitsPreview(character){
        const preview = document.querySelector('[data-traits-preview]');
        if (preview) preview.innerHTML = buildTraitsPreviewMarkup(character);
      }

      function updateLookPreview(kind, character){
        const slot = document.querySelector(`[data-look-preview="${kind}"]`);
        if (!slot) return;
        let url = '';
        if (kind === 'portrait') url = (character?.looks?.portrait || '').trim();
        else if (kind === 'turnaround') url = Array.isArray(character?.looks?.turnarounds) ? character.looks.turnarounds[0] || '' : '';
        else if (kind === 'expression') url = Array.isArray(character?.looks?.expressions) ? character.looks.expressions[0] || '' : '';
        const content = slot.querySelector('[data-look-content]');
        if (content) content.innerHTML = characterLookPreviewMarkup(kind, url, character);
        if (kind === 'portrait'){
          const profileSlot = document.querySelector('[data-profile-portrait]');
          if (profileSlot) profileSlot.innerHTML = characterLookPreviewMarkup('portrait', url, character);
        }
      }

      function setupCharacterTabs(container){
        if (!container) return;
        const tablist = container.querySelector('[data-character-tablist]');
        if (!tablist) return;
        const buttons = Array.from(tablist.querySelectorAll('[data-tab-id]'));
        const panels = Array.from(container.querySelectorAll('[data-tab-panel]'));
        if (!buttons.length || !panels.length) return;

        const tabIds = buttons.map(btn => btn.getAttribute('data-tab-id'));
        if (!tabIds.includes(state.activeTabId)){
          state.activeTabId = tabIds[0];
        }

        const activate = (id, { focus } = { focus: true }) => {
          if (!tabIds.includes(id)) id = tabIds[0];
          state.activeTabId = id;
          buttons.forEach(btn => {
            const tabId = btn.getAttribute('data-tab-id');
            const isActive = tabId === id;
            btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
            btn.tabIndex = isActive ? 0 : -1;
            if (isActive && focus) btn.focus();
          });
          panels.forEach(panel => {
            const panelId = panel.getAttribute('data-tab-panel');
            const isActive = panelId === id;
            panel.hidden = !isActive;
            panel.setAttribute('aria-hidden', isActive ? 'false' : 'true');
          });
        };

        buttons.forEach((btn, index) => {
          const tabId = btn.getAttribute('data-tab-id');
          btn.addEventListener('click', () => activate(tabId, { focus: false }));
          btn.addEventListener('keydown', event => {
            if (!['ArrowRight', 'ArrowDown', 'ArrowLeft', 'ArrowUp', 'Home', 'End'].includes(event.key)) return;
            event.preventDefault();
            let targetIndex = index;
            if (event.key === 'ArrowRight' || event.key === 'ArrowDown'){
              targetIndex = (index + 1) % buttons.length;
            } else if (event.key === 'ArrowLeft' || event.key === 'ArrowUp'){
              targetIndex = (index - 1 + buttons.length) % buttons.length;
            } else if (event.key === 'Home'){
              targetIndex = 0;
            } else if (event.key === 'End'){
              targetIndex = buttons.length - 1;
            }
            activate(buttons[targetIndex].getAttribute('data-tab-id'));
          });
        });

        activate(state.activeTabId, { focus: false });
      }

      function bindCharacterStudioFields(container, active){
        if (!container || !active) return;
        const id = active.id;
        const aiStatus = container.querySelector('[data-ai-status]');
        const clearAiStatus = () => {
          if (aiStatus){
            aiStatus.textContent = '';
            aiStatus.removeAttribute('data-state');
          }
        };

        const nameInput = container.querySelector('[data-character-field="name"]');
        if (nameInput){
          nameInput.addEventListener('input', e => {
            updateCharacterField(id, 'name', e.target.value);
            renderCharacterList();
            refreshCharacterMeta(active);
            updateLookPreview('portrait', active);
            updateLookPreview('turnaround', active);
            updateLookPreview('expression', active);
          });
        }

        const roleInput = container.querySelector('[data-character-field="role"]');
        if (roleInput){
          roleInput.addEventListener('input', e => {
            updateCharacterField(id, 'role', e.target.value);
            renderCharacterList();
            refreshCharacterMeta(active);
          });
        }

        const archetypeInput = container.querySelector('[data-character-field="archetype"]');
        if (archetypeInput){
          archetypeInput.addEventListener('input', e => {
            updateCharacterField(id, 'archetype', e.target.value);
            renderCharacterList();
            refreshCharacterMeta(active);
          });
        }

        const pronounsInput = container.querySelector('[data-character-field="pronouns"]');
        if (pronounsInput){
          pronounsInput.addEventListener('input', e => {
            updateCharacterField(id, 'pronouns', e.target.value);
            renderCharacterList();
            refreshCharacterMeta(active);
          });
        }

        const ageInput = container.querySelector('[data-character-field="age"]');
        if (ageInput){
          ageInput.addEventListener('input', e => {
            updateCharacterField(id, 'age', e.target.value);
            renderCharacterList();
            refreshCharacterMeta(active);
          });
        }

        const summaryInput = container.querySelector('[data-character-field="summary"]');
        if (summaryInput){
          summaryInput.addEventListener('input', e => {
            updateCharacterField(id, 'summary', e.target.value);
          });
        }

        const statsScenesInput = container.querySelector('[data-character-field="stats.scenes"]');
        if (statsScenesInput){
          statsScenesInput.addEventListener('input', e => {
            const value = parseIntegerInput(e.target.value);
            updateCharacterField(id, 'stats.scenes', value);
            const display = container.querySelector('[data-character-stat="scenes"]');
            if (display) display.textContent = value;
          });
        }

        const statsDialogueInput = container.querySelector('[data-character-field="stats.dialogue"]');
        if (statsDialogueInput){
          statsDialogueInput.addEventListener('input', e => {
            const value = parseIntegerInput(e.target.value);
            updateCharacterField(id, 'stats.dialogue', value);
            const display = container.querySelector('[data-character-stat="dialogue"]');
            if (display) display.textContent = value;
          });
        }

        const statsScreenTimeInput = container.querySelector('[data-character-field="stats.screenTime"]');
        if (statsScreenTimeInput){
          statsScreenTimeInput.addEventListener('input', e => {
            const value = parseFloatInput(e.target.value);
            updateCharacterField(id, 'stats.screenTime', value);
            const display = container.querySelector('[data-character-stat="screenTime"]');
            if (display) display.textContent = value;
          });
        }

        const traitsInput = container.querySelector('[data-character-field="traits"]');
        if (traitsInput){
          traitsInput.addEventListener('input', e => {
            const list = normalizeList(e.target.value);
            updateCharacterField(id, 'traits', list);
            refreshTraitsPreview(active);
          });
        }

        const backgroundInput = container.querySelector('[data-character-field="background"]');
        if (backgroundInput){
          backgroundInput.addEventListener('input', e => {
            updateCharacterField(id, 'background', e.target.value);
          });
        }

        const familyInput = container.querySelector('[data-character-field="familyTree"]');
        if (familyInput){
          familyInput.addEventListener('input', e => {
            updateCharacterField(id, 'familyTree', e.target.value);
          });
        }

        const arcSetupInput = container.querySelector('[data-character-field="arc.setup"]');
        if (arcSetupInput){
          arcSetupInput.addEventListener('input', e => {
            updateCharacterField(id, 'arc.setup', e.target.value);
          });
        }

        const arcDevInput = container.querySelector('[data-character-field="arc.development"]');
        if (arcDevInput){
          arcDevInput.addEventListener('input', e => {
            updateCharacterField(id, 'arc.development', e.target.value);
          });
        }

        const arcResolutionInput = container.querySelector('[data-character-field="arc.resolution"]');
        if (arcResolutionInput){
          arcResolutionInput.addEventListener('input', e => {
            updateCharacterField(id, 'arc.resolution', e.target.value);
          });
        }

        const portraitInput = container.querySelector('[data-character-field="looks.portrait"]');
        if (portraitInput){
          portraitInput.addEventListener('input', e => {
            const value = e.target.value.trim();
            updateCharacterField(id, 'looks.portrait', value);
            updateLookPreview('portrait', active);
          });
        }

        const turnaroundsInput = container.querySelector('[data-character-field="looks.turnarounds"]');
        if (turnaroundsInput){
          turnaroundsInput.addEventListener('input', e => {
            const list = normalizeList(e.target.value);
            updateCharacterField(id, 'looks.turnarounds', list);
            updateLookPreview('turnaround', active);
          });
        }

        const expressionsInput = container.querySelector('[data-character-field="looks.expressions"]');
        if (expressionsInput){
          expressionsInput.addEventListener('input', e => {
            const list = normalizeList(e.target.value);
            updateCharacterField(id, 'looks.expressions', list);
            updateLookPreview('expression', active);
          });
        }

        const aiPromptInput = container.querySelector('[data-character-field="ai.prompt"]');
        if (aiPromptInput){
          aiPromptInput.addEventListener('input', e => {
            updateCharacterField(id, 'ai.prompt', e.target.value);
            clearAiStatus();
          });
        }

        const aiNotesInput = container.querySelector('[data-character-field="ai.notes"]');
        if (aiNotesInput){
          aiNotesInput.addEventListener('input', e => {
            updateCharacterField(id, 'ai.notes', e.target.value);
            clearAiStatus();
          });
        }

        const aiButton = container.querySelector('[data-character-ai-generate]');
        if (aiButton){
          aiButton.addEventListener('click', () => {
            const prompt = (active.ai?.prompt || '').trim();
            if (!prompt){
              if (aiStatus){
                aiStatus.textContent = 'Add an AI prompt to generate concept art.';
                aiStatus.dataset.state = 'warning';
              }
              return;
            }
            if (aiStatus){
              aiStatus.textContent = 'Prompt saved! Connect to StudioOrganize AI to generate character images.';
              aiStatus.dataset.state = 'ready';
            }
          });
        }

        const deleteBtn = container.querySelector('[data-character-delete]');
        if (deleteBtn){
          deleteBtn.addEventListener('click', () => {
            const name = active.name || 'this character';
            const ok = window.confirm(`Delete ${name}? This will remove their notes and stats.`);
            if (!ok) return;
            const index = state.characters.findIndex(c => c.id === id);
            if (index !== -1) state.characters.splice(index, 1);
            if (state.characters.length){
              state.activeId = state.characters[0].id;
            } else {
              state.activeId = null;
            }
            markDirty();
            renderCharacterList();
            renderCharacterDetails();
          });
        }
      }

      async function waitForSupabaseClient(timeoutMs = 6000){
        if (window.supabaseClient) return window.supabaseClient;
        const start = Date.now();
        while (Date.now() - start < timeoutMs){
          await new Promise(resolve => setTimeout(resolve, 50));
          if (window.supabaseClient) return window.supabaseClient;
        }
        return window.supabaseClient || null;
      }

      async function fetchSupabaseSession(client){
        try {
          const { data, error } = await client.auth.getSession();
          if (error) throw error;
          return data?.session ?? null;
        } catch (err){
          console.error('Character Studio failed to fetch Supabase session', err);
          return null;
        }
      }

      async function loadProjectMetadata(){
        if (!state.supabase || !state.projectId || !state.ownerId) return;
        try {
          const filters = [`id.eq.${state.projectId}`, `project_id.eq.${state.projectId}`, `script_id.eq.${state.projectId}`];
          const { data, error } = await state.supabase
            .from('project_data')
            .select('id, project_id, script_id, script_name, name, title, description, updated_at')
            .or(filters.join(','))
            .order('updated_at', { ascending: false })
            .limit(1)
            .maybeSingle();
          if (error) throw error;
          if (data){
            const label = data.script_name || data.name || data.title || 'Untitled Story';
            setProjectLabel(`Story: ${label}`, 'ready');
            return;
          }
        } catch (err){
          console.warn('Character Studio project metadata fetch failed:', err);
        }
        const fallback = state.projectId ? `Story ID: ${state.projectId.slice(0, 8).toUpperCase()}` : 'No story selected';
        setProjectLabel(fallback, state.projectId ? '' : 'warning');
      }

      async function loadCharactersFromSupabase(){
        if (!state.supabase || !state.projectId || !state.ownerId){
          state.loading = false;
          renderCharacterList();
          renderCharacterDetails();
          updateSaveButtonState();
          return;
        }
        state.loading = true;
        renderCharacterList();
        renderCharacterDetails();
        updateSaveButtonState();
        setSaveStatus('Loading characters‚Ä¶', 'saving');
        try {
          const { data, error } = await state.supabase
            .from('characters')
            .select('id, name, role, archetype, pronouns, age, summary, background, family_tree, traits, stats_scenes, stats_dialogue, stats_screen_time, arc_setup, arc_development, arc_resolution, look_portrait_url, look_turnaround_urls, look_expression_urls, ai_prompt, ai_notes, created_at')
            .eq('project_id', state.projectId)
            .order('created_at', { ascending: true });
          if (error) throw error;
          const list = Array.isArray(data) ? data.map(supabaseRowToCharacter) : [];
          state.characters = list;
          state.activeId = list.length ? list[0].id : null;
          state.remoteIds = new Set(list.map(char => char.id));
          state.dirty = false;
          await persistCharactersToLocal();
          if (list.length){
            setSaveStatus('Characters synced.', 'ready');
          } else {
            setSaveStatus('No characters saved yet for this story.', 'warning');
          }
        } catch (err){
          console.error('Failed to load characters from Supabase', err);
          setSaveStatus('Unable to load characters from Supabase.', 'error');
        } finally {
          state.loading = false;
          renderCharacterList();
          renderCharacterDetails();
          updateSaveButtonState();
        }
      }

      async function handleSession(session){
        state.session = session;
        const ownerId = session?.user?.id || null;
        const previousOwner = state.ownerId;
        state.ownerId = ownerId;
        updateSaveButtonState();
        if (!ownerId){
          state.remoteIds = new Set();
          state.characters = [];
          state.activeId = null;
          state.dirty = false;
          state.loading = false;
          renderCharacterList();
          renderCharacterDetails();
          if (state.projectId){
            setSaveStatus('Sign in to load and save your cast.', 'warning');
          }
          return;
        }
        if (!state.projectId){
          state.loading = false;
          renderCharacterList();
          renderCharacterDetails();
          setSaveStatus('Open your story in the Writer to link characters.', 'warning');
          return;
        }
        if (previousOwner !== ownerId){
          state.remoteIds = new Set();
        }
        await Promise.all([loadProjectMetadata(), loadCharactersFromSupabase()]);
      }

      async function handleSaveClick(){
        if (state.saving) return;
        if (!state.supabase){
          setSaveStatus('Supabase is still initializing. Please try again.', 'warning');
          return;
        }
        if (!state.session || !state.ownerId){
          setSaveStatus('Sign in to save your cast.', 'warning');
          return;
        }
        if (!state.projectId){
          setSaveStatus('Open your story in the Writer to link characters.', 'warning');
          return;
        }
        if (!state.dirty){
          setSaveStatus('Everything is up to date.', 'ready');
          return;
        }
        state.saving = true;
        updateSaveButtonState();
        setSaveStatus('Saving‚Ä¶', 'saving');
        try {
          const rows = state.characters.map(characterToSupabaseRow);
          if (rows.length){
            const { error } = await state.supabase
              .from('characters')
              .upsert(rows, { onConflict: 'id' });
            if (error) throw error;
          }
          const localIds = new Set(rows.map(row => row.id));
          const remoteIds = Array.from(state.remoteIds || []);
          const idsToDelete = remoteIds.filter(id => !localIds.has(id));
          if (idsToDelete.length){
            const { error: deleteError } = await state.supabase
              .from('characters')
              .delete()
              .in('id', idsToDelete);
            if (deleteError) throw deleteError;
          }
          state.remoteIds = localIds;
          state.dirty = false;
          await persistCharactersToLocal();
          setSaveStatus('Characters saved!', 'ready');
        } catch (err){
          console.error('Failed to save characters to Supabase', err);
          setSaveStatus('Save failed. Please try again.', 'error');
        } finally {
          state.saving = false;
          updateSaveButtonState();
        }
      }

      async function initializeSupabase(){
        if (!state.projectId){
          setProjectLabel('No story selected ‚Äî open the Writer to choose a story.', 'warning');
          state.loading = false;
          renderCharacterList();
          renderCharacterDetails();
          updateSaveButtonState();
          return;
        }
        const supabase = await waitForSupabaseClient();
        if (!supabase){
          state.loading = false;
          setSaveStatus('Supabase is unavailable. Reload to try again.', 'error');
          renderCharacterList();
          renderCharacterDetails();
          updateSaveButtonState();
          return;
        }
        state.supabase = supabase;
        updateSaveButtonState();
        const session = await fetchSupabaseSession(supabase);
        await handleSession(session);
        supabase.auth.onAuthStateChange((event, nextSession) => {
          if (event === 'TOKEN_REFRESHED'){
            state.session = nextSession;
            state.ownerId = nextSession?.user?.id || null;
            updateSaveButtonState();
            return;
          }
          handleSession(nextSession).catch(err => console.error('Character Studio auth change failed', err));
        });
      }

      function addCharacter(){
        const newCharacter = createCharacterData('New Character');
        state.characters.push(newCharacter);
        state.activeId = newCharacter.id;
        markDirty();
        renderCharacterList();
        renderCharacterDetails();
        window.requestAnimationFrame(() => {
          const input = document.querySelector('[data-character-field="name"]');
          if (input){
            input.focus();
            input.select();
          }
        });
      }

      const addButton = document.getElementById('characterStudioAddBtn');
      if (addButton){
        addButton.addEventListener('click', addCharacter);
      }

      const saveButton = document.getElementById('characterStudioSaveBtn');
      if (saveButton){
        saveButton.addEventListener('click', () => { handleSaveClick(); });
      }

      const initialProjectLabel = state.projectId
        ? `Story ID: ${state.projectId.slice(0, 8).toUpperCase()}`
        : 'No story selected ‚Äî open the Writer to choose a story.';
      setProjectLabel(initialProjectLabel, state.projectId ? '' : 'warning');
      setSaveStatus('', '');

      renderCharacterList();
      renderCharacterDetails();
      updateSaveButtonState();
      hydrateCharactersFromLocal();
      initializeSupabase();
    })();
  </script>
  <script>document.getElementById('y').textContent = new Date().getFullYear();</script>
  <script type="module" src="/assets/main.js"></script>
</body>
</html>
