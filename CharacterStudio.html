<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Character Studio ‚Äî StudioOrganize</title>
  <meta
    name="description"
    content="Character Studio keeps every character's profile, arc, lookbook, and AI prompt in one dedicated workspace."
  />
  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="icon" type="image/webp" href="/assets/img/studioorganizeFavicon.webp" />
</head>
<body>
  <header class="nav">
    <div class="brand-with-logo">
      <a class="brand" href="/">StudioOrganize</a>
      <span class="brand-with-logo__badge brand-with-logo__badge--character" aria-hidden="true">CS</span>
    </div>
    <nav class="menu">
      <a class="menu__link menu__link--plain menu__link--icon" href="/">
        <span aria-hidden="true">üè†</span>
        <span class="sr-only">Home</span>
      </a>
      <div class="dropdown">
        <button class="dropbtn dropbtn--plain" type="button">Use Cases</button>
        <div class="dropdown-content">
          <a href="/use-cases/">All Use Cases</a>
          <a href="/use-cases/generate-ideas.html">Generate Ideas</a>
          <a href="/use-cases/screenplay.html">Screenplay Script</a>
          <a href="/use-cases/character-design.html">Character Design</a>
          <a href="/use-cases/set-design.html">Set / Production Design</a>
        </div>
      </div>
      <a class="menu__link menu__link--plain" href="https://finishthatstory.com" target="_blank" rel="noopener noreferrer">FinishThatStory.com</a>
      <div class="menu__actions">
        <button class="theme-toggle theme-toggle--icon" type="button" data-theme-toggle aria-pressed="false">
          <span class="sr-only">Toggle theme</span>
          <span class="theme-toggle__icon" aria-hidden="true" data-theme-icon>‚òÄÔ∏è</span>
        </button>
        <a class="menu__cta" href="https://studioorganize.com/supabase-test.html" data-auth-link>Sign up / Log in</a>
        <div class="dropdown" data-account-menu hidden>
          <button class="menu__cta" type="button" data-account-button>Account</button>
          <div class="dropdown-content">
            <a href="/account.html">My Creator Page</a>
            <a href="/product/personal.html">My Subscription</a>
            <a href="#" data-account-logout>Log out</a>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main class="section">
    <style>
      html, body { height: 100%; font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial; }
      body {
        color: var(--ink);
        background: radial-gradient(circle at top right, rgba(123, 97, 255, 0.1), transparent 35%), var(--surface);
        --nav-height: 72px;
      }
      main.section { flex: 1; display: flex; flex-direction: column; width: 100%; max-width: none; padding: 0; margin: 0; }
      .character-studio-app { flex: 1; display: flex; flex-direction: column; min-height: 0; padding: clamp(18px, 4vw, 32px); gap: 24px; }
      .character-studio-window {
        position: relative;
        width: 100%;
        min-height: 0;
        background: var(--panel);
        border: 1px solid var(--ring);
        border-radius: 24px;
        box-shadow: 0 36px 110px rgba(0, 0, 0, 0.35);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .character-studio-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 18px;
        padding: 26px 30px;
        border-bottom: 1px solid var(--ring);
        background: var(--chip);
      }
      .brand-with-logo__badge--character {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        letter-spacing: .6px;
        background: linear-gradient(135deg, #7c3aed, #22d3ee);
        color: white;
        box-shadow: 0 8px 24px rgba(124, 58, 237, 0.35);
      }
      .character-studio-header h2 { margin: 0; font-size: 24px; font-weight: 600; }
      .character-studio-header .muted-text { margin: 6px 0 0; max-width: 60ch; font-size: 14px; }
      .character-studio-header-actions { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: flex-end; }
      .character-studio-tabs { display: flex; flex-direction: column; gap: 18px; }
      .character-studio-tablist { display: flex; flex-wrap: wrap; gap: 8px; padding: 8px; border-radius: 14px; background: var(--card); border: 1px solid var(--ring); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04); overflow-x: auto; }
      .character-studio-tablist::-webkit-scrollbar { height: 6px; }
      .character-studio-tab-button {
        appearance: none;
        border: 1px solid transparent;
        border-radius: 999px;
        background: transparent;
        color: var(--muted);
        font: inherit;
        font-size: 13px;
        padding: 8px 16px;
        cursor: pointer;
        transition: background .2s ease, color .2s ease, box-shadow .2s ease, transform .2s ease;
      }
      .character-studio-tab-button:hover { color: var(--ink); }
      .character-studio-tab-button[aria-selected="true"] {
        background: var(--acc);
        color: var(--active-tab-text);
        box-shadow: 0 14px 36px rgba(62, 114, 255, 0.28);
        border-color: var(--acc);
        transform: translateY(-1px);
      }
      .character-studio-tab-button:focus-visible {
        outline: none;
        box-shadow: 0 0 0 2px rgba(79, 123, 255, 0.45);
      }
      .character-studio-tabpanels { position: relative; }
      .character-studio-header-badge {
        font-size: 11px;
        letter-spacing: .3px;
        text-transform: uppercase;
        background: rgba(123, 97, 255, 0.16);
        border: 1px solid rgba(123, 97, 255, 0.35);
        color: var(--ink);
        border-radius: 999px;
        padding: 6px 12px;
        font-weight: 600;
      }
      .character-studio-add {
        background: var(--acc);
        border: 1px solid var(--acc);
        color: var(--active-tab-text);
        border-radius: 999px;
        padding: 8px 18px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: transform .2s ease, box-shadow .2s ease;
      }
      .character-studio-add:hover { box-shadow: 0 14px 32px rgba(79, 123, 255, 0.25); transform: translateY(-1px); }
      .character-studio-add:focus-visible { outline: none; box-shadow: 0 0 0 2px rgba(79,123,255,0.25); }
      .character-studio-body { padding: 26px 30px 32px; flex: 1; overflow: hidden; }
      .character-studio-layout { display: grid; grid-template-columns: 300px 1fr; gap: 24px; height: 100%; min-height: 0; }
      .character-studio-sidebar { display: flex; flex-direction: column; gap: 16px; min-height: 0; }
      .character-studio-sidebar-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
      .character-studio-sidebar h3 { margin: 0; font-size: 12px; letter-spacing: .4px; text-transform: uppercase; color: var(--muted); }
      .character-studio-sidebar-note { font-size: 12px; color: var(--muted); line-height: 1.45; }
      .character-studio-sidebar-list { display: flex; flex-direction: column; gap: 10px; overflow: auto; padding-right: 4px; min-height: 0; }
      .character-studio-list-item {
        background: var(--card);
        border: 1px solid var(--ring);
        border-radius: 14px;
        padding: 12px 14px;
        text-align: left;
        display: flex;
        flex-direction: column;
        gap: 6px;
        cursor: pointer;
        color: inherit;
        font: inherit;
        transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease;
      }
      .character-studio-list-item strong { font-size: 14px; font-weight: 600; }
      .character-studio-list-item span { font-size: 11px; color: var(--muted); letter-spacing: .3px; text-transform: uppercase; }
      .character-studio-list-item:hover { border-color: var(--acc); box-shadow: 0 18px 48px rgba(47, 110, 255, 0.18); transform: translateY(-1px); }
      .character-studio-list-item.active { border-color: var(--acc); box-shadow: 0 18px 48px rgba(47, 110, 255, 0.28); background: var(--acc); color: var(--active-tab-text); }
      .character-studio-list-item.active span { color: var(--active-tab-text); opacity: 0.85; }
      .character-studio-details { display: flex; flex-direction: column; gap: 20px; min-height: 0; overflow: auto; padding-right: 6px; }
      .character-studio-detail-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 18px; flex-wrap: wrap; }
      .character-studio-detail-header h2 { margin: 0; font-size: 26px; font-weight: 600; }
      .character-studio-detail-header .muted-text { margin: 6px 0 0; font-size: 13px; }
      .character-studio-tertiary {
        background: none;
        border: 1px solid var(--ring);
        border-radius: 12px;
        padding: 6px 14px;
        font-size: 12px;
        cursor: pointer;
        color: var(--muted);
      }
      .character-studio-tertiary:hover { border-color: var(--acc); color: var(--ink); }
      .character-studio-section {
        background: var(--card);
        border: 1px solid var(--ring);
        border-radius: 18px;
        padding: 22px 24px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }
      .character-studio-section[hidden] { display: none; }
      .character-studio-section h3 { margin: 0; font-size: 14px; font-weight: 600; }
      .character-studio-section p { margin: 0; }
      .character-studio-two-col { display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
      .character-studio-field { display: flex; flex-direction: column; gap: 6px; font-size: 13px; }
      .character-studio-field span { font-size: 11px; color: var(--muted); letter-spacing: .3px; text-transform: uppercase; }
      .character-studio-field input,
      .character-studio-field textarea {
        background: var(--field);
        color: var(--ink);
        border: 1px solid var(--ring);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 14px;
        width: 100%;
      }
      .character-studio-field textarea { min-height: 108px; resize: vertical; }
      .character-studio-field textarea.small { min-height: 78px; }
      .character-studio-stats-grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
      .character-studio-stat { background: var(--chip); border: 1px solid var(--ring); border-radius: 16px; padding: 16px; display: flex; flex-direction: column; gap: 6px; }
      .character-studio-stat-value { font-size: 22px; font-weight: 700; }
      .character-studio-stat-label { font-size: 11px; color: var(--muted); letter-spacing: .3px; text-transform: uppercase; }
      .character-studio-traits-preview { display: flex; flex-wrap: wrap; gap: 8px; min-height: 36px; align-items: flex-start; }
      .character-studio-chip { background: var(--chip); border: 1px solid var(--ring); border-radius: 999px; padding: 4px 10px; font-size: 12px; }
      .character-studio-look-grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
      .character-studio-look-card { position: relative; border: 1px solid var(--ring); border-radius: 16px; overflow: hidden; background: var(--chip); aspect-ratio: 4 / 3; display: flex; align-items: center; justify-content: center; text-align: center; }
      .character-studio-look-card [data-look-content] { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
      .character-studio-look-card img { width: 100%; height: 100%; object-fit: cover; }
      .character-studio-look-empty { padding: 0 16px; font-size: 12px; color: var(--muted); line-height: 1.45; }
      .character-studio-look-label { position: absolute; top: 10px; left: 10px; padding: 4px 8px; border-radius: 999px; font-size: 11px; text-transform: uppercase; letter-spacing: .3px; background: rgba(15, 18, 30, 0.65); color: #fff; }
      .character-studio-ai-actions { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
      .character-studio-ai-actions button { background: var(--acc); border: 1px solid var(--acc); color: var(--active-tab-text); border-radius: 999px; padding: 10px 18px; font-weight: 600; cursor: pointer; }
      .character-studio-status { font-size: 12px; color: var(--muted); min-height: 18px; }
      .character-studio-status[data-state="ready"] { color: var(--acc); }
      .character-studio-status[data-state="warning"] { color: #f97316; }
      .character-studio-empty,
      .character-studio-empty-list {
        border: 1px dashed var(--ring);
        border-radius: 16px;
        padding: 28px;
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 10px;
        color: var(--muted);
        align-items: center;
        justify-content: center;
      }
      .character-studio-empty h2 { margin: 0; font-size: 22px; color: var(--ink); }
      .character-studio-empty p { margin: 0; font-size: 14px; }
      .muted-text { color: var(--muted); font-size: 12px; }
      @media (max-width: 1100px) {
        .character-studio-layout { grid-template-columns: 260px 1fr; }
      }
      @media (max-width: 920px) {
        .character-studio-body { padding: 22px 20px 26px; }
        .character-studio-layout { grid-template-columns: 1fr; }
        .character-studio-sidebar { order: 2; }
        .character-studio-details { order: 1; }
      }
      @media (max-width: 640px) {
        .character-studio-app { padding: 16px 12px; }
        .character-studio-header { flex-direction: column; align-items: flex-start; }
        .character-studio-header-actions { width: 100%; justify-content: space-between; }
      }
    </style>

    <div class="character-studio-app">
      <div class="character-studio-window">
        <div class="character-studio-header">
          <div>
            <h2>Character Studio</h2>
            <p class="muted-text">Craft multidimensional characters with dedicated planners, lookbooks, and AI prompts.</p>
          </div>
          <div class="character-studio-header-actions">
            <span class="character-studio-header-badge">Cast</span>
            <button class="character-studio-add" type="button" id="characterStudioAddBtn">+ New</button>
          </div>
        </div>
        <div class="character-studio-body">
          <div class="character-studio-layout">
            <aside class="character-studio-sidebar">
              <div class="character-studio-sidebar-header">
                <h3>Characters</h3>
              </div>
              <p class="character-studio-sidebar-note">Keep track of stats, arcs, and visual references for every character in one place.</p>
              <div class="character-studio-sidebar-list" data-character-list></div>
            </aside>
            <section class="character-studio-details" data-character-details></section>
          </div>
        </div>
      </div>
      <section class="feature-section">
        <h2>Bring dimension to every member of your cast.</h2>
        <div class="feature-grid">
          <div class="feature-card">
            <h3>Structured character dossiers</h3>
            <p>Capture profiles, backstory, and evolving arcs without jumping between docs.</p>
          </div>
          <div class="feature-card">
            <h3>Visual continuity built-in</h3>
            <p>Collect portrait, turnaround, and expression sheets alongside production stats.</p>
          </div>
          <div class="feature-card">
            <h3>AI concepting ready</h3>
            <p>Draft prompts, reference notes, and feed everything directly into StudioOrganize AI.</p>
          </div>
          <div class="feature-card">
            <h3>Save and share</h3>
            <p>Export details for collaborators or sync with your StudioOrganize project workspace.</p>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="footer">
    <div class="footer__grid">
      <div>
        <strong>StudioOrganize</strong>
        <p class="muted">Tools for storytellers &amp; focused work.</p>
      </div>
      <div>
        <a href="/about.html">About</a><br />
      </div>
      <div>
        <a href="mailto:support@studioorganize.com">support@studioorganize.com</a><br />
        <span class="muted">¬© <span id="y"></span> StudioOrganize</span>
      </div>
    </div>
  </footer>

  <script>
    (function(){
      const CHARACTER_LOOK_LABELS = {
        portrait: 'Portrait',
        turnaround: 'Turnaround Sheet',
        expression: 'Expression Sheet'
      };

      const CHARACTER_TAB_CONFIG = [
        { id: 'profile', label: 'Profile' },
        { id: 'stats', label: 'Stats & Spotlight' },
        { id: 'traits', label: 'Traits & Personality' },
        { id: 'background', label: 'Background & Family' },
        { id: 'arc', label: 'Character Arc' },
        { id: 'lookbook', label: 'Lookbook' },
        { id: 'ai', label: 'AI Concepting' }
      ];

      const initialCharacters = [
        {
          id: 'char-mr-mega',
          name: 'Mr Mega',
          role: 'Protagonist, Antagonist...',
          archetype: 'Unlikely Hero',
          pronouns: 'They/Them',
          age: '63',
          summary: 'Logline summary',
          traits: ['Resilient', 'Impulsive', 'Secret romantic'],
          background: 'Origin story, formative experiences',
          familyTree: 'Parents, siblings, key relationships',
          stats: { scenes: 0, dialogue: 0, screenTime: 0 },
          arc: {
            setup: 'Who are they at the beginning?',
            development: 'Challenges, midpoint, reversals',
            resolution: 'Where do they end up?'
          },
          looks: {
            portrait: '',
            turnarounds: [],
            expressions: []
          },
          ai: {
            prompt: 'Describe the character\'s look, vibe, and scene',
            notes: 'Shot list, wardrobe callouts, artist references'
          }
        }
      ];

      const state = {
        characters: initialCharacters.map(normalizeCharacter),
        activeId: initialCharacters.length ? initialCharacters[0].id : null,
        activeTabId: 'profile'
      };

      function escapeHtml(value){
        return String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function normalizeList(value){
        if (Array.isArray(value)) return value.map(v => String(v || '').trim()).filter(Boolean);
        if (typeof value === 'string') return value.split(/\r?\n+/).map(v => v.trim()).filter(Boolean);
        return [];
      }

      function createId(){
        if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
        return `char-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
      }

      function createCharacterData(name = ''){
        return {
          id: createId(),
          name,
          role: '',
          archetype: '',
          pronouns: '',
          age: '',
          summary: '',
          traits: [],
          background: '',
          familyTree: '',
          stats: { scenes: 0, dialogue: 0, screenTime: 0 },
          arc: { setup: '', development: '', resolution: '' },
          looks: { portrait: '', turnarounds: [], expressions: [] },
          ai: { prompt: '', notes: '' }
        };
      }

      function normalizeCharacter(item){
        const base = createCharacterData(item?.name || 'Untitled Character');
        if (!item || typeof item !== 'object') return base;
        const normalized = { ...base, ...item };
        normalized.id = item.id || base.id;
        normalized.name = typeof item.name === 'string' ? item.name : base.name;
        normalized.role = typeof item.role === 'string' ? item.role : '';
        normalized.archetype = typeof item.archetype === 'string' ? item.archetype : '';
        normalized.pronouns = typeof item.pronouns === 'string' ? item.pronouns : '';
        if (typeof item.age === 'number') normalized.age = String(item.age);
        else if (typeof item.age === 'string') normalized.age = item.age;
        normalized.summary = typeof item.summary === 'string' ? item.summary : '';
        normalized.background = typeof item.background === 'string' ? item.background : '';
        normalized.familyTree = typeof item.familyTree === 'string' ? item.familyTree : '';
        normalized.traits = normalizeList(item.traits);
        normalized.stats = { ...base.stats, ...(item.stats || {}) };
        normalized.arc = { ...base.arc, ...(item.arc || {}) };
        normalized.looks = { ...base.looks, ...(item.looks || {}) };
        normalized.looks.turnarounds = normalizeList(normalized.looks.turnarounds);
        normalized.looks.expressions = normalizeList(normalized.looks.expressions);
        normalized.ai = { ...base.ai, ...(item.ai || {}) };
        return normalized;
      }

      function getActiveCharacter(){
        if (!state.activeId) return null;
        return state.characters.find(char => char.id === state.activeId) || null;
      }

      function characterSidebarMeta(character){
        if (!character) return '';
        if (character.role) return character.role;
        if (character.archetype) return character.archetype;
        const identity = [character.pronouns, character.age].filter(Boolean).join(' ‚Ä¢ ');
        if (identity) return identity;
        return 'Tap to detail profile';
      }

      function buildCharacterSubheading(character){
        if (!character) return '';
        const parts = [];
        if (character.role) parts.push(character.role);
        const identity = [character.pronouns, character.age].filter(Boolean).join(' ‚Ä¢ ');
        if (identity) parts.push(identity);
        if (character.archetype) parts.push(character.archetype);
        return parts.join(' ‚Äî ');
      }

      function buildTraitsPreviewMarkup(character){
        const traits = Array.isArray(character?.traits) ? character.traits : [];
        if (!traits.length) return '<span class="muted-text">Add traits to see quick reference chips.</span>';
        return traits.map(trait => `<span class="character-studio-chip"><strong>${escapeHtml(trait)}</strong></span>`).join('');
      }

      function characterLookPreviewMarkup(kind, url, character){
        const label = CHARACTER_LOOK_LABELS[kind] || 'Reference';
        const name = character?.name ? character.name : 'Character';
        if (url){
          return `<img src="${escapeHtml(url)}" alt="${escapeHtml(`${name} ${label.toLowerCase()}`)}" />`;
        }
        return `<div class="character-studio-look-empty">Add a ${escapeHtml(label.toLowerCase())} URL to preview.</div>`;
      }

      function parseIntegerInput(value){
        const num = parseInt(value, 10);
        return Number.isFinite(num) && num >= 0 ? num : 0;
      }

      function parseFloatInput(value){
        const num = parseFloat(value);
        return Number.isFinite(num) && num >= 0 ? Number(num.toFixed(2)) : 0;
      }

      function updateCharacterField(id, path, value){
        const character = state.characters.find(c => c.id === id);
        if (!character) return;
        const parts = path.split('.');
        let target = character;
        for (let i = 0; i < parts.length - 1; i++){
          const key = parts[i];
          if (typeof target[key] !== 'object' || target[key] === null) target[key] = {};
          target = target[key];
        }
        target[parts[parts.length - 1]] = value;
      }

      function renderCharacterList(){
        const listEl = document.querySelector('[data-character-list]');
        if (!listEl) return;
        listEl.innerHTML = '';
        if (!state.characters.length){
          state.activeId = null;
          const empty = document.createElement('div');
          empty.className = 'character-studio-empty-list';
          empty.innerHTML = '<strong>No characters yet</strong><span>Add the first member of your cast to begin planning.</span>';
          listEl.appendChild(empty);
          return;
        }
        state.characters.forEach(char => {
          const item = document.createElement('button');
          item.type = 'button';
          item.className = 'character-studio-list-item' + (char.id === state.activeId ? ' active' : '');
          item.innerHTML = `<strong>${escapeHtml(char.name || 'Untitled Character')}</strong><span>${escapeHtml(characterSidebarMeta(char))}</span>`;
          item.addEventListener('click', () => {
            if (state.activeId === char.id) return;
            state.activeId = char.id;
            renderCharacterList();
            renderCharacterDetails();
          });
          listEl.appendChild(item);
        });
      }

      function renderCharacterDetails(){
        const container = document.querySelector('[data-character-details]');
        if (!container) return;
        const active = getActiveCharacter();
        if (!active){
          container.innerHTML = `
            <div class="character-studio-empty">
              <h2>No characters yet</h2>
              <p>Use the + New button to start building your cast.</p>
            </div>`;
          return;
        }

        const statsScenes = Number.isFinite(active.stats?.scenes) ? active.stats.scenes : 0;
        const statsDialogue = Number.isFinite(active.stats?.dialogue) ? active.stats.dialogue : 0;
        const statsScreenTime = Number.isFinite(active.stats?.screenTime) ? active.stats.screenTime : 0;
        const traitsText = Array.isArray(active.traits) ? active.traits.join('\n') : '';
        const portraitUrl = active.looks?.portrait || '';
        const turnaroundsText = Array.isArray(active.looks?.turnarounds) ? active.looks.turnarounds.join('\n') : '';
        const expressionsText = Array.isArray(active.looks?.expressions) ? active.looks.expressions.join('\n') : '';
        const turnaroundPreview = Array.isArray(active.looks?.turnarounds) ? active.looks.turnarounds[0] || '' : '';
        const expressionPreview = Array.isArray(active.looks?.expressions) ? active.looks.expressions[0] || '' : '';
        const subheading = buildCharacterSubheading(active);
        const traitsPreview = buildTraitsPreviewMarkup(active);
        const aiPrompt = active.ai?.prompt || '';
        const aiNotes = active.ai?.notes || '';

        if (!CHARACTER_TAB_CONFIG.some(tab => tab.id === state.activeTabId)){
          state.activeTabId = CHARACTER_TAB_CONFIG[0].id;
        }

        const tabButtonsMarkup = CHARACTER_TAB_CONFIG.map(tab => {
          const isActive = tab.id === state.activeTabId;
          return `<button type="button" class="character-studio-tab-button" role="tab" id="character-tab-${tab.id}" data-tab-id="${tab.id}" aria-controls="character-panel-${tab.id}" aria-selected="${isActive ? 'true' : 'false'}" tabindex="${isActive ? '0' : '-1'}">${escapeHtml(tab.label)}</button>`;
        }).join('');

        const panelAttributes = id => {
          const isActive = state.activeTabId === id;
          return `${isActive ? '' : ' hidden'} aria-hidden="${isActive ? 'false' : 'true'}"`;
        };

        container.innerHTML = `
          <div class="character-studio-detail-header">
            <div>
              <h2 data-character-heading>${escapeHtml(active.name || 'Untitled Character')}</h2>
              <p class="muted-text" data-character-subheading>${escapeHtml(subheading || 'Add role, pronouns, or age details.')}</p>
            </div>
            <div class="character-studio-header-actions">
              <button class="character-studio-tertiary" type="button" data-character-delete>Delete Character</button>
            </div>
          </div>
          <div class="character-studio-tabs">
            <div class="character-studio-tablist" role="tablist" aria-label="Character sections" data-character-tablist>
              ${tabButtonsMarkup}
            </div>
            <div class="character-studio-tabpanels">
              <section class="character-studio-section" role="tabpanel" tabindex="0" id="character-panel-profile" aria-labelledby="character-tab-profile" data-tab-panel="profile"${panelAttributes('profile')}>
                <h3>Profile</h3>
                <p class="muted-text">Keep the essentials handy when writing.</p>
                <div class="character-studio-two-col">
                  <label class="character-studio-field">
                    <span>Name</span>
                    <input type="text" value="${escapeHtml(active.name || '')}" data-character-field="name" placeholder="Character name" />
                  </label>
                  <label class="character-studio-field">
                    <span>Role</span>
                    <input type="text" value="${escapeHtml(active.role || '')}" data-character-field="role" placeholder="Protagonist, Antagonist..." />
                  </label>
                  <label class="character-studio-field">
                    <span>Archetype</span>
                    <input type="text" value="${escapeHtml(active.archetype || '')}" data-character-field="archetype" placeholder="e.g. Reluctant hero" />
                  </label>
                  <label class="character-studio-field">
                    <span>Pronouns</span>
                    <input type="text" value="${escapeHtml(active.pronouns || '')}" data-character-field="pronouns" placeholder="They/Them" />
                  </label>
                  <label class="character-studio-field">
                    <span>Age</span>
                    <input type="text" value="${escapeHtml(active.age || '')}" data-character-field="age" placeholder="32" />
                  </label>
                </div>
                <label class="character-studio-field">
                  <span>Summary</span>
                  <textarea class="small" data-character-field="summary" placeholder="Logline summary">${escapeHtml(active.summary || '')}</textarea>
                </label>
              </section>
              <section class="character-studio-section" role="tabpanel" tabindex="0" id="character-panel-stats" aria-labelledby="character-tab-stats" data-tab-panel="stats"${panelAttributes('stats')}>
                <h3>Stats &amp; Spotlight</h3>
                <p class="muted-text">Track how often this character appears in the script.</p>
                <div class="character-studio-stats-grid">
                  <div class="character-studio-stat">
                    <span class="character-studio-stat-value" data-character-stat="scenes">${escapeHtml(String(statsScenes))}</span>
                    <span class="character-studio-stat-label">Scenes</span>
                  </div>
                  <div class="character-studio-stat">
                    <span class="character-studio-stat-value" data-character-stat="dialogue">${escapeHtml(String(statsDialogue))}</span>
                    <span class="character-studio-stat-label">Dialogue Lines</span>
                  </div>
                  <div class="character-studio-stat">
                    <span class="character-studio-stat-value" data-character-stat="screenTime">${escapeHtml(String(statsScreenTime))}</span>
                    <span class="character-studio-stat-label">Estimated Minutes</span>
                  </div>
                </div>
                <div class="character-studio-two-col">
                  <label class="character-studio-field">
                    <span>Total scenes</span>
                    <input type="number" min="0" value="${escapeHtml(String(statsScenes))}" data-character-field="stats.scenes" />
                  </label>
                  <label class="character-studio-field">
                    <span>Dialogue lines</span>
                    <input type="number" min="0" value="${escapeHtml(String(statsDialogue))}" data-character-field="stats.dialogue"/>
                  </label>
                  <label class="character-studio-field">
                    <span>Screen time (minutes)</span>
                    <input type="number" min="0" step="0.1" value="${escapeHtml(String(statsScreenTime))}" data-character-field="stats.screenTime" />
                  </label>
                </div>
              </section>
              <section class="character-studio-section" role="tabpanel" tabindex="0" id="character-panel-traits" aria-labelledby="character-tab-traits" data-tab-panel="traits"${panelAttributes('traits')}>
                <h3>Traits &amp; Personality</h3>
                <p class="muted-text">List defining qualities, habits, and secrets.</p>
                <div class="character-studio-traits-preview" data-traits-preview>${traitsPreview}</div>
                <label class="character-studio-field">
                  <span>Traits (one per line)</span>
                  <textarea data-character-field="traits" placeholder="Resilient&#10;Impulsive&#10;Secret romantic">${escapeHtml(traitsText)}</textarea>
                </label>
              </section>
              <section class="character-studio-section" role="tabpanel" tabindex="0" id="character-panel-background" aria-labelledby="character-tab-background" data-tab-panel="background"${panelAttributes('background')}>
                <h3>Background &amp; Family</h3>
                <div class="character-studio-two-col">
                  <label class="character-studio-field">
                    <span>Background story</span>
                    <textarea data-character-field="background" placeholder="Origin story, formative experiences">${escapeHtml(active.background || '')}</textarea>
                  </label>
                  <label class="character-studio-field">
                    <span>Family tree / relationships</span>
                    <textarea data-character-field="familyTree" placeholder="Parents, siblings, key relationships">${escapeHtml(active.familyTree || '')}</textarea>
                  </label>
                </div>
              </section>
              <section class="character-studio-section" role="tabpanel" tabindex="0" id="character-panel-arc" aria-labelledby="character-tab-arc" data-tab-panel="arc"${panelAttributes('arc')}>
                <h3>Character Arc</h3>
                <p class="muted-text">Map how the character transforms across the story.</p>
                <div class="character-studio-two-col">
                  <label class="character-studio-field">
                    <span>Setup</span>
                    <textarea data-character-field="arc.setup" placeholder="Who are they at the beginning?">${escapeHtml(active.arc?.setup || '')}</textarea>
                  </label>
                  <label class="character-studio-field">
                    <span>Development</span>
                    <textarea data-character-field="arc.development" placeholder="Challenges, midpoint, reversals">${escapeHtml(active.arc?.development || '')}</textarea>
                  </label>
                  <label class="character-studio-field">
                    <span>Resolution</span>
                    <textarea data-character-field="arc.resolution" placeholder="Where do they end up?">${escapeHtml(active.arc?.resolution || '')}</textarea>
                  </label>
                </div>
              </section>
              <section class="character-studio-section" role="tabpanel" tabindex="0" id="character-panel-lookbook" aria-labelledby="character-tab-lookbook" data-tab-panel="lookbook"${panelAttributes('lookbook')}>
                <h3>Lookbook</h3>
                <p class="muted-text">Collect portrait, turnaround, and expression references.</p>
                <div class="character-studio-two-col">
                  <label class="character-studio-field">
                    <span>Portrait URL</span>
                    <input type="url" data-character-field="looks.portrait" value="${escapeHtml(portraitUrl)}" placeholder="https://..." />
                  </label>
                  <label class="character-studio-field">
                    <span>Turnarounds (one per line)</span>
                    <textarea data-character-field="looks.turnarounds" class="small" placeholder="Link to turnaround sheets">${escapeHtml(turnaroundsText)}</textarea>
                  </label>
                  <label class="character-studio-field">
                    <span>Expression sheets (one per line)</span>
                    <textarea data-character-field="looks.expressions" class="small" placeholder="Link to expressions">${escapeHtml(expressionsText)}</textarea>
                  </label>
                </div>
                <div class="character-studio-look-grid">
                  <div class="character-studio-look-card" data-look-preview="portrait">
                    <span class="character-studio-look-label">Portrait</span>
                    <div data-look-content>
                      ${characterLookPreviewMarkup('portrait', portraitUrl, active)}
                    </div>
                  </div>
                  <div class="character-studio-look-card" data-look-preview="turnaround">
                    <span class="character-studio-look-label">Turnaround</span>
                    <div data-look-content>
                      ${characterLookPreviewMarkup('turnaround', turnaroundPreview, active)}
                    </div>
                  </div>
                  <div class="character-studio-look-card" data-look-preview="expression">
                    <span class="character-studio-look-label">Expressions</span>
                    <div data-look-content>
                      ${characterLookPreviewMarkup('expression', expressionPreview, active)}
                    </div>
                  </div>
                </div>
              </section>
              <section class="character-studio-section" role="tabpanel" tabindex="0" id="character-panel-ai" aria-labelledby="character-tab-ai" data-tab-panel="ai"${panelAttributes('ai')}>
                <h3>AI Concepting</h3>
                <p class="muted-text">Draft prompts for StudioOrganize AI or export for other tools.</p>
                <label class="character-studio-field">
                  <span>AI prompt</span>
                  <textarea data-character-field="ai.prompt" placeholder="Describe the character's look, vibe, and scene">${escapeHtml(aiPrompt)}</textarea>
                </label>
                <label class="character-studio-field">
                  <span>Notes / references</span>
                  <textarea data-character-field="ai.notes" class="small" placeholder="Shot list, wardrobe callouts, artist references">${escapeHtml(aiNotes)}</textarea>
                </label>
                <div class="character-studio-ai-actions">
                  <button type="button" data-character-ai-generate>Save prompt &amp; prep AI render</button>
                  <span class="character-studio-status" data-ai-status></span>
                </div>
              </section>
            </div>
          </div>
        `;

        setupCharacterTabs(container);
        bindCharacterStudioFields(container, active);
        updateTimelineCharacterMeta();
        updateTimelineHighlights();
      }

      function refreshCharacterMeta(character){
        const heading = document.querySelector('[data-character-heading]');
        if (heading) heading.textContent = character?.name ? character.name : 'Untitled Character';
        const subheading = document.querySelector('[data-character-subheading]');
        if (subheading){
          const text = buildCharacterSubheading(character);
          subheading.textContent = text || 'Add role, pronouns, or age details.';
        }
        updateTimelineCharacterMeta();
        updateTimelineHighlights();
      }

      function refreshTraitsPreview(character){
        const preview = document.querySelector('[data-traits-preview]');
        if (preview) preview.innerHTML = buildTraitsPreviewMarkup(character);
      }

      function updateLookPreview(kind, character){
        const slot = document.querySelector(`[data-look-preview="${kind}"]`);
        if (!slot) return;
        let url = '';
        if (kind === 'portrait') url = (character?.looks?.portrait || '').trim();
        else if (kind === 'turnaround') url = Array.isArray(character?.looks?.turnarounds) ? character.looks.turnarounds[0] || '' : '';
        else if (kind === 'expression') url = Array.isArray(character?.looks?.expressions) ? character.looks.expressions[0] || '' : '';
        const content = slot.querySelector('[data-look-content]');
        if (content) content.innerHTML = characterLookPreviewMarkup(kind, url, character);
      }

      function setupCharacterTabs(container){
        if (!container) return;
        const tablist = container.querySelector('[data-character-tablist]');
        if (!tablist) return;
        const buttons = Array.from(tablist.querySelectorAll('[data-tab-id]'));
        const panels = Array.from(container.querySelectorAll('[data-tab-panel]'));
        if (!buttons.length || !panels.length) return;

        const tabIds = buttons.map(btn => btn.getAttribute('data-tab-id'));
        if (!tabIds.includes(state.activeTabId)){
          state.activeTabId = tabIds[0];
        }

        const activate = (id, { focus } = { focus: true }) => {
          if (!tabIds.includes(id)) id = tabIds[0];
          state.activeTabId = id;
          buttons.forEach(btn => {
            const tabId = btn.getAttribute('data-tab-id');
            const isActive = tabId === id;
            btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
            btn.tabIndex = isActive ? 0 : -1;
            if (isActive && focus) btn.focus();
          });
          panels.forEach(panel => {
            const panelId = panel.getAttribute('data-tab-panel');
            const isActive = panelId === id;
            panel.hidden = !isActive;
            panel.setAttribute('aria-hidden', isActive ? 'false' : 'true');
          });
        };

        buttons.forEach((btn, index) => {
          const tabId = btn.getAttribute('data-tab-id');
          btn.addEventListener('click', () => activate(tabId, { focus: false }));
          btn.addEventListener('keydown', event => {
            if (!['ArrowRight', 'ArrowDown', 'ArrowLeft', 'ArrowUp', 'Home', 'End'].includes(event.key)) return;
            event.preventDefault();
            let targetIndex = index;
            if (event.key === 'ArrowRight' || event.key === 'ArrowDown'){
              targetIndex = (index + 1) % buttons.length;
            } else if (event.key === 'ArrowLeft' || event.key === 'ArrowUp'){
              targetIndex = (index - 1 + buttons.length) % buttons.length;
            } else if (event.key === 'Home'){
              targetIndex = 0;
            } else if (event.key === 'End'){
              targetIndex = buttons.length - 1;
            }
            activate(buttons[targetIndex].getAttribute('data-tab-id'));
          });
        });

        activate(state.activeTabId, { focus: false });
      }

      function bindCharacterStudioFields(container, active){
        if (!container || !active) return;
        const id = active.id;
        const aiStatus = container.querySelector('[data-ai-status]');
        const clearAiStatus = () => {
          if (aiStatus){
            aiStatus.textContent = '';
            aiStatus.removeAttribute('data-state');
          }
        };

        const nameInput = container.querySelector('[data-character-field="name"]');
        if (nameInput){
          nameInput.addEventListener('input', e => {
            updateCharacterField(id, 'name', e.target.value);
            renderCharacterList();
            refreshCharacterMeta(active);
            updateLookPreview('portrait', active);
            updateLookPreview('turnaround', active);
            updateLookPreview('expression', active);
          });
        }

        const roleInput = container.querySelector('[data-character-field="role"]');
        if (roleInput){
          roleInput.addEventListener('input', e => {
            updateCharacterField(id, 'role', e.target.value);
            renderCharacterList();
            refreshCharacterMeta(active);
          });
        }

        const archetypeInput = container.querySelector('[data-character-field="archetype"]');
        if (archetypeInput){
          archetypeInput.addEventListener('input', e => {
            updateCharacterField(id, 'archetype', e.target.value);
            renderCharacterList();
            refreshCharacterMeta(active);
          });
        }

        const pronounsInput = container.querySelector('[data-character-field="pronouns"]');
        if (pronounsInput){
          pronounsInput.addEventListener('input', e => {
            updateCharacterField(id, 'pronouns', e.target.value);
            renderCharacterList();
            refreshCharacterMeta(active);
          });
        }

        const ageInput = container.querySelector('[data-character-field="age"]');
        if (ageInput){
          ageInput.addEventListener('input', e => {
            updateCharacterField(id, 'age', e.target.value);
            renderCharacterList();
            refreshCharacterMeta(active);
          });
        }

        const summaryInput = container.querySelector('[data-character-field="summary"]');
        if (summaryInput){
          summaryInput.addEventListener('input', e => {
            updateCharacterField(id, 'summary', e.target.value);
          });
        }

        const statsScenesInput = container.querySelector('[data-character-field="stats.scenes"]');
        if (statsScenesInput){
          statsScenesInput.addEventListener('input', e => {
            const value = parseIntegerInput(e.target.value);
            updateCharacterField(id, 'stats.scenes', value);
            const display = container.querySelector('[data-character-stat="scenes"]');
            if (display) display.textContent = value;
          });
        }

        const statsDialogueInput = container.querySelector('[data-character-field="stats.dialogue"]');
        if (statsDialogueInput){
          statsDialogueInput.addEventListener('input', e => {
            const value = parseIntegerInput(e.target.value);
            updateCharacterField(id, 'stats.dialogue', value);
            const display = container.querySelector('[data-character-stat="dialogue"]');
            if (display) display.textContent = value;
          });
        }

        const statsScreenTimeInput = container.querySelector('[data-character-field="stats.screenTime"]');
        if (statsScreenTimeInput){
          statsScreenTimeInput.addEventListener('input', e => {
            const value = parseFloatInput(e.target.value);
            updateCharacterField(id, 'stats.screenTime', value);
            const display = container.querySelector('[data-character-stat="screenTime"]');
            if (display) display.textContent = value;
          });
        }

        const traitsInput = container.querySelector('[data-character-field="traits"]');
        if (traitsInput){
          traitsInput.addEventListener('input', e => {
            const list = normalizeList(e.target.value);
            updateCharacterField(id, 'traits', list);
            refreshTraitsPreview(active);
          });
        }

        const backgroundInput = container.querySelector('[data-character-field="background"]');
        if (backgroundInput){
          backgroundInput.addEventListener('input', e => {
            updateCharacterField(id, 'background', e.target.value);
          });
        }

        const familyInput = container.querySelector('[data-character-field="familyTree"]');
        if (familyInput){
          familyInput.addEventListener('input', e => {
            updateCharacterField(id, 'familyTree', e.target.value);
          });
        }

        const arcSetupInput = container.querySelector('[data-character-field="arc.setup"]');
        if (arcSetupInput){
          arcSetupInput.addEventListener('input', e => {
            updateCharacterField(id, 'arc.setup', e.target.value);
          });
        }

        const arcDevInput = container.querySelector('[data-character-field="arc.development"]');
        if (arcDevInput){
          arcDevInput.addEventListener('input', e => {
            updateCharacterField(id, 'arc.development', e.target.value);
          });
        }

        const arcResolutionInput = container.querySelector('[data-character-field="arc.resolution"]');
        if (arcResolutionInput){
          arcResolutionInput.addEventListener('input', e => {
            updateCharacterField(id, 'arc.resolution', e.target.value);
          });
        }

        const portraitInput = container.querySelector('[data-character-field="looks.portrait"]');
        if (portraitInput){
          portraitInput.addEventListener('input', e => {
            const value = e.target.value.trim();
            updateCharacterField(id, 'looks.portrait', value);
            updateLookPreview('portrait', active);
          });
        }

        const turnaroundsInput = container.querySelector('[data-character-field="looks.turnarounds"]');
        if (turnaroundsInput){
          turnaroundsInput.addEventListener('input', e => {
            const list = normalizeList(e.target.value);
            updateCharacterField(id, 'looks.turnarounds', list);
            updateLookPreview('turnaround', active);
          });
        }

        const expressionsInput = container.querySelector('[data-character-field="looks.expressions"]');
        if (expressionsInput){
          expressionsInput.addEventListener('input', e => {
            const list = normalizeList(e.target.value);
            updateCharacterField(id, 'looks.expressions', list);
            updateLookPreview('expression', active);
          });
        }

        const aiPromptInput = container.querySelector('[data-character-field="ai.prompt"]');
        if (aiPromptInput){
          aiPromptInput.addEventListener('input', e => {
            updateCharacterField(id, 'ai.prompt', e.target.value);
            clearAiStatus();
          });
        }

        const aiNotesInput = container.querySelector('[data-character-field="ai.notes"]');
        if (aiNotesInput){
          aiNotesInput.addEventListener('input', e => {
            updateCharacterField(id, 'ai.notes', e.target.value);
            clearAiStatus();
          });
        }

        const aiButton = container.querySelector('[data-character-ai-generate]');
        if (aiButton){
          aiButton.addEventListener('click', () => {
            const prompt = (active.ai?.prompt || '').trim();
            if (!prompt){
              if (aiStatus){
                aiStatus.textContent = 'Add an AI prompt to generate concept art.';
                aiStatus.dataset.state = 'warning';
              }
              return;
            }
            if (aiStatus){
              aiStatus.textContent = 'Prompt saved! Connect to StudioOrganize AI to generate character images.';
              aiStatus.dataset.state = 'ready';
            }
          });
        }

        const deleteBtn = container.querySelector('[data-character-delete]');
        if (deleteBtn){
          deleteBtn.addEventListener('click', () => {
            const name = active.name || 'this character';
            const ok = window.confirm(`Delete ${name}? This will remove their notes and stats.`);
            if (!ok) return;
            const index = state.characters.findIndex(c => c.id === id);
            if (index !== -1) state.characters.splice(index, 1);
            if (state.characters.length){
              state.activeId = state.characters[0].id;
            } else {
              state.activeId = null;
            }
            renderCharacterList();
            renderCharacterDetails();
          });
        }
      }

      function addCharacter(){
        const newCharacter = createCharacterData('New Character');
        state.characters.push(newCharacter);
        state.activeId = newCharacter.id;
        renderCharacterList();
        renderCharacterDetails();
        window.requestAnimationFrame(() => {
          const input = document.querySelector('[data-character-field="name"]');
          if (input){
            input.focus();
            input.select();
          }
        });
      }

      const addButton = document.getElementById('characterStudioAddBtn');
      if (addButton){
        addButton.addEventListener('click', addCharacter);
      }

      renderCharacterList();
      renderCharacterDetails();
    })();
  </script>
  <script>document.getElementById('y').textContent = new Date().getFullYear();</script>
  <script type="module" src="/assets/main.js"></script>
</body>
</html>
