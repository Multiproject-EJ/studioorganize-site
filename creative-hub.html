<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StorySpark – Creative Boost Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/styles.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["Inter", "ui-sans-serif", "system-ui", "-apple-system", "BlinkMacSystemFont", "Segoe UI", "sans-serif"],
          },
          boxShadow: {
            glowteal: "0 0 30px rgba(74,242,196,0.3)",
            glowpink: "0 0 30px rgba(236,72,153,0.35)",
            glowviolet: "0 0 30px rgba(168,85,247,0.3)",
          },
          keyframes: {
            blink: {
              '50%': { opacity: '0' },
            },
            'spin-slow': {
              '0%': { transform: 'rotate(0deg)' },
              '100%': { transform: 'rotate(360deg)' },
            },
            'spin-slow-reverse': {
              '0%': { transform: 'rotate(360deg)' },
              '100%': { transform: 'rotate(0deg)' },
            },
            float: {
              '0%, 100%': { transform: 'translateY(0px)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            'pulse-slow': {
              '0%, 100%': { opacity: '0.3' },
              '50%': { opacity: '0.6' },
            },
          },
          animation: {
            blink: 'blink 1s step-start infinite',
            'spin-slow': 'spin-slow 10s linear infinite',
            'spin-slow-reverse': 'spin-slow-reverse 12s linear infinite',
            float: 'float 4s ease-in-out infinite',
            'pulse-slow': 'pulse-slow 10s ease-in-out infinite',
          },
        },
      },
    };
  </script>
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(45,212,191,0.08), transparent 55%), radial-gradient(circle at 80% 0%, rgba(192,132,252,0.1), transparent 60%), #020617;
      color: #e2e8f0;
      min-height: 100vh;
    }
    button:focus-visible, a:focus-visible {
      outline: 2px solid rgba(45,212,191,0.75);
      outline-offset: 3px;
    }
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div id="app"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    const MODE_KEYWORDS = {
      idea: ["idea", "premise", "concept", "seed", "spark"],
      character: ["character", "protagonist", "antagonist", "hero", "villain", "backstory", "motivation", "arc"],
      world: ["world", "setting", "lore", "map", "city", "planet", "magic", "society"],
      plot: ["plot", "twist", "arc", "structure", "beat", "conflict", "climax", "resolution"],
      scene: ["scene", "dialogue", "moment", "beat", "description", "action"],
      block: ["block", "stuck", "can't write", "cant write", "motivation", "help"],
    };

    const SUGGESTIONS = [
      "invent a fantasy world with floating markets",
      "flesh out my detective's secret flaw",
      "give me a plot twist for a family drama",
      "write a tense scene in a storm",
      "I'm blocked — surprise me",
    ];

    const PROMPTS_BY_MODE = {
      idea: [
        "A promise broken sparks a citywide hunt",
        "What if memories could be traded like currency?",
        "Two rivals must share one disguise",
      ],
      character: [
        "Write your hero’s private superstition",
        "A kindness they regret — why?",
        "The secret they’d defend with a lie",
      ],
      world: [
        "Define one law of nature that’s different here",
        "Sketch a market scene with one forbidden item",
        "Who really owns nightfall in this place?",
      ],
      plot: [
        "Inciting incident in 1 sentence",
        "Midpoint reversal: who changes sides?",
        "Climax: raise the price of failure",
      ],
      scene: [
        "Write the moment without adjectives",
        "All dialogue, no tags",
        "Add one sensory detail per line",
      ],
      block: [
        "10-minute freewrite about the room you’re in",
        "Use three random nouns in a paragraph",
        "Rewrite a cliché in a strange tone",
      ],
    };

    const BUBBLES = [
      { mode: "idea", label: "New Idea", icon: "✨", tag: "premise, what-if" },
      { mode: "character", label: "Character", icon: "🧠", tag: "motives, wounds" },
      { mode: "world", label: "World", icon: "🌍", tag: "rules, places" },
      { mode: "plot", label: "Plot", icon: "🎭", tag: "beats, twists" },
      { mode: "scene", label: "Scene", icon: "🎬", tag: "moments, dialogue" },
      { mode: "block", label: "Unblock", icon: "🕯", tag: "freewrite, seed" },
    ];

    const ANALYTICS = (name, payload = {}) => {
      console.info(`[analytics] ${name}`, payload);
    };

    function detectIntent(text) {
      const value = (text || "").toLowerCase();
      let best = "idea";
      let bestScore = 0;
      let bestTokens = [];
      Object.keys(MODE_KEYWORDS).forEach((mode) => {
        const tokens = MODE_KEYWORDS[mode];
        const matches = tokens.filter((token) => value.includes(token));
        if (matches.length > bestScore) {
          best = mode;
          bestScore = matches.length;
          bestTokens = matches;
        }
      });
      if (bestScore === 0) {
        if (value.includes("surprise")) {
          return { mode: "idea", confidence: 0.6, tokensMatched: ["surprise"] };
        }
        const words = value.trim().split(/\s+/);
        if (words.length > 10 && (value.includes(" he ") || value.includes(" she "))) {
          return { mode: "scene", confidence: 0.4, tokensMatched: [] };
        }
      }
      const confidence = Math.min(1, 0.4 + bestScore * 0.2);
      return { mode: best, confidence, tokensMatched: bestTokens };
    }

    function nextStepHint(mode) {
      switch (mode) {
        case "character":
          return "Write a secret your character would never admit out loud.";
        case "world":
          return "Define one rule that makes this world different from ours.";
        case "plot":
          return "Draft a sentence for the inciting incident and why it upends normal life.";
        case "scene":
          return "Write the same beat twice: first calm, then with rising tension.";
        case "block":
          return "Do a 10-minute freewrite about anything you can see or hear right now.";
        default:
          return "Write a 1-sentence premise that includes a protagonist, goal, and obstacle.";
      }
    }

    const randomItem = (array) => array[Math.floor(Math.random() * array.length)];
    const randomPremise = () => randomItem(PROMPTS_BY_MODE.idea);
    const randomTwist = () => randomItem(PROMPTS_BY_MODE.plot);
    const randomConceptPair = () => `${randomItem(PROMPTS_BY_MODE.idea)} + ${randomItem(PROMPTS_BY_MODE.world)}`;

    const seedBank = {
      load() {
        try {
          const raw = localStorage.getItem("storyspark.seeds");
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch (error) {
          console.warn("Seed bank load failed", error);
          return [];
        }
      },
      save(seed) {
        const all = this.load();
        all.push(seed);
        localStorage.setItem("storyspark.seeds", JSON.stringify(all));
        ANALYTICS("seed_saved", { mode: seed.mode });
        return all;
      },
    };

    function useFlowTimer(initialSeconds = 600) {
      const [seconds, setSeconds] = useState(initialSeconds);
      const [running, setRunning] = useState(false);
      const initialRef = useRef(initialSeconds);

      useEffect(() => {
        initialRef.current = initialSeconds;
        setSeconds(initialSeconds);
        setRunning(false);
      }, [initialSeconds]);

      useEffect(() => {
        if (!running) return undefined;
        const id = setInterval(() => {
          setSeconds((prev) => {
            if (prev <= 1) {
              clearInterval(id);
              setRunning(false);
              return 0;
            }
            return prev - 1;
          });
        }, 1000);
        return () => clearInterval(id);
      }, [running]);

      const start = () => {
        setRunning(true);
      };

      const pause = () => {
        setRunning(false);
      };

      const reset = () => {
        setRunning(false);
        setSeconds(initialRef.current);
      };

      const formatted = `${String(Math.floor(seconds / 60)).padStart(2, "0")}:${String(seconds % 60).padStart(2, "0")}`;
      return { seconds, formatted, running, start, pause, reset };
    }

    function StageFrame({ stage, onNavigate, children, fade }) {
      return (
        <div className="min-h-screen relative overflow-hidden">
          <div className="absolute inset-0 pointer-events-none">
            <div className="w-full h-full bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800" />
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_30%_20%,rgba(76,201,240,0.12),transparent_60%)] animate-pulse-slow" />
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_80%_30%,rgba(216,180,254,0.12),transparent_65%)] animate-pulse-slow" style={{ animationDelay: '1.5s' }} />
          </div>
          <div className="relative z-10 flex flex-col min-h-screen">
            <div className="workspace-launcher" data-workspace-launcher>
              <div className="workspace-launcher__controls">
                <div className="workspace-launcher__toggle-wrap">
                  <button
                    className="workspace-launcher__toggle"
                    type="button"
                    aria-expanded="false"
                    aria-label="Workspace menu"
                    data-workspace-toggle=""
                  >
                    <span className="sr-only">Workspace menu</span>
                    <span className="workspace-launcher__icon" aria-hidden="true"></span>
                  </button>
                  <div className="workspace-launcher__chat" data-workspace-chat="" hidden aria-hidden="true">
                    <div className="workspace-launcher__chat-bubble">
                      <div className="workspace-launcher__chat-thread" data-workspace-chat-thread="">
                        <div className="workspace-launcher__chat-message workspace-launcher__chat-message--assistant">
                          Hi there! Ready to build something great today?
                        </div>
                      </div>
                      <div className="workspace-launcher__chat-suggestions">
                        <button
                          type="button"
                          className="workspace-launcher__chat-chip"
                          data-workspace-chat-suggestion=""
                          data-workspace-chat-action="continue"
                        >
                          {"Check my progress"}
                        </button>
                        <button
                          type="button"
                          className="workspace-launcher__chat-chip"
                          data-workspace-chat-suggestion=""
                          data-workspace-chat-action="new"
                        >
                          {"Spin up something new"}
                        </button>
                        <button
                          type="button"
                          className="workspace-launcher__chat-chip"
                          data-workspace-chat-suggestion=""
                          data-workspace-chat-action="settings"
                        >
                          {"How should you behave?"}
                        </button>
                      </div>
                      <form className="workspace-launcher__chat-form" data-workspace-chat-form="">
                        <div className="workspace-launcher__chat-input">
                          <input
                            type="text"
                            placeholder="Ask StudioOrganize…"
                            aria-label="Ask the workspace assistant"
                            data-workspace-chat-input=""
                          />
                          <button type="submit" className="workspace-launcher__chat-send" aria-label="Send chat message">
                            <span aria-hidden="true">➤</span>
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
              <div
                className="workspace-launcher__panel"
                data-workspace-panel=""
                aria-hidden="true"
                hidden
                tabIndex={-1}
              >
                <div className="workspace-launcher__actions">
                  <button type="button" className="workspace-launcher__script" data-workspace-script="">
                    <span className="workspace-launcher__script-icon" aria-hidden="true">＋</span>
                    <span>STORY</span>
                  </button>
                </div>
                <nav className="workspace-launcher__modules" aria-label="Workspace modules">
                  <a
                    className="workspace-launcher__module"
                    href="/use-cases/screenplay-writing.html"
                    data-label="Screenplay Writing"
                  >
                    <span className="workspace-launcher__module-icon" aria-hidden="true">
                      <img src="/assets/img/screenplay_writer1.webp" alt="" loading="lazy" />
                    </span>
                    <span className="sr-only">Screenplay Writing</span>
                  </a>
                  <a className="workspace-launcher__module" href="/CharacterStudio.html" data-label="Character Studio">
                    <span className="workspace-launcher__module-icon" aria-hidden="true">
                      <img src="/assets/img/studioorganize_mock.png" alt="" loading="lazy" />
                    </span>
                    <span className="sr-only">Character Studio</span>
                  </a>
                  <a className="workspace-launcher__module" href="/StoryboardPro.html" data-label="Storyboard Pro">
                    <span className="workspace-launcher__module-icon" aria-hidden="true">
                      <img src="/assets/img/studioorganize_mock.png" alt="" loading="lazy" />
                    </span>
                    <span className="sr-only">Storyboard Pro</span>
                  </a>
                  <a className="workspace-launcher__module" href="/use-cases/generate-ideas.html" data-label="Idea Generator">
                    <span className="workspace-launcher__module-icon" aria-hidden="true">
                      <img src="/assets/img/studioorganize_mock.png" alt="" loading="lazy" />
                    </span>
                    <span className="sr-only">Idea Generator</span>
                  </a>
                  <a className="workspace-launcher__module" href="/use-cases/set-design.html" data-label="Set Design">
                    <span className="workspace-launcher__module-icon" aria-hidden="true">
                      <img src="/assets/img/studioorganize_mock.png" alt="" loading="lazy" />
                    </span>
                    <span className="sr-only">Set Design</span>
                  </a>
                  <a
                    className="workspace-launcher__module workspace-launcher__module--active"
                    href="/creative-hub.html"
                    data-label="Creative Hub"
                    aria-current="page"
                  >
                    <span className="workspace-launcher__module-icon" aria-hidden="true">
                      <img src="/assets/img/studioorganize_mock.png" alt="" loading="lazy" />
                    </span>
                    <span className="sr-only">Creative Hub</span>
                  </a>
                </nav>
              </div>
            </div>
            <header className="px-6 pt-8 pb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div>
                <span className="text-sm uppercase tracking-[0.4em] text-slate-500">StorySpark</span>
                <h1 className="text-3xl md:text-4xl font-semibold text-slate-100 mt-2">Creative Boost Hub</h1>
                <p className="text-slate-400 text-sm md:text-base">Single-page playground to shake loose new storytelling energy.</p>
              </div>
              <div className="flex items-center gap-3 self-start md:self-auto">
                <button
                  type="button"
                  className="px-4 py-2 rounded-full border border-slate-700/80 bg-slate-900/60 text-xs uppercase tracking-wide"
                  title="Coming soon: share a prompt to the community"
                >
                  Leave a Seed (soon)
                </button>
                {stage !== 'gateway' && (
                  <button
                    type="button"
                    onClick={() => onNavigate('gateway')}
                    className="px-4 py-2 rounded-full border border-slate-700/80 bg-slate-900/60 text-sm hover:border-teal-400 transition"
                  >
                    ← Back to Gateway
                  </button>
                )}
              </div>
            </header>
            <main className={`flex-1 px-6 pb-16 transition-opacity duration-200 ${fade ? 'opacity-0' : 'opacity-100'}`}>
              {children}
            </main>
          </div>
        </div>
      );
    }

    function Gateway({ onSelect }) {
      return (
        <div className="max-w-6xl mx-auto flex flex-col items-center text-center gap-12">
          <div>
            <h2 className="text-4xl font-semibold text-teal-400 drop-shadow-lg mb-3">Every creator begins differently.</h2>
            <p className="text-lg text-slate-300">How do you want to enter your story space today?</p>
          </div>
          <div className="flex flex-wrap justify-center gap-8">
            <button
              onClick={() => onSelect('type')}
              className="relative group w-72 h-72 rounded-3xl bg-slate-900/70 border border-slate-700 backdrop-blur-md flex flex-col items-center justify-center hover:border-teal-500 hover:shadow-glowteal transition focus:outline-none focus:ring-2 focus:ring-teal-500"
              aria-label="Enter by typing what you need"
            >
              <div className="text-2xl font-medium mb-4 text-teal-300">Type Your Need</div>
              <div className="w-60 h-12 bg-slate-800/70 rounded-lg flex items-center justify-start px-4 border border-slate-700 overflow-hidden">
                <span className="text-slate-400 italic">What do you need to create today?</span>
                <span className="ml-1 w-2 h-5 bg-teal-400 animate-blink" />
              </div>
              <p className="absolute bottom-5 text-xs text-slate-400">Introspective • Focused</p>
            </button>
            <button
              onClick={() => onSelect('explore')}
              className="relative group w-72 h-72 rounded-3xl bg-slate-900/70 border border-slate-700 backdrop-blur-md flex flex-col items-center justify-center hover:border-pink-400 hover:shadow-glowpink transition focus:outline-none focus:ring-2 focus:ring-pink-400"
              aria-label="Explore creative directions by feeling"
            >
              <div className="text-2xl font-medium mb-4 text-pink-300">Explore by Feeling</div>
              <div className="relative w-56 h-40 flex items-center justify-center">
                {[...Array(6)].map((_, i) => (
                  <div
                    key={i}
                    className="absolute w-14 h-14 rounded-full bg-gradient-to-br from-pink-500 to-purple-600 opacity-70 blur-sm animate-float"
                    style={{ top: `${20 + Math.sin(i) * 30}%`, left: `${30 + Math.cos(i) * 30}%`, animationDelay: `${i * 0.2}s` }}
                  />
                ))}
              </div>
              <p className="absolute bottom-5 text-xs text-slate-400">Playful • Visual</p>
            </button>
            <button
              onClick={() => onSelect('surprise')}
              className="relative group w-72 h-72 rounded-3xl bg-slate-900/70 border border-slate-700 backdrop-blur-md flex flex-col items-center justify-center hover:border-violet-400 hover:shadow-glowviolet transition focus:outline-none focus:ring-2 focus:ring-violet-400"
              aria-label="Surprise me with a random starting path"
            >
              <div className="text-2xl font-medium mb-4 text-violet-300">Surprise Me</div>
              <div className="relative w-24 h-24">
                <div className="absolute inset-0 rounded-full border-4 border-violet-500 animate-spin-slow" />
                <div className="absolute inset-0 rounded-full border-t-4 border-violet-300 animate-spin-slow-reverse" />
              </div>
              <p className="absolute bottom-5 text-xs text-slate-400">Spontaneous • Bold</p>
            </button>
          </div>
        </div>
      );
    }

    function TypeMode({ onBack, openWorkspace }) {
      const [phase, setPhase] = useState('prompt');
      const [input, setInput] = useState('');
      const [intent, setIntent] = useState(null);

      const begin = () => {
        const result = detectIntent(input);
        setIntent(result);
        setPhase('workspace');
        openWorkspace({ mode: result.mode, confidence: result.confidence, tokensMatched: result.tokensMatched }, input);
        ANALYTICS('intent_detected', { mode: result.mode });
      };

      useEffect(() => {
        if (phase === 'workspace' && intent) {
          ANALYTICS('workspace_opened', { mode: intent.mode });
        }
      }, [phase, intent]);

      return (
        <div className="max-w-3xl mx-auto">
          <div className="flex items-center justify-between mb-8">
            <h2 className="text-2xl font-semibold text-teal-300">Type Your Need</h2>
            <button onClick={onBack} className="px-3 py-1.5 rounded-md bg-slate-800 border border-slate-700 hover:bg-slate-700">← Back</button>
          </div>
          <p className="text-slate-300 mb-6">
            Start by telling the space what you need. Examples:
            <span className="italic text-slate-400"> “invent a fantasy world”, “flesh out my detective”, “give me a plot twist”, “I'm blocked—surprise me”</span>.
          </p>
          <div className="bg-slate-900/60 border border-slate-700 rounded-2xl p-6 shadow-lg">
            <label htmlFor="need" className="block text-sm text-slate-400 mb-2">What do you need to create today?</label>
            <div className="flex flex-col md:flex-row gap-3">
              <input
                id="need"
                value={input}
                onChange={(event) => setInput(event.target.value)}
                onKeyDown={(event) => {
                  if (event.key === 'Enter') {
                    begin();
                  }
                }}
                placeholder="e.g., a flawed hero backstory in a neon city"
                className="flex-1 bg-slate-950/70 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-teal-500"
              />
              <button onClick={begin} className="px-5 py-3 rounded-lg bg-teal-600 hover:bg-teal-500 text-white font-medium">Begin</button>
            </div>
            <div className="mt-4 flex flex-wrap gap-2 text-sm">
              {SUGGESTIONS.map((suggestion) => (
                <button
                  key={suggestion}
                  onClick={() => setInput(suggestion)}
                  className="px-3 py-1.5 bg-slate-800 border border-slate-700 rounded-full hover:bg-slate-700 text-slate-300"
                >
                  {suggestion}
                </button>
              ))}
            </div>
          </div>
          <div className="mt-6 text-sm text-slate-400">
            <span className="mr-2">Detected mode:</span>
            <span className="px-2 py-1 rounded-md bg-slate-800 border border-slate-700 text-slate-200">{detectIntent(input).mode.toUpperCase()}</span>
            <span className="ml-3">• confidence {Math.round(detectIntent(input).confidence * 100)}%</span>
          </div>
        </div>
      );
    }

    function ExploreMode({ onBack, openWorkspace }) {
      const [phase, setPhase] = useState('select');
      const [mode, setMode] = useState(null);
      const [seed, setSeed] = useState('');

      useEffect(() => {
        const listener = (event) => {
          const strength = 10;
          document.querySelectorAll('[data-bubble]').forEach((el) => {
            const rect = el.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const offsetX = (event.clientX - centerX) / rect.width;
            const offsetY = (event.clientY - centerY) / rect.height;
            el.style.transform = `translate(${offsetX * strength}px, ${offsetY * strength}px)`;
          });
        };
        window.addEventListener('mousemove', listener);
        return () => window.removeEventListener('mousemove', listener);
      }, []);

      const openPrompts = (nextMode) => {
        setMode(nextMode);
        setPhase('prompt');
      };

      const begin = (text) => {
        if (!mode) return;
        const chosenSeed = text ?? seed ?? '';
        setSeed(chosenSeed);
        openWorkspace({ mode, confidence: 0.9, tokensMatched: ['explore'] }, chosenSeed);
        setPhase('workspace');
        ANALYTICS('intent_detected', { mode });
        ANALYTICS('workspace_opened', { mode });
      };

      if (phase === 'workspace') {
        return null;
      }

      return (
        <div className="min-h-[70vh] w-full flex flex-col">
          <div className="flex items-center justify-between mb-6">
            <div className="text-2xl font-semibold text-pink-300">Explore by Feeling</div>
            <button onClick={onBack} className="px-3 py-1.5 rounded-md bg-slate-800 border border-slate-700 hover:bg-slate-700">← Back</button>
          </div>
          {phase === 'select' && (
            <div>
              <p className="text-slate-300 mb-6">Pick a vibe to start — the workspace will configure itself.</p>
              <div className="grid grid-cols-12 gap-6 min-h-[360px]">
                {BUBBLES.map((bubble) => (
                  <button
                    key={bubble.mode}
                    onClick={() => openPrompts(bubble.mode)}
                    className="col-span-6 md:col-span-4 lg:col-span-2 h-32 rounded-full bg-gradient-to-br from-pink-500/80 to-purple-600/80 backdrop-blur-sm border border-pink-400/40 hover:shadow-glowpink transition flex items-center justify-center text-center"
                    aria-label={`Explore ${bubble.label}`}
                    data-bubble
                  >
                    <div>
                      <div className="text-xl font-semibold text-white drop-shadow-sm">{bubble.icon} {bubble.label}</div>
                      <div className="text-xs text-pink-50/80 mt-1">{bubble.tag}</div>
                    </div>
                  </button>
                ))}
              </div>
            </div>
          )}
          {phase === 'prompt' && mode && (
            <div>
              <p className="text-slate-300 mb-4">Pick a micro-prompt or write your own, then begin.</p>
              <div className="grid grid-cols-12 gap-3 mb-4">
                {PROMPTS_BY_MODE[mode].map((prompt) => (
                  <button
                    key={prompt}
                    onClick={() => begin(prompt)}
                    className="col-span-12 md:col-span-6 lg:col-span-4 text-left px-3 py-3 rounded-xl bg-slate-900/60 border border-slate-700 hover:bg-slate-800 text-slate-200"
                  >
                    {prompt}
                  </button>
                ))}
              </div>
              <div className="flex flex-col md:flex-row gap-2">
                <input
                  value={seed}
                  onChange={(event) => setSeed(event.target.value)}
                  placeholder="or type your own seed..."
                  className="flex-1 bg-slate-950/60 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-pink-400"
                />
                <button onClick={() => begin(seed)} className="px-5 py-3 rounded-lg bg-pink-500 hover:bg-pink-400 text-white font-medium">Begin</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    function SurpriseMode({ onBack, openWorkspace }) {
      const [rolled, setRolled] = useState(null);

      const roll = () => {
        const modes = Object.keys(PROMPTS_BY_MODE);
        const mode = randomItem(modes);
        const seed = randomItem(PROMPTS_BY_MODE[mode]);
        const challenge = '10-minute Flow';
        setRolled({ mode, seed, challenge });
      };

      useEffect(() => {
        roll();
      }, []);

      const start = () => {
        if (!rolled) return;
        openWorkspace({ mode: rolled.mode, confidence: 0.8, tokensMatched: ['surprise'] }, rolled.seed, true);
        ANALYTICS('intent_detected', { mode: rolled.mode });
        ANALYTICS('workspace_opened', { mode: rolled.mode });
      };

      return (
        <div className="min-h-[60vh] w-full flex flex-col">
          <div className="flex items-center justify-between mb-6">
            <div className="text-2xl font-semibold text-violet-300">Surprise Me</div>
            <button onClick={onBack} className="px-3 py-1.5 rounded-md bg-slate-800 border border-slate-700 hover:bg-slate-700">← Back</button>
          </div>
          {rolled && (
            <div className="max-w-2xl bg-slate-900/60 border border-violet-600/40 rounded-3xl p-8 shadow-xl">
              <div className="text-sm uppercase tracking-widest text-violet-300 mb-2">🎲 We rolled:</div>
              <div className="text-3xl font-semibold text-slate-100 mb-4">{rolled.mode.toUpperCase()} + “{rolled.seed}”</div>
              <p className="text-slate-300 mb-6">Challenge: <span className="text-violet-200 font-medium">{rolled.challenge}</span>. Timer will be primed to 10:00 when you enter the workspace.</p>
              <div className="flex flex-wrap gap-3">
                <button onClick={start} className="px-5 py-3 rounded-lg bg-violet-500 hover:bg-violet-400 text-white font-medium">Start</button>
                <button onClick={roll} className="px-5 py-3 rounded-lg bg-slate-800 border border-slate-600 hover:bg-slate-700">Reroll</button>
                <button onClick={onBack} className="px-5 py-3 rounded-lg bg-slate-900 border border-slate-700 hover:bg-slate-800">Back</button>
              </div>
            </div>
          )}
          {!rolled && (
            <div className="text-slate-400">Rolling a surprise seed...</div>
          )}
        </div>
      );
    }

    function FlowTimerControl({ timer, mode }) {
      const { seconds, formatted, running, start, pause, reset } = timer;
      useEffect(() => {
        if (seconds === 0) {
          ANALYTICS('flow_completed', { mode });
        }
      }, [seconds, mode]);
      return (
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3" aria-live="polite">
          <div className="text-3xl font-semibold text-teal-300 tracking-wide">{formatted}</div>
          <div className="flex gap-2">
            {seconds === 0 ? (
              <button onClick={reset} className="px-4 py-2 rounded-md bg-teal-600 hover:bg-teal-500 text-white">Again?</button>
            ) : running ? (
              <>
                <button onClick={() => { pause(); }} className="px-4 py-2 rounded-md bg-slate-700 hover:bg-slate-600 text-white">Pause</button>
                <button onClick={() => { reset(); }} className="px-4 py-2 rounded-md bg-slate-800 border border-slate-600 hover:bg-slate-700">Reset</button>
              </>
            ) : (
              <>
                <button onClick={() => { start(); ANALYTICS('flow_started', { mode }); }} className="px-4 py-2 rounded-md bg-teal-600 hover:bg-teal-500 text-white">Start Flow</button>
                <button onClick={() => { reset(); }} className="px-4 py-2 rounded-md bg-slate-800 border border-slate-600 hover:bg-slate-700">Reset</button>
              </>
            )}
          </div>
        </div>
      );
    }

    function ConfiguredWorkspace({ intent, userText, onReturn, initialSeed = '', forceTimerStart = false }) {
      const accent = useMemo(() => ({
        idea: 'teal',
        character: 'pink',
        world: 'cyan',
        plot: 'amber',
        scene: 'indigo',
        block: 'rose',
      }[intent.mode] || 'teal'), [intent.mode]);

      const accentText = useMemo(() => ({
        teal: 'text-teal-300',
        pink: 'text-pink-300',
        cyan: 'text-cyan-300',
        amber: 'text-amber-300',
        indigo: 'text-indigo-300',
        rose: 'text-rose-300',
      }[accent] || 'text-teal-300'), [accent]);

      const [coreText, setCoreText] = useState(userText || initialSeed || '');
      const [note, setNote] = useState('');
      const [mapMode, setMapMode] = useState(false);
      const [aiAssist, setAiAssist] = useState(false);
      const [ambient, setAmbient] = useState('off');
      const [seeds, setSeeds] = useState(() => seedBank.load());
      const timer = useFlowTimer(600);
      const analyticsModeRef = useRef(intent.mode);

      useEffect(() => {
        if (forceTimerStart) {
          timer.start();
        }
      }, [forceTimerStart]);

      useEffect(() => {
        const recent = seedBank.load();
        setSeeds(recent);
      }, []);

      useEffect(() => {
        const audioElements = document.querySelectorAll('[data-ambient-sound]');
        audioElements.forEach((audio) => {
          if (ambient === audio.dataset.ambientSound) {
            audio.volume = 0.2;
            audio.loop = true;
            audio.play().catch(() => {});
          } else {
            audio.pause();
          }
        });
      }, [ambient]);

      const saveSeed = () => {
        const payload = {
          text: note || coreText || userText || '(no text yet)',
          mode: intent.mode,
          timestamp: new Date().toISOString(),
        };
        const updated = seedBank.save(payload);
        setSeeds(updated);
      };

      const accentBorder = useMemo(() => ({
        teal: 'border-teal-500/60',
        pink: 'border-pink-500/60',
        cyan: 'border-cyan-500/60',
        amber: 'border-amber-500/60',
        indigo: 'border-indigo-500/60',
        rose: 'border-rose-500/60',
      }[accent] || 'border-teal-500/60'), [accent]);

      const sparkActions = {
        idea: [
          { label: '🎲 Shuffle premise', onClick: () => setCoreText(randomPremise()) },
          { label: '🧩 Combine two concepts', onClick: () => setCoreText(randomConceptPair()) },
          { label: '🔀 What-if twist', onClick: () => setCoreText(randomTwist()) },
        ],
        character: [
          { label: '🧠 Secret fear', onClick: () => setCoreText('Secret fear: ') },
          { label: '🧭 Moral dilemma', onClick: () => setCoreText('Moral dilemma: ') },
          { label: '🕰 Past wound', onClick: () => setCoreText('Past wound: ') },
        ],
        world: [
          { label: '🗺 Map a district', onClick: () => setCoreText('District sketch: ') },
          { label: '⚖️ Power hierarchy', onClick: () => setCoreText('Power hierarchy: ') },
          { label: '🔮 One strange rule', onClick: () => setCoreText('Strange rule: ') },
        ],
        plot: [
          { label: '📌 Inciting incident', onClick: () => setCoreText('Inciting incident: ') },
          { label: '⚔️ Midpoint reversal', onClick: () => setCoreText('Midpoint reversal: ') },
          { label: '🏁 Climax stakes', onClick: () => setCoreText('Climax stakes: ') },
        ],
        scene: [
          { label: '💬 Write only dialogue', onClick: () => setCoreText('Dialogue draft: ') },
          { label: '👃 Sensory detail pass', onClick: () => setCoreText('Sensory detail notes: ') },
          { label: '⬆ Raise tension', onClick: () => setCoreText('Escalation plan: ') },
        ],
        block: [
          { label: '⏱ 10‑min freewrite', onClick: () => setCoreText('Freewrite start: ') },
          { label: '🎲 Random seed', onClick: () => setCoreText(randomItem(PROMPTS_BY_MODE.block)) },
          { label: '🌱 Pull last saved seed', onClick: () => setCoreText((seeds.slice(-1)[0]?.text) || 'No seeds saved yet.') },
        ],
      };

      const accentGradient = useMemo(() => ({
        teal: 'from-teal-500/40 to-teal-400/20',
        pink: 'from-pink-500/40 to-purple-500/20',
        cyan: 'from-cyan-500/40 to-blue-500/20',
        amber: 'from-amber-500/40 to-orange-500/20',
        indigo: 'from-indigo-500/40 to-purple-500/20',
        rose: 'from-rose-500/40 to-pink-500/20',
      }[accent] || 'from-teal-500/40 to-teal-400/20'), [accent]);

      return (
        <div className="flex flex-col gap-6">
          <section className={`rounded-3xl border ${accentBorder} bg-slate-900/70 backdrop-blur-sm p-6`}> 
            <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div>
                <h2 className={`text-2xl font-semibold ${accentText}`}>Workspace: {intent.mode.toUpperCase()}</h2>
                <p className="text-slate-400 text-sm">Configured from your request: <span className="text-slate-200">“{userText || initialSeed || '(no input)'}”</span></p>
              </div>
              <div className="flex flex-wrap gap-3">
                <button
                  onClick={() => setAiAssist((value) => !value)}
                  className="px-3 py-2 rounded-lg border border-slate-700 bg-slate-800/80 text-sm"
                  title="AI appears after your first draft (to protect your creativity)."
                >
                  AI Assist: {aiAssist ? 'On' : 'Off'}
                </button>
                <div className="relative">
                  <select
                    value={ambient}
                    onChange={(event) => setAmbient(event.target.value)}
                    className="px-3 py-2 rounded-lg border border-slate-700 bg-slate-800/80 text-sm pr-8"
                    title="Ambient sound coming soon."
                  >
                    <option value="off">Ambient Sound: Off</option>
                    <option value="cafe">Café (soon)</option>
                    <option value="wind">Wind (soon)</option>
                  </select>
                </div>
                <div>
                  <select disabled className="px-3 py-2 rounded-lg border border-slate-700 bg-slate-900/60 text-sm text-slate-500" title="Exports unlock soon.">
                    <option>Export (soon)</option>
                    <option>Markdown</option>
                    <option>.txt</option>
                  </select>
                </div>
              </div>
            </div>
          </section>

          <section className="grid grid-cols-12 gap-6">
            <aside className="col-span-12 md:col-span-3 bg-slate-900/60 rounded-2xl p-5 border border-slate-700">
              <h3 className="font-medium mb-3 text-slate-200">Spark</h3>
              <div className="space-y-2 text-sm text-slate-300">
                {(sparkActions[intent.mode] || []).map((action) => (
                  <button key={action.label} onClick={action.onClick} className="w-full py-2 rounded-md bg-slate-800 hover:bg-slate-700 border border-slate-700">
                    {action.label}
                  </button>
                ))}
              </div>
              <div className="mt-6 text-xs text-slate-500">
                Gamification (word count & badges) coming soon.
              </div>
            </aside>

            <section className="col-span-12 md:col-span-6 bg-slate-800/40 rounded-2xl border border-slate-700 shadow-md p-5 flex flex-col gap-4">
              <div className={`rounded-xl p-4 border border-slate-700 bg-gradient-to-br ${accentGradient}`}>
                <FlowTimerControl timer={timer} mode={intent.mode} />
              </div>
              <div className="flex gap-3">
                <button
                  className="px-4 py-2 bg-teal-600 hover:bg-teal-500 rounded-md text-white"
                  onClick={() => setMapMode(false)}
                >
                  Write
                </button>
                <button
                  className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-md text-white"
                  onClick={() => setMapMode(true)}
                  title="Idea Map mode is a simple node list for now."
                >
                  Map (beta)
                </button>
                <button
                  className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-md text-white"
                  title="AI-assisted expansion coming after your first draft."
                  disabled={!aiAssist}
                >
                  Expand (AI)
                </button>
              </div>
              {!mapMode ? (
                <textarea
                  value={coreText}
                  onChange={(event) => setCoreText(event.target.value)}
                  placeholder="Start writing..."
                  className="flex-1 bg-slate-950/60 rounded-lg border border-slate-700 p-4 text-slate-100 resize-none focus:outline-none focus:ring-2 focus:ring-teal-500 min-h-[260px]"
                />
              ) : (
                <div className="flex-1 bg-slate-950/60 rounded-lg border border-dashed border-slate-700 p-4 text-slate-300 min-h-[260px]">
                  <p className="font-medium text-slate-200 mb-3">Idea Map (early stub)</p>
                  <ul className="list-disc list-inside space-y-1 text-sm">
                    <li>Drag-to-connect nodes coming soon.</li>
                    <li>Add nodes by outlining bullet points.</li>
                    <li>TODO: Persist relationships + export map.</li>
                  </ul>
                </div>
              )}
            </section>

            <aside className="col-span-12 md:col-span-3 bg-slate-900/60 rounded-2xl p-5 border border-slate-700 flex flex-col gap-4">
              <div>
                <h3 className="font-medium mb-2 text-slate-200">Momentum</h3>
                <div className="bg-slate-950/60 p-3 rounded-md text-slate-200 mb-3 border border-slate-700 text-sm">
                  Next step for <span className="font-semibold">{intent.mode}</span>: {nextStepHint(intent.mode)}
                </div>
                <textarea
                  value={note}
                  onChange={(event) => setNote(event.target.value)}
                  placeholder="Quick journal note..."
                  className="w-full h-24 bg-slate-950/60 rounded-lg border border-slate-700 p-3 text-slate-100 mb-3 resize-none"
                />
                <button onClick={saveSeed} className="w-full bg-teal-600 hover:bg-teal-500 py-2 rounded-md text-white">🌱 Save Seed</button>
              </div>
              <div className="text-xs text-slate-500">Recent Seeds</div>
              <div className="bg-slate-950/60 border border-slate-800 rounded-lg p-3 space-y-2 max-h-40 overflow-auto text-xs text-slate-300">
                {seeds.slice(-3).reverse().map((seed) => (
                  <div key={seed.timestamp} className="border border-slate-800 rounded-md p-2">
                    <div className="text-[0.65rem] uppercase tracking-widest text-slate-500">{seed.mode}</div>
                    <div className="mt-1 text-slate-200">{seed.text}</div>
                    <div className="text-[0.6rem] text-slate-500 mt-1">{new Date(seed.timestamp).toLocaleString()}</div>
                  </div>
                ))}
                {seeds.length === 0 && <div className="text-slate-500 text-sm">No seeds yet — save your first one!</div>}
              </div>
            </aside>
          </section>

          <audio data-ambient-sound="cafe" src="https://cdn.jsdelivr.net/gh/anars/blank-audio/10-seconds-of-silence.mp3" hidden></audio>
          <audio data-ambient-sound="wind" src="https://cdn.jsdelivr.net/gh/anars/blank-audio/10-seconds-of-silence.mp3" hidden></audio>
        </div>
      );
    }

    function DevAsserts() {
      useEffect(() => {
        console.assert(detectIntent('please give me a plot twist').mode === 'plot', "Expected 'plot' for plot twist");
        console.assert(detectIntent('create a character with a dark backstory').mode === 'character', "Expected 'character' for backstory");
        console.assert(detectIntent('world rules and a city map').mode === 'world', "Expected 'world' for world rules");
        console.assert(detectIntent('dialogue for a tense scene').mode === 'scene', "Expected 'scene' for dialogue/scene");
        console.assert(detectIntent('I am stuck and need help').mode === 'block', "Expected 'block' for stuck/help");
        console.assert(['idea','character','world','plot','scene','block'].includes(detectIntent('').mode), 'DetectIntent should always return a valid mode');
      }, []);
      return null;
    }

    function App() {
      const [stage, setStage] = useState('gateway');
      const [fade, setFade] = useState(false);
      const [workspaceConfig, setWorkspaceConfig] = useState(null);

      const go = (next) => {
        setFade(true);
        setTimeout(() => {
          setStage(next);
          setFade(false);
        }, 220);
      };

      const openWorkspace = (intent, seed, forceTimerStart = false) => {
        setWorkspaceConfig({ intent, seed, forceTimerStart });
        go('workspace');
      };

      let content = null;
      if (stage === 'gateway') {
        content = <Gateway onSelect={go} />;
      } else if (stage === 'type') {
        content = <TypeMode onBack={() => go('gateway')} openWorkspace={openWorkspace} />;
      } else if (stage === 'explore') {
        content = <ExploreMode onBack={() => go('gateway')} openWorkspace={openWorkspace} />;
      } else if (stage === 'surprise') {
        content = <SurpriseMode onBack={() => go('gateway')} openWorkspace={openWorkspace} />;
      } else if (stage === 'workspace' && workspaceConfig) {
        content = (
          <ConfiguredWorkspace
            intent={workspaceConfig.intent}
            userText={workspaceConfig.seed}
            onReturn={() => go('gateway')}
            initialSeed={workspaceConfig.seed}
            forceTimerStart={workspaceConfig.forceTimerStart}
          />
        );
      }

      return (
        <StageFrame stage={stage} onNavigate={go} fade={fade}>
          {content}
          <DevAsserts />
        </StageFrame>
      );
    }

    ReactDOM.createRoot(document.getElementById('app')).render(<App />);
  </script>
  <script type="module" src="/assets/main.js"></script>
</body>
</html>
