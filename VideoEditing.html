<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Video &amp; Editing ‚Äî StudioOrganize</title>
  <meta
    name="description"
    content="Video &amp; Editing timelines keep beats, audio, and storyboard previews aligned with the StudioOrganize writer."
  />
  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="stylesheet" href="/storyboard/ai-generation.css" />
  <link rel="icon" type="image/webp" href="/assets/img/studioorganizeFavicon.webp" />
</head>
<body>
  <header class="nav">
    <div class="brand-with-logo">
      <a class="brand brand--with-logo" href="/">
        <span class="brand__logo" aria-hidden="true"></span>
        <span class="sr-only">StudioOrganize</span>
      </a>
    </div>
    <nav class="menu">
      <a class="menu__link menu__link--plain menu__link--icon" href="/">
        <span aria-hidden="true">üè†</span>
        <span class="sr-only">Home</span>
      </a>
      <div class="dropdown">
        <button class="dropbtn dropbtn--plain" type="button">Use Cases</button>
        <div class="dropdown-content">
          <a href="/use-cases/">All Use Cases</a>
          <a href="/use-cases/generate-ideas.html">Generate Ideas</a>
          <a href="/use-cases/screenplay.html">Screenplay Script</a>
          <a href="/use-cases/character-design.html">Character Design</a>
          <a href="/use-cases/set-design.html">Set / Production Design</a>
        </div>
      </div>
      <a class="menu__link menu__link--plain" href="https://finishthatstory.com" target="_blank" rel="noopener noreferrer">FinishThatStory.com</a>
      <div class="menu__actions">
        <button class="theme-toggle theme-toggle--icon" type="button" data-theme-toggle aria-pressed="false">
          <span class="sr-only">Toggle theme</span>
          <span class="theme-toggle__icon" aria-hidden="true" data-theme-icon>‚òÄÔ∏è</span>
        </button>
        <a class="menu__cta" href="https://studioorganize.com/supabase-test.html" data-auth-link data-auth-intent="signin">Sign in</a>
        <div class="dropdown" data-account-menu hidden>
          <button class="menu__cta" type="button" data-account-button>Account</button>
          <div class="dropdown-content">
            <a href="/account.html">My Creator Page</a>
            <a href="/product/personal.html">My Subscription</a>
            <a href="#" data-account-logout>Log out</a>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main class="section">
    <style>
      html, body { height: 100%; font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial; }
      body {
        color: var(--ink);
        background: radial-gradient(circle at top right, rgba(79,123,255,0.08), transparent 35%), var(--surface);
        --nav-height: 72px;
      }
      main.section { flex: 1; display: flex; flex-direction: column; width: 100%; max-width: none; padding: 0; margin: 0; }
      .app { display: grid; grid-template-rows: 56px 1fr; flex: 1; min-height: 0; transition: transform .35s ease; }
      .topbar { display: flex; align-items: center; gap: 12px; padding: 10px 16px; background: var(--panel); border-bottom: 1px solid var(--ring); }
      .topbar h1 { font-size: 18px; font-weight: 600; margin: 0; letter-spacing: 0.1px; }
      .topbar .badge { font-size: 11px; letter-spacing: .3px; text-transform: uppercase; background: rgba(79,123,255,0.12); color: var(--acc); border: 1px solid rgba(79,123,255,0.4); border-radius: 999px; padding: 3px 8px; }
      .spacer { flex: 1; }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: var(--chip);
        color: var(--ink);
        border: 1px solid var(--ring);
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        line-height: 1.2;
        transition: background .2s ease, color .2s ease, border-color .2s ease, box-shadow .2s ease;
      }
      .btn svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
        stroke-width: 1.6;
        fill: none;
      }
      .btn svg path,
      .btn svg rect,
      .btn svg circle,
      .btn svg polyline,
      .btn svg line {
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .btn:hover { border-color: var(--acc); }
      .btn:focus-visible { outline: none; border-color: var(--acc); box-shadow: 0 0 0 2px rgba(79,123,255,0.18); }
      .btn.active { background: var(--acc); border-color: var(--acc); color: var(--active-tab-text); font-weight: 600; }
      .btn.btn-primary { background: var(--acc); border-color: var(--acc); color: var(--active-tab-text); font-weight: 600; }
      .topbar-group { display: flex; gap: 6px; align-items: center; }
      .scene-carousel-wrapper {
        --scene-carousel-active-scale: 0.96;
        --scene-carousel-adjacent-scale: 0.68;
        --scene-carousel-far-scale: 0.52;
        --scene-carousel-distant-scale: 0.42;
        --scene-carousel-horizon-scale: 0.34;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px 20px 10px;
        background: linear-gradient(180deg, rgba(79,123,255,0.08), transparent);
        border-bottom: 1px solid var(--ring);
      }
      .scene-pair-lab {
        display: grid;
        gap: 14px;
        padding: 18px 20px 14px;
        margin-bottom: 12px;
        border: 1px solid var(--ring);
        border-radius: 16px;
        background: linear-gradient(135deg, rgba(79,123,255,0.12), rgba(79,123,255,0.04));
        box-shadow: 0 18px 36px rgba(15,23,42,0.18);
      }
      .scene-pair-lab__header {
        margin: 0;
        font-size: 15px;
        font-weight: 600;
        letter-spacing: 0.2px;
        color: var(--ink);
      }
      .scene-pair-row {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .scene-pair-row--all { min-height: 48px; }
      .scene-pair-row--pair {
        min-height: clamp(240px, 32vw, 320px);
      }
      .scene-pair-row--focus {
        min-height: auto;
        margin-top: -20px;
      }
      .scene-pair-grid {
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: minmax(52px, 1fr);
        gap: 8px;
        list-style: none;
        padding: 0;
        margin: 0;
        overflow-x: auto;
        scroll-snap-type: x proximity;
      }
      .scene-pair-grid__item { scroll-snap-align: center; }
      .scene-pair-grid__button {
        width: 100%;
        min-height: 48px;
        border-radius: 12px;
        border: 1px solid var(--ring);
        background: var(--panel);
        color: var(--ink);
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.2px;
        padding: 6px 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        cursor: pointer;
        transition: border-color .2s ease, background .2s ease, box-shadow .2s ease, transform .2s ease;
      }
      .scene-pair-grid__button span {
        display: block;
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .scene-pair-grid__button span:last-child {
        font-size: 11px;
        font-weight: 500;
        color: var(--muted);
      }
      .scene-pair-grid__button:hover,
      .scene-pair-grid__button:focus-visible {
        outline: none;
        border-color: var(--acc);
        box-shadow: 0 10px 24px rgba(79,123,255,0.18);
        transform: translateY(-1px);
      }
      .scene-pair-grid__button.is-active {
        border-color: rgba(79,123,255,0.65);
        background: rgba(79,123,255,0.12);
      }
      .scene-pair-grid__button.is-focused {
        border-color: var(--acc);
        background: rgba(79,123,255,0.22);
        color: var(--acc);
      }
      .scene-pair-grid__empty {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: var(--muted);
        padding: 12px 0;
      }
      .scene-pair-feature {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: stretch;
        gap: 12px;
      }
      .scene-pair-nav {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        border: 1px solid var(--ring);
        background: var(--panel);
        color: var(--ink);
        font-size: 20px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: border-color .2s ease, background .2s ease, box-shadow .2s ease, transform .2s ease;
      }
      .scene-pair-nav:hover,
      .scene-pair-nav:focus-visible {
        outline: none;
        border-color: var(--acc);
        background: rgba(79,123,255,0.16);
        box-shadow: 0 12px 26px rgba(79,123,255,0.18);
        transform: translateY(-1px);
      }
      .scene-pair-nav:disabled {
        opacity: 0.45;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .scene-pair-cards {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }
      .scene-pair-card {
        border-radius: 16px;
        background: var(--card);
        border: 1px solid var(--ring);
        overflow: hidden;
        box-shadow: 0 14px 32px rgba(8,15,28,0.22);
        transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease;
      }
      .scene-pair-card--active {
        border-color: var(--acc);
        box-shadow: 0 16px 34px rgba(79,123,255,0.25);
      }
      .scene-pair-card--empty {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 18px;
        border-style: dashed;
        background: rgba(148,163,184,0.08);
      }
      .scene-pair-card--empty p {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
        text-align: center;
      }
      .scene-pair-card__button {
        width: 100%;
        padding: 18px 18px 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
        border: none;
        background: transparent;
        color: inherit;
        text-align: left;
        cursor: pointer;
      }
      .scene-pair-card__button:focus-visible {
        outline: none;
      }
      .scene-pair-card__eyebrow {
        font-size: 11px;
        letter-spacing: 0.3px;
        text-transform: uppercase;
        color: var(--muted);
      }
      .scene-pair-card__title {
        font-size: 17px;
        font-weight: 600;
        letter-spacing: 0.2px;
        margin: 0;
      }
      .scene-pair-card__meta {
        font-size: 13px;
        color: var(--muted);
        margin: 0;
      }
      .scene-pair-focus {
        display: grid;
        grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
        gap: 16px;
        width: 100%;
        margin: 0;
        padding: 20px;
        border-radius: 18px;
        background: var(--card);
        border: 1px solid var(--ring);
        box-shadow: 0 18px 40px rgba(8,15,28,0.24);
      }
      .scene-pair-focus__image {
        position: relative;
        border-radius: 18px;
        overflow: hidden;
        background: linear-gradient(135deg, rgba(79,123,255,0.18), rgba(79,123,255,0.04));
      }
      .scene-pair-focus__image::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.12);
        pointer-events: none;
      }
      .scene-pair-focus__image img {
        width: 100%;
        height: 100%;
        aspect-ratio: 3 / 2;
        object-fit: cover;
        display: block;
      }
      .scene-pair-focus__caption {
        display: flex;
        flex-direction: column;
        gap: 10px;
        justify-content: center;
      }
      .scene-pair-focus__eyebrow {
        font-size: 12px;
        letter-spacing: 0.3px;
        text-transform: uppercase;
        color: var(--muted);
        margin: 0;
      }
      .scene-pair-focus__title {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
        letter-spacing: 0.2px;
      }
      .scene-pair-focus__meta {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
      }
      .scene-pair-actions {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px;
      }
      .scene-pair-select {
        position: relative;
        display: inline-flex;
        align-items: center;
      }
      .scene-pair-select select {
        appearance: none;
        border-radius: 10px;
        border: 1px solid var(--ring);
        background: var(--panel);
        color: var(--ink);
        font-size: 13px;
        font-weight: 500;
        padding: 10px 34px 10px 12px;
        cursor: pointer;
        transition: border-color .2s ease, box-shadow .2s ease;
      }
      .scene-pair-select select:focus-visible {
        outline: none;
        border-color: var(--acc);
        box-shadow: 0 0 0 2px rgba(79,123,255,0.2);
      }
      .scene-pair-select::after {
        content: '‚ñæ';
        position: absolute;
        right: 12px;
        pointer-events: none;
        font-size: 12px;
        color: var(--muted);
      }
      .scene-pair-lab--empty .scene-pair-focus,
      .scene-pair-lab--empty .scene-pair-feature,
      .scene-pair-lab--empty .scene-pair-actions {
        opacity: 0.6;
      }
      @media (max-width: 1024px) {
        .scene-pair-focus {
          grid-template-columns: 1fr;
          padding: 18px;
        }
        .scene-pair-focus__image img { aspect-ratio: 16 / 9; }
      }
      @media (max-width: 768px) {
        .scene-pair-lab {
          padding: 16px;
        }
        .scene-pair-feature {
          grid-template-columns: 1fr;
        }
        .scene-pair-nav {
          width: 44px;
          height: 44px;
        }
        .scene-pair-cards {
          grid-template-columns: 1fr;
        }
      }
      .scene-carousel-wrapper.scene-carousel--zoomed {
        --scene-carousel-active-scale: 1.04;
        --scene-carousel-adjacent-scale: 0.78;
        --scene-carousel-far-scale: 0.62;
        --scene-carousel-distant-scale: 0.5;
        --scene-carousel-horizon-scale: 0.4;
      }
      .scene-carousel-wrapper:focus-within { outline: 2px solid rgba(79,123,255,0.28); outline-offset: 6px; box-shadow: none; border-radius: 0; }
      .scene-carousel { display: flex; align-items: center; gap: 14px; }
      .scene-carousel__nav { width: 44px; height: 44px; border-radius: 50%; border: 1px solid var(--ring); background: var(--panel); color: var(--ink); display: inline-flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 16px 32px rgba(8,15,28,0.28); transition: transform .2s ease, border-color .2s ease, box-shadow .2s ease, background .2s ease; font-size: 0; }
      .scene-carousel__nav:hover { transform: translateY(-1px); border-color: var(--acc); background: linear-gradient(135deg, rgba(79,123,255,0.2), rgba(79,123,255,0.08)); }
      .scene-carousel__nav:focus-visible { outline: 2px solid var(--acc); outline-offset: 3px; }
      .scene-carousel__nav:disabled { opacity: 0.45; cursor: not-allowed; transform: none; box-shadow: none; background: var(--chip); }
      .scene-carousel__viewport { position: relative; flex: 1; overflow: hidden; border-radius: 0; box-shadow: none; border: none; background: transparent; padding: 12px 0 8px; perspective: 1400px; transform-style: preserve-3d; touch-action: pan-y; cursor: grab; }
      .scene-carousel__viewport.is-dragging { cursor: grabbing; }
      .scene-carousel__track {
        position: relative;
        display: grid;
        place-items: center;
        width: 100%;
        list-style: none;
        padding: 0;
        margin: 0;
        min-height: clamp(380px, 50vw, 520px);
        transform: translateX(var(--scene-carousel-drag-offset, 0));
        transition: transform var(--scene-carousel-drag-transition, .45s cubic-bezier(0.32, 0.72, 0, 1));
        will-change: transform;
        transform-style: preserve-3d;
      }
      .scene-carousel-wrapper.scene-carousel--zoomed .scene-carousel__track { min-height: clamp(460px, 60vw, 600px); }
      .scene-carousel__slide { position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; pointer-events: none; transform-style: preserve-3d; }
      .scene-carousel__slide-button { border: none; background: transparent; padding: 0; margin: 0; width: 100%; display: flex; flex-direction: column; cursor: pointer; text-align: left; color: inherit; pointer-events: auto; position: relative; transform-style: preserve-3d; transition: transform .45s ease; }
      .scene-carousel__slide-button:focus-visible { outline: none; }
      .scene-carousel__figure { display: flex; flex-direction: column; align-items: center; gap: 14px; height: 100%; max-width: clamp(520px, 82vw, 880px); margin: 0 auto; background: transparent; border-radius: 0; overflow: visible; transform-origin: center bottom; transform: scale(var(--scene-carousel-horizon-scale)); opacity: 0.18; filter: saturate(0.7) blur(0.45px); box-shadow: none; transition: transform .45s ease, opacity .45s ease, filter .45s ease; }
      .scene-carousel__image-wrapper { position: relative; width: 100%; border-radius: 20px; overflow: hidden; }
      .scene-carousel__image { width: 100%; aspect-ratio: 3 / 2; object-fit: cover; border: none; transition: transform .3s ease; display: block; border-radius: 20px; box-shadow: none; }
      .scene-carousel__image-strip { position: absolute; right: 16px; bottom: 16px; display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: rgba(15,23,42,0.72); backdrop-filter: blur(12px); box-shadow: 0 10px 24px rgba(8,15,28,0.38); }
      .scene-carousel__thumb { width: 44px; height: 44px; border-radius: 10px; object-fit: cover; border: 1px solid rgba(255,255,255,0.55); box-shadow: 0 8px 18px rgba(15,23,42,0.45); }
      .scene-carousel__thumb-count { display: inline-flex; align-items: center; justify-content: center; min-width: 38px; height: 38px; padding: 0 12px; border-radius: 999px; font-size: 12px; font-weight: 600; letter-spacing: .3px; color: rgba(255,255,255,0.92); background: rgba(79,123,255,0.55); border: 1px solid rgba(148,163,184,0.45); box-shadow: 0 8px 18px rgba(15,23,42,0.45); }
      .scene-carousel__thumb-count[aria-hidden="true"] { pointer-events: none; }
      .scene-carousel__caption { margin: 0 auto; padding: 0; display: flex; flex-direction: column; gap: 6px; text-align: center; max-width: clamp(520px, 82vw, 880px); }
      .scene-carousel__title { font-size: 18px; font-weight: 600; letter-spacing: 0.2px; margin: 0; display: flex; gap: 10px; align-items: baseline; }
      .scene-carousel__title small { font-size: 12px; letter-spacing: .25px; text-transform: uppercase; color: var(--muted); }
      .scene-carousel__description { margin: 0; font-size: 14px; color: var(--muted); line-height: 1.45; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
      .scene-carousel__meta { font-size: 12px; color: var(--muted); margin: 0; }
      .scene-carousel__slide--active .scene-carousel__figure { transform: scale(var(--scene-carousel-active-scale)); opacity: 1; filter: none; }
      .scene-carousel-wrapper.scene-carousel--zoomed .scene-carousel__slide--active .scene-carousel__image { transform: scale(1.02); }
      .scene-carousel__slide--previous .scene-carousel__figure,
      .scene-carousel__slide--next .scene-carousel__figure { opacity: 0.48; filter: saturate(0.62) blur(0.55px); }
      .scene-carousel__slide--previous .scene-carousel__figure { transform: translateX(-82%) scale(var(--scene-carousel-adjacent-scale)) rotateY(-14deg); }
      .scene-carousel__slide--next .scene-carousel__figure { transform: translateX(82%) scale(var(--scene-carousel-adjacent-scale)) rotateY(14deg); }
      .scene-carousel__slide--previous-2 .scene-carousel__figure,
      .scene-carousel__slide--next-2 .scene-carousel__figure { opacity: 0.24; filter: saturate(0.5) blur(0.9px); }
      .scene-carousel__slide--previous-2 .scene-carousel__figure { transform: translateX(-158%) scale(var(--scene-carousel-far-scale)) rotateY(-20deg); }
      .scene-carousel__slide--next-2 .scene-carousel__figure { transform: translateX(158%) scale(var(--scene-carousel-far-scale)) rotateY(20deg); }
      .scene-carousel__slide--previous-3 .scene-carousel__figure,
      .scene-carousel__slide--next-3 .scene-carousel__figure { opacity: 0.16; filter: saturate(0.42) blur(1.3px); }
      .scene-carousel__slide--previous-3 .scene-carousel__figure { transform: translateX(-228%) scale(var(--scene-carousel-distant-scale)) rotateY(-24deg); }
      .scene-carousel__slide--next-3 .scene-carousel__figure { transform: translateX(228%) scale(var(--scene-carousel-distant-scale)) rotateY(24deg); }
      .scene-carousel__slide--previous-4 .scene-carousel__figure,
      .scene-carousel__slide--next-4 .scene-carousel__figure { opacity: 0.12; filter: saturate(0.36) blur(1.7px); }
      .scene-carousel__slide--previous-4 .scene-carousel__figure { transform: translateX(-298%) scale(var(--scene-carousel-horizon-scale)) rotateY(-28deg); }
      .scene-carousel__slide--next-4 .scene-carousel__figure { transform: translateX(298%) scale(var(--scene-carousel-horizon-scale)) rotateY(28deg); }
      .scene-carousel__slide--previous-5 .scene-carousel__figure,
      .scene-carousel__slide--next-5 .scene-carousel__figure { opacity: 0.08; filter: saturate(0.3) blur(2.1px); }
      .scene-carousel__slide--previous-5 .scene-carousel__figure { transform: translateX(-368%) scale(calc(var(--scene-carousel-horizon-scale) * 0.92)) rotateY(-32deg); }
      .scene-carousel__slide--next-5 .scene-carousel__figure { transform: translateX(368%) scale(calc(var(--scene-carousel-horizon-scale) * 0.92)) rotateY(32deg); }
      .scene-carousel__slide--offscreen .scene-carousel__figure { opacity: 0; filter: saturate(0.2) blur(2.4px); transform: translateX(0) scale(calc(var(--scene-carousel-horizon-scale) * 0.8)); pointer-events: none; }
      .scene-carousel__slide-button:hover .scene-carousel__image { transform: scale(1.02); }
      .scene-carousel__slide-button:focus-visible .scene-carousel__image { transform: scale(1.02); }
      .scene-carousel__zoom { position: absolute; top: 12px; right: 12px; border: none; border-radius: 999px; background: rgba(12,19,33,0.58); color: var(--active-tab-text, #ffffff); display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; font-size: 12px; font-weight: 600; letter-spacing: .3px; text-transform: uppercase; cursor: pointer; transition: background .2s ease, transform .2s ease; }
      .scene-carousel__zoom:hover { background: rgba(79,123,255,0.8); transform: translateY(-1px); }
      .scene-carousel__zoom:focus-visible { outline: 2px solid var(--acc); outline-offset: 2px; }
      .scene-carousel__zoom-icon { font-size: 14px; }
      .scene-carousel__dots { display: flex; gap: 10px; justify-content: center; align-items: center; padding-bottom: 4px; }
      .scene-carousel__dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(79,123,255,0.4); background: rgba(79,123,255,0.12); padding: 0; cursor: pointer; transition: transform .2s ease, background .2s ease, border-color .2s ease; }
      .scene-carousel__dot[aria-selected="true"] { transform: scale(1.2); background: var(--acc); border-color: var(--acc); }
      .scene-carousel__dot:focus-visible { outline: 2px solid var(--acc); outline-offset: 3px; }
      .scene-carousel__empty { min-height: 220px; display: flex; align-items: center; justify-content: center; text-align: center; padding: 40px; font-size: 14px; color: var(--muted); }
      .scene-carousel__nav-icon { font-size: 24px; line-height: 1; }
      .scene-carousel-wrapper--compact {
        --scene-carousel-active-scale: 0.82;
        --scene-carousel-adjacent-scale: 0.58;
        --scene-carousel-far-scale: 0.46;
        --scene-carousel-distant-scale: 0.38;
        --scene-carousel-horizon-scale: 0.3;
        padding: 12px 14px 10px;
        border: 1px solid var(--ring);
        border-radius: 14px;
        background: var(--card);
        box-shadow: 0 14px 32px rgba(8,15,28,0.22);
        border-bottom: none;
      }
      .scene-carousel-wrapper--compact .scene-carousel { gap: 8px; }
      .scene-carousel-wrapper--compact .scene-carousel__nav { width: 32px; height: 32px; box-shadow: none; }
      .scene-carousel-wrapper--compact .scene-carousel__track { min-height: 180px; }
      .scene-carousel-wrapper--compact.scene-carousel--zoomed .scene-carousel__track { min-height: 220px; }
      .scene-carousel-wrapper--compact .scene-carousel__figure { max-width: 280px; gap: 10px; }
      .scene-carousel-wrapper--compact .scene-carousel__image-wrapper { border-radius: 12px; }
      .scene-carousel-wrapper--compact .scene-carousel__image { border-radius: 12px; }
      .scene-carousel-wrapper--compact .scene-carousel__caption { max-width: 260px; gap: 4px; font-size: 12px; }
      .scene-carousel-wrapper--compact .scene-carousel__title { font-size: 14px; }
      .scene-carousel-wrapper--compact .scene-carousel__description { font-size: 12px; -webkit-line-clamp: 2; }
      .scene-carousel-wrapper--compact .scene-carousel__meta { font-size: 11px; }
      .scene-carousel-wrapper--compact .scene-carousel__thumb { width: 36px; height: 36px; }
      .scene-carousel-wrapper--compact .scene-carousel__thumb-count { min-width: 32px; height: 32px; font-size: 11px; }
      .scene-carousel-wrapper--compact .scene-carousel__zoom { display: none; }
      .scene-carousel-wrapper--compact .scene-carousel__dots { justify-content: flex-end; padding-bottom: 0; padding-top: 6px; }
      .story-arc-columns > .scene-carousel-wrapper--compact { width: 100%; flex: 1 1 auto; }
      @media (max-width: 920px) {
        .scene-carousel-wrapper { padding: 16px 16px 10px; }
        .scene-carousel-wrapper--compact { padding: 12px 12px 8px; }
        .scene-carousel { gap: 10px; }
        .scene-carousel__nav { width: 38px; height: 38px; }
        .scene-carousel-wrapper--compact .scene-carousel__nav { width: 32px; height: 32px; }
        .scene-carousel__caption { padding: 16px 16px 18px; }
        .scene-carousel__image-strip { right: 12px; bottom: 12px; }
      }
      @media (max-width: 720px) {
        .scene-carousel { flex-direction: column; align-items: stretch; }
        .scene-carousel__nav { order: -1; align-self: flex-end; }
        .scene-carousel__nav--prev { align-self: flex-start; }
        .scene-carousel__viewport { border-radius: 0; }
        .scene-carousel-wrapper--compact .scene-carousel { flex-direction: row; align-items: center; }
        .scene-carousel-wrapper--compact .scene-carousel__nav { order: 0; align-self: center; }
      }
      @media (prefers-reduced-motion: reduce) {
        .scene-carousel__track { transition: none; }
        .scene-carousel__nav { transition: none; }
        .scene-carousel__dot { transition: none; }
      }
      .timeline-dock { position: relative; z-index: var(--timeline-dock-layer, 4); display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 14px 20px 6px; background: linear-gradient(180deg, var(--bg) 0%, transparent 90%); }
      .timeline-dock.floating { position: sticky; top: 0; }
      .timeline-dock__handle { order: 2; width: clamp(64px, 18vw, 110px); height: 10px; border-radius: 999px; border: none; padding: 0; background: var(--ring); cursor: pointer; transition: width .35s ease, background .3s ease, box-shadow .3s ease, opacity .2s ease, height .3s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.35); }
      .timeline-dock__handle:hover { background: var(--acc); }
      .timeline-dock__handle:focus-visible { outline: 2px solid var(--acc); outline-offset: 3px; }
      .timeline-dock.pinned .timeline-dock__handle { background: var(--acc); box-shadow: 0 8px 22px rgba(79,123,255,0.35); animation: timelineDockHandlePinnedRelax .35s ease forwards; animation-delay: 1s; }
      @keyframes timelineDockHandlePinnedRelax {
        from { background: var(--acc); box-shadow: 0 8px 22px rgba(79,123,255,0.35); height: 10px; opacity: 1; }
        to { background: var(--ring); box-shadow: 0 3px 10px rgba(0,0,0,0.22); height: 6px; opacity: 0.7; }
      }
      .timeline-dock.floating-hidden .timeline-dock__handle { opacity: 0.85; }
      .timeline-dock__shell { order: 1; width: min(1080px, 100%); background: var(--hud); border: 1px solid var(--ring); border-radius: 18px; box-shadow: 0 14px 34px rgba(8,15,28,0.32); overflow: hidden; transition: max-height .35s ease, box-shadow .35s ease, border-color .3s ease; max-height: 560px; margin: 0 auto; }
      .timeline-dock.floating-hidden .timeline-dock__shell { max-height: 0; border-color: transparent; box-shadow: none; }
      .timeline-dock__content { display: flex; flex-direction: column; gap: 12px; padding: 12px 16px 18px; opacity: 1; transform: translateY(0); transition: transform .35s ease, opacity .25s ease; }
      .timeline-dock.floating-hidden .timeline-dock__content { opacity: 0; transform: translateY(-18px); pointer-events: none; }
      .timeline-dock.floating-hidden { flex-direction: column-reverse; padding-top: 6px; padding-bottom: 0; gap: 6px; }
      .story-arc-layout { display: flex; flex-wrap: wrap; align-items: stretch; gap: 16px; }
      .story-arc-columns { flex: 1 1 280px; display: flex; flex-direction: column; gap: 12px; min-width: 0; }
      .story-arc-actions { display: flex; flex-direction: column; gap: 12px; align-items: flex-end; justify-content: center; min-width: 48px; }
      .story-arc-action { position: relative; }
      .story-arc-action-btn { width: 38px; height: 38px; border-radius: 999px; border: 1px solid var(--ring); background: var(--panel); color: var(--muted); display: inline-flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; cursor: pointer; transition: background .2s ease, border-color .2s ease, box-shadow .2s ease, transform .2s ease; box-shadow: 0 10px 22px rgba(8,15,28,0.16); }
      .story-arc-action-btn:hover { background: linear-gradient(135deg, rgba(79,123,255,0.2), rgba(79,123,255,0.08)); border-color: var(--acc); color: var(--ink); transform: translateY(-1px); }
      .story-arc-action-btn:focus-visible { outline: 2px solid var(--acc); outline-offset: 3px; }
      .story-arc-action-btn:active { transform: translateY(0); }
      .story-arc-action--menu:hover .story-arc-action-btn,
      .story-arc-action--menu:focus-within .story-arc-action-btn { background: linear-gradient(135deg, rgba(79,123,255,0.24), rgba(79,123,255,0.12)); border-color: var(--acc); color: var(--ink); }
      .story-arc-action-btn svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 1.6; }
      .story-arc-action-btn svg path,
      .story-arc-action-btn svg circle,
      .story-arc-action-btn svg polyline { stroke-linecap: round; stroke-linejoin: round; }
      .story-arc-menu { position: absolute; top: calc(100% + 12px); right: 0; display: flex; flex-direction: column; gap: 6px; padding: 12px; min-width: 220px; border-radius: 14px; border: 1px solid var(--ring); background: var(--panel); box-shadow: 0 24px 48px rgba(8,15,28,0.32); opacity: 0; pointer-events: none; transform: translateY(8px); transition: opacity .2s ease, transform .2s ease; z-index: 40; }
      .story-arc-action--menu:hover .story-arc-menu,
      .story-arc-action--menu:focus-within .story-arc-menu { opacity: 1; pointer-events: auto; transform: translateY(0); }
      .story-arc-menu__item { border: none; border-radius: 10px; background: var(--chip); color: var(--ink); font-size: 13px; font-weight: 600; padding: 10px 12px; text-align: left; cursor: pointer; transition: background .2s ease, color .2s ease, transform .2s ease; }
      .story-arc-menu__item:hover,
      .story-arc-menu__item:focus-visible { background: linear-gradient(135deg, rgba(79,123,255,0.16), rgba(79,123,255,0.06)); color: var(--ink); outline: none; transform: translateY(-1px); }
      .story-arc-menu__item:active { transform: translateY(0); }
      .story-arc-timeline { padding: 0; }
      .story-arc-container { background: var(--panel); border: 1px solid var(--ring); border-radius: 14px; padding: 3px 10px; }
      .story-arc-track { display: flex; align-items: stretch; justify-content: space-between; gap: 8px; margin: 0; padding: 0; list-style: none; }
      .story-arc-step { flex: 1; display: flex; min-width: 0; }
      .story-arc-pill { position: relative; display: flex; flex-direction: column; gap: 1px; align-items: flex-start; justify-content: center; width: 100%; padding: 3px 10px; border-radius: 999px; border: 1px solid var(--ring); background: linear-gradient(135deg, rgba(79,123,255,0.14), rgba(79,123,255,0.06)); box-shadow: inset 0 0 0 1px rgba(79,123,255,0.08); transition: background .2s ease, border-color .2s ease, box-shadow .2s ease; }
      .story-arc-label { font-size: 9px; font-weight: 600; letter-spacing: .28px; text-transform: uppercase; color: var(--muted); }
      .story-arc-step--active .story-arc-pill {
        border: 2px solid transparent;
        background:
          linear-gradient(var(--panel), var(--panel)) padding-box,
          linear-gradient(135deg, rgba(79,123,255,0.65), rgba(122,167,255,0.45)) border-box;
        box-shadow: 0 0 0 3px rgba(79,123,255,0.28), 0 12px 28px rgba(79,123,255,0.18);
      }
      .story-arc-step--active .story-arc-label { color: var(--acc); }
      .story-arc-scenes { padding: 0; }
      .story-arc-scenes__container { background: var(--panel); border: 1px solid var(--ring); border-radius: 14px; padding: 6px 12px; }
      .story-arc-scenes__track { display: flex; align-items: stretch; gap: 8px; margin: 0; padding: 0; list-style: none; }
      .story-arc-scenes__step { flex: 1 1 0; min-width: 0; display: flex; }
      .story-arc-scenes__slot { flex: 1; min-width: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; padding: 6px 6px; border-radius: 10px; border: 1px solid var(--ring); background: var(--chip); text-align: center; position: relative; transition: border-color .15s ease, box-shadow .15s ease, background .15s ease; }
      .story-arc-scenes__slot:hover,
      .story-arc-scenes__slot:focus-visible { border-color: var(--acc); box-shadow: 0 10px 24px rgba(79,123,255,0.22); background: linear-gradient(135deg, rgba(122,167,255,0.12), rgba(122,167,255,0.04)); outline: none; }
      .story-arc-scenes__slot::after { content: attr(data-tooltip); position: absolute; left: 50%; bottom: calc(100% + 10px); transform: translate(-50%, 0); background: var(--panel); color: var(--ink); border: 1px solid var(--ring); border-radius: 8px; padding: 6px 10px; font-size: 11px; font-weight: 500; box-shadow: 0 12px 24px rgba(8,15,28,0.25); opacity: 0; pointer-events: none; white-space: nowrap; max-width: 260px; text-overflow: ellipsis; overflow: hidden; transition: opacity .15s ease, transform .15s ease; z-index: 20; }
      .story-arc-scenes__slot::before { content: ''; position: absolute; left: 50%; bottom: calc(100% + 2px); transform: translate(-50%, 0) rotate(45deg); width: 10px; height: 10px; background: var(--panel); border: 1px solid var(--ring); border-top: none; border-left: none; opacity: 0; pointer-events: none; transition: opacity .15s ease, transform .15s ease; z-index: 19; box-shadow: 0 8px 16px rgba(8,15,28,0.2); }
      .story-arc-scenes__slot:hover::after,
      .story-arc-scenes__slot:hover::before,
      .story-arc-scenes__slot:focus-visible::after,
      .story-arc-scenes__slot:focus-visible::before { opacity: 1; transform: translate(-50%, -4px); }
      .story-arc-scenes__scene-number { font-size: 10px; font-weight: 600; letter-spacing: .3px; text-transform: uppercase; color: var(--muted); transition: color .15s ease; }
      .story-arc-scenes__scene-label { font-size: 12px; font-weight: 600; color: var(--ink); max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; transition: color .15s ease; }
      .story-arc-scenes__slot--compact .story-arc-scenes__scene-number { text-transform: none; font-size: 13px; letter-spacing: 0; }
      .story-arc-scenes__slot--compact .story-arc-scenes__scene-label { display: none; }
      .story-arc-scenes__step--active .story-arc-scenes__slot { background: linear-gradient(135deg, var(--acc), rgba(122,167,255,0.95)); border-color: var(--acc); box-shadow: 0 8px 20px rgba(79,123,255,0.18); }
      .story-arc-scenes__step--active .story-arc-scenes__scene-number { color: var(--active-tab-text); }
      .story-arc-scenes__step--active .story-arc-scenes__scene-label { color: var(--active-tab-text); }
      .story-arc-scenes__empty { flex: 1; display: flex; align-items: center; justify-content: center; min-height: 48px; border-radius: 10px; border: 1px dashed var(--ring); color: var(--muted); font-size: 12px; background: var(--chip); }
      @media (max-width: 1020px) {
        .timeline-player { grid-template-columns: minmax(220px, 1fr) 1fr; }
      }
      @media (max-width: 860px) {
        .timeline-player { grid-template-columns: 1fr; }
        .timeline-player__timeline { min-height: 320px; }
        .timeline-preview { order: -1; }
      }
      @media (max-width: 820px) {
        .story-arc-layout { flex-direction: column; align-items: stretch; }
        .story-arc-actions { flex-direction: row; justify-content: flex-end; align-items: center; }
      }
      .layout { display: grid; grid-template-columns: 280px 1fr 320px; gap: 12px; padding: 16px; min-height: 0; }
      .panel { background: var(--panel); border: 1px solid var(--ring); border-radius: 14px; overflow: hidden; display: flex; flex-direction: column; min-height: 0; }
      .panel h2 { font-size: 13px; font-weight: 600; letter-spacing: .4px; color: var(--muted); margin: 12px 16px 8px; text-transform: uppercase; }
      .panel-body { flex: 1; padding: 0 16px 16px; overflow: auto; }
      .scene-list { display: flex; flex-direction: column; gap: 10px; }
      .scene-card { background: var(--card); border: 1px solid var(--ring); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; gap: 6px; cursor: pointer; transition: border-color .2s ease, transform .2s ease; outline: none; position: relative; }
      .scene-card.active { border-color: var(--acc); box-shadow: 0 0 0 2px rgba(79,123,255,0.25); transform: translateY(-1px); }
      .scene-card small { color: var(--muted); font-size: 12px; }
      .scene-card-label { display: flex; align-items: center; gap: 8px; font-weight: 600; letter-spacing: .2px; width: 100%; }
      .scene-card-label span.scene-card-color { display: inline-flex; width: 14px; height: 14px; border-radius: 50%; background: linear-gradient(135deg, #4f7bff, #22d3ee); box-shadow: inset 0 0 0 2px rgba(255,255,255,0.55); }
      .scene-card-label-display { display: inline-flex; align-items: baseline; gap: 4px; flex: 1; min-width: 0; }
      .scene-card-label-display strong { font-size: 13px; font-weight: 600; }
      .scene-card-label-display span[data-scene-card-name] { font-weight: 600; }
      .scene-card-label-display span.scene-card-separator { opacity: 0.5; margin: 0 2px; }
      .scene-card-input { display: none; flex: 1; min-width: 0; border-radius: 8px; border: 1px solid var(--ring); background: var(--chip); color: var(--ink); padding: 6px 8px; font-size: 13px; font-weight: 500; }
      .scene-card.editing { cursor: text; }
      .scene-card.editing .scene-card-label-display { display: none; }
      .scene-card.editing .scene-card-input { display: inline-flex; }
      .timeline-panel { padding: 0; }
      .timeline-stage { flex: 1; display: flex; flex-direction: column; min-height: 0; }
      .timeline-stage header { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid var(--ring); gap: 16px; }
      .timeline-stage header h2 { margin: 0; font-size: 15px; font-weight: 600; }
      .timeline-stage header span { font-size: 12px; color: var(--muted); }
      .timeline-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
      .timeline-player { flex: 1; min-height: 0; display: grid; grid-template-columns: minmax(260px, 340px) 1fr; gap: 16px; align-items: start; padding: 16px; }
      .timeline-player__timeline { min-height: 0; display: flex; }
      .timeline-player__timeline .timeline-wrapper { flex: 1; }
      .timeline-preview { margin: 0; background: var(--card); border: 1px solid var(--ring); border-radius: 14px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 12px 28px rgba(8,15,28,0.18); }
      .timeline-preview__image { position: relative; width: 100%; aspect-ratio: 16 / 9; background: linear-gradient(135deg, rgba(79,123,255,0.14), rgba(79,123,255,0.04)); }
      .timeline-preview__image img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: block; }
      .timeline-preview__caption { display: flex; flex-direction: column; gap: 6px; padding: 16px; }
      .timeline-preview__caption h3 { margin: 0; font-size: 15px; font-weight: 600; letter-spacing: .2px; }
      .timeline-preview__meta { margin: 0; font-size: 12px; color: var(--muted); }
      .timeline-preview__status { margin: 0; font-size: 12px; color: var(--muted); }
      .timeline-preview--empty .timeline-preview__image { background: linear-gradient(135deg, rgba(79,123,255,0.18), rgba(79,123,255,0.06)); }
      .timeline-wrapper { flex: 1; overflow: auto; padding-bottom: 16px; scroll-behavior: smooth; scroll-snap-type: y proximity; }
      .timeline-grid { display: grid; grid-template-columns: 200px 1fr; min-width: 680px; }
      .timeline-scale { grid-column: 1 / -1; padding: 12px 24px; border-bottom: 1px solid var(--ring); background: linear-gradient(135deg, rgba(79,123,255,0.12), rgba(79,123,255,0)); position: sticky; top: 0; z-index: 2; }
      .timeline-scale__header { font-size: 12px; color: var(--muted); letter-spacing: .3px; text-transform: uppercase; margin-bottom: 10px; display: flex; justify-content: space-between; }
      .timeline-scale__ruler { position: relative; height: 28px; border-bottom: 1px dashed rgba(79,123,255,0.35); }
      .timeline-scale__ruler span { position: absolute; top: 8px; font-size: 11px; color: var(--muted); transform: translateX(-50%); }
      .timeline-scene { display: contents; }
      .timeline-scene__label { padding: 20px 16px; border-right: 1px solid var(--ring); background: var(--panel); display: flex; flex-direction: column; gap: 6px; position: sticky; left: 0; z-index: 1; scroll-snap-align: start; }
      .timeline-scene__label strong { font-size: 14px; letter-spacing: .2px; }
      .timeline-scene__label span { font-size: 13px; }
      .timeline-scene__label small { font-size: 12px; color: var(--muted); }
      .timeline-scene.active .timeline-scene__label { box-shadow: inset 3px 0 0 var(--acc); }
      .timeline-scene__tracks { padding: 16px 24px; display: flex; flex-direction: column; gap: 14px; background: var(--card); border-bottom: 1px solid var(--ring); }
      .timeline-track { display: flex; flex-direction: column; gap: 6px; }
      .timeline-track__header { font-size: 11px; text-transform: uppercase; letter-spacing: .3px; color: var(--muted); }
      .timeline-track__lane { position: relative; background: var(--panel); border: 1px solid var(--ring); border-radius: 10px; height: 48px; overflow: hidden; }
      .timeline-track__lane::before { content: ""; position: absolute; inset: 0; background-image: repeating-linear-gradient(to right, transparent, transparent calc(12.5% - 1px), rgba(79,123,255,0.12) calc(12.5% - 1px), rgba(79,123,255,0.12) calc(12.5%)); pointer-events: none; }
      .timeline-block { position: absolute; top: 6px; bottom: 6px; border-radius: 8px; padding: 6px 10px; font-size: 12px; display: inline-flex; align-items: center; gap: 6px; color: rgba(15,23,42,0.9); font-weight: 500; }
      .timeline-block::before { content: attr(data-icon); font-size: 14px; }
      .timeline-block--shots { background: rgba(79,123,255,0.18); border: 1px solid rgba(79,123,255,0.35); }
      .timeline-block--audio { background: rgba(220,38,38,0.14); border: 1px solid rgba(220,38,38,0.3); }
      .timeline-block--lighting { background: rgba(14,165,233,0.18); border: 1px solid rgba(14,165,233,0.3); }
      .timeline-block--notes { background: rgba(126,58,242,0.16); border: 1px solid rgba(126,58,242,0.28); }
      .timeline-block--beats { background: rgba(16,185,129,0.18); border: 1px solid rgba(16,185,129,0.3); }
      .timeline-block--cards { background: rgba(251,191,36,0.18); border: 1px solid rgba(251,191,36,0.32); }
      .timeline-track--hidden { display: none; }
      .brand-with-logo__badge--storyboard { width: 36px; height: 36px; border-radius: 12px; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; letter-spacing: .6px; background: linear-gradient(135deg, #1d4ed8, #22d3ee); color: white; box-shadow: 0 8px 24px rgba(30,64,175,0.35); }
      .panel.ai-panel { background: linear-gradient(135deg, rgba(79,123,255,0.08), rgba(34,211,238,0.08)), var(--panel); border-color: rgba(79,123,255,0.45); }
      .ai-panel header { padding: 16px; border-bottom: 1px solid rgba(79,123,255,0.25); }
      .ai-panel header h2 { margin: 0; font-size: 15px; font-weight: 600; }
      .ai-panel header p { margin: 6px 0 0; font-size: 13px; color: var(--muted); line-height: 1.5; }
      .timeline-controls__actions { display: inline-flex; gap: 8px; align-items: center; margin-left: auto; }
      .timeline-controls__actions .btn svg { stroke-width: 1.8; }
      .card-dialog { border: none; padding: 0; background: rgba(15,23,42,0.6); color: #0f172a; }
      .card-dialog::backdrop { background: rgba(15,23,42,0.55); backdrop-filter: blur(4px); }
      .card-dialog__surface {
        width: min(1120px, 96vw);
        max-height: 90vh;
        overflow: hidden;
        background: linear-gradient(180deg, #f8fbff 0%, #eef2ff 100%);
        border-radius: 24px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 40px 90px rgba(15, 23, 42, 0.32);
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 24px;
        color-scheme: light;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }
      .card-dialog__header { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; }
      .card-dialog__eyebrow { margin: 0 0 4px; text-transform: uppercase; letter-spacing: .32px; font-size: 11px; color: #64748b; }
      .card-dialog__header h2 { margin: 0; font-size: 22px; font-weight: 700; color: #0f172a; }
      .card-dialog__scene { margin: 6px 0 0; font-size: 13px; color: #475569; font-weight: 600; }
      .card-dialog__header-actions { display: flex; align-items: center; gap: 12px; }
      .card-dialog__close {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(248, 250, 255, 0.9);
        color: #0f172a;
        font-size: 20px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: border-color .2s ease, background .2s ease, transform .2s ease;
      }
      .card-dialog__close:hover { border-color: rgba(37, 99, 235, 0.65); background: rgba(226, 232, 240, 0.9); transform: translateY(-1px); }
      .card-dialog__close:focus-visible { outline: 2px solid rgba(37, 99, 235, 0.75); outline-offset: 3px; }
      .card-dialog__body { display: grid; grid-template-columns: 320px minmax(0, 1fr) 280px; gap: 18px; align-items: flex-start; }
      .card-dialog__sidebar { display: flex; flex-direction: column; gap: 16px; }
      .card-dialog__main { display: flex; flex-direction: column; gap: 16px; }
      .card-dialog__preview { display: flex; flex-direction: column; gap: 16px; }
      .card-dialog__section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.32);
        box-shadow: 0 20px 48px rgba(15, 23, 42, 0.08);
        padding: 18px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }
      .card-dialog__section-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
      .card-dialog__section-header h3 { margin: 0; font-size: 16px; font-weight: 700; color: #0f172a; }
      .card-dialog__hint { margin: 0; font-size: 12px; color: #64748b; line-height: 1.5; }
      .card-dialog__chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        letter-spacing: .3px;
        font-weight: 700;
        text-transform: uppercase;
        background: rgba(37, 99, 235, 0.1);
        color: #1d4ed8;
        border: 1px solid rgba(37, 99, 235, 0.2);
      }
      .card-dialog__chip--accent { background: rgba(6, 182, 212, 0.12); border-color: rgba(6, 182, 212, 0.28); color: #0f766e; }
      .card-dialog__tabs { display: inline-flex; align-items: center; gap: 6px; background: rgba(226, 232, 240, 0.85); border-radius: 999px; padding: 4px; }
      .card-dialog__tab {
        border: none;
        background: transparent;
        border-radius: 999px;
        padding: 6px 14px;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: .2px;
        color: #475569;
        cursor: pointer;
        transition: background .2s ease, color .2s ease, box-shadow .2s ease;
      }
      .card-dialog__tab:focus-visible { outline: none; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.5); }
      .card-dialog__tab--active { background: linear-gradient(135deg, #2563eb, #60a5fa); color: #f8fbff; box-shadow: 0 16px 32px rgba(37, 99, 235, 0.28); }
      .card-dialog__panel-group { display: flex; flex-direction: column; gap: 18px; }
      .card-dialog__panel { display: flex; flex-direction: column; gap: 14px; }
      .card-dialog__panel[hidden] { display: none; }
      .card-dialog__panel h4 { margin: 0; font-size: 12px; letter-spacing: .25px; text-transform: uppercase; color: #475569; }
      .card-dialog__cta-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
      .card-dialog__cta {
        border: 1px dashed rgba(37, 99, 235, 0.38);
        border-radius: 14px;
        padding: 12px;
        background: rgba(240, 249, 255, 0.9);
        color: #1d4ed8;
        font-size: 13px;
        font-weight: 600;
        display: inline-flex;
        flex-direction: column;
        gap: 6px;
        align-items: flex-start;
        cursor: pointer;
        transition: border-color .2s ease, background .2s ease, transform .2s ease;
      }
      .card-dialog__cta span:first-child { font-size: 18px; line-height: 1; }
      .card-dialog__cta:hover { border-color: rgba(37, 99, 235, 0.6); background: rgba(219, 234, 254, 0.9); transform: translateY(-1px); }
      .card-dialog__asset-strip { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 6px; }
      .card-dialog__asset-strip::-webkit-scrollbar { height: 6px; }
      .card-dialog__asset-strip::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.4); border-radius: 999px; }
      .card-dialog__asset-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
      .card-dialog__asset {
        position: relative;
        border: 1px solid rgba(148, 163, 184, 0.35);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.96);
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
        cursor: pointer;
        transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease;
        min-width: 160px;
      }
      .card-dialog__asset:hover { border-color: rgba(37, 99, 235, 0.55); box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12); transform: translateY(-1px); }
      .card-dialog__asset:focus-visible { outline: 2px solid rgba(37, 99, 235, 0.55); outline-offset: 3px; }
      .card-dialog__asset--active { border-color: rgba(37, 99, 235, 0.85); box-shadow: 0 22px 46px rgba(37, 99, 235, 0.24); }
      .card-dialog__asset-thumb { width: 44px; height: 44px; border-radius: 14px; background: linear-gradient(135deg, rgba(37, 99, 235, 0.18), rgba(14, 165, 233, 0.1)); display: grid; place-items: center; font-weight: 700; font-size: 13px; color: #1d4ed8; }
      .card-dialog__asset-name { font-size: 13px; font-weight: 600; color: #0f172a; }
      .card-dialog__asset-meta { font-size: 11px; color: #64748b; }
      .card-dialog__asset-badge {
        font-size: 10px;
        font-weight: 700;
        letter-spacing: .4px;
        text-transform: uppercase;
        padding: 3px 6px;
        border-radius: 999px;
        background: rgba(37, 99, 235, 0.12);
        color: #1d4ed8;
      }
      .card-dialog__label { font-size: 12px; font-weight: 600; color: #475569; display: flex; flex-direction: column; gap: 6px; }
      .card-dialog__textarea {
        width: 100%;
        min-height: 90px;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(255, 255, 255, 0.96);
        color: #0f172a;
        padding: 12px;
        font: inherit;
        resize: vertical;
        box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.04);
      }
      .card-dialog__textarea:focus-visible { outline: 2px solid rgba(37, 99, 235, 0.55); outline-offset: 2px; }
      .card-dialog__form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }
      .card-dialog__form-grid select {
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(255, 255, 255, 0.96);
        color: #0f172a;
        padding: 10px 12px;
        font: inherit;
      }
      .card-dialog__actions { display: flex; align-items: center; gap: 10px; }
      .card-dialog__status {
        margin: 0;
        font-size: 12px;
        color: #1d4ed8;
        background: rgba(37, 99, 235, 0.08);
        border-radius: 12px;
        padding: 8px 12px;
        min-height: 32px;
        display: flex;
        align-items: center;
      }
      .card-dialog__status[data-state="loading"] { color: #0f172a; background: rgba(14, 165, 233, 0.14); }
      .card-dialog__summary { margin: 0; font-size: 13px; color: #334155; line-height: 1.5; }
      .card-dialog__text-stack { display: flex; flex-direction: column; gap: 10px; }
      .card-dialog__text-card {
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.28);
        background: rgba(248, 250, 255, 0.95);
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .card-dialog__text-card--note { background: rgba(244, 244, 255, 0.95); }
      .card-dialog__text-card strong { font-size: 13px; color: #0f172a; }
      .card-dialog__text-card p { margin: 0; font-size: 13px; color: #334155; line-height: 1.4; }
      .card-dialog__text-badge {
        font-size: 11px;
        font-weight: 700;
        letter-spacing: .32px;
        text-transform: uppercase;
        color: #2563eb;
      }
      .card-dialog__empty { margin: 0; font-size: 12px; color: #64748b; }
      .card-dialog__frame-list { display: flex; flex-direction: column; gap: 10px; }
      .card-dialog__frame {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 12px;
        align-items: center;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(255, 255, 255, 0.94);
      }
      .card-dialog__frame-index {
        width: 30px;
        height: 30px;
        border-radius: 10px;
        background: rgba(37, 99, 235, 0.12);
        color: #1d4ed8;
        font-size: 13px;
        font-weight: 700;
        display: grid;
        place-items: center;
      }
      .card-dialog__frame strong { display: block; font-size: 13px; color: #0f172a; }
      .card-dialog__frame span { font-size: 12px; color: #64748b; }
      .card-dialog__preview-card {
        background: rgba(255, 255, 255, 0.96);
        border-radius: 22px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 20px 48px rgba(15, 23, 42, 0.12);
        padding: 18px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }
      .card-dialog__preview-meta { display: flex; flex-direction: column; gap: 4px; }
      .card-dialog__preview-label { font-size: 11px; letter-spacing: .32px; text-transform: uppercase; color: #64748b; }
      .card-dialog__preview-meta strong { font-size: 15px; color: #0f172a; }
      .card-dialog__preview-sub { font-size: 12px; color: #475569; }
      .card-dialog__preview-figure {
        position: relative;
        border-radius: 18px;
        background: var(--card-dialog-preview, linear-gradient(135deg, #a5b4fc, #f9a8d4));
        aspect-ratio: 4 / 3;
        box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.35);
        overflow: hidden;
      }
      .card-dialog__preview-figure::after {
        content: 'ChatGPT image creator';
        position: absolute;
        right: 12px;
        bottom: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.82);
        color: #0f172a;
        font-size: 11px;
        letter-spacing: .32px;
        text-transform: uppercase;
        font-weight: 700;
      }
      .card-dialog__preview-notes { display: flex; flex-direction: column; gap: 6px; }
      .card-dialog__preview-notes strong { font-size: 12px; letter-spacing: .24px; text-transform: uppercase; color: #475569; }
      .card-dialog__preview-notes p { margin: 0; font-size: 13px; color: #334155; line-height: 1.4; }
      .card-dialog__preview-tags { display: flex; flex-wrap: wrap; gap: 8px; }
      .card-dialog__footer { display: flex; align-items: center; justify-content: flex-end; gap: 12px; }
      .card-dialog__footer .btn { min-width: 130px; justify-content: center; }
      .card-dialog__footer .btn.btn-primary { box-shadow: 0 16px 40px rgba(37, 99, 235, 0.26); }
      @media (max-width: 1140px) {
        .card-dialog__body { grid-template-columns: minmax(0, 1fr); }
        .card-dialog__preview { order: -1; }
      }
      @media (max-width: 720px) {
        .card-dialog__surface { padding: 18px; }
        .card-dialog__body { gap: 14px; }
        .card-dialog__section { padding: 14px; }
        .card-dialog__footer { flex-direction: column; align-items: stretch; }
        .card-dialog__footer .btn { width: 100%; }
      }
      .ai-form { display: flex; flex-direction: column; gap: 12px; padding: 16px; }
      .ai-form label { font-size: 12px; letter-spacing: .3px; text-transform: uppercase; color: var(--muted); }
      .ai-form textarea, .ai-form input { width: 100%; border-radius: 12px; border: 1px solid var(--ring); background: var(--chip); color: var(--ink); padding: 10px 12px; font-size: 14px; resize: vertical; min-height: 96px; }
      .ai-form input { min-height: auto; }
      .ai-hint { font-size: 12px; color: var(--muted); line-height: 1.5; }
      .ai-status { font-size: 12px; letter-spacing: .3px; text-transform: uppercase; color: var(--acc); }
      .ai-actions { display: flex; align-items: center; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }
      .ai-actions [data-api-manager] { margin-right: auto; }
      .ai-actions button[data-api-manager] { order: -1; }
      .ai-result { margin-top: 12px; background: var(--card); border: 1px solid var(--ring); border-radius: 12px; padding: 16px; display: none; flex-direction: column; gap: 12px; }
      .ai-result.active { display: flex; }
      .ai-result__heading { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: .3px; color: var(--muted); margin: 0; }
      .ai-result__image { width: 100%; border-radius: 10px; border: 1px solid var(--ring); background: var(--chip); object-fit: cover; max-height: 320px; }
      .ai-result__meta { font-size: 12px; color: var(--muted); margin: 0; }
      .ai-result pre { margin: 0; padding: 12px; background: var(--panel); border-radius: 10px; overflow: auto; font-size: 12px; line-height: 1.5; max-height: 260px; }
      .ai-result__empty { font-size: 13px; color: var(--muted); }
      .api-dialog { border: none; border-radius: 18px; padding: 0; width: min(480px, 90vw); background: var(--panel); color: var(--ink); box-shadow: 0 30px 70px rgba(15,23,42,0.28); }
      .api-dialog[open] { display: block; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; }
      .api-dialog::backdrop { background: rgba(15,23,42,0.55); }
      .api-dialog__container { display: flex; flex-direction: column; gap: 16px; padding: 24px; }
      .api-dialog__header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
      .api-dialog__header h2 { margin: 0; font-size: 18px; }
      .api-dialog__body { display: flex; flex-direction: column; gap: 16px; }
      .api-dialog label { font-size: 12px; letter-spacing: .3px; text-transform: uppercase; color: var(--muted); display: block; margin-bottom: 6px; }
      .api-dialog input { width: 100%; border-radius: 12px; border: 1px solid var(--ring); background: var(--chip); color: var(--ink); padding: 10px 12px; font-size: 14px; }
      .api-dialog__hint { font-size: 12px; color: var(--muted); margin: 4px 0 0; }
      .api-dialog__actions { display: flex; align-items: center; justify-content: flex-end; gap: 8px; }
      .api-dialog__feedback { font-size: 12px; color: var(--acc); margin-right: auto; min-height: 18px; }
      .api-dialog__close { border: none; background: transparent; color: inherit; font-size: 22px; line-height: 1; cursor: pointer; padding: 4px 8px; border-radius: 8px; }
      .api-dialog__close:hover { background: rgba(79,123,255,0.12); }
      .ai-form select { width: 100%; border-radius: 12px; border: 1px solid var(--ring); background: var(--chip); color: var(--ink); padding: 10px 12px; font-size: 14px; }
      .feature-section { padding: 36px 48px 72px; display: grid; gap: 24px; }
      .feature-section h2 { font-size: 26px; margin: 0; }
      .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
      .feature-card { background: var(--panel); border: 1px solid var(--ring); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
      .feature-card h3 { margin: 0; font-size: 16px; }
      .feature-card p { margin: 0; color: var(--muted); line-height: 1.5; }
      @media (max-width: 1280px) {
        .layout { grid-template-columns: 1fr; grid-template-rows: repeat(3, minmax(0, auto)); }
        .timeline-wrapper { max-height: 520px; }
        .panel.ai-panel { order: 3; }
      }
      @media (max-width: 720px) {
        .topbar { flex-wrap: wrap; }
        .layout { padding: 12px; }
        .timeline-grid { min-width: 560px; }
        .timeline-stage header { flex-direction: column; align-items: flex-start; }
        .timeline-controls { width: 100%; justify-content: space-between; }
      }
    </style>

    <div class="workspace-launcher" data-workspace-launcher>
      <div class="workspace-launcher__toggle-wrap">
        <button class="workspace-launcher__toggle" type="button" aria-expanded="false" aria-label="Workspace menu" data-workspace-toggle>
          <span class="sr-only">Workspace menu</span>
          <span class="workspace-launcher__icon" aria-hidden="true"></span>
        </button>
        <div class="workspace-launcher__chat" data-workspace-chat hidden aria-hidden="true">
          <div class="workspace-launcher__chat-bubble">
            <div class="workspace-launcher__chat-thread" data-workspace-chat-thread>
              <div class="workspace-launcher__chat-message workspace-launcher__chat-message--assistant">Hi there! Ready to build something great today?</div>
            </div>
            <div class="workspace-launcher__chat-suggestions">
              <button type="button" class="workspace-launcher__chat-chip" data-workspace-chat-suggestion data-workspace-chat-action="continue">Check my progress</button>
              <button type="button" class="workspace-launcher__chat-chip" data-workspace-chat-suggestion data-workspace-chat-action="new">Spin up something new</button>
              <button type="button" class="workspace-launcher__chat-chip" data-workspace-chat-suggestion data-workspace-chat-action="settings">How should you behave?</button>
            </div>
            <form class="workspace-launcher__chat-form" data-workspace-chat-form>
              <div class="workspace-launcher__chat-input">
                <input type="text" placeholder="Ask StudioOrganize‚Ä¶" aria-label="Ask the workspace assistant" data-workspace-chat-input />
                <button type="submit" class="workspace-launcher__chat-send" aria-label="Send chat message">
                  <span aria-hidden="true">‚û§</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="workspace-launcher__panel" data-workspace-panel aria-hidden="true" hidden tabindex="-1">
        <div class="workspace-launcher__quick-actions">
          <p class="workspace-launcher__quick-actions-label">Quick actions</p>
          <div class="workspace-launcher__quick-actions-buttons" role="group" aria-label="Workspace quick actions">
            <button type="button" class="workspace-launcher__script" data-workspace-script>
              <span>Story</span>
            </button>
            <a class="workspace-launcher__script workspace-launcher__creator" href="/account.html" aria-label="Creator Page">
              <span>Creator Page</span>
            </a>
            <a
              class="workspace-launcher__module workspace-launcher__module--creative-hub"
              href="/creative-hub.html"
              data-label="Creative Hub"
            >
              <span class="workspace-launcher__module-icon" aria-hidden="true">
                <img src="/assets/img/IMG_6896.webp" alt="" loading="lazy" />
              </span>
              <span class="sr-only">Creative Hub</span>
            </a>
            <button
              type="button"
              class="workspace-launcher__module workspace-launcher__module--assistant"
              data-workspace-assistant-toggle
              data-label="Assistant"
              aria-pressed="false"
              aria-expanded="false"
              aria-label="Open StudioOrganize Assistant"
            >
            <span class="workspace-launcher__module-icon" aria-hidden="true">
              <span class="workspace-launcher__assistant-glyph" aria-hidden="true"></span>
            </span>
            <span class="sr-only">Open StudioOrganize Assistant</span>
          </button>
          <button type="button" class="workspace-launcher__module workspace-launcher__module--lessons" data-video-lessons-open data-label="Video Lessons" aria-label="Open video lesson library">
            <span class="workspace-launcher__module-icon workspace-launcher__module-icon--lessons" aria-hidden="true">
              <span aria-hidden="true">üé¨</span>
            </span>
            <span class="sr-only">Open video lesson library</span>
          </button>
          <button
            type="button"
            class="workspace-launcher__module workspace-launcher__module--music-note"
            data-music-library-open
            data-label="Create with Music"
            aria-label="Open Create with Music"
          >
            <span class="workspace-launcher__module-icon workspace-launcher__module-icon--music-note" aria-hidden="true">
              <span aria-hidden="true">üéµ</span>
            </span>
            <span class="sr-only">Open Create with Music</span>
          </button>
          <button type="button" class="workspace-launcher__module workspace-launcher__module--save" data-workspace-save data-label="Save Progress">
              <span class="workspace-launcher__module-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
              </span>
              <span class="sr-only">Save Progress</span>
            </button>
            <button type="button" class="workspace-launcher__module workspace-launcher__module--story" data-workspace-script data-label="New Story">
              <span class="workspace-launcher__module-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </span>
              <span class="sr-only">New Story</span>
            </button>
          </div>
        </div>
        <div class="workspace-launcher__module-stack">
          <nav class="workspace-launcher__modules" aria-label="Workspace modules">
            <a class="workspace-launcher__module" href="/use-cases/screenplay-writing.html" data-label="Screenplay Writing">
              <span class="workspace-launcher__module-icon" aria-hidden="true">
                <img src="/assets/img/IMG_6892.webp" alt="" loading="lazy" />
              </span>
              <span class="sr-only">Screenplay Writing</span>
            </a>
            <a class="workspace-launcher__module" href="/CharacterStudio.html" data-label="Character Studio">
              <span class="workspace-launcher__module-icon" aria-hidden="true">
                <img src="/assets/img/IMG_6894.webp" alt="" loading="lazy" />
              </span>
              <span class="sr-only">Character Studio</span>
            </a>
            <a class="workspace-launcher__module" href="/use-cases/set-design.html" data-label="Set Design">
              <span class="workspace-launcher__module-icon" aria-hidden="true">
                <img src="/assets/img/IMG_6903.webp" alt="" loading="lazy" />
              </span>
              <span class="sr-only">Set Design</span>
            </a>
            <a class="workspace-launcher__module" href="/MusicStudio.html" data-label="Music Workspace">
              <span class="workspace-launcher__module-icon workspace-launcher__module-icon--music" aria-hidden="true">
                <span aria-hidden="true">üéµ‚ù§Ô∏è</span>
              </span>
              <span class="sr-only">Music Workspace</span>
            </a>
            <a class="workspace-launcher__module workspace-launcher__module--active" href="/StoryboardPro.html" data-label="Storyboard Pro">
              <span class="workspace-launcher__module-icon" aria-hidden="true">
                <img src="/assets/img/IMG_6893.webp" alt="" loading="lazy" />
              </span>
              <span class="sr-only">Storyboard Pro</span>
            </a>
            <a class="workspace-launcher__module" href="/VideoEditing.html" data-label="Video &amp; Editing">
              <span class="workspace-launcher__module-icon" aria-hidden="true">
                <img src="/assets/img/IMG_6893.webp" alt="" loading="lazy" />
              </span>
              <span class="sr-only">Video &amp; Editing</span>
            </a>
          </nav>
        </div>
      </div>
    </div>

    <div class="app">
      <div class="topbar">
        <span class="topbar__badge" aria-hidden="true">
          <img src="/assets/img/IMG_6893.webp" alt="" />
        </span>
        <h1>Video &amp; Editing</h1>
        <span class="badge">Scene-locked edit prep</span>
        <div class="spacer"></div>
        <div class="topbar-group" role="group" aria-label="Timeline track visibility">
          <button class="btn active" type="button" data-track-toggle="cards" aria-pressed="true">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <rect x="7" y="4" width="10" height="16" rx="2"></rect>
              <path d="M12 9.5l2 2.5-2 2.5-2-2.5z"></path>
            </svg>
            Cards
          </button>
          <button class="btn active" type="button" data-track-toggle="beats" aria-pressed="true">Beat grid</button>
          <button class="btn active" type="button" data-track-toggle="shots" aria-pressed="true">Shots</button>
          <button class="btn active" type="button" data-track-toggle="audio" aria-pressed="true">Audio</button>
          <button class="btn active" type="button" data-track-toggle="lighting" aria-pressed="true">Lighting</button>
          <button class="btn active" type="button" data-track-toggle="notes" aria-pressed="true">Notes</button>
        </div>
        <button class="btn btn-primary" type="button" data-scene-best-pose>Use character + best pose</button>
      </div>

      <div id="timelineDock" class="timeline-dock pinned" aria-label="Story timeline dock">
        <button id="timelineDockHandle" class="timeline-dock__handle" type="button" aria-pressed="true" aria-expanded="true" aria-label="Click to float story timelines" title="Click to float story timelines"></button>
        <div class="timeline-dock__shell">
          <div class="timeline-dock__content">
            <section class="scene-pair-lab" aria-label="Scene pair explorer" data-scene-pair-lab>
              <h2 class="scene-pair-lab__header">Scene pair explorer</h2>
              <div class="scene-pair-row scene-pair-row--all">
                <ol class="scene-pair-grid" data-scene-pair-grid role="list"></ol>
              </div>
              <div class="scene-pair-row scene-pair-row--pair">
                <div class="scene-pair-feature">
                  <button class="scene-pair-nav" type="button" aria-label="Previous scene pair" data-scene-pair-prev>
                    ‚Äπ
                  </button>
                  <div class="scene-pair-cards" data-scene-pair-cards></div>
                  <button class="scene-pair-nav" type="button" aria-label="Next scene pair" data-scene-pair-next>
                    ‚Ä∫
                  </button>
                </div>
              </div>
              <div class="scene-pair-row scene-pair-row--focus">
                <figure class="scene-pair-focus" data-scene-pair-focus hidden>
                  <div class="scene-pair-focus__image">
                    <img src="" alt="" loading="lazy" decoding="async" data-scene-pair-focus-image />
                  </div>
                  <figcaption class="scene-pair-focus__caption">
                    <p class="scene-pair-focus__eyebrow" data-scene-pair-focus-label></p>
                    <h3 class="scene-pair-focus__title" data-scene-pair-focus-title></h3>
                    <p class="scene-pair-focus__meta" data-scene-pair-focus-meta></p>
                  </figcaption>
                </figure>
              </div>
              <div class="scene-pair-row scene-pair-row--actions">
                <div class="scene-pair-actions">
                  <button class="btn btn-primary" type="button" data-scene-pair-generate disabled>Generate</button>
                  <label class="scene-pair-select">
                    <span class="sr-only">Choose generator</span>
                    <select data-scene-pair-engine disabled>
                      <option value="">Select</option>
                      <option value="google-veo">Google VEO</option>
                      <option value="openai-sora">| OPENAI SORA</option>
                    </select>
                  </label>
                </div>
              </div>
            </section>
            <div class="story-arc-layout">
              <div class="story-arc-columns">
                <div class="story-arc-timeline" aria-label="Story arc timeline">
                  <div class="story-arc-container">
                    <ol class="story-arc-track" role="list">
                      <li class="story-arc-step" role="listitem">
                        <div class="story-arc-pill">
                          <span class="story-arc-label">Opening</span>
                        </div>
                      </li>
                      <li class="story-arc-step story-arc-step--active" role="listitem" aria-current="step">
                        <div class="story-arc-pill">
                          <span class="story-arc-label">Middle</span>
                        </div>
                      </li>
                      <li class="story-arc-step" role="listitem">
                        <div class="story-arc-pill">
                          <span class="story-arc-label">End</span>
                        </div>
                      </li>
                    </ol>
                  </div>
                </div>
                <section class="scene-carousel-wrapper scene-carousel-wrapper--compact" aria-label="Scene previews" data-scene-carousel-container>
                  <div class="scene-carousel">
                    <button class="scene-carousel__nav scene-carousel__nav--prev" type="button" aria-label="Previous scene" data-scene-carousel-prev>
                      <span class="scene-carousel__nav-icon" aria-hidden="true">‚Äπ</span>
                    </button>
                    <div class="scene-carousel__viewport" data-scene-carousel-viewport tabindex="0" role="group" aria-label="Storyboard scene preview">
                      <button class="scene-carousel__zoom" type="button" data-scene-carousel-zoom aria-pressed="false">
                        <span class="scene-carousel__zoom-icon" aria-hidden="true">‚§¢</span>
                        <span data-scene-carousel-zoom-label>Zoom in</span>
                      </button>
                      <ul class="scene-carousel__track" data-scene-carousel-track></ul>
                    </div>
                    <button class="scene-carousel__nav scene-carousel__nav--next" type="button" aria-label="Next scene" data-scene-carousel-next>
                      <span class="scene-carousel__nav-icon" aria-hidden="true">‚Ä∫</span>
                    </button>
                  </div>
                  <div class="scene-carousel__dots" role="tablist" aria-label="Select scene preview" data-scene-carousel-dots></div>
                </section>
                <div class="story-arc-scenes" aria-label="Scene timeline">
                  <div class="story-arc-scenes__container">
                    <ol class="story-arc-scenes__track" id="storyArcSceneSlots" role="list"></ol>
                  </div>
                </div>
              </div>
              <div class="story-arc-actions" aria-label="Story timeline actions">
                <div class="story-arc-action story-arc-action--menu">
                  <button class="story-arc-action-btn" type="button" aria-haspopup="true" aria-label="Choose story arc template" title="Choose story arc template">
                    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                      <circle cx="10.5" cy="10.5" r="6.5"></circle>
                      <path d="M10.5 4v6.5H17"></path>
                      <path d="M17 3v4"></path>
                      <path d="M19 5h-4"></path>
                      <path d="M17 10.5l4.5-4.5"></path>
                    </svg>
                  </button>
                  <div class="story-arc-menu" role="menu">
                    <button class="story-arc-menu__item" type="button" role="menuitem">Choose Story Arc ¬∑ Opening, Middle, End</button>
                    <button class="story-arc-menu__item" type="button" role="menuitem">Story Arc 2 ¬∑ Build up</button>
                    <button class="story-arc-menu__item" type="button" role="menuitem">Hero's Journey</button>
                    <button class="story-arc-menu__item" type="button" role="menuitem">Conflict resolution</button>
                  </div>
                </div>
                <button class="story-arc-action-btn" type="button" aria-label="Story timeline bookmarks" title="Story timeline bookmarks">
                  <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path d="M9 4h6a2 2 0 0 1 2 2v15l-5-3-5 3V6a2 2 0 0 1 2-2z"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="layout">
        <aside class="panel">
          <h2>Scenes</h2>
          <div class="panel-body">
            <div class="scene-list" data-scene-list></div>
          </div>
        </aside>

        <section class="panel timeline-panel">
          <div class="timeline-stage">
            <header>
              <div>
                <h2 data-scene-title>Scene 13 ¬∑ Rooftop chase</h2>
                <span data-scene-meta>Linked to draft v4 ¬∑ 00:45 runtime ¬∑ 8 frames</span>
              </div>
              <div class="timeline-controls">
                <span class="muted">Timeline synced to script page 47</span>
                <div class="timeline-controls__actions">
                  <button class="btn" type="button" data-card-dialog-open aria-haspopup="dialog" aria-controls="cardDialog">
                    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                      <rect x="3" y="4" width="18" height="16" rx="3"></rect>
                      <path d="M8 9h8"></path>
                      <path d="M8 13h5"></path>
                    </svg>
                    Card dialog
                  </button>
                </div>
              </div>
            </header>
            <div class="timeline-player">
              <figure class="timeline-preview timeline-preview--empty" data-current-frame>
                <div class="timeline-preview__image">
                  <img
                    data-current-frame-image
                    src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
                    alt="Select a scene to view its current frame"
                  />
                </div>
                <figcaption class="timeline-preview__caption">
                  <h3 data-current-frame-title>Current frame</h3>
                  <p class="timeline-preview__meta" data-current-frame-meta>
                    Activate a scene to sync timeline metadata.
                  </p>
                  <p class="timeline-preview__status" data-current-frame-status>
                    Storyboard previews will appear here.
                  </p>
                </figcaption>
              </figure>
              <div class="timeline-player__timeline">
                <div class="timeline-wrapper">
                  <div class="timeline-grid" data-timeline-grid>
                    <div class="timeline-scale" aria-hidden="true">
                      <div class="timeline-scale__header">
                        <span>Scene timeline (minutes)</span>
                        <span>Drag & drop clips to re-time</span>
                      </div>
                      <div class="timeline-scale__ruler">
                        <span style="left:0%">0:00</span>
                        <span style="left:12.5%">0:05</span>
                        <span style="left:25%">0:10</span>
                        <span style="left:37.5%">0:15</span>
                        <span style="left:50%">0:20</span>
                        <span style="left:62.5%">0:25</span>
                        <span style="left:75%">0:30</span>
                        <span style="left:87.5%">0:35</span>
                        <span style="left:100%">0:40</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <aside class="panel ai-panel">
          <header>
            <h2>Storyboard AI Companion</h2>
            <p>Feed scene context and characters to draft new frames that stay aligned with your script timing.</p>
          </header>
          <form class="ai-form">
            <div>
              <label for="aiShotPrompt">Shot prompt</label>
              <textarea id="aiShotPrompt" placeholder="Wide aerial reveals the neon skyline before pushing into the rooftop chase."></textarea>
            </div>
            <div>
              <label for="aiProvider">Image model</label>
              <select id="aiProvider">
                <option value="gemini">Gemini image</option>
                <option value="soara">Soara images</option>
              </select>
            </div>
            <div>
              <label for="aiFrameCount">Frame count</label>
              <input id="aiFrameCount" type="number" min="1" max="12" value="4" />
            </div>
            <p class="ai-hint">Character tokens and lighting notes auto-sync from the writer so your frames stay on model. Select a provider and store API keys to render previews.</p>
            <div class="ai-actions">
              <button class="btn" type="button" data-api-manager>Manage API keys</button>
              <span class="ai-status" data-ai-status>Ready</span>
              <button class="btn btn-primary" type="button" data-ai-generate>Generate preview</button>
            </div>
            <div class="ai-result" data-ai-result aria-live="polite"></div>
          </form>
        </aside>
      </div>
    </div>

    <dialog class="api-dialog" data-api-dialog aria-labelledby="apiDialogTitle">
      <form class="api-dialog__container" method="dialog" data-api-form>
        <div class="api-dialog__header">
          <h2 id="apiDialogTitle">AI API manager</h2>
          <button class="api-dialog__close" type="button" data-api-close aria-label="Close API manager">√ó</button>
        </div>
        <div class="api-dialog__body">
          <p>Store your Gemini and Soara API keys locally to test storyboard image generation. Keys are saved to this browser only.</p>
          <div>
            <label for="apiGeminiKey">Gemini API key</label>
            <input id="apiGeminiKey" type="password" placeholder="AIz..." autocomplete="off" data-api-gemini />
            <p class="api-dialog__hint">Create a key in Google AI Studio and enable the Gemini image endpoint.</p>
          </div>
          <div>
            <label for="apiSoaraKey">Soara API key</label>
            <input id="apiSoaraKey" type="password" placeholder="soara_..." autocomplete="off" data-api-soara />
            <p class="api-dialog__hint">Use your Soara developer dashboard to generate a token with image permissions.</p>
          </div>
        </div>
        <div class="api-dialog__actions">
          <span class="api-dialog__feedback" data-api-feedback role="status" aria-live="polite"></span>
          <button class="btn" type="button" data-api-close>Cancel</button>
          <button class="btn btn-primary" type="submit">Save keys</button>
        </div>
      </form>
    </dialog>

    <dialog class="card-dialog" id="cardDialog" data-card-dialog aria-labelledby="cardDialogTitle">
      <div class="card-dialog__surface" role="document">
        <header class="card-dialog__header">
          <div>
            <p class="card-dialog__eyebrow">Cards workspace</p>
            <h2 id="cardDialogTitle">Beat card generator</h2>
            <p class="card-dialog__scene" data-card-dialog-scene>Scene 13 ¬∑ Rooftop chase</p>
            <p class="card-dialog__hint" data-card-dialog-meta>Linked to draft v4 ¬∑ 00:45 runtime ¬∑ 8 frames</p>
          </div>
          <div class="card-dialog__header-actions">
            <span class="card-dialog__chip card-dialog__chip--accent">ChatGPT image creator</span>
            <button class="card-dialog__close" type="button" data-card-dialog-close aria-label="Close card dialog">√ó</button>
          </div>
        </header>
        <div class="card-dialog__body">
          <aside class="card-dialog__sidebar">
            <section class="card-dialog__section card-dialog__section--tabs">
              <div class="card-dialog__section-header">
                <h3>Assets &amp; frames</h3>
                <div class="card-dialog__tabs" role="tablist" aria-label="Card sources">
                  <button class="card-dialog__tab card-dialog__tab--active" type="button" role="tab" aria-selected="true" data-card-tab="assets" data-card-dialog-initial-focus>Assets</button>
                  <button class="card-dialog__tab" type="button" role="tab" aria-selected="false" data-card-tab="frames" tabindex="-1">Frames</button>
                </div>
              </div>
              <div class="card-dialog__panel-group">
                <div class="card-dialog__panel" data-card-panel="assets" role="tabpanel" tabindex="-1">
                  <div class="card-dialog__cta-grid">
                    <button class="card-dialog__cta" type="button">
                      <span>Ôºã</span>
                      Create character
                      <span class="card-dialog__hint">Draft a new hero in ChatGPT image creator.</span>
                    </button>
                    <button class="card-dialog__cta" type="button">
                      <span>‚á™</span>
                      Upload image
                      <span class="card-dialog__hint">Keep hand-drawn concepts in the asset locker.</span>
                    </button>
                  </div>
                  <h4>Recent</h4>
                  <div class="card-dialog__asset-strip">
                    <button class="card-dialog__asset" type="button" data-card-asset aria-pressed="false" data-card-label="Designer gesture sketches" data-card-meta="Sketchbook ¬∑ synced 2m ago" data-card-preview="linear-gradient(135deg, #bae6fd, #c3ddff)" data-card-prompt="Designer and creative director reviewing rooftop chase beats around a lightboard, cinematic storyboard style.">
                      <span class="card-dialog__asset-thumb" aria-hidden="true">CD</span>
                      <span class="card-dialog__asset-name">Designer sketching</span>
                      <span class="card-dialog__asset-meta">Sketchbook ¬∑ synced 2m ago</span>
                      <span class="card-dialog__asset-badge">Use as image input</span>
                    </button>
                    <button class="card-dialog__asset" type="button" data-card-asset aria-pressed="false" data-card-label="Client reference moodboard" data-card-meta="Moodboard ¬∑ synced 5m ago" data-card-preview="linear-gradient(135deg, #fde68a, #fbcfe8)" data-card-prompt="Reference board pinned to a studio wall with neon rooftop lighting studies, cinematic notes in margins.">
                      <span class="card-dialog__asset-thumb" aria-hidden="true">MB</span>
                      <span class="card-dialog__asset-name">Moodboard slices</span>
                      <span class="card-dialog__asset-meta">Moodboard ¬∑ synced 5m ago</span>
                      <span class="card-dialog__asset-badge">Use as image input</span>
                    </button>
                    <button class="card-dialog__asset" type="button" data-card-asset aria-pressed="false" data-card-label="Rooftop chase 3D blockout" data-card-meta="Previz ¬∑ synced 11m ago" data-card-preview="linear-gradient(135deg, #bbf7d0, #bef264)" data-card-prompt="Grey box 3D previz of a rooftop chase with dramatic overhead lighting and hero silhouettes.">
                      <span class="card-dialog__asset-thumb" aria-hidden="true">3D</span>
                      <span class="card-dialog__asset-name">Previz pass</span>
                      <span class="card-dialog__asset-meta">Previz ¬∑ synced 11m ago</span>
                      <span class="card-dialog__asset-badge">Use as image input</span>
                    </button>
                  </div>
                  <h4>All assets</h4>
                  <div class="card-dialog__asset-grid">
                    <button class="card-dialog__asset" type="button" data-card-asset aria-pressed="false" data-card-label="Storyboard thumbnails" data-card-meta="Artist upload ¬∑ yesterday" data-card-preview="linear-gradient(135deg, #ddd6fe, #f5d0fe)" data-card-prompt="Hand-drawn storyboard thumbnails of the rooftop chase with motion arrows and timing notes.">
                      <span class="card-dialog__asset-thumb" aria-hidden="true">SB</span>
                      <span class="card-dialog__asset-name">Storyboard thumbnails</span>
                      <span class="card-dialog__asset-meta">Artist upload ¬∑ yesterday</span>
                      <span class="card-dialog__asset-badge">Use as image input</span>
                    </button>
                    <button class="card-dialog__asset" type="button" data-card-asset aria-pressed="false" data-card-label="Lighting reference plates" data-card-meta="Look dev ¬∑ 2 days ago" data-card-preview="linear-gradient(135deg, #bae6ff, #7dd3fc)" data-card-prompt="Lighting plates captured at night with neon reflections, foggy rain atmosphere on rooftops.">
                      <span class="card-dialog__asset-thumb" aria-hidden="true">LX</span>
                      <span class="card-dialog__asset-name">Lighting plates</span>
                      <span class="card-dialog__asset-meta">Look dev ¬∑ 2 days ago</span>
                      <span class="card-dialog__asset-badge">Use as image input</span>
                    </button>
                    <button class="card-dialog__asset" type="button" data-card-asset aria-pressed="false" data-card-label="Shot list annotations" data-card-meta="Director notes ¬∑ 3 days ago" data-card-preview="linear-gradient(135deg, #fca5a5, #fef08a)" data-card-prompt="Shot list annotated with camera moves and emotional beats for the rooftop escape.">
                      <span class="card-dialog__asset-thumb" aria-hidden="true">DR</span>
                      <span class="card-dialog__asset-name">Director notes</span>
                      <span class="card-dialog__asset-meta">Director notes ¬∑ 3 days ago</span>
                      <span class="card-dialog__asset-badge">Use as image input</span>
                    </button>
                    <button class="card-dialog__asset" type="button" data-card-asset aria-pressed="false" data-card-label="Costume swatches" data-card-meta="Wardrobe ¬∑ this week" data-card-preview="linear-gradient(135deg, #fed7aa, #fecdd3)" data-card-prompt="Wardrobe swatches pinned beside rooftop reference photos, hero jacket and antagonist cape.">
                      <span class="card-dialog__asset-thumb" aria-hidden="true">WD</span>
                      <span class="card-dialog__asset-name">Costume palette</span>
                      <span class="card-dialog__asset-meta">Wardrobe ¬∑ this week</span>
                      <span class="card-dialog__asset-badge">Use as image input</span>
                    </button>
                    <button class="card-dialog__asset" type="button" data-card-asset aria-pressed="false" data-card-label="Animatic still" data-card-meta="Edit review ¬∑ last week" data-card-preview="linear-gradient(135deg, #cbd5f5, #e0f2fe)" data-card-prompt="Animatic still of the hero leaping between rooftops with motion blur and city glow.">
                      <span class="card-dialog__asset-thumb" aria-hidden="true">AN</span>
                      <span class="card-dialog__asset-name">Animatic still</span>
                      <span class="card-dialog__asset-meta">Edit review ¬∑ last week</span>
                      <span class="card-dialog__asset-badge">Use as image input</span>
                    </button>
                    <button class="card-dialog__asset" type="button" data-card-asset aria-pressed="false" data-card-label="Location photos" data-card-meta="Scout ¬∑ last month" data-card-preview="linear-gradient(135deg, #bbf7d0, #86efac)" data-card-prompt="Location scout photos of rain-slicked rooftops with emergency lighting and puddles.">
                      <span class="card-dialog__asset-thumb" aria-hidden="true">SC</span>
                      <span class="card-dialog__asset-name">Location plates</span>
                      <span class="card-dialog__asset-meta">Scout ¬∑ last month</span>
                      <span class="card-dialog__asset-badge">Use as image input</span>
                    </button>
                  </div>
                </div>
                <div class="card-dialog__panel" data-card-panel="frames" role="tabpanel" tabindex="-1" hidden>
                  <p class="card-dialog__hint">Storyboard frames generated for this beat will appear here.</p>
                  <div class="card-dialog__frame-list" data-card-dialog-frames></div>
                </div>
              </div>
            </section>
          </aside>
          <section class="card-dialog__main">
            <section class="card-dialog__section">
              <div class="card-dialog__section-header">
                <h3>Generate with ChatGPT</h3>
                <span class="card-dialog__chip card-dialog__chip--accent">Use as image input</span>
              </div>
              <p class="card-dialog__hint">Send script context to ChatGPT‚Äôs image creator for consistent storyboard cards.</p>
              <label class="card-dialog__label" for="cardDialogPrompt">Prompt</label>
              <textarea id="cardDialogPrompt" class="card-dialog__textarea" rows="4" placeholder="Describe the beat to render a frame‚Ä¶" data-card-dialog-prompt></textarea>
              <div class="card-dialog__form-grid">
                <label class="card-dialog__label">Style
                  <select data-card-dialog-style>
                    <option>Cinematic storyboard linework</option>
                    <option>Flat animation storyboard</option>
                    <option>Graphic novel noir</option>
                  </select>
                </label>
                <label class="card-dialog__label">Aspect ratio
                  <select data-card-dialog-aspect>
                    <option value="16:9">16:9</option>
                    <option value="2.39:1">2.39:1</option>
                    <option value="1:1">1:1</option>
                  </select>
                </label>
              </div>
              <div class="card-dialog__actions">
                <button class="btn" type="button" data-card-dialog-generate>Preview with ChatGPT</button>
              </div>
              <p class="card-dialog__status" data-card-dialog-status role="status" aria-live="polite">Ready to generate with ChatGPT image creator.</p>
            </section>
            <section class="card-dialog__section">
              <div class="card-dialog__section-header">
                <h3>Text fields</h3>
                <span class="card-dialog__hint">Cards, notes, and director cues synced live from Writer.</span>
              </div>
              <p class="card-dialog__summary" data-card-dialog-summary>Bring in your scene summary to seed prompts.</p>
              <div class="card-dialog__text-stack" data-card-dialog-text></div>
            </section>
          </section>
          <aside class="card-dialog__preview">
            <div class="card-dialog__section card-dialog__preview-card">
              <div class="card-dialog__preview-meta">
                <span class="card-dialog__preview-label">Selected asset</span>
                <strong data-card-dialog-preview-label>Designer sketching</strong>
                <span class="card-dialog__preview-sub" data-card-dialog-preview-meta>Sketchbook ¬∑ synced 2m ago</span>
              </div>
              <div class="card-dialog__preview-figure" data-card-dialog-preview-figure></div>
              <div class="card-dialog__preview-notes">
                <strong>Scene context</strong>
                <p data-card-dialog-meta-preview>Linked to draft v4 ¬∑ 00:45 runtime ¬∑ 8 frames</p>
              </div>
              <div class="card-dialog__preview-tags" data-card-dialog-preview-tags></div>
            </div>
          </aside>
        </div>
        <footer class="card-dialog__footer">
          <button class="btn" type="button" data-card-dialog-close>Close</button>
          <button class="btn btn-primary" type="button" data-card-dialog-generate>Generate 4 frames</button>
        </footer>
      </div>
    </dialog>

    <section class="feature-section">
      <h2>Storyboard Pro keeps every department locked to the same scene timeline.</h2>
      <div class="feature-grid">
        <div class="feature-card">
          <h3>Scene-aware continuity</h3>
          <p>Every block tracks back to a script beat, automatically inheriting dialogue, props, and camera notes from the writer.</p>
        </div>
        <div class="feature-card">
          <h3>Unified stacked timelines</h3>
          <p>Shots, audio cues, lighting rigs, and production notes live in parallel so teams can iterate without losing sync.</p>
        </div>
        <div class="feature-card">
          <h3>Realtime collaboration</h3>
          <p>Invite directors, storyboard artists, and producers with role-based access and threaded feedback.</p>
        </div>
        <div class="feature-card">
          <h3>Production-ready pipeline</h3>
          <p>Sync cues with lighting, VFX, and edit teams using integrations for Notion, Frame.io, and timeline apps.</p>
        </div>
      </div>
    </section>

    <div
      class="storyboard-ai-modal"
      data-storyboard-ai-modal
      role="dialog"
      aria-modal="true"
      aria-labelledby="storyboardAiModalTitle"
      hidden
    >
      <div class="storyboard-ai-modal__backdrop" data-storyboard-ai-dismiss></div>
      <div class="storyboard-ai-modal__dialog">
        <header class="storyboard-ai-modal__header">
          <h2 id="storyboardAiModalTitle" class="storyboard-ai-modal__title">Generate scene image</h2>
          <button class="storyboard-ai-modal__close" type="button" data-storyboard-ai-dismiss aria-label="Close dialog">√ó</button>
        </header>
        <p class="storyboard-ai-status" data-storyboard-ai-status role="status" aria-live="polite">Select a scene to start.</p>
        <form class="storyboard-ai-form" data-storyboard-ai-form>
          <input type="hidden" data-storyboard-ai-scene />
          <div class="storyboard-ai-form__group">
            <div class="storyboard-ai-field">
              <label for="storyboardAiPrompt">Prompt</label>
              <textarea id="storyboardAiPrompt" data-storyboard-ai-prompt rows="6" placeholder="Describe the frame you want to render."></textarea>
            </div>
            <div class="storyboard-ai-field">
              <label for="storyboardAiNegative">Negative prompt</label>
              <textarea id="storyboardAiNegative" data-storyboard-ai-negative rows="3" placeholder="Details to avoid (optional)"></textarea>
            </div>
            <div class="storyboard-ai-options-grid">
              <div class="storyboard-ai-option">
                <label for="storyboardAiWidth">Width</label>
                <input id="storyboardAiWidth" data-storyboard-ai-width type="number" min="256" max="1536" step="64" value="1024" />
              </div>
              <div class="storyboard-ai-option">
                <label for="storyboardAiHeight">Height</label>
                <input id="storyboardAiHeight" data-storyboard-ai-height type="number" min="256" max="1536" step="64" value="576" />
              </div>
              <div class="storyboard-ai-option">
                <label for="storyboardAiSteps">Steps</label>
                <input id="storyboardAiSteps" data-storyboard-ai-steps type="number" min="1" max="150" step="1" value="30" />
              </div>
              <div class="storyboard-ai-option">
                <label for="storyboardAiGuidance">Guidance</label>
                <input id="storyboardAiGuidance" data-storyboard-ai-guidance type="number" min="1" max="30" step="0.1" value="7" />
              </div>
              <div class="storyboard-ai-option">
                <label for="storyboardAiSeed">Seed</label>
                <input id="storyboardAiSeed" data-storyboard-ai-seed type="number" min="0" max="999999999" step="1" value="0" />
              </div>
            </div>
          </div>
          <div class="storyboard-ai-form__group">
            <div class="storyboard-ai-field">
              <label for="storyboardAiProvider">Provider</label>
              <select id="storyboardAiProvider" data-storyboard-ai-provider>
                <option value="auto">Auto select</option>
                <option value="openai">OpenAI</option>
                <option value="stability">Stability SDXL</option>
                <option value="openrouter">OpenRouter</option>
              </select>
            </div>
            <div class="storyboard-ai-upload">
              <label for="storyboardAiReference">Reference image</label>
              <select id="storyboardAiReference" data-storyboard-ai-reference>
                <option value="">No reference</option>
              </select>
              <input id="storyboardAiReferenceUpload" data-storyboard-ai-reference-upload type="file" accept="image/*" />
            </div>
            <div class="storyboard-ai-upload">
              <label for="storyboardAiMask">Mask (optional)</label>
              <select id="storyboardAiMask" data-storyboard-ai-mask>
                <option value="">No mask</option>
              </select>
              <input id="storyboardAiMaskUpload" data-storyboard-ai-mask-upload type="file" accept="image/*" />
            </div>
            <div class="storyboard-ai-history">
              <strong>Recent renders</strong>
              <div class="storyboard-ai-history__list" data-storyboard-ai-history></div>
            </div>
          </div>
          <div class="storyboard-ai-form__actions">
            <button class="storyboard-ai-button" type="button" data-storyboard-ai-dismiss>Cancel</button>
            <button class="storyboard-ai-button storyboard-ai-button--primary" type="submit" data-storyboard-ai-submit>Generate</button>
          </div>
          <p class="storyboard-ai-error" data-storyboard-ai-error hidden></p>
        </form>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="footer__grid">
      <div>
        <strong>StudioOrganize</strong>
        <p class="muted">Tools for storytellers &amp; focused work.</p>
      </div>
      <div>
        <a href="/about.html">About</a><br />
      </div>
      <div>
        <a href="mailto:support@studioorganize.com">support@studioorganize.com</a><br />
        <span class="muted">¬© <span id="y"></span> StudioOrganize</span>
      </div>
    </div>
  </footer>

  <script>
    const trackToggles = document.querySelectorAll('[data-track-toggle]');
    window.storyboardScenes = [];
    window.storyboardActiveSceneId = null;
    const sceneListContainer = document.querySelector('[data-scene-list]');
    const sceneTitle = document.querySelector('[data-scene-title]');
    const sceneMeta = document.querySelector('[data-scene-meta]');
    const currentFrameFigure = document.querySelector('[data-current-frame]');
    const currentFrameImage = currentFrameFigure ? currentFrameFigure.querySelector('[data-current-frame-image]') : null;
    const currentFrameTitle = currentFrameFigure ? currentFrameFigure.querySelector('[data-current-frame-title]') : null;
    const currentFrameMeta = currentFrameFigure ? currentFrameFigure.querySelector('[data-current-frame-meta]') : null;
    const currentFrameStatus = currentFrameFigure ? currentFrameFigure.querySelector('[data-current-frame-status]') : null;
    const timelineGrid = document.querySelector('[data-timeline-grid]');
    const timelineWrapper = document.querySelector('.timeline-wrapper');
    const aiPromptInput = document.getElementById('aiShotPrompt');
    const aiFrameInput = document.getElementById('aiFrameCount');
    const aiProviderSelect = document.getElementById('aiProvider');
    const aiStatusLabel = document.querySelector('[data-ai-status]');
    const aiResultContainer = document.querySelector('[data-ai-result]');
    const aiGenerateButton = document.querySelector('[data-ai-generate]');
    const apiManagerButton = document.querySelector('[data-api-manager]');
    const apiDialog = document.querySelector('[data-api-dialog]');
    const apiForm = document.querySelector('[data-api-form]');
    const apiCloseButtons = document.querySelectorAll('[data-api-close]');
    const sceneCarouselContainer = document.querySelector('[data-scene-carousel-container]');
    const sceneCarouselTrack = document.querySelector('[data-scene-carousel-track]');
    const sceneCarouselDots = document.querySelector('[data-scene-carousel-dots]');
    const sceneCarouselPrev = document.querySelector('[data-scene-carousel-prev]');
    const sceneCarouselNext = document.querySelector('[data-scene-carousel-next]');
    const sceneCarouselViewport = document.querySelector('[data-scene-carousel-viewport]');
    const sceneCarouselZoomButton = document.querySelector('[data-scene-carousel-zoom]');
    const sceneCarouselZoomLabel = sceneCarouselZoomButton
      ? sceneCarouselZoomButton.querySelector('[data-scene-carousel-zoom-label]')
      : null;
    const scenePairLab = document.querySelector('[data-scene-pair-lab]');
    const scenePairGrid = scenePairLab ? scenePairLab.querySelector('[data-scene-pair-grid]') : null;
    const scenePairCardsContainer = scenePairLab ? scenePairLab.querySelector('[data-scene-pair-cards]') : null;
    const scenePairPrevButton = scenePairLab ? scenePairLab.querySelector('[data-scene-pair-prev]') : null;
    const scenePairNextButton = scenePairLab ? scenePairLab.querySelector('[data-scene-pair-next]') : null;
    const scenePairFocusFigure = scenePairLab ? scenePairLab.querySelector('[data-scene-pair-focus]') : null;
    const scenePairFocusImage = scenePairLab ? scenePairLab.querySelector('[data-scene-pair-focus-image]') : null;
    const scenePairFocusLabel = scenePairLab ? scenePairLab.querySelector('[data-scene-pair-focus-label]') : null;
    const scenePairFocusTitle = scenePairLab ? scenePairLab.querySelector('[data-scene-pair-focus-title]') : null;
    const scenePairFocusMeta = scenePairLab ? scenePairLab.querySelector('[data-scene-pair-focus-meta]') : null;
    const scenePairGenerateButton = scenePairLab ? scenePairLab.querySelector('[data-scene-pair-generate]') : null;
    const scenePairEngineSelect = scenePairLab ? scenePairLab.querySelector('[data-scene-pair-engine]') : null;
    const cardDialog = document.querySelector('[data-card-dialog]');
    const cardDialogElements = cardDialog
      ? {
          scene: cardDialog.querySelector('[data-card-dialog-scene]'),
          meta: cardDialog.querySelector('[data-card-dialog-meta]'),
          metaPreview: cardDialog.querySelector('[data-card-dialog-meta-preview]'),
          summary: cardDialog.querySelector('[data-card-dialog-summary]'),
          text: cardDialog.querySelector('[data-card-dialog-text]'),
          frames: cardDialog.querySelector('[data-card-dialog-frames]'),
          previewLabel: cardDialog.querySelector('[data-card-dialog-preview-label]'),
          previewMeta: cardDialog.querySelector('[data-card-dialog-preview-meta]'),
          previewFigure: cardDialog.querySelector('[data-card-dialog-preview-figure]'),
          previewTags: cardDialog.querySelector('[data-card-dialog-preview-tags]'),
          status: cardDialog.querySelector('[data-card-dialog-status]'),
          prompt: cardDialog.querySelector('[data-card-dialog-prompt]'),
        }
      : null;
    const apiGeminiInput = apiDialog ? apiDialog.querySelector('[data-api-gemini]') : null;
    const apiSoaraInput = apiDialog ? apiDialog.querySelector('[data-api-soara]') : null;
    const apiFeedbackLabel = apiDialog ? apiDialog.querySelector('[data-api-feedback]') : null;

    const API_STORAGE_KEYS = {
      provider: 'ai.provider',
      gemini: 'ai.geminiKey',
      soara: 'ai.soaraKey',
    };

    const storage = createScopedStorage('storyboard');
    const TIMELINE_STORAGE_KEYS = { dockPinned: 'timelineDockPinned' };
    const TIMELINE_HIDE_DELAY = 3500;
    const SCENE_CAROUSEL_SWIPE_THRESHOLD = 48;
    const EMPTY_PREVIEW_SCENE = {
      numberLabel: 'Scene',
      displayName: 'No scene selected',
      description: 'Choose a scene to view its current frame.',
      color: '#4f7bff',
    };
    let timelinePinned = true;
    let timelineHideTimer = null;
    let timelineHovering = false;
    let lastTimelinePinned = null;

    const storedTimelinePinned = storage.get(TIMELINE_STORAGE_KEYS.dockPinned);
    if (storedTimelinePinned === 'true') {
      timelinePinned = true;
    } else if (storedTimelinePinned === 'false') {
      timelinePinned = false;
    }

    const sceneDataMap = new Map();
    let sceneData = [];
    let sceneCards = [];
    let sceneRows = [];
    let sceneCarouselOrder = [];
    let sceneCarouselSlides = [];
    let sceneCarouselDotsList = [];
    let activeSceneId = null;
    let sceneCarouselZoomed = true;
    let sceneCarouselDragState = null;
    let scenePairStartIndex = 0;
    let scenePairFocusId = null;

    setSceneCarouselZoom(true);
    updateCurrentFramePreview(null);

    setupScenePairLab();
    renderScenePairLab();
    initialiseAiProviderSelect();
    setupApiDialog();
    setupCardDialog();
    setupGenerationWorkflow();
    setupTimelineDockInteractions();
    renderTimelineDockScenes();
    renderSceneCarousel();

    const WRITER_DB_NAME = 'sw_db_v1';
    const WRITER_DB_STORE = 'projects';
    const WRITER_LAST_PROJECT_KEY = 'SW_LAST_PROJECT_ID';

    const FALLBACK_SCENES_RAW = [
      {
        id: 'demo-alley',
        slug: 'EXT. ALLEY - NIGHT',
        storyboardStatus: 'Storyboard locked ¬∑ 12 frames',
        storyboardDescription: 'Lighting cues synced to script beats.',
        cards: ['Establish threat', 'Knife reversal', 'Slow mo impact', 'Escape alley'],
        storyboards: [
          { id: 'demo-alley-shot-1', title: 'Establish threat' },
          { id: 'demo-alley-shot-2', title: 'Knife reversal' },
          { id: 'demo-alley-shot-3', title: 'Slow mo impact' },
          { id: 'demo-alley-shot-4', title: 'Escape alley' }
        ],
        sounds: [
          { id: 'demo-alley-sound-1', cue: 'SFX: rain layers' },
          { id: 'demo-alley-sound-2', cue: 'Score: tension swell' }
        ],
        notes: 'Director: stay wide\nProducer: add rain plates',
        metadata: {
          sceneTagState: { locationType: 'ALLEY', timeOfDay: 'NIGHT', custom: ['Rain soaked'] },
          sceneAutoColorLabel: 'Night exterior',
          sceneAutoColorDetail: 'Neon practical bounce'
        },
        color: '#1d4ed8'
      },
      {
        id: 'demo-rooftop',
        slug: 'EXT. ROOFTOP - NIGHT',
        storyboardStatus: 'In progress ¬∑ 8 frames',
        storyboardDescription: 'Share draft with second unit.',
        cards: ['Drone reveal', 'Leap across gap', 'Handheld scramble', 'Edge save'],
        storyboards: [
          { id: 'demo-rooftop-shot-1', title: 'Drone reveal' },
          { id: 'demo-rooftop-shot-2', title: 'Leap across gap' },
          { id: 'demo-rooftop-shot-3', title: 'Handheld scramble' },
          { id: 'demo-rooftop-shot-4', title: 'Edge save' }
        ],
        sounds: [
          { id: 'demo-rooftop-sound-1', cue: 'Drone whir' },
          { id: 'demo-rooftop-sound-2', cue: 'Score: percussive chase bed' },
          { id: 'demo-rooftop-sound-3', cue: 'Wind gusts' }
        ],
        notes: 'FX: add rain pass\nDirector: add wide landing',
        metadata: {
          sceneTagState: { locationType: 'ROOFTOP', timeOfDay: 'NIGHT', custom: ['Neon spill'] },
          sceneAutoColorLabel: 'City skyline',
          sceneAutoColorDetail: 'Helipad strobes'
        },
        color: '#1f2937'
      },
      {
        id: 'demo-safehouse',
        slug: 'INT. SAFEHOUSE - NIGHT',
        storyboardStatus: 'Needs review ¬∑ 5 frames',
        storyboardDescription: 'Director comments pending.',
        cards: ['Intel drop', 'Mission brief', 'Surveillance plan'],
        storyboards: [
          { id: 'demo-safehouse-shot-1', title: 'Table wide' },
          { id: 'demo-safehouse-shot-2', title: 'Files close-up' },
          { id: 'demo-safehouse-shot-3', title: 'Resolve push-in' }
        ],
        sounds: [
          { id: 'demo-safehouse-sound-1', cue: 'Score: low synth tension' },
          { id: 'demo-safehouse-sound-2', cue: 'Radio chatter' }
        ],
        notes: 'AD: schedule reshoot\nDP: add monitor glow',
        metadata: {
          sceneTagState: { locationType: 'SAFEHOUSE', timeOfDay: 'NIGHT', custom: ['Briefing table'] },
          sceneAutoColorLabel: 'Interior warm practicals',
          sceneAutoColorDetail: 'Desk lamps dim'
        },
        color: '#0f172a'
      },
      {
        id: 'demo-finale',
        slug: 'INT. SOUNDSTAGE - NIGHT',
        storyboardStatus: 'Storyboard AI ready',
        storyboardDescription: 'Generate new hero shots.',
        cards: ['Setup reveal', 'Hero choice', 'Twist', 'Resolution'],
        storyboards: [
          { id: 'demo-finale-shot-1', title: 'Reveal wide' },
          { id: 'demo-finale-shot-2', title: 'Close hero' },
          { id: 'demo-finale-shot-3', title: 'VFX burst' }
        ],
        sounds: [
          { id: 'demo-finale-sound-1', cue: 'Score: ascend' },
          { id: 'demo-finale-sound-2', cue: 'FX: energy surge' },
          { id: 'demo-finale-sound-3', cue: 'Score: resolve' }
        ],
        notes: 'Producer: confirm VFX\nDirector: punch final beat',
        metadata: {
          sceneTagState: { locationType: 'STAGE', timeOfDay: 'NIGHT', custom: ['Hero moment'] },
          sceneAutoColorLabel: 'Moving spots',
          sceneAutoColorDetail: 'Backlight flare'
        },
        color: '#312e81'
      }
    ];

    function sanitizeString(value) {
      return typeof value === 'string' ? value.trim() : '';
    }

    function extractCardLabel(card) {
      if (typeof card === 'string') return card.trim();
      if (!card || typeof card !== 'object') return '';
      const keys = ['title', 'label', 'name', 'text', 'slug'];
      for (const key of keys) {
        const value = card[key];
        if (typeof value === 'string' && value.trim()) return value.trim();
      }
      return '';
    }

    function extractStoryboardLabel(entry, index) {
      const label = extractCardLabel(entry);
      if (label) return label;
      return `Storyboard ${index + 1}`;
    }

    function extractSoundLabel(sound) {
      if (typeof sound === 'string') return sound.trim();
      if (!sound || typeof sound !== 'object') return '';
      if (typeof sound.cue === 'string' && sound.cue.trim()) return sound.cue.trim();
      if (typeof sound.title === 'string' && sound.title.trim()) return sound.title.trim();
      return '';
    }

    function resolveAudioIcon(label) {
      const lower = label.toLowerCase();
      if (lower.includes('score') || lower.includes('music') || lower.includes('choir')) {
        return 'üéµ';
      }
      return 'üîä';
    }

    function getSceneSnippetFromElements(elements) {
      if (!Array.isArray(elements)) return '';
      const text = elements
        .map(el => (el && typeof el.txt === 'string' ? el.txt : ''))
        .join(' ')
        .replace(/\s+/g, ' ')
        .trim();
      if (!text) return '';
      return text.length > 160 ? `${text.slice(0, 157)}‚Ä¶` : text;
    }

    function formatWriterScene(scene, index, options = {}) {
      const { source = 'writer' } = options;
      const rawSlug = sanitizeString(scene?.slug) || sanitizeString(scene?.title);
      const number = index + 1;
      const numberLabel = sanitizeString(scene?.metadata?.sceneNumberLabel) || `Scene ${number}`;
      const displayName = rawSlug || numberLabel;
      const cards = Array.isArray(scene?.cards) ? scene.cards.map(extractCardLabel).filter(Boolean) : [];
      const storyboards = Array.isArray(scene?.storyboards)
        ? scene.storyboards.map((entry, idx) => extractStoryboardLabel(entry, idx)).filter(Boolean)
        : [];
      const sounds = Array.isArray(scene?.sounds) ? scene.sounds.map(extractSoundLabel).filter(Boolean) : [];
      const metadata = scene && typeof scene.metadata === 'object' ? scene.metadata : {};
      const tagState = metadata.sceneTagState && typeof metadata.sceneTagState === 'object' ? metadata.sceneTagState : {};
      const notesLines = [];
      const rawNotes = sanitizeString(scene?.notes);
      if (rawNotes) {
        rawNotes.split(/\n+/).map(part => part.trim()).filter(Boolean).forEach(part => notesLines.push(part));
      }
      const customTags = Array.isArray(tagState.custom) ? tagState.custom.map(sanitizeString).filter(Boolean) : [];
      customTags.forEach(tag => notesLines.push(`Tag: ${tag}`));
      const snippet = getSceneSnippetFromElements(scene?.elements);
      let statusText = sanitizeString(scene?.storyboardStatus) || sanitizeString(metadata.storyboardStatus);
      if (!statusText) {
        const pieces = [];
        if (cards.length) pieces.push(`${cards.length} beat${cards.length === 1 ? '' : 's'}`);
        if (storyboards.length) pieces.push(`${storyboards.length} storyboard${storyboards.length === 1 ? '' : 's'}`);
        if (sounds.length) pieces.push(`${sounds.length} sound cue${sounds.length === 1 ? '' : 's'}`);
        statusText = pieces.join(' ¬∑ ') || 'No beats yet';
      }
      const description = sanitizeString(scene?.storyboardDescription)
        || sanitizeString(metadata.storyboardDescription)
        || snippet
        || 'Add scene summary in the writer to see it here.';
      const lightingCues = [];
      const autoLabel = sanitizeString(metadata.sceneAutoColorLabel);
      const autoDetail = sanitizeString(metadata.sceneAutoColorDetail);
      if (autoLabel) lightingCues.push(autoLabel);
      if (autoDetail && autoDetail !== autoLabel) lightingCues.push(autoDetail);
      const locationType = sanitizeString(tagState.locationType);
      const timeOfDay = sanitizeString(tagState.timeOfDay);
      const locationMeta = [locationType, timeOfDay].filter(Boolean).join(' ¬∑ ');
      if (!lightingCues.length && locationMeta) lightingCues.push(locationMeta);
      const notesList = notesLines.slice(0, 4);
      const sourceMeta = source === 'writer'
        ? 'Synced from Writer workspace'
        : 'Demo data ‚Äî open Writer to sync live scenes.';
      const timelinePieces = [];
      if (statusText) timelinePieces.push(statusText);
      if (locationMeta) timelinePieces.push(locationMeta);
      timelinePieces.push(sourceMeta);
      const colorValue = sanitizeString(scene?.color);
      const color = /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(colorValue) ? colorValue : '';
      const colorSourceRaw = sanitizeString(metadata.sceneColorSource || scene?.colorSource);
      const colorSourceLabel = color
        ? (colorSourceRaw === 'custom'
          ? 'Writer custom color'
          : (colorSourceRaw === 'auto'
            ? 'Writer auto color'
            : (source === 'writer' ? 'Writer scene color' : 'Demo scene color')))
        : 'Scene color';
      const previewImages = Array.isArray(scene?.previewImages)
        ? scene.previewImages
            .map(value => (typeof value === 'string' ? value.trim() : ''))
            .filter(Boolean)
        : [];

      return {
        id: String(scene?.id || `scene-${index}`),
        index,
        numberLabel,
        displayName,
        statusText,
        description,
        timelineMeta: timelinePieces.join(' ¬∑ '),
        cards,
        storyboards,
        sounds,
        lightingCues,
        notesList,
        color,
        colorSourceLabel,
        source,
        previewImages,
      };
    }

    function computeBlockPositions(count) {
      if (!count) return [];
      if (count === 1) {
        return [{ left: 30, width: 40 }];
      }
      const width = Math.max(12, Math.min(36, 70 / count));
      const step = (100 - width) / Math.max(1, count - 1);
      const positions = [];
      for (let index = 0; index < count; index += 1) {
        const left = Math.max(0, Math.min(100 - width, step * index));
        positions.push({ left, width });
      }
      return positions;
    }

    function createTimelineTrack(trackKey, headerLabel, blockClass, icon, items, iconResolver = null) {
      const track = document.createElement('div');
      track.className = 'timeline-track';
      track.dataset.track = trackKey;
      const header = document.createElement('div');
      header.className = 'timeline-track__header';
      header.textContent = headerLabel;
      const lane = document.createElement('div');
      lane.className = 'timeline-track__lane';
      const values = Array.isArray(items) ? items.filter(Boolean) : [];
      const positions = computeBlockPositions(values.length);
      values.forEach((label, index) => {
        const block = document.createElement('div');
        block.className = `timeline-block ${blockClass}`;
        const iconValue = iconResolver ? iconResolver(label) : icon;
        block.dataset.icon = iconValue;
        block.style.left = `${positions[index].left}%`;
        block.style.width = `${positions[index].width}%`;
        block.textContent = label;
        lane.appendChild(block);
      });
      track.append(header, lane);
      return track;
    }

    function createSceneCard(scene) {
      const card = document.createElement('div');
      card.className = 'scene-card';
      card.dataset.scene = scene.id;
      card.setAttribute('role', 'button');
      card.tabIndex = 0;
      const combinedLabel = `${scene.numberLabel} ¬∑ ${scene.displayName}`;
      card.setAttribute('aria-label', combinedLabel);

      const label = document.createElement('div');
      label.className = 'scene-card-label';
      label.setAttribute('data-scene-edit-root', '');

      const color = document.createElement('span');
      color.className = 'scene-card-color';
      color.setAttribute('aria-hidden', 'true');
      if (scene.color) {
        color.style.background = scene.color;
      }
      if (scene.colorSourceLabel) {
        color.title = scene.colorSourceLabel;
      }

      const display = document.createElement('div');
      display.className = 'scene-card-label-display';
      const strong = document.createElement('strong');
      strong.dataset.sceneCardNumber = '';
      strong.textContent = scene.numberLabel;
      const separator = document.createElement('span');
      separator.className = 'scene-card-separator';
      separator.setAttribute('aria-hidden', 'true');
      separator.textContent = '¬∑';
      const name = document.createElement('span');
      name.dataset.sceneCardName = '';
      name.textContent = scene.displayName;
      display.append(strong, separator, name);

      const input = document.createElement('input');
      input.className = 'scene-card-input';
      input.type = 'text';
      input.value = scene.displayName;
      input.setAttribute('data-scene-input', '');
      input.setAttribute('aria-label', 'Scene name');

      label.append(color, display, input);

      const status = document.createElement('small');
      status.textContent = scene.statusText || '';

      const description = document.createElement('p');
      description.className = 'muted';
      description.textContent = scene.description || '';

      const thumbnail = document.createElement('div');
      thumbnail.className = 'scene-card-thumbnail';
      const thumbnailImage = document.createElement('img');
      thumbnailImage.loading = 'lazy';
      thumbnailImage.alt = `${combinedLabel} storyboard preview`;
      thumbnailImage.dataset.sceneThumbnail = scene.id;
      const previewImages = getScenePreviewImages(scene);
      if (previewImages.length) {
        thumbnailImage.src = previewImages[0];
        thumbnailImage.hidden = false;
      } else {
        thumbnailImage.hidden = true;
        thumbnailImage.removeAttribute('src');
      }
      thumbnail.appendChild(thumbnailImage);

      const actions = document.createElement('div');
      actions.className = 'scene-card-actions';
      const generateBtn = document.createElement('button');
      generateBtn.type = 'button';
      generateBtn.className = 'scene-card-generate';
      generateBtn.dataset.sceneGenerate = scene.id;
      generateBtn.textContent = 'Generate image';
      actions.appendChild(generateBtn);

      card.append(label, status, description, thumbnail, actions);

      card.addEventListener('click', () => {
        if (card.classList.contains('editing')) return;
        activateScene(scene.id);
      });

      card.addEventListener('keydown', event => {
        if (event.key === 'F2') {
          event.preventDefault();
          startSceneRename(card);
          return;
        }
        if (card.classList.contains('editing')) return;
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          activateScene(scene.id);
        }
      });

      label.addEventListener('dblclick', event => {
        event.preventDefault();
        event.stopPropagation();
        startSceneRename(card);
      });

      input.addEventListener('keydown', event => {
        if (event.key === 'Enter') {
          event.preventDefault();
          finishSceneRename(card, true);
        } else if (event.key === 'Escape') {
          event.preventDefault();
          finishSceneRename(card, false);
        }
      });
      input.addEventListener('blur', () => finishSceneRename(card, true));
      input.addEventListener('click', event => event.stopPropagation());

      return card;
    }

    function createTimelineScene(scene) {
      const row = document.createElement('div');
      row.className = 'timeline-scene';
      row.dataset.sceneRow = scene.id;
      row.dataset.sceneName = `${scene.numberLabel} ¬∑ ${scene.displayName}`;
      row.dataset.sceneMeta = scene.timelineMeta;

      const label = document.createElement('div');
      label.className = 'timeline-scene__label';
      const number = document.createElement('strong');
      number.textContent = scene.numberLabel;
      const name = document.createElement('span');
      name.textContent = scene.displayName;
      const small = document.createElement('small');
      small.textContent = scene.statusText || '';
      label.append(number, name, small);

      const tracks = document.createElement('div');
      tracks.className = 'timeline-scene__tracks';
      const beatGridLabels = Array.isArray(scene.cards)
        ? scene.cards.map((_, index) => `Beat ${index + 1}`)
        : [];
      tracks.append(
        createTimelineTrack('cards', 'Cards', 'timeline-block--cards', 'üÉè', scene.cards),
        createTimelineTrack('beats', 'Beat grid', 'timeline-block--beats', '‚è±', beatGridLabels),
        createTimelineTrack('shots', 'Shots', 'timeline-block--shots', 'üé¨', scene.storyboards),
        createTimelineTrack('audio', 'Audio', 'timeline-block--audio', 'üîä', scene.sounds, resolveAudioIcon),
        createTimelineTrack('lighting', 'Lighting', 'timeline-block--lighting', 'üí°', scene.lightingCues),
        createTimelineTrack('notes', 'Notes', 'timeline-block--notes', 'üìù', scene.notesList)
      );

      row.append(label, tracks);
      return row;
    }

    function clearSceneCarouselDragStyles() {
      if (!sceneCarouselTrack) return;
      sceneCarouselTrack.style.removeProperty('--scene-carousel-drag-offset');
      sceneCarouselTrack.style.removeProperty('--scene-carousel-drag-transition');
    }

    function renderSceneCarousel() {
      if (!sceneCarouselTrack) return;
      sceneCarouselTrack.innerHTML = '';
      sceneCarouselOrder = [];
      sceneCarouselSlides = [];
      sceneCarouselDotsList = [];
      if (sceneCarouselDots) sceneCarouselDots.innerHTML = '';
      clearSceneCarouselDragStyles();
      if (sceneCarouselViewport) sceneCarouselViewport.classList.remove('is-dragging');

      const scenes = Array.isArray(sceneData) ? sceneData : [];
      if (!scenes.length) {
        const slide = document.createElement('li');
        slide.className = 'scene-carousel__slide';
        const empty = document.createElement('div');
        empty.className = 'scene-carousel__empty';
        empty.textContent = 'Add scenes to view storyboard previews.';
        slide.appendChild(empty);
        sceneCarouselTrack.appendChild(slide);
        clearSceneCarouselDragStyles();
        if (sceneCarouselPrev) sceneCarouselPrev.disabled = true;
        if (sceneCarouselNext) sceneCarouselNext.disabled = true;
        updateSceneCarouselZoomAvailability(false);
        return;
      }

      const fragment = document.createDocumentFragment();
      const dotsFragment = document.createDocumentFragment();

      scenes.forEach(scene => {
        const slide = createSceneCarouselSlide(scene);
        fragment.appendChild(slide);
        sceneCarouselOrder.push(scene.id);
        sceneCarouselSlides.push(slide);

        if (sceneCarouselDots) {
          const dot = document.createElement('button');
          dot.type = 'button';
          dot.className = 'scene-carousel__dot';
          dot.dataset.sceneCarouselTarget = scene.id;
          dot.setAttribute('role', 'tab');
          dot.setAttribute('aria-label', `${scene.numberLabel} ¬∑ ${scene.displayName}`);
          dot.setAttribute('aria-selected', 'false');
          dot.tabIndex = -1;
          dot.addEventListener('click', () => activateScene(scene.id, { scroll: false }));
          dotsFragment.appendChild(dot);
          sceneCarouselDotsList.push(dot);
        }
      });

      sceneCarouselTrack.appendChild(fragment);
      if (sceneCarouselDots) sceneCarouselDots.appendChild(dotsFragment);
      updateSceneCarouselZoomAvailability(true);
      syncSceneCarouselActiveState();
    }

    function setSceneCarouselZoom(nextState) {
      if (!sceneCarouselContainer) return;
      sceneCarouselZoomed = nextState;
      sceneCarouselContainer.classList.toggle('scene-carousel--zoomed', sceneCarouselZoomed);
      if (sceneCarouselZoomButton) {
        sceneCarouselZoomButton.setAttribute('aria-pressed', sceneCarouselZoomed ? 'true' : 'false');
      }
      if (sceneCarouselZoomLabel) {
        sceneCarouselZoomLabel.textContent = sceneCarouselZoomed ? 'Zoom out' : 'Zoom in';
      }
    }

    function updateSceneCarouselZoomAvailability(hasScenes) {
      if (!sceneCarouselZoomButton) return;
      sceneCarouselZoomButton.hidden = !hasScenes;
      sceneCarouselZoomButton.disabled = !hasScenes;
      if (!hasScenes && sceneCarouselZoomed) {
        setSceneCarouselZoom(false);
      } else if (hasScenes) {
        setSceneCarouselZoom(sceneCarouselZoomed);
      }
    }

    function createSceneCarouselSlide(scene) {
      const slide = document.createElement('li');
      slide.className = 'scene-carousel__slide';
      slide.dataset.sceneCarouselSlide = scene.id;

      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'scene-carousel__slide-button';
      const combinedLabel = `${scene.numberLabel} ¬∑ ${scene.displayName}`;
      button.setAttribute('aria-label', `Activate ${combinedLabel}`);
      button.addEventListener('click', () => activateScene(scene.id, { scroll: false }));

      const figure = document.createElement('figure');
      figure.className = 'scene-carousel__figure';

      const imageWrapper = document.createElement('div');
      imageWrapper.className = 'scene-carousel__image-wrapper';
      const previewImages = getScenePreviewImages(scene);
      const hasPreviewImages = previewImages.length > 0;

      const image = document.createElement('img');
      image.className = 'scene-carousel__image';
      image.src = hasPreviewImages ? previewImages[0] : createScenePreviewData(scene);
      image.alt = hasPreviewImages
        ? `${combinedLabel} storyboard preview${previewImages.length > 1 ? ` (showing frame 1 of ${previewImages.length})` : ''}`
        : `${combinedLabel} preview image`;
      image.loading = 'lazy';
      image.decoding = 'async';
      imageWrapper.appendChild(image);

      if (previewImages.length > 1) {
        const strip = document.createElement('div');
        strip.className = 'scene-carousel__image-strip';
        const extraImages = previewImages.slice(1, 4);
        extraImages.forEach((src, index) => {
          const thumb = document.createElement('img');
          thumb.className = 'scene-carousel__thumb';
          thumb.src = src;
          thumb.alt = `${combinedLabel} storyboard preview frame ${index + 2}`;
          thumb.loading = 'lazy';
          thumb.decoding = 'async';
          strip.appendChild(thumb);
        });
        const remaining = previewImages.length - (1 + extraImages.length);
        if (remaining > 0) {
          const count = document.createElement('span');
          count.className = 'scene-carousel__thumb-count';
          count.textContent = `+${remaining}`;
          count.title = `${remaining} more storyboard frame${remaining === 1 ? '' : 's'}`;
          strip.appendChild(count);
        }
        imageWrapper.appendChild(strip);
      }

      const caption = document.createElement('figcaption');
      caption.className = 'scene-carousel__caption';

      const title = document.createElement('h3');
      title.className = 'scene-carousel__title';
      const number = document.createElement('small');
      number.textContent = scene.numberLabel;
      const name = document.createElement('span');
      name.textContent = scene.displayName;
      title.append(number, name);

      const description = document.createElement('p');
      description.className = 'scene-carousel__description';
      description.textContent = scene.description || 'Add a scene summary in the writer to see it here.';

      caption.append(title, description);

      if (scene.timelineMeta || scene.statusText) {
        const meta = document.createElement('p');
        meta.className = 'scene-carousel__meta';
        meta.textContent = scene.timelineMeta || scene.statusText;
        caption.appendChild(meta);
      }

      figure.append(imageWrapper, caption);
      button.appendChild(figure);
      slide.appendChild(button);
      return slide;
    }

    function cleanImageUrl(value) {
      return typeof value === 'string' ? value.trim() : '';
    }

    function normaliseScenePreviewImages(scene) {
      if (!scene || typeof scene !== 'object') return [];
      const cleaned = [];
      const seen = new Set();
      const push = url => {
        const formatted = cleanImageUrl(url);
        if (formatted && !seen.has(formatted)) {
          seen.add(formatted);
          cleaned.push(formatted);
        }
      };
      if (Array.isArray(scene.previewImages)) {
        scene.previewImages.forEach(push);
      }
      if (!cleaned.length && scene.latestRenderUrl) {
        push(scene.latestRenderUrl);
      }
      scene.previewImages = cleaned;
      if (cleaned.length) {
        scene.latestRenderUrl = cleaned[0];
      } else if ('latestRenderUrl' in scene) {
        delete scene.latestRenderUrl;
      }
      return cleaned;
    }

    function getScenePreviewImages(scene) {
      return normaliseScenePreviewImages(scene);
    }

    function createScenePreviewData(scene) {
      const baseColor = /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(scene.color || '') ? scene.color : '#4f7bff';
      const fallbackAccent = '#22d3ee';
      const label = encodeSvgText(scene.numberLabel || 'Scene');
      const rawName = scene.displayName || 'Storyboard';
      const rawDescription = scene.description || 'Scene preview';
      const name = encodeSvgText(rawName.length > 42 ? `${rawName.slice(0, 39)}‚Ä¶` : rawName);
      const description = encodeSvgText(rawDescription.length > 72 ? `${rawDescription.slice(0, 69)}‚Ä¶` : rawDescription);
      const svg = `<?xml version="1.0" encoding="UTF-8"?>` +
        `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 360" preserveAspectRatio="xMidYMid slice">` +
        `<defs>` +
        `<linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">` +
        `<stop offset="0%" stop-color="${baseColor}" stop-opacity="0.95"/>` +
        `<stop offset="100%" stop-color="${fallbackAccent}" stop-opacity="0.85"/>` +
        `</linearGradient>` +
        `</defs>` +
        `<rect width="600" height="360" fill="${baseColor}"/>` +
        `<rect width="600" height="360" fill="url(#grad)"/>` +
        `<text x="40" y="120" fill="rgba(255,255,255,0.86)" font-size="52" font-family="'Segoe UI', 'Inter', sans-serif" font-weight="600">${label}</text>` +
        `<text x="40" y="200" fill="rgba(255,255,255,0.92)" font-size="40" font-family="'Segoe UI', 'Inter', sans-serif" font-weight="500">${name}</text>` +
        `<text x="40" y="260" fill="rgba(255,255,255,0.78)" font-size="24" font-family="'Segoe UI', 'Inter', sans-serif" font-weight="400">${description}</text>` +
        `</svg>`;
      return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
    }

    function getSceneCombinedLabel(scene) {
      if (!scene || typeof scene !== 'object') return '';
      const number = sanitizeString(scene.numberLabel);
      const name = sanitizeString(scene.displayName);
      if (number && name && number !== name) return `${number} ¬∑ ${name}`;
      return number || name || '';
    }

    function getScenePreviewImageDetails(scene, combinedLabel) {
      const label = combinedLabel || getSceneCombinedLabel(scene) || 'Scene preview';
      const previewImages = getScenePreviewImages(scene);
      if (previewImages.length) {
        const suffix = previewImages.length > 1 ? ` (showing frame 1 of ${previewImages.length})` : '';
        return {
          src: previewImages[0],
          alt: `${label} storyboard preview${suffix}`,
        };
      }
      return {
        src: createScenePreviewData(scene),
        alt: `${label} preview image`,
      };
    }

    function getEmptyPreviewImageDetails() {
      return {
        src: createScenePreviewData(EMPTY_PREVIEW_SCENE),
        alt: 'Select a scene to view its current frame',
      };
    }

    function updateCurrentFramePreview(scene) {
      if (!currentFrameFigure) return;
      const hasScene = Boolean(scene);
      currentFrameFigure.classList.toggle('timeline-preview--empty', !hasScene);

      const combinedLabel = hasScene ? getSceneCombinedLabel(scene) : '';
      const titleText = hasScene ? combinedLabel || 'Scene preview' : 'No scene selected';
      if (currentFrameTitle) currentFrameTitle.textContent = titleText;

      if (currentFrameMeta) {
        currentFrameMeta.textContent = hasScene
          ? scene.timelineMeta || 'Timeline metadata not available yet.'
          : 'Activate a scene from the list to sync timeline metadata.';
      }

      if (currentFrameStatus) {
        const statusText = hasScene
          ? scene.statusText || 'Storyboard previews update as you add frames.'
          : 'Storyboard previews will appear here when a scene is active.';
        currentFrameStatus.textContent = statusText;
        currentFrameStatus.hidden = !statusText;
      }

      if (currentFrameImage) {
        const details = hasScene
          ? getScenePreviewImageDetails(scene, combinedLabel)
          : getEmptyPreviewImageDetails();
        currentFrameImage.src = details.src;
        currentFrameImage.alt = details.alt;
      }
    }

    function encodeSvgText(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function syncSceneCarouselActiveState() {
      if (!sceneCarouselTrack) return;
      const hasScenes = sceneCarouselOrder.length > 0;
      let index = hasScenes ? sceneCarouselOrder.indexOf(activeSceneId) : -1;
      if (index < 0 && hasScenes) {
        index = 0;
      }

      const offsetClassMap = [
        { offset: -1, className: 'scene-carousel__slide--previous' },
        { offset: 1, className: 'scene-carousel__slide--next' },
        { offset: -2, className: 'scene-carousel__slide--previous-2' },
        { offset: 2, className: 'scene-carousel__slide--next-2' },
        { offset: -3, className: 'scene-carousel__slide--previous-3' },
        { offset: 3, className: 'scene-carousel__slide--next-3' },
        { offset: -4, className: 'scene-carousel__slide--previous-4' },
        { offset: 4, className: 'scene-carousel__slide--next-4' },
        { offset: -5, className: 'scene-carousel__slide--previous-5' },
        { offset: 5, className: 'scene-carousel__slide--next-5' },
      ];

      sceneCarouselSlides.forEach((slide, slideIndex) => {
        const isActive = index >= 0 && slideIndex === index;
        const offset = index >= 0 ? slideIndex - index : 0;
        slide.classList.toggle('scene-carousel__slide--active', isActive);
        offsetClassMap.forEach(({ offset: classOffset, className }) => {
          slide.classList.toggle(className, index >= 0 && offset === classOffset);
        });
        slide.classList.toggle('scene-carousel__slide--offscreen', index >= 0 && Math.abs(offset) > 5);
        if (index >= 0) {
          slide.style.zIndex = String(20 - Math.abs(offset));
        } else {
          slide.style.zIndex = '';
        }
      });

      sceneCarouselDotsList.forEach((dot, dotIndex) => {
        const isActive = dotIndex === index && index >= 0;
        dot.setAttribute('aria-selected', isActive ? 'true' : 'false');
        dot.tabIndex = isActive ? 0 : -1;
      });

      const atStart = index <= 0;
      const atEnd = !hasScenes || index >= sceneCarouselOrder.length - 1;
      if (sceneCarouselPrev) sceneCarouselPrev.disabled = atStart;
      if (sceneCarouselNext) sceneCarouselNext.disabled = atEnd;
      if (!sceneCarouselDragState) {
        clearSceneCarouselDragStyles();
      }
    }

    function renderScenes() {
      if (!sceneListContainer || !timelineGrid) return;
      sceneDataMap.clear();
      sceneListContainer.innerHTML = '';
      timelineGrid.querySelectorAll('.timeline-scene').forEach(el => el.remove());

      if (!sceneData.length) {
        const empty = document.createElement('p');
        empty.className = 'muted';
        empty.dataset.sceneEmpty = 'true';
        empty.textContent = 'No scenes yet. Open the Writer workspace to add scenes.';
        sceneListContainer.appendChild(empty);
        if (sceneTitle) sceneTitle.textContent = 'No scenes yet';
        if (sceneMeta) sceneMeta.textContent = 'Create a scene in the writer to sync it here.';
        updateCurrentFramePreview(null);
        sceneCards = [];
        sceneRows = [];
        window.storyboardScenes = [];
        scenePairStartIndex = 0;
        scenePairFocusId = null;
        document.dispatchEvent(
          new CustomEvent('storyboard:scenes-rendered', {
            detail: { scenes: [], activeSceneId: null },
          })
        );
        activeSceneId = null;
        renderSceneCarousel();
        renderTimelineDockScenes();
        updateStoryArcActiveState();
        syncCardDialogSceneData();
        return;
      }

      const fragment = document.createDocumentFragment();
      sceneData.forEach(scene => {
        normaliseScenePreviewImages(scene);
        sceneDataMap.set(scene.id, scene);
        fragment.appendChild(createSceneCard(scene));
      });
      sceneListContainer.appendChild(fragment);
      sceneCards = Array.from(sceneListContainer.querySelectorAll('.scene-card'));
      window.storyboardScenes = Array.isArray(sceneData) ? [...sceneData] : [];
      document.dispatchEvent(
        new CustomEvent('storyboard:scenes-rendered', {
          detail: { scenes: window.storyboardScenes, activeSceneId },
        })
      );

      sceneData.forEach(scene => {
        timelineGrid.appendChild(createTimelineScene(scene));
      });
      sceneRows = Array.from(timelineGrid.querySelectorAll('[data-scene-row]'));
      renderSceneCarousel();
      renderTimelineDockScenes();

      if (!sceneDataMap.has(activeSceneId)) {
        activeSceneId = sceneData[0]?.id || null;
      }

      if (activeSceneId) {
        activateScene(activeSceneId, { scroll: false });
      } else {
        updateStoryArcActiveState();
        syncCardDialogSceneData();
      }
    }

    async function bootstrapScenes() {
      if (sceneListContainer) {
        sceneListContainer.innerHTML = '';
        const loading = document.createElement('p');
        loading.className = 'muted';
        loading.dataset.sceneEmpty = 'true';
        loading.textContent = 'Loading scenes from Writer‚Ä¶';
        sceneListContainer.appendChild(loading);
      }
      const writerScenes = await loadWriterScenes();
      if (writerScenes && writerScenes.length) {
        sceneData = writerScenes;
      } else {
        sceneData = FALLBACK_SCENES_RAW.map((scene, index) => formatWriterScene(scene, index, { source: 'fallback' }));
      }
      renderScenes();
    }

    function setupScenePairLab() {
      if (!scenePairLab) return;
      if (scenePairPrevButton) {
        scenePairPrevButton.addEventListener('click', () => shiftScenePair(-1));
      }
      if (scenePairNextButton) {
        scenePairNextButton.addEventListener('click', () => shiftScenePair(1));
      }
    }

    function getScenePairScenes() {
      const scenes = Array.isArray(sceneData) ? sceneData : [];
      if (!scenes.length) return [];
      const length = scenes.length;
      const normalisedStart = ((scenePairStartIndex % length) + length) % length;
      scenePairStartIndex = normalisedStart;
      const firstScene = scenes[normalisedStart] || null;
      if (length === 1) {
        return [firstScene, null];
      }
      const secondScene = scenes[(normalisedStart + 1) % length] || null;
      return [firstScene, secondScene];
    }

    function shiftScenePair(step) {
      const scenes = Array.isArray(sceneData) ? sceneData : [];
      if (!scenes.length) return;
      const length = scenes.length;
      if (!length) return;
      const nextIndex = ((scenePairStartIndex + step) % length + length) % length;
      setScenePairStart(nextIndex, { focusSceneId: scenePairFocusId });
    }

    function setScenePairStart(index, options = {}) {
      const scenes = Array.isArray(sceneData) ? sceneData : [];
      if (!scenes.length) return;
      const length = scenes.length;
      const normalisedIndex = ((index % length) + length) % length;
      scenePairStartIndex = normalisedIndex;
      if (options && options.focusSceneId) {
        scenePairFocusId = options.focusSceneId;
      }
      const pair = getScenePairScenes();
      const pairIds = pair.map(scene => (scene ? scene.id : null)).filter(Boolean);
      if (!pairIds.includes(scenePairFocusId)) {
        scenePairFocusId = pairIds[0] || null;
      }
      renderScenePairLab();
    }

    function setScenePairFocus(sceneId) {
      if (!sceneId) return;
      const scenes = Array.isArray(sceneData) ? sceneData : [];
      const exists = scenes.some(scene => scene && scene.id === sceneId);
      if (!exists) return;
      scenePairFocusId = sceneId;
      renderScenePairLab();
    }

    function renderScenePairLab() {
      if (!scenePairLab) return;
      const scenes = Array.isArray(sceneData) ? sceneData : [];
      const hasScenes = scenes.length > 0;
      scenePairLab.classList.toggle('scene-pair-lab--empty', !hasScenes);

      if (!hasScenes) {
        if (scenePairGrid) {
          scenePairGrid.innerHTML = '';
          const emptyItem = document.createElement('li');
          emptyItem.className = 'scene-pair-grid__empty';
          emptyItem.setAttribute('role', 'listitem');
          emptyItem.textContent = 'Add scenes to start pairing.';
          scenePairGrid.appendChild(emptyItem);
        }
        if (scenePairCardsContainer) {
          scenePairCardsContainer.innerHTML = '';
          const placeholder = document.createElement('article');
          placeholder.className = 'scene-pair-card scene-pair-card--empty';
          const text = document.createElement('p');
          text.textContent = 'Create scenes in Writer to explore pairs.';
          placeholder.appendChild(text);
          scenePairCardsContainer.appendChild(placeholder);
        }
        if (scenePairPrevButton) scenePairPrevButton.disabled = true;
        if (scenePairNextButton) scenePairNextButton.disabled = true;
        if (scenePairFocusFigure) scenePairFocusFigure.hidden = true;
        if (scenePairGenerateButton) {
          scenePairGenerateButton.disabled = true;
          scenePairGenerateButton.title = '';
        }
        if (scenePairEngineSelect) {
          scenePairEngineSelect.disabled = true;
          scenePairEngineSelect.value = '';
        }
        return;
      }

      const pair = getScenePairScenes();
      const pairIds = pair.map(scene => (scene ? scene.id : null)).filter(Boolean);
      if (!pairIds.includes(scenePairFocusId)) {
        scenePairFocusId = pairIds[0] || null;
      }

      if (scenePairGrid) {
        scenePairGrid.innerHTML = '';
        const fragment = document.createDocumentFragment();
        scenes.forEach((scene, index) => {
          const item = document.createElement('li');
          item.className = 'scene-pair-grid__item';
          item.setAttribute('role', 'listitem');
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'scene-pair-grid__button';
          const numberLabel = scene.numberLabel || `Scene ${index + 1}`;
          const rawName = scene.displayName || scene.slug || `Scene ${index + 1}`;
          const isInPair = pairIds.includes(scene.id);
          const isFocused = scene.id === scenePairFocusId;
          if (isInPair) button.classList.add('is-active');
          if (isFocused) button.classList.add('is-focused');
          button.setAttribute('aria-pressed', isInPair ? 'true' : 'false');
          button.setAttribute('aria-label', `${numberLabel} ¬∑ ${rawName}. Set as starting scene for pair.`);
          const numberSpan = document.createElement('span');
          numberSpan.textContent = numberLabel;
          const nameSpan = document.createElement('span');
          nameSpan.textContent = rawName;
          button.append(numberSpan, nameSpan);
          button.addEventListener('click', () => setScenePairStart(index, { focusSceneId: scene.id }));
          item.appendChild(button);
          fragment.appendChild(item);
        });
        scenePairGrid.appendChild(fragment);
      }

      if (scenePairPrevButton) scenePairPrevButton.disabled = scenes.length <= 1;
      if (scenePairNextButton) scenePairNextButton.disabled = scenes.length <= 1;

      if (scenePairCardsContainer) {
        scenePairCardsContainer.innerHTML = '';
        const cardsFragment = document.createDocumentFragment();
        pair.forEach((scene, cardIndex) => {
          if (!scene) {
            const placeholder = document.createElement('article');
            placeholder.className = 'scene-pair-card scene-pair-card--empty';
            const text = document.createElement('p');
            text.textContent = 'Add another scene to complete the pair.';
            placeholder.appendChild(text);
            cardsFragment.appendChild(placeholder);
            return;
          }
          const card = document.createElement('article');
          card.className = 'scene-pair-card' + (scene.id === scenePairFocusId ? ' scene-pair-card--active' : '');
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'scene-pair-card__button';
          button.addEventListener('click', () => setScenePairFocus(scene.id));
          const eyebrow = document.createElement('span');
          eyebrow.className = 'scene-pair-card__eyebrow';
          eyebrow.textContent = `${cardIndex === 0 ? 'First' : 'Second'} ¬∑ ${scene.numberLabel || `Scene ${cardIndex + 1}`}`;
          const title = document.createElement('p');
          title.className = 'scene-pair-card__title';
          title.textContent = scene.displayName || scene.slug || 'Untitled scene';
          const meta = document.createElement('p');
          meta.className = 'scene-pair-card__meta';
          meta.textContent = scene.timelineMeta || scene.statusText || 'Timeline metadata coming soon.';
          button.append(eyebrow, title, meta);
          card.appendChild(button);
          cardsFragment.appendChild(card);
        });
        scenePairCardsContainer.appendChild(cardsFragment);
      }

      const focusScene = pair.find(scene => scene && scene.id === scenePairFocusId) || pair.find(Boolean) || null;
      if (scenePairFocusFigure) {
        if (!focusScene) {
          scenePairFocusFigure.hidden = true;
        } else {
          scenePairFocusFigure.hidden = false;
          const previewImages = getScenePreviewImages(focusScene);
          const previewSrc = previewImages[0] || createScenePreviewData(focusScene);
          if (scenePairFocusImage) {
            scenePairFocusImage.src = previewSrc;
            const focusTitle = focusScene.displayName || focusScene.slug || 'Storyboard preview';
            const focusNumber = focusScene.numberLabel || 'Scene';
            scenePairFocusImage.alt = `${focusNumber} ¬∑ ${focusTitle} preview image`;
          }
          if (scenePairFocusLabel) {
            scenePairFocusLabel.textContent = focusScene.numberLabel || 'Scene';
          }
          if (scenePairFocusTitle) {
            scenePairFocusTitle.textContent = focusScene.displayName || focusScene.slug || 'Storyboard preview';
          }
          if (scenePairFocusMeta) {
            scenePairFocusMeta.textContent = focusScene.timelineMeta || focusScene.statusText || 'Timeline metadata coming soon.';
          }
        }
      }

      if (scenePairGenerateButton) {
        scenePairGenerateButton.disabled = false;
        const pairLabels = pair
          .filter(scene => !!scene)
          .map(scene => `${scene.numberLabel || 'Scene'} ¬∑ ${scene.displayName || scene.slug || 'Untitled scene'}`);
        scenePairGenerateButton.title = pairLabels.length ? `Generate ideas for ${pairLabels.join(' and ')}` : '';
        if (pairLabels.length) {
          scenePairGenerateButton.setAttribute('aria-label', `Generate ideas for ${pairLabels.join(' and ')}`);
        } else {
          scenePairGenerateButton.setAttribute('aria-label', 'Generate scene pair ideas');
        }
      }
      if (scenePairEngineSelect) {
        scenePairEngineSelect.disabled = false;
      }
    }

    function renderTimelineDockScenes() {
      renderScenePairLab();
      const track = document.getElementById('storyArcSceneSlots');
      if (!track) return;
      track.innerHTML = '';
      const scenes = Array.isArray(sceneData) ? sceneData : [];
      if (!scenes.length) {
        const empty = document.createElement('li');
        empty.className = 'story-arc-scenes__empty';
        empty.setAttribute('role', 'listitem');
        empty.textContent = 'Add scenes to build your timeline.';
        track.appendChild(empty);
        return;
      }
      const collapseSceneLabels = scenes.length > 8;
      scenes.forEach((scene, index) => {
        const step = document.createElement('li');
        step.className = 'story-arc-scenes__step';
        step.dataset.storyArcSceneStep = scene.id;
        step.setAttribute('role', 'listitem');

        const slot = document.createElement('div');
        slot.className = 'story-arc-scenes__slot' + (collapseSceneLabels ? ' story-arc-scenes__slot--compact' : '');
        slot.dataset.storyArcSceneSlot = scene.id;
        slot.tabIndex = 0;
        slot.setAttribute('role', 'button');

        const sceneNumberLabel = `Scene ${index + 1}`;
        const rawName = typeof scene?.displayName === 'string' ? scene.displayName.trim() : '';
        const slug = typeof scene?.slug === 'string' ? scene.slug.trim() : '';
        const displayLabel = rawName || slug || sceneNumberLabel;
        const tooltipLabel = displayLabel && displayLabel !== sceneNumberLabel ? `${sceneNumberLabel} ‚Ä¢ ${displayLabel}` : sceneNumberLabel;

        const numberSpan = document.createElement('span');
        numberSpan.className = 'story-arc-scenes__scene-number';
        numberSpan.textContent = collapseSceneLabels ? String(index + 1) : sceneNumberLabel;

        const labelSpan = document.createElement('span');
        labelSpan.className = 'story-arc-scenes__scene-label';
        labelSpan.textContent = displayLabel;
        labelSpan.title = displayLabel;
        if (collapseSceneLabels) {
          labelSpan.hidden = true;
        }

        slot.dataset.tooltip = tooltipLabel;
        slot.setAttribute('aria-label', tooltipLabel);
        slot.setAttribute('aria-pressed', scene.id === activeSceneId ? 'true' : 'false');

        slot.addEventListener('click', event => {
          event.preventDefault();
          activateScene(scene.id);
        });
        slot.addEventListener('keydown', event => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            activateScene(scene.id);
          }
        });

        slot.append(numberSpan, labelSpan);
        step.appendChild(slot);
        track.appendChild(step);
      });
      updateStoryArcActiveState();
    }

    document.addEventListener('storyboard:scene-images-updated', event => {
      const sceneId = event?.detail?.sceneId;
      if (!sceneId) return;
      const incomingImages = Array.isArray(event.detail.images)
        ? event.detail.images.filter(Boolean)
        : [];
      const scene = sceneDataMap.get(sceneId);
      if (!scene) return;
      scene.previewImages = incomingImages;
      const previewImages = normaliseScenePreviewImages(scene);
      const thumbnail = document.querySelector(`img[data-scene-thumbnail="${sceneId}"]`);
      if (thumbnail) {
        if (previewImages.length) {
          thumbnail.src = previewImages[0];
          thumbnail.hidden = false;
        } else {
          thumbnail.hidden = true;
          thumbnail.removeAttribute('src');
        }
      }
      if (sceneId === activeSceneId) {
        syncCardDialogSceneData();
        updateCurrentFramePreview(scene);
      }
      renderSceneCarousel();
    });

    function updateStoryArcActiveState() {
      const steps = document.querySelectorAll('[data-story-arc-scene-step]');
      steps.forEach(step => {
        const sceneId = step.dataset.storyArcSceneStep;
        const isActive = sceneId && sceneId === activeSceneId;
        step.classList.toggle('story-arc-scenes__step--active', Boolean(isActive));
        const slot = step.querySelector('[data-story-arc-scene-slot]');
        if (slot) {
          slot.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        }
      });
    }

    function getLastWriterProjectId() {
      try {
        return window.localStorage.getItem(WRITER_LAST_PROJECT_KEY) || null;
      } catch (error) {
        console.warn('Unable to read Writer project id from localStorage:', error);
        return null;
      }
    }

    function openWriterDb() {
      return new Promise((resolve, reject) => {
        try {
          const request = indexedDB.open(WRITER_DB_NAME, 1);
          request.onerror = () => reject(request.error || new Error('IndexedDB open failed'));
          request.onsuccess = () => resolve(request.result);
        } catch (error) {
          reject(error);
        }
      });
    }

    function readWriterProject(db, projectId) {
      return new Promise((resolve, reject) => {
        try {
          const transaction = db.transaction([WRITER_DB_STORE], 'readonly');
          const store = transaction.objectStore(WRITER_DB_STORE);
          const request = store.get(projectId);
          request.onsuccess = () => resolve(request.result || null);
          request.onerror = () => reject(request.error || new Error('Project lookup failed'));
        } catch (error) {
          reject(error);
        }
      });
    }

    async function loadWriterScenes() {
      if (!('indexedDB' in window)) return null;
      const projectId = getLastWriterProjectId();
      if (!projectId) return null;
      let db;
      try {
        db = await openWriterDb();
        const project = await readWriterProject(db, projectId);
        if (!project || !Array.isArray(project.scenes) || !project.scenes.length) return null;
        const title = sanitizeString(project.title);
        return project.scenes.map((scene, index) => formatWriterScene(scene, index, { source: 'writer' }));
      } catch (error) {
        console.warn('Unable to load Writer scenes:', error);
        return null;
      } finally {
        if (db && typeof db.close === 'function') {
          db.close();
        }
      }
    }

    function setupTimelineDockInteractions() {
      const dock = document.getElementById('timelineDock');
      const handle = document.getElementById('timelineDockHandle');
      if (!dock || !handle) return;

      handle.addEventListener('click', () => {
        timelinePinned = !timelinePinned;
        storage.set(TIMELINE_STORAGE_KEYS.dockPinned, timelinePinned ? 'true' : 'false');
        syncTimelineDockState(true);
      });

      dock.addEventListener('pointerenter', event => {
        timelineHovering = true;
        if (handle.contains(event.target)) {
          showTimelineDock();
        }
      });
      dock.addEventListener('pointerleave', () => {
        timelineHovering = false;
        scheduleTimelineHide();
      });
      dock.addEventListener('focusin', () => {
        timelineHovering = true;
        showTimelineDock();
      });
      dock.addEventListener('focusout', event => {
        if (event.relatedTarget && dock.contains(event.relatedTarget)) return;
        timelineHovering = false;
        scheduleTimelineHide();
      });

      const topbar = document.querySelector('.topbar');
      if (topbar) {
        topbar.addEventListener('pointerenter', () => hideTimelineDockImmediately());
        topbar.addEventListener('focusin', () => hideTimelineDockImmediately());
      }

      const timelineStage = document.querySelector('.timeline-stage');
      if (timelineStage) {
        const hideForInteraction = () => hideTimelineDockImmediately();
        timelineStage.addEventListener('pointerdown', hideForInteraction);
        timelineStage.addEventListener('focusin', hideForInteraction);
      }

      window.addEventListener('resize', () => {
        if (typeof requestAnimationFrame === 'function') {
          requestAnimationFrame(updateTimelineHandleWidth);
        } else {
          updateTimelineHandleWidth();
        }
      });

      if (typeof requestAnimationFrame === 'function') {
        requestAnimationFrame(updateTimelineHandleWidth);
      } else {
        updateTimelineHandleWidth();
      }

      syncTimelineDockState(true);
    }

    function showTimelineDock() {
      const dock = document.getElementById('timelineDock');
      const handle = document.getElementById('timelineDockHandle');
      if (!dock || !handle) return;
      dock.classList.remove('floating-hidden');
      handle.setAttribute('aria-expanded', 'true');
      clearTimeout(timelineHideTimer);
      timelineHideTimer = null;
      if (typeof requestAnimationFrame === 'function') {
        requestAnimationFrame(updateTimelineHandleWidth);
      } else {
        updateTimelineHandleWidth();
      }
    }

    function hideTimelineDockImmediately() {
      if (timelinePinned) return;
      const dock = document.getElementById('timelineDock');
      const handle = document.getElementById('timelineDockHandle');
      if (dock) dock.classList.add('floating-hidden');
      if (handle) handle.setAttribute('aria-expanded', 'false');
      clearTimeout(timelineHideTimer);
      timelineHideTimer = null;
    }

    function scheduleTimelineHide() {
      if (timelinePinned) return;
      clearTimeout(timelineHideTimer);
      timelineHideTimer = window.setTimeout(() => {
        if (timelinePinned || timelineHovering) return;
        hideTimelineDockImmediately();
      }, TIMELINE_HIDE_DELAY);
    }

    function updateTimelineHandleWidth() {
      const handle = document.getElementById('timelineDockHandle');
      if (!handle) return;
      if (!timelinePinned) {
        handle.style.width = '';
        return;
      }
      const dock = document.getElementById('timelineDock');
      const shell = dock ? dock.querySelector('.timeline-dock__shell') : null;
      const width = shell ? shell.offsetWidth : 0;
      handle.style.width = width ? `${width}px` : '';
    }

    function syncTimelineDockState(forceReveal = false) {
      const dock = document.getElementById('timelineDock');
      const handle = document.getElementById('timelineDockHandle');
      if (handle) {
        handle.setAttribute('aria-pressed', timelinePinned ? 'true' : 'false');
        handle.setAttribute('aria-label', timelinePinned ? 'Click to float story timelines' : 'Click to pin story timelines');
        handle.title = timelinePinned ? 'Click to float story timelines' : 'Click to pin story timelines';
      }
      if (!dock) return;
      dock.classList.toggle('pinned', timelinePinned);
      dock.classList.toggle('floating', !timelinePinned);
      if (timelinePinned) {
        showTimelineDock();
      } else {
        if (forceReveal) showTimelineDock();
        if (!timelineHovering) scheduleTimelineHide();
        if (handle) handle.style.width = '';
      }
      if (typeof requestAnimationFrame === 'function') {
        requestAnimationFrame(updateTimelineHandleWidth);
      } else {
        updateTimelineHandleWidth();
      }
      lastTimelinePinned = timelinePinned;
    }

    function setTrackVisibility(track, visible) {
      document.querySelectorAll(`[data-track="${track}"]`).forEach(trackRow => {
        trackRow.classList.toggle('timeline-track--hidden', !visible);
      });
    }

    trackToggles.forEach(btn => {
      btn.addEventListener('click', () => {
        btn.classList.toggle('active');
        const nowActive = btn.classList.contains('active');
        btn.setAttribute('aria-pressed', String(nowActive));
        setTrackVisibility(btn.dataset.trackToggle, nowActive);
      });
    });

    function activateAdjacentScene(offset) {
      if (!sceneCarouselOrder.length) return;
      let index = sceneCarouselOrder.indexOf(activeSceneId);
      if (index < 0) index = 0;
      let nextIndex = index + offset;
      nextIndex = Math.max(0, Math.min(sceneCarouselOrder.length - 1, nextIndex));
      const targetId = sceneCarouselOrder[nextIndex];
      if (targetId && targetId !== activeSceneId) {
        activateScene(targetId, { scroll: false });
      }
    }

    function getSceneCarouselSwipeThreshold() {
      if (!sceneCarouselViewport) return SCENE_CAROUSEL_SWIPE_THRESHOLD;
      const width = sceneCarouselViewport.clientWidth || 0;
      if (!width) return SCENE_CAROUSEL_SWIPE_THRESHOLD;
      return Math.max(SCENE_CAROUSEL_SWIPE_THRESHOLD, Math.min(320, width * 0.2));
    }

    function handleSceneCarouselPointerDown(event) {
      if (!sceneCarouselViewport || !sceneCarouselTrack) return;
      if (sceneCarouselDragState) return;
      if (event.pointerType === 'mouse' && event.button !== 0) return;
      sceneCarouselDragState = {
        pointerId: event.pointerId,
        startX: event.clientX,
        startTime: typeof performance !== 'undefined' && typeof performance.now === 'function'
          ? performance.now()
          : Date.now(),
        isDragging: false,
      };
      if (typeof sceneCarouselViewport.setPointerCapture === 'function') {
        try {
          sceneCarouselViewport.setPointerCapture(event.pointerId);
        } catch (err) {
          // ignore capture errors
        }
      }
      sceneCarouselViewport.classList.remove('is-dragging');
      sceneCarouselTrack.style.setProperty('--scene-carousel-drag-transition', '0s');
      sceneCarouselTrack.style.setProperty('--scene-carousel-drag-offset', '0px');
    }

    function handleSceneCarouselPointerMove(event) {
      if (!sceneCarouselDragState || event.pointerId !== sceneCarouselDragState.pointerId) return;
      if (!sceneCarouselViewport || !sceneCarouselTrack) return;
      const delta = event.clientX - sceneCarouselDragState.startX;
      if (!sceneCarouselDragState.isDragging && Math.abs(delta) > 8) {
        sceneCarouselDragState.isDragging = true;
        sceneCarouselViewport.classList.add('is-dragging');
      }
      if (sceneCarouselDragState.isDragging) {
        event.preventDefault();
        sceneCarouselTrack.style.setProperty('--scene-carousel-drag-offset', `${delta}px`);
      }
    }

    function finishSceneCarouselPointerInteraction(event, cancelled = false) {
      if (!sceneCarouselDragState || event.pointerId !== sceneCarouselDragState.pointerId) return;
      const state = sceneCarouselDragState;
      sceneCarouselDragState = null;
      if (sceneCarouselViewport) {
        sceneCarouselViewport.classList.remove('is-dragging');
        if (typeof sceneCarouselViewport.releasePointerCapture === 'function') {
          try {
            sceneCarouselViewport.releasePointerCapture(event.pointerId);
          } catch (err) {
            // ignore release errors
          }
        }
      }
      clearSceneCarouselDragStyles();
      if (cancelled) return;

      const delta = event.clientX - state.startX;
      const elapsed = (typeof performance !== 'undefined' && typeof performance.now === 'function'
        ? performance.now()
        : Date.now()) - state.startTime;
      const threshold = getSceneCarouselSwipeThreshold();
      const quickSwipe = elapsed < 250 && Math.abs(delta) > 24;
      if (Math.abs(delta) > threshold || quickSwipe) {
        activateAdjacentScene(delta < 0 ? 1 : -1);
      }
    }

    if (sceneCarouselPrev) {
      sceneCarouselPrev.addEventListener('click', () => activateAdjacentScene(-1));
    }

    if (sceneCarouselNext) {
      sceneCarouselNext.addEventListener('click', () => activateAdjacentScene(1));
    }

    if (sceneCarouselViewport) {
      sceneCarouselViewport.addEventListener('pointerdown', handleSceneCarouselPointerDown);
      sceneCarouselViewport.addEventListener('pointermove', handleSceneCarouselPointerMove);
      sceneCarouselViewport.addEventListener('pointerup', event => finishSceneCarouselPointerInteraction(event, false));
      sceneCarouselViewport.addEventListener('pointercancel', event => finishSceneCarouselPointerInteraction(event, true));
      sceneCarouselViewport.addEventListener('pointerleave', event => finishSceneCarouselPointerInteraction(event, true));
      sceneCarouselViewport.addEventListener('keydown', event => {
        if (event.key === 'ArrowLeft') {
          event.preventDefault();
          activateAdjacentScene(-1);
        } else if (event.key === 'ArrowRight') {
          event.preventDefault();
          activateAdjacentScene(1);
        } else if (event.key === 'Home') {
          event.preventDefault();
          const target = sceneCarouselOrder[0];
          if (target) activateScene(target, { scroll: false });
        } else if (event.key === 'End') {
          event.preventDefault();
          const target = sceneCarouselOrder[sceneCarouselOrder.length - 1];
          if (target) activateScene(target, { scroll: false });
        } else if (event.key === 'Escape' && sceneCarouselZoomed) {
          event.preventDefault();
          setSceneCarouselZoom(false);
        }
      });
    }

    if (sceneCarouselZoomButton) {
      sceneCarouselZoomButton.addEventListener('click', () => {
        const nextState = !sceneCarouselZoomed;
        setSceneCarouselZoom(nextState);
        if (nextState && sceneCarouselViewport) {
          sceneCarouselViewport.focus();
        }
      });
    }

    if (sceneCarouselDots) {
      sceneCarouselDots.addEventListener('keydown', event => {
        if (!sceneCarouselDotsList.length) return;
        const activeIndex = sceneCarouselDotsList.findIndex(dot => dot.getAttribute('aria-selected') === 'true');
        if (event.key === 'ArrowLeft') {
          event.preventDefault();
          const nextIndex = Math.max(0, activeIndex <= 0 ? 0 : activeIndex - 1);
          const target = sceneCarouselOrder[nextIndex];
          if (target) activateScene(target, { scroll: false });
        } else if (event.key === 'ArrowRight') {
          event.preventDefault();
          const nextIndex = Math.min(sceneCarouselDotsList.length - 1, activeIndex < 0 ? 0 : activeIndex + 1);
          const target = sceneCarouselOrder[nextIndex];
          if (target) activateScene(target, { scroll: false });
        } else if (event.key === 'Home') {
          event.preventDefault();
          const target = sceneCarouselOrder[0];
          if (target) activateScene(target, { scroll: false });
        } else if (event.key === 'End') {
          event.preventDefault();
          const target = sceneCarouselOrder[sceneCarouselOrder.length - 1];
          if (target) activateScene(target, { scroll: false });
        }
      });
    }

    function activateScene(id, opts = { scroll: true }) {
      if (!id) return;
      activeSceneId = id;
      window.storyboardActiveSceneId = id;
      const sceneInfo = sceneDataMap.get(id) || null;
      sceneCards.forEach(card => {
        const isActive = card.dataset.scene === id;
        card.classList.toggle('active', isActive);
      });
      sceneRows.forEach(row => {
        const isActive = row.dataset.sceneRow === id;
        row.classList.toggle('active', isActive);
        if (isActive) {
          if (sceneTitle) sceneTitle.textContent = row.dataset.sceneName || '';
          if (sceneMeta) sceneMeta.textContent = row.dataset.sceneMeta || '';
          if (opts.scroll) {
            const label = row.querySelector('.timeline-scene__label');
            if (label) {
              if (timelineWrapper && typeof timelineWrapper.scrollTo === 'function') {
                const wrapperRect = timelineWrapper.getBoundingClientRect();
                const labelRect = label.getBoundingClientRect();
                const offsetTop = labelRect.top - wrapperRect.top + timelineWrapper.scrollTop;
                const targetTop = Math.max(0, offsetTop - 12);
                timelineWrapper.scrollTo({ top: targetTop, behavior: 'smooth' });
              } else if (typeof label.scrollIntoView === 'function') {
                label.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }
          }
        }
      });
      updateCurrentFramePreview(sceneInfo);
      updateStoryArcActiveState();
      syncCardDialogSceneData();
      syncSceneCarouselActiveState();
      document.dispatchEvent(
        new CustomEvent('storyboard:scene-activated', {
          detail: { sceneId: id },
        })
      );
    }

    function updateSceneName(card, newName) {
      if (!card) return;
      const numberEl = card.querySelector('[data-scene-card-number]');
      const nameEl = card.querySelector('[data-scene-card-name]');
      if (!numberEl || !nameEl) return;
      const sceneId = card.dataset.scene;
      const sceneInfo = sceneDataMap.get(sceneId);
      const sceneNumber = sceneInfo ? sceneInfo.numberLabel : numberEl.textContent.trim();
      const trimmedName = newName.trim() || nameEl.textContent.trim();
      if (!trimmedName) return;
      nameEl.textContent = trimmedName;
      if (sceneInfo) sceneInfo.displayName = trimmedName;
      const combinedLabel = sceneNumber ? `${sceneNumber} ¬∑ ${trimmedName}` : trimmedName;
      card.setAttribute('aria-label', combinedLabel);

      const matchingRow = sceneRows.find(row => row.dataset.sceneRow === sceneId);
      if (matchingRow) {
        matchingRow.dataset.sceneName = combinedLabel;
        const timelineName = matchingRow.querySelector('.timeline-scene__label span');
        if (timelineName) {
          timelineName.textContent = trimmedName;
        }
        if (matchingRow.classList.contains('active') && sceneTitle) {
          sceneTitle.textContent = combinedLabel;
        }
      }
      renderTimelineDockScenes();
      renderSceneCarousel();
      syncCardDialogSceneData();
    }

    function startSceneRename(card) {
      if (!card || card.classList.contains('editing')) return;
      const input = card.querySelector('[data-scene-input]');
      const nameEl = card.querySelector('[data-scene-card-name]');
      if (!input || !nameEl) return;
      card.classList.add('editing');
      input.value = nameEl.textContent.trim();
      requestAnimationFrame(() => {
        input.focus();
        input.select();
      });
    }

    function finishSceneRename(card, commit = true) {
      if (!card) return;
      const input = card.querySelector('[data-scene-input]');
      const nameEl = card.querySelector('[data-scene-card-name]');
      if (!input || !nameEl) {
        card.classList.remove('editing');
        return;
      }
      const originalName = nameEl.textContent.trim();
      const desiredName = commit ? input.value.trim() : originalName;
      if (!desiredName) {
        input.value = originalName;
        card.classList.remove('editing');
        return;
      }
      input.value = desiredName;
      updateSceneName(card, desiredName);
      card.classList.remove('editing');
    }

    function createScopedStorage(namespace) {
      const prefix = namespace ? `${namespace}.` : '';
      let storageAvailable = true;
      try {
        const testKey = `${prefix}__test__`;
        window.localStorage.setItem(testKey, '1');
        window.localStorage.removeItem(testKey);
      } catch (error) {
        storageAvailable = false;
        console.warn('Local storage unavailable for API keys:', error);
      }

      return {
        get(key) {
          if (!storageAvailable) return '';
          try {
            return window.localStorage.getItem(`${prefix}${key}`) || '';
          } catch (error) {
            console.warn('Unable to read from storage:', error);
            return '';
          }
        },
        set(key, value) {
          if (!storageAvailable) return;
          try {
            if (value === undefined || value === null || value === '') {
              window.localStorage.removeItem(`${prefix}${key}`);
            } else {
              window.localStorage.setItem(`${prefix}${key}`, value);
            }
          } catch (error) {
            console.warn('Unable to write to storage:', error);
          }
        },
      };
    }

    function initialiseAiProviderSelect() {
      if (!aiProviderSelect) return;
      const storedProvider = storage.get(API_STORAGE_KEYS.provider);
      if (storedProvider) {
        aiProviderSelect.value = storedProvider;
      }
      aiProviderSelect.addEventListener('change', () => {
        storage.set(API_STORAGE_KEYS.provider, aiProviderSelect.value);
      });
    }

    function setupApiDialog() {
      if (!apiManagerButton || !apiDialog) return;

      const isDialogElement = typeof HTMLDialogElement !== 'undefined' && apiDialog instanceof HTMLDialogElement;

      function populateDialogFields() {
        if (apiGeminiInput) {
          apiGeminiInput.value = storage.get(API_STORAGE_KEYS.gemini);
        }
        if (apiSoaraInput) {
          apiSoaraInput.value = storage.get(API_STORAGE_KEYS.soara);
        }
        if (apiFeedbackLabel) {
          apiFeedbackLabel.textContent = '';
        }
      }

      function openDialog() {
        populateDialogFields();
        if (isDialogElement && typeof apiDialog.showModal === 'function') {
          apiDialog.showModal();
        } else {
          apiDialog.setAttribute('open', 'true');
        }
        if (apiGeminiInput) {
          requestAnimationFrame(() => apiGeminiInput.focus());
        }
      }

      function closeDialog() {
        if (isDialogElement && typeof apiDialog.close === 'function') {
          apiDialog.close();
        } else {
          apiDialog.removeAttribute('open');
        }
      }

      apiManagerButton.addEventListener('click', event => {
        event.preventDefault();
        openDialog();
      });

      if (apiForm) {
        apiForm.addEventListener('submit', event => {
          event.preventDefault();
          const geminiKey = apiGeminiInput ? apiGeminiInput.value.trim() : '';
          const soaraKey = apiSoaraInput ? apiSoaraInput.value.trim() : '';
          storage.set(API_STORAGE_KEYS.gemini, geminiKey);
          storage.set(API_STORAGE_KEYS.soara, soaraKey);
          if (apiFeedbackLabel) {
            apiFeedbackLabel.textContent = 'Saved locally';
            window.setTimeout(() => {
              if (apiFeedbackLabel && apiFeedbackLabel.textContent === 'Saved locally') {
                apiFeedbackLabel.textContent = '';
              }
            }, 3200);
          }
        });
      }

      apiCloseButtons.forEach(btn => {
        btn.addEventListener('click', event => {
          event.preventDefault();
          closeDialog();
        });
      });

      apiDialog.addEventListener('cancel', () => {
        if (apiFeedbackLabel) {
          apiFeedbackLabel.textContent = '';
        }
      });

      apiDialog.addEventListener('close', () => {
        if (apiFeedbackLabel) {
          apiFeedbackLabel.textContent = '';
        }
      });

      apiDialog.addEventListener('click', event => {
        if (event.target === apiDialog) {
          closeDialog();
        }
      });
    }

    function syncCardDialogSceneData() {
      if (!cardDialog || !cardDialogElements) return;

      const scene = activeSceneId ? sceneDataMap.get(activeSceneId) : null;
      const sceneLabel = cardDialogElements.scene;
      if (sceneLabel) {
        sceneLabel.textContent = scene
          ? `${scene.numberLabel} ¬∑ ${scene.displayName}`
          : 'Select a scene to start generating cards';
      }

      const timelineMeta = scene
        ? (scene.timelineMeta || 'Timeline metadata not available yet.')
        : 'Open a scene to sync timeline metadata.';
      if (cardDialogElements.meta) {
        cardDialogElements.meta.textContent = timelineMeta;
      }
      if (cardDialogElements.metaPreview) {
        cardDialogElements.metaPreview.textContent = timelineMeta;
      }

      if (cardDialogElements.summary) {
        cardDialogElements.summary.textContent = scene
          ? scene.description
          : 'Bring in your scene summary to seed prompts.';
      }

      const textStack = cardDialogElements.text;
      if (textStack) {
        textStack.innerHTML = '';
        const beats = scene && Array.isArray(scene.cards) ? scene.cards : [];
        const notes = scene && Array.isArray(scene.notesList) ? scene.notesList : [];
        if (!beats.length && !notes.length) {
          const empty = document.createElement('p');
          empty.className = 'card-dialog__empty';
          empty.textContent = 'No beats or notes yet. Add them in Writer to sync them here.';
          textStack.appendChild(empty);
        } else {
          beats.forEach((beat, index) => {
            if (!beat) return;
            const item = document.createElement('article');
            item.className = 'card-dialog__text-card';
            const badge = document.createElement('span');
            badge.className = 'card-dialog__text-badge';
            badge.textContent = `Beat ${index + 1}`;
            const title = document.createElement('strong');
            title.textContent = beat;
            item.append(badge, title);
            textStack.appendChild(item);
          });
          notes.forEach(note => {
            if (!note) return;
            const item = document.createElement('article');
            item.className = 'card-dialog__text-card card-dialog__text-card--note';
            const badge = document.createElement('span');
            badge.className = 'card-dialog__text-badge';
            badge.textContent = 'Note';
            const body = document.createElement('p');
            body.textContent = note;
            item.append(badge, body);
            textStack.appendChild(item);
          });
        }
      }

      const framesContainer = cardDialogElements.frames;
      if (framesContainer) {
        framesContainer.innerHTML = '';
        const frames = scene && Array.isArray(scene.storyboards) ? scene.storyboards : [];
        if (!frames.length) {
          const emptyFrame = document.createElement('p');
          emptyFrame.className = 'card-dialog__empty';
          emptyFrame.textContent = 'No storyboard frames yet. Generate previews to fill this tab.';
          framesContainer.appendChild(emptyFrame);
        } else {
          frames.forEach((frame, index) => {
            if (!frame) return;
            const entry = document.createElement('div');
            entry.className = 'card-dialog__frame';
            const indexEl = document.createElement('span');
            indexEl.className = 'card-dialog__frame-index';
            indexEl.textContent = String(index + 1).padStart(2, '0');
            const copy = document.createElement('div');
            const title = document.createElement('strong');
            title.textContent = frame;
            const caption = document.createElement('span');
            caption.textContent = 'Synced storyboard';
            copy.append(title, caption);
            entry.append(indexEl, copy);
            framesContainer.appendChild(entry);
          });
        }
      }

      const tagsContainer = cardDialogElements.previewTags;
      if (tagsContainer) {
        tagsContainer.innerHTML = '';
        const tags = [];
        if (scene) {
          const cues = Array.isArray(scene.lightingCues) ? scene.lightingCues : [];
          cues.forEach(cue => {
            if (cue) tags.push(cue);
          });
          if (Array.isArray(scene.cards) && scene.cards.length) {
            tags.push(`${scene.cards.length} beats`);
          }
          if (scene.source === 'writer') {
            tags.unshift('Live writer sync');
          } else if (scene.source === 'fallback') {
            tags.unshift('Demo scene');
          }
        }
        if (!tags.length) {
          tagsContainer.hidden = true;
        } else {
          tagsContainer.hidden = false;
          tags.slice(0, 4).forEach(label => {
            const chip = document.createElement('span');
            chip.className = 'card-dialog__chip';
            chip.textContent = label;
            tagsContainer.appendChild(chip);
          });
        }
      }

      const promptInput = cardDialogElements.prompt;
      if (promptInput instanceof HTMLTextAreaElement && promptInput.dataset.userEdited !== 'true') {
        const pieces = [];
        if (scene && Array.isArray(scene.cards) && scene.cards.length) {
          pieces.push(scene.cards[0]);
        }
        if (scene?.description) {
          pieces.push(scene.description);
        }
        const base = pieces.join(' ‚Äî ').trim();
        if (base) {
          const suffix = base.endsWith('.') ? '' : '.';
          promptInput.value = `${base}${suffix} Render as a cinematic storyboard panel with on-model characters.`;
        } else {
          promptInput.value = '';
        }
        promptInput.dataset.userEdited = 'false';
      }
    }

    function setupCardDialog() {
      if (!cardDialog || !cardDialogElements) return;
      if (cardDialog.dataset.cardDialogReady === 'true') return;

      cardDialog.dataset.cardDialogReady = 'true';
      const openButtons = document.querySelectorAll('[data-card-dialog-open]');
      const closeButtons = cardDialog.querySelectorAll('[data-card-dialog-close]');
      const tabButtons = Array.from(cardDialog.querySelectorAll('[data-card-tab]'));
      const panels = Array.from(cardDialog.querySelectorAll('[data-card-panel]'));
      const assetButtons = Array.from(cardDialog.querySelectorAll('[data-card-asset]'));
      const generateButtons = cardDialog.querySelectorAll('[data-card-dialog-generate]');
      const initialFocus = cardDialog.querySelector('[data-card-dialog-initial-focus]');
      const promptInput = cardDialogElements.prompt instanceof HTMLTextAreaElement ? cardDialogElements.prompt : null;
      const isDialogElement = typeof HTMLDialogElement !== 'undefined' && cardDialog instanceof HTMLDialogElement;
      let currentTab = tabButtons[0]?.dataset.cardTab || 'assets';
      let activeAsset = null;
      let statusTimer = null;
      let lastTrigger = null;

      function resetStatus() {
        if (!cardDialogElements.status) return;
        cardDialogElements.status.dataset.state = 'ready';
        cardDialogElements.status.textContent = 'Ready to generate with ChatGPT image creator.';
      }

      function closeDialog(returnValue = 'dismissed') {
        if (isDialogElement && typeof cardDialog.close === 'function') {
          cardDialog.close(returnValue);
        } else {
          cardDialog.removeAttribute('open');
          cardDialog.dispatchEvent(new Event('close'));
        }
      }

      function selectTab(value, { focusPanel = false } = {}) {
        tabButtons.forEach(button => {
          const isActive = button.dataset.cardTab === value;
          button.classList.toggle('card-dialog__tab--active', isActive);
          button.setAttribute('aria-selected', isActive ? 'true' : 'false');
          button.tabIndex = isActive ? 0 : -1;
        });
        panels.forEach(panel => {
          const isActive = panel.dataset.cardPanel === value;
          panel.hidden = !isActive;
          panel.setAttribute('aria-hidden', isActive ? 'false' : 'true');
          if (isActive && focusPanel && typeof panel.focus === 'function') {
            panel.focus({ preventScroll: true });
          }
        });
        currentTab = value;
      }

      function selectAsset(asset, { silent = false } = {}) {
        if (!asset) return;
        assetButtons.forEach(button => {
          const isActive = button === asset;
          button.classList.toggle('card-dialog__asset--active', isActive);
          button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
        activeAsset = asset;
        const label = asset.getAttribute('data-card-label')
          || asset.querySelector('.card-dialog__asset-name')?.textContent?.trim()
          || '';
        const meta = asset.getAttribute('data-card-meta')
          || asset.querySelector('.card-dialog__asset-meta')?.textContent?.trim()
          || '';
        const preview = asset.getAttribute('data-card-preview');
        const assetPrompt = asset.getAttribute('data-card-prompt');
        if (cardDialogElements.previewLabel) {
          cardDialogElements.previewLabel.textContent = label || 'Selected asset';
        }
        if (cardDialogElements.previewMeta) {
          cardDialogElements.previewMeta.textContent = meta;
        }
        if (cardDialogElements.previewFigure) {
          if (preview) {
            cardDialogElements.previewFigure.style.setProperty('--card-dialog-preview', preview);
          } else {
            cardDialogElements.previewFigure.style.removeProperty('--card-dialog-preview');
          }
        }
        if (!silent && promptInput && promptInput.dataset.userEdited !== 'true' && assetPrompt) {
          promptInput.value = assetPrompt;
          promptInput.dataset.userEdited = 'false';
        }
      }

      if (promptInput) {
        promptInput.addEventListener('input', () => {
          promptInput.dataset.userEdited = promptInput.value.trim() ? 'true' : 'false';
        });
      }

      tabButtons.forEach((button, index) => {
        button.addEventListener('click', () => {
          selectTab(button.dataset.cardTab || 'assets', { focusPanel: true });
        });
        button.addEventListener('keydown', event => {
          if (event.key === 'ArrowRight' || event.key === 'ArrowLeft') {
            event.preventDefault();
            const direction = event.key === 'ArrowRight' ? 1 : -1;
            const nextIndex = (index + direction + tabButtons.length) % tabButtons.length;
            const nextButton = tabButtons[nextIndex];
            selectTab(nextButton.dataset.cardTab || 'assets');
            nextButton.focus();
          }
        });
      });

      assetButtons.forEach(button => {
        button.setAttribute('aria-pressed', 'false');
        button.addEventListener('click', () => selectAsset(button));
        button.addEventListener('keydown', event => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            selectAsset(button);
          }
        });
      });
      if (assetButtons.length) {
        selectAsset(assetButtons[0], { silent: true });
      }

      generateButtons.forEach(button => {
        button.addEventListener('click', () => {
          if (!cardDialogElements.status) return;
          if (statusTimer) {
            window.clearTimeout(statusTimer);
          }
          const promptValue = promptInput && typeof promptInput.value === 'string' ? promptInput.value.trim() : '';
          const snippet = promptValue ? `‚Äú${promptValue.slice(0, 64)}${promptValue.length > 64 ? '‚Ä¶' : ''}‚Äù` : 'scene context';
          cardDialogElements.status.dataset.state = 'loading';
          cardDialogElements.status.textContent = `ChatGPT is rendering frames from ${snippet}.`;
          statusTimer = window.setTimeout(() => {
            cardDialogElements.status.dataset.state = 'ready';
            cardDialogElements.status.textContent = '4 new card frames ready in the Frames tab.';
          }, 1400);
        });
      });

      function openDialog(trigger) {
        lastTrigger = trigger instanceof HTMLElement ? trigger : null;
        resetStatus();
        syncCardDialogSceneData();
        if (assetButtons.length) {
          selectAsset(activeAsset || assetButtons[0], { silent: true });
        }
        selectTab(currentTab || 'assets');
        if (isDialogElement && typeof cardDialog.showModal === 'function') {
          cardDialog.showModal();
          document.body.classList.add('modal-open');
        } else {
          cardDialog.setAttribute('open', 'true');
          document.body.classList.add('modal-open');
        }
        const focusTarget = initialFocus instanceof HTMLElement ? initialFocus : tabButtons[0];
        if (focusTarget instanceof HTMLElement) {
          requestAnimationFrame(() => {
            try {
              focusTarget.focus({ preventScroll: true });
            } catch (_error) {
              focusTarget.focus();
            }
          });
        }
      }

      openButtons.forEach(button => {
        button.addEventListener('click', event => {
          event.preventDefault();
          openDialog(button);
        });
      });

      closeButtons.forEach(button => {
        button.addEventListener('click', event => {
          event.preventDefault();
          closeDialog('button');
        });
      });

      cardDialog.addEventListener('cancel', event => {
        event.preventDefault();
        closeDialog('cancel');
      });

      cardDialog.addEventListener('click', event => {
        if (event.target === cardDialog) {
          closeDialog('backdrop');
        }
      });

      cardDialog.addEventListener('close', () => {
        document.body.classList.remove('modal-open');
        if (statusTimer) {
          window.clearTimeout(statusTimer);
          statusTimer = null;
        }
        resetStatus();
        if (lastTrigger instanceof HTMLElement) {
          try {
            lastTrigger.focus({ preventScroll: true });
          } catch (_error) {
            lastTrigger.focus();
          }
        }
        lastTrigger = null;
      });

      selectTab(currentTab);
      syncCardDialogSceneData();
    }

    function setAiStatus(message) {
      if (!aiStatusLabel) return;
      aiStatusLabel.textContent = message;
    }

    function summariseJson(value) {
      try {
        const jsonString = typeof value === 'string' ? value : JSON.stringify(value, null, 2);
        return jsonString.length > 2000 ? `${jsonString.slice(0, 2000)}\n‚Ä¶` : jsonString;
      } catch (error) {
        return '';
      }
    }

    function extractGeminiResult(data) {
      const result = {
        heading: 'Gemini response',
        provider: 'gemini',
        imageDataUrl: '',
        altText: 'Gemini storyboard preview',
        rawText: summariseJson(data),
      };
      const parts = data?.candidates?.[0]?.content?.parts || [];
      for (const part of parts) {
        if (part?.inlineData?.data) {
          const mimeType = part.inlineData.mimeType || 'image/png';
          result.imageDataUrl = `data:${mimeType};base64,${part.inlineData.data}`;
          break;
        }
        if (part?.fileData?.fileUri) {
          result.imageDataUrl = part.fileData.fileUri;
          break;
        }
      }
      const textParts = parts.map(part => part?.text).filter(Boolean);
      if (textParts.length) {
        result.rawText = textParts.join('\n');
      }
      return result;
    }

    function extractSoaraResult(data) {
      const result = {
        heading: 'Soara response',
        provider: 'soara',
        imageDataUrl: '',
        altText: 'Soara storyboard preview',
        rawText: summariseJson(data),
      };
      const images = Array.isArray(data?.data)
        ? data.data
        : Array.isArray(data?.images)
        ? data.images
        : [];
      const firstImage = images[0] || data;
      if (firstImage?.b64_json) {
        result.imageDataUrl = `data:image/png;base64,${firstImage.b64_json}`;
      } else if (firstImage?.base64) {
        result.imageDataUrl = `data:image/png;base64,${firstImage.base64}`;
      } else if (firstImage?.url) {
        result.imageDataUrl = firstImage.url;
      }
      return result;
    }

    function showAiResult(content) {
      if (!aiResultContainer) return;
      if (!content) {
        aiResultContainer.classList.remove('active');
        aiResultContainer.innerHTML = '';
        return;
      }
      aiResultContainer.classList.add('active');
      aiResultContainer.innerHTML = '';
      const headingText = content.heading || 'API response';
      const headingEl = document.createElement('p');
      headingEl.className = 'ai-result__heading';
      headingEl.textContent = headingText;
      aiResultContainer.appendChild(headingEl);

      const metaItems = Array.isArray(content.meta)
        ? content.meta
        : content.meta
        ? [content.meta]
        : [];
      metaItems.forEach(text => {
        const metaEl = document.createElement('p');
        metaEl.className = 'ai-result__meta';
        metaEl.textContent = text;
        aiResultContainer.appendChild(metaEl);
      });

      if (content.imageDataUrl) {
        const img = document.createElement('img');
        img.className = 'ai-result__image';
        img.src = content.imageDataUrl;
        img.alt = content.altText || 'Storyboard frame preview';
        aiResultContainer.appendChild(img);
      }

      if (content.rawText) {
        const pre = document.createElement('pre');
        pre.textContent = content.rawText;
        aiResultContainer.appendChild(pre);
      } else if (!content.imageDataUrl) {
        const fallback = document.createElement('p');
        fallback.className = 'ai-result__empty';
        fallback.textContent = 'No response payload received. Check your API keys and try again.';
        aiResultContainer.appendChild(fallback);
      }
    }

    async function requestGeminiImage(apiKey, prompt, frameCount, signal) {
      const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${encodeURIComponent(apiKey)}`;
      const payload = {
        contents: [
          {
            role: 'user',
            parts: [
              {
                text: `Generate ${frameCount} storyboard frame${frameCount > 1 ? 's' : ''} for an action sequence. Return base64 image data if available.\n${prompt}`,
              },
            ],
          },
        ],
        generationConfig: {
          temperature: 0.9,
        },
      };
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
        signal,
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        const message = data?.error?.message || `${response.status} ${response.statusText}`;
        throw new Error(message);
      }
      return data;
    }

    async function requestSoaraImage(apiKey, prompt, frameCount, signal) {
      const response = await fetch('https://api.soara.ai/v1/images', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          prompt,
          frames: frameCount,
          response_format: 'b64_json',
        }),
        signal,
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        const message = data?.error?.message || `${response.status} ${response.statusText}`;
        throw new Error(message);
      }
      return data;
    }

    function setupGenerationWorkflow() {
      setAiStatus('Ready');
      showAiResult(null);
      if (!aiGenerateButton || !aiPromptInput) return;

      aiGenerateButton.addEventListener('click', async () => {
        const prompt = aiPromptInput.value.trim();
        const provider = aiProviderSelect ? aiProviderSelect.value : 'gemini';
        const frameCount = Math.max(1, Math.min(12, Number(aiFrameInput ? aiFrameInput.value : 1) || 1));

        if (!prompt) {
          setAiStatus('Add a prompt first');
          aiPromptInput.focus();
          return;
        }

        const apiKey = provider === 'soara'
          ? storage.get(API_STORAGE_KEYS.soara)
          : storage.get(API_STORAGE_KEYS.gemini);

        if (!apiKey) {
          setAiStatus('Add your API key first');
          showAiResult({
            heading: 'Missing API key',
            rawText: 'Open the API manager to save a key for this provider before generating.',
          });
          if (apiManagerButton) {
            apiManagerButton.focus();
          }
          return;
        }

        storage.set(API_STORAGE_KEYS.provider, provider);
        setAiStatus('Contacting provider‚Ä¶');
        showAiResult(null);
        aiGenerateButton.disabled = true;

        const controller = new AbortController();
        const timeoutId = window.setTimeout(() => controller.abort(), 45000);
        const startedAt = performance.now();

        try {
          let data;
          if (provider === 'soara') {
            data = await requestSoaraImage(apiKey, prompt, frameCount, controller.signal);
            const duration = ((performance.now() - startedAt) / 1000).toFixed(1);
            const result = extractSoaraResult(data);
            result.meta = [`Frames requested: ${frameCount}`, `Completed in ${duration}s`];
            showAiResult(result);
          } else {
            data = await requestGeminiImage(apiKey, prompt, frameCount, controller.signal);
            const duration = ((performance.now() - startedAt) / 1000).toFixed(1);
            const result = extractGeminiResult(data);
            result.meta = [`Frames requested: ${frameCount}`, `Completed in ${duration}s`];
            showAiResult(result);
          }
          setAiStatus('Preview ready');
        } catch (error) {
          const message = error?.name === 'AbortError' ? 'Request timed out' : error?.message || 'Request failed';
          setAiStatus(message);
          showAiResult({
            heading: 'Request error',
            rawText: `${message}. Check the developer console for additional context.`,
          });
          console.error('Storyboard AI generation error:', error);
        } finally {
          window.clearTimeout(timeoutId);
          aiGenerateButton.disabled = false;
        }
      });
    }

    bootstrapScenes();

    // Listen for workspace save requests
    document.addEventListener('studioorganize:save-requested', event => {
      const detail = event?.detail;
      if (!detail) return;
      
      // Mark the event as handled
      if (typeof detail.markHandled === 'function'){
        detail.markHandled();
      } else {
        detail.handled = true;
      }
      
      const action = detail.action || 'save';
      const source = detail.source || 'unknown';
      
      // Create a promise for the save operation
      const savePromise = (async () => {
        try {
          // VideoEditing currently saves to localStorage automatically
          // This could be enhanced to save to Supabase in the future
          const message = 'Video edit list saved locally. Cloud sync coming soon!';
          console.log('VideoEditing save requested:', { action, source });
          
          // Show a notification to user
          const statusEl = document.querySelector('[data-video-status]');
          if (statusEl){
            statusEl.textContent = message;
            setTimeout(() => {
              statusEl.textContent = '';
            }, 3000);
          }
          
          return { success: true, handled: true, action, source, message };
        } catch (error){
          console.error('Workspace save failed in VideoEditing', error);
          return { success: false, handled: true, action, source, error };
        }
      })();
      
      // Register the promise with the event
      if (typeof detail.waitUntil === 'function'){
        detail.waitUntil(savePromise);
      }
    });
  </script>
  <script>document.getElementById('y').textContent = new Date().getFullYear();</script>
  <script type="module" src="/assets/main.js"></script>
  <script type="module" src="/storyboard/ai-generation.js"></script>
</body>
</html>
