<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Story Map ‚Äî StudioOrganize</title>
  <meta
    name="description"
    content="Build a color-coded story map that organizes seasons, episodes, and lore while staying connected to your Supabase scripts."
  />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="icon" type="image/webp" href="/assets/img/studioorganizeFavicon.webp" />
</head>
<body class="story-map-body">
  <header class="nav">
    <div class="brand-with-logo">
      <a class="brand brand--with-logo" href="/">
        <span class="brand__logo" aria-hidden="true"></span>
        <span class="sr-only">StudioOrganize</span>
      </a>
    </div>
    <nav class="menu">
      <a class="menu__link menu__link--plain menu__link--icon" href="/">
        <span aria-hidden="true">üè†</span>
        <span class="sr-only">Home</span>
      </a>
      <div class="dropdown">
        <button class="dropbtn dropbtn--plain" type="button">Use Cases</button>
        <div class="dropdown-content">
          <a href="/use-cases/">All Use Cases</a>
          <a href="/use-cases/generate-ideas.html">Generate Ideas</a>
          <a href="/use-cases/screenplay.html">Screenplay Script</a>
          <a href="/use-cases/character-design.html">Character Design</a>
          <a href="/use-cases/set-design.html">Set / Production Design</a>
        </div>
      </div>
      <a class="menu__link menu__link--plain" href="https://finishthatstory.com" target="_blank" rel="noopener noreferrer">FinishThatStory.com</a>
      <div class="menu__actions">
        <button class="theme-toggle theme-toggle--icon" type="button" data-theme-toggle aria-pressed="false">
          <span class="sr-only">Toggle theme</span>
          <span class="theme-toggle__icon" aria-hidden="true" data-theme-icon>‚òÄÔ∏è</span>
        </button>
        <a class="menu__cta" href="https://studioorganize.com/supabase-test.html" data-auth-link data-auth-intent="signin">Sign in</a>
        <div class="dropdown" data-account-menu hidden>
          <button class="menu__cta" type="button" data-account-button>Account</button>
          <div class="dropdown-content">
            <a href="/account.html">My Creator Page</a>
          <a href="/dashboard.html">Dashboard</a>
          <a href="/goals.html">Goals</a>
          <a href="/product/personal.html">My Subscription</a>
          <a href="#" data-account-logout>Log out</a>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main class="story-map-main">
    <section class="story-map-hero">
      <div class="story-map-hero__content">
        <span class="story-map-hero__badge">Workspace</span>
        <h1>Story Map</h1>
        <p>
          Build a dynamic story atlas with color slick cards for seasons, episodes, and lore. Link Supabase scripts to jump between drafts and keep each universe organized.
        </p>
        <div class="story-map-hero__actions">
          <button class="story-map-cta" type="button" id="createSeasonBtn">+ Season</button>
          <button class="story-map-cta story-map-cta--secondary" type="button" id="linkScriptBtn">Link selected script</button>
        </div>
      </div>
      <div class="story-map-hero__preview" aria-hidden="true">
        <div class="story-map-hero__planet"></div>
        <div class="story-map-hero__rings"></div>
        <div class="story-map-hero__stars"></div>
      </div>
    </section>

    <section class="story-map-grid">
      <div class="story-map-column story-map-column--primary">
        <article class="story-map-card story-map-card--overview">
          <header class="story-map-card__header">
            <div>
              <h2>Series bible</h2>
              <p class="muted-text">Set the tone for the entire franchise.</p>
            </div>
            <button class="story-map-save" type="button" id="saveStoryBtn">Save story</button>
          </header>
          <div class="story-map-card__body story-map-card__body--stack">
            <label class="story-map-field">
              <span>Main title</span>
              <input type="text" id="storyTitle" placeholder="Chronicles of the Astral Archive" autocomplete="off" />
            </label>
            <label class="story-map-field">
              <span>Season / franchise overview</span>
              <textarea id="storyLogline" rows="2" placeholder="One line pitch or core conflict..."></textarea>
            </label>
            <label class="story-map-field">
              <span>Lore library</span>
              <textarea id="storyLore" rows="4" placeholder="Recurring motifs, tone guide, non-negotiables..."></textarea>
            </label>
          </div>
        </article>

        <article class="story-map-card">
          <header class="story-map-card__header">
            <div>
              <h2>Seasons &amp; Episodes</h2>
              <p class="muted-text">Create a hierarchy and track optional notes for each episode.</p>
            </div>
            <div class="story-map-card__header-actions">
              <button class="story-map-cta story-map-cta--ghost" type="button" id="addSeasonInlineBtn">+ Add season</button>
            </div>
          </header>
          <div class="story-map-card__body">
            <div id="seasonList" class="season-list"></div>
            <button class="story-map-cta story-map-cta--dashed" type="button" id="addSeasonFooterBtn">Add new season</button>
          </div>
        </article>

        <article class="story-map-card">
          <header class="story-map-card__header">
            <div>
              <h2>Story outline</h2>
              <p class="muted-text">Rendered view of the current structure.</p>
            </div>
          </header>
          <div class="story-map-card__body">
            <div id="storyOutline" class="story-outline" aria-live="polite"></div>
          </div>
        </article>
      </div>

      <aside class="story-map-column story-map-column--sidebar">
        <section class="story-map-card story-map-card--scripts">
          <header class="story-map-card__header">
            <div>
              <h2>Supabase scripts</h2>
              <p class="muted-text">Browse saved drafts and link them to this map.</p>
            </div>
            <button class="story-map-cta story-map-cta--ghost" type="button" id="refreshScriptsBtn" aria-label="Refresh script list">‚Üª</button>
          </header>
          <div class="story-map-card__body story-map-card__body--stack">
            <label class="story-map-field">
              <span>Select a script</span>
              <select id="scriptLibrarySelect"></select>
            </label>
            <div class="story-map-status" id="scriptStatus" role="status"></div>
            <div class="story-map-script-preview" id="scriptPreview">
              <div class="story-map-script-cover" data-empty="true">
                <img id="scriptPreviewImage" src="https://placehold.co/320x200/1f2937/f8fafc?text=Script" alt="Script cover" loading="lazy" />
              </div>
              <div class="story-map-script-meta">
                <h3 id="scriptPreviewTitle">No script selected</h3>
                <p id="scriptPreviewDescription" class="muted-text"></p>
              </div>
            </div>
            <div class="story-map-card__actions">
              <button class="story-map-cta" type="button" id="linkScriptActionBtn">Link to story map</button>
              <button class="story-map-cta story-map-cta--secondary" type="button" id="loadScriptActionBtn">Load saved map</button>
            </div>
          </div>
        </section>

        <section class="story-map-card">
          <header class="story-map-card__header">
            <div>
              <h2>Linked scripts</h2>
              <p class="muted-text">Switch between saved structures in a click.</p>
            </div>
          </header>
          <div class="story-map-card__body story-map-card__body--stack">
            <div id="linkedScriptsList" class="linked-scripts" role="list"></div>
          </div>
        </section>

        <section class="story-map-card story-map-card--notes">
          <header class="story-map-card__header">
            <div>
              <h2>Universe notes</h2>
              <p class="muted-text">Quick reference library for your lore team.</p>
            </div>
          </header>
          <div class="story-map-card__body story-map-card__body--stack">
            <label class="story-map-field">
              <span>Canon tracker</span>
              <textarea id="canonNotes" rows="3" placeholder="Track continuity checks, retcons, or crossover rules..."></textarea>
            </label>
            <label class="story-map-field">
              <span>Research links</span>
              <textarea id="researchNotes" rows="3" placeholder="Paste URLs, interview quotes, or key references..."></textarea>
            </label>
          </div>
        </section>
      </aside>
    </section>
  </main>

  <footer class="footer">
    <div class="footer__grid">
      <div>
        <strong>StudioOrganize</strong>
        <p class="muted">Tools for storytellers &amp; focused work.</p>
      </div>
      <div>
        <a href="/about.html">About</a><br />
      </div>
      <div>
        <a href="mailto:support@studioorganize.com">support@studioorganize.com</a><br />
        <span class="muted">¬© <span id="y"></span> StudioOrganize</span>
      </div>
    </div>
  </footer>

  <script type="module" src="/assets/main.js"></script>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://ycgqgkwwitqunabowswi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InljZ3Fna3d3aXRxdW5hYm93c3dpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNTg2NTAsImV4cCI6MjA3NDczNDY1MH0.W0mKqZlHVn6tRYSyZ4VRK4zCpCPC1ICwqtqoWrQMBuU';
    const STORAGE_ROOT = 'SO_STORY_MAP_V1';

    const supabase = window.supabaseClient || createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    if (!window.supabaseClient) {
      window.supabaseClient = supabase;
    }

    const storyTitle = document.getElementById('storyTitle');
    const storyLogline = document.getElementById('storyLogline');
    const storyLore = document.getElementById('storyLore');
    const canonNotes = document.getElementById('canonNotes');
    const researchNotes = document.getElementById('researchNotes');
    const seasonList = document.getElementById('seasonList');
    const storyOutline = document.getElementById('storyOutline');
    const scriptSelect = document.getElementById('scriptLibrarySelect');
    const scriptStatus = document.getElementById('scriptStatus');
    const scriptPreview = document.getElementById('scriptPreview');
    const scriptPreviewTitle = document.getElementById('scriptPreviewTitle');
    const scriptPreviewDescription = document.getElementById('scriptPreviewDescription');
    const scriptPreviewImage = document.getElementById('scriptPreviewImage');
    const linkScriptButton = document.getElementById('linkScriptActionBtn');
    const loadScriptButton = document.getElementById('loadScriptActionBtn');
    const linkScriptHeroButton = document.getElementById('linkScriptBtn');
    const addSeasonHeroButton = document.getElementById('createSeasonBtn');
    const addSeasonInlineButton = document.getElementById('addSeasonInlineBtn');
    const addSeasonFooterButton = document.getElementById('addSeasonFooterBtn');
    const refreshScriptsButton = document.getElementById('refreshScriptsBtn');
    const saveStoryButton = document.getElementById('saveStoryBtn');
    const linkedScriptsList = document.getElementById('linkedScriptsList');

    const DEFAULT_SCRIPT_IMAGE = 'https://placehold.co/320x200/1f2937/f8fafc?text=Script';

    const state = {
      title: '',
      logline: '',
      lore: '',
      canon: '',
      research: '',
      seasons: [],
      linkedScripts: [],
      currentScriptId: null,
      currentScriptMeta: null,
    };

    let scriptOptionsCache = [];
    let selectedScriptId = '';
    let persistTimer = null;
    let suppressPersist = false;

    function createId(prefix = 'id') {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
      }
      return `${prefix}-${Math.random().toString(36).slice(2, 10)}`;
    }

    function getStorageKey(suffix) {
      return `${STORAGE_ROOT}:${suffix}`;
    }

    function getStoryStorageKey(scriptId) {
      return scriptId ? getStorageKey(`script:${scriptId}`) : getStorageKey('default');
    }

    function safeParse(json) {
      if (!json) return null;
      try {
        return JSON.parse(json);
      } catch (error) {
        console.warn('Failed to parse stored story map', error);
        return null;
      }
    }

    function loadLinkedScriptsFromStorage() {
      try {
        const raw = localStorage.getItem(getStorageKey('linked'));
        const parsed = safeParse(raw);
        if (Array.isArray(parsed)) {
          state.linkedScripts = parsed.filter(item => item && item.id);
        }
      } catch (error) {
        console.warn('Unable to load linked scripts', error);
      }
    }

    function persistLinkedScripts() {
      try {
        localStorage.setItem(getStorageKey('linked'), JSON.stringify(state.linkedScripts));
      } catch (error) {
        console.warn('Unable to persist linked scripts', error);
      }
    }

    function persistLastScriptId(scriptId) {
      try {
        if (scriptId) {
          localStorage.setItem(getStorageKey('last'), scriptId);
        } else {
          localStorage.removeItem(getStorageKey('last'));
        }
      } catch (error) {
        console.warn('Unable to persist last script id', error);
      }
    }

    function getLastScriptId() {
      try {
        return localStorage.getItem(getStorageKey('last')) || null;
      } catch (error) {
        return null;
      }
    }

    function persistStoryState() {
      if (suppressPersist) return;
      const payload = {
        title: state.title,
        logline: state.logline,
        lore: state.lore,
        canon: state.canon,
        research: state.research,
        seasons: state.seasons,
      };
      try {
        localStorage.setItem(getStoryStorageKey(state.currentScriptId), JSON.stringify(payload));
        persistLastScriptId(state.currentScriptId || '');
      } catch (error) {
        console.warn('Unable to persist story map', error);
      }
    }

    function schedulePersist() {
      if (suppressPersist) return;
      if (persistTimer) {
        clearTimeout(persistTimer);
      }
      persistTimer = setTimeout(() => {
        persistTimer = null;
        persistStoryState();
      }, 400);
    }

    function loadStoryState(scriptId) {
      const raw = (() => {
        try {
          return localStorage.getItem(getStoryStorageKey(scriptId));
        } catch (error) {
          console.warn('Unable to load story state', error);
          return null;
        }
      })();
      const parsed = safeParse(raw) || {};
      suppressPersist = true;
      state.title = parsed.title || '';
      state.logline = parsed.logline || '';
      state.lore = parsed.lore || '';
      state.canon = parsed.canon || '';
      state.research = parsed.research || '';
      state.seasons = Array.isArray(parsed.seasons) ? parsed.seasons : [];
      suppressPersist = false;
      renderStoryInputs();
      renderSeasons();
      renderOutline();
    }

    function renderStoryInputs() {
      if (storyTitle) storyTitle.value = state.title || '';
      if (storyLogline) storyLogline.value = state.logline || '';
      if (storyLore) storyLore.value = state.lore || '';
      if (canonNotes) canonNotes.value = state.canon || '';
      if (researchNotes) researchNotes.value = state.research || '';
    }

    function renderSeasons() {
      if (!seasonList) return;
      seasonList.innerHTML = '';
      if (!state.seasons.length) {
        const empty = document.createElement('div');
        empty.className = 'season-empty';
        empty.innerHTML = '<strong>No seasons yet.</strong><p>Add a season to begin mapping your universe.</p>';
        seasonList.appendChild(empty);
        return;
      }
      const fragment = document.createDocumentFragment();
      state.seasons.forEach((season, index) => {
        const section = document.createElement('section');
        section.className = 'season-card';
        section.dataset.seasonId = season.id;
        section.style.setProperty('--season-accent', season.color || fallbackSeasonColor(index));
        section.innerHTML = `
          <header class="season-card__header">
            <div class="season-card__title">
              <span class="season-card__badge">Season ${index + 1}</span>
              <input class="season-card__input" type="text" data-season-name placeholder="Season name" />
            </div>
            <div class="season-card__actions">
              <input class="season-card__swatch" type="color" data-season-color aria-label="Season color" />
              <button class="season-card__remove" type="button" data-remove-season aria-label="Remove season">‚úï</button>
            </div>
          </header>
          <div class="season-card__body">
            <label class="season-card__field">
              <span>Season arc</span>
              <textarea rows="2" data-season-summary placeholder="Key beats or tone shift..."></textarea>
            </label>
            <div class="season-card__episodes" data-episode-list></div>
            <button class="season-card__add" type="button" data-add-episode>+ Episode</button>
          </div>
        `;
        fragment.appendChild(section);
        const nameInput = section.querySelector('[data-season-name]');
        const colorInput = section.querySelector('[data-season-color]');
        const summaryInput = section.querySelector('[data-season-summary]');
        const episodesContainer = section.querySelector('[data-episode-list]');
        if (nameInput) nameInput.value = season.name || '';
        if (colorInput) colorInput.value = season.color || fallbackSeasonColor(index);
        if (summaryInput) summaryInput.value = season.summary || '';
        renderEpisodes(season, episodesContainer);
      });
      seasonList.appendChild(fragment);
    }

    function fallbackSeasonColor(index) {
      const palette = ['#5fa8ff', '#f97316', '#10b981', '#a855f7', '#ec4899', '#38bdf8'];
      return palette[index % palette.length];
    }

    function renderEpisodes(season, container) {
      if (!container) return;
      container.innerHTML = '';
      if (!Array.isArray(season.episodes) || !season.episodes.length) {
        const empty = document.createElement('div');
        empty.className = 'episode-empty';
        empty.innerHTML = '<p class="muted-text">Add an episode or milestone.</p>';
        container.appendChild(empty);
        return;
      }
      const fragment = document.createDocumentFragment();
      season.episodes.forEach((episode, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'episode-card';
        wrapper.dataset.episodeId = episode.id;
        wrapper.innerHTML = `
          <div class="episode-card__header">
            <span class="episode-card__badge">Ep ${index + 1}</span>
            <input class="episode-card__input" type="text" data-episode-title placeholder="Episode title" />
            <button class="episode-card__remove" type="button" data-remove-episode aria-label="Remove episode">‚úï</button>
          </div>
          <label class="episode-card__field">
            <span>Synopsis</span>
            <textarea rows="2" data-episode-summary placeholder="What happens..."></textarea>
          </label>
          <label class="episode-card__field episode-card__field--notes">
            <span>Notes</span>
            <textarea rows="2" data-episode-notes placeholder="Foreshadowing, callbacks, guest characters..."></textarea>
          </label>
        `;
        fragment.appendChild(wrapper);
        const titleInput = wrapper.querySelector('[data-episode-title]');
        const summaryInput = wrapper.querySelector('[data-episode-summary]');
        const notesInput = wrapper.querySelector('[data-episode-notes]');
        if (titleInput) titleInput.value = episode.title || '';
        if (summaryInput) summaryInput.value = episode.summary || '';
        if (notesInput) notesInput.value = episode.notes || '';
      });
      container.appendChild(fragment);
    }

    function renderOutline() {
      if (!storyOutline) return;
      storyOutline.innerHTML = '';
      if (!state.seasons.length) {
        const empty = document.createElement('div');
        empty.className = 'outline-empty';
        empty.innerHTML = '<p class="muted-text">Your outline will appear after adding seasons and episodes.</p>';
        storyOutline.appendChild(empty);
        return;
      }
      const list = document.createElement('ol');
      list.className = 'outline-list';
      state.seasons.forEach(season => {
        const seasonItem = document.createElement('li');
        seasonItem.className = 'outline-season';
        seasonItem.style.setProperty('--season-accent', season.color || '#5fa8ff');
        const title = document.createElement('div');
        title.className = 'outline-season__title';
        title.textContent = season.name || 'Untitled season';
        const summary = document.createElement('p');
        summary.className = 'outline-season__summary';
        summary.textContent = season.summary || 'No summary yet.';
        seasonItem.appendChild(title);
        seasonItem.appendChild(summary);
        const episodes = Array.isArray(season.episodes) ? season.episodes : [];
        if (episodes.length) {
          const episodeList = document.createElement('ol');
          episodeList.className = 'outline-episodes';
          episodes.forEach(episode => {
            const episodeItem = document.createElement('li');
            episodeItem.className = 'outline-episode';
            const episodeTitle = document.createElement('div');
            episodeTitle.className = 'outline-episode__title';
            episodeTitle.textContent = episode.title || 'Untitled episode';
            const episodeSummary = document.createElement('p');
            episodeSummary.className = 'outline-episode__summary';
            episodeSummary.textContent = episode.summary || 'No synopsis yet.';
            episodeItem.appendChild(episodeTitle);
            episodeItem.appendChild(episodeSummary);
            if (episode.notes) {
              const notes = document.createElement('p');
              notes.className = 'outline-episode__notes';
              notes.textContent = episode.notes;
              episodeItem.appendChild(notes);
            }
            episodeList.appendChild(episodeItem);
          });
          seasonItem.appendChild(episodeList);
        }
        list.appendChild(seasonItem);
      });
      storyOutline.appendChild(list);
    }

    function renderLinkedScripts() {
      if (!linkedScriptsList) return;
      linkedScriptsList.innerHTML = '';
      if (!state.linkedScripts.length) {
        const empty = document.createElement('div');
        empty.className = 'linked-scripts__empty';
        empty.innerHTML = '<p class="muted-text">Link a script to unlock fast switching.</p>';
        linkedScriptsList.appendChild(empty);
        return;
      }
      const fragment = document.createDocumentFragment();
      state.linkedScripts.forEach(meta => {
        const item = document.createElement('article');
        item.className = 'linked-script';
        item.dataset.scriptId = meta.id;
        const isActive = state.currentScriptId === meta.id;
        item.innerHTML = `
          <div class="linked-script__header">
            <div class="linked-script__cover" data-empty="${meta.image_url ? 'false' : 'true'}">
              <img src="${meta.image_url || DEFAULT_SCRIPT_IMAGE}" alt="${meta.name || 'Script cover'}" loading="lazy" />
            </div>
            <div class="linked-script__meta">
              <h3>${meta.name || 'Untitled script'}</h3>
              <p class="muted-text">${meta.description || 'Ready to load into your map.'}</p>
            </div>
          </div>
          <div class="linked-script__actions">
            <button type="button" class="story-map-cta story-map-cta--ghost" data-activate-script ${isActive ? 'disabled' : ''}>${isActive ? 'Active' : 'Activate'}</button>
            <button type="button" class="story-map-cta story-map-cta--danger" data-remove-script>Remove</button>
          </div>
        `;
        fragment.appendChild(item);
      });
      linkedScriptsList.appendChild(fragment);
    }

    function updateScriptPreview(scriptId) {
      const meta = scriptOptionsCache.find(item => item.id === scriptId) || state.linkedScripts.find(item => item.id === scriptId) || null;
      selectedScriptId = scriptId || '';
      if (!meta) {
        if (scriptPreview) scriptPreview.dataset.active = 'false';
        if (scriptPreviewTitle) scriptPreviewTitle.textContent = 'No script selected';
        if (scriptPreviewDescription) scriptPreviewDescription.textContent = '';
        if (scriptPreviewImage) scriptPreviewImage.src = DEFAULT_SCRIPT_IMAGE;
        return;
      }
      if (scriptPreview) scriptPreview.dataset.active = 'true';
      if (scriptPreviewTitle) scriptPreviewTitle.textContent = meta.name || 'Untitled script';
      if (scriptPreviewDescription) scriptPreviewDescription.textContent = meta.description || '';
      if (scriptPreviewImage) scriptPreviewImage.src = meta.image_url || DEFAULT_SCRIPT_IMAGE;
    }

    async function fetchScriptOptions(force = false) {
      if (scriptOptionsCache.length && !force) {
        return scriptOptionsCache;
      }
      if (scriptStatus) {
        scriptStatus.textContent = 'Loading scripts‚Ä¶';
      }
      try {
        const { data, error } = await supabase
          .from('project_data')
          .select('id, project_id, script_id, script_name, name, title, description, summary, image_url, thumbnail_url');
        if (error) throw error;
        const normalized = (Array.isArray(data) ? data : []).map(row => {
          const id = row.id || row.project_id || row.script_id;
          if (!id) return null;
          return {
            id,
            project_id: row.project_id || null,
            script_id: row.script_id || null,
            name: row.script_name || row.name || row.title || 'Untitled script',
            description: row.description || row.summary || '',
            image_url: row.image_url || row.thumbnail_url || DEFAULT_SCRIPT_IMAGE,
          };
        }).filter(Boolean);
        normalized.sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));
        scriptOptionsCache = normalized;
        if (!normalized.length && scriptStatus) {
          scriptStatus.textContent = 'Save a script to Supabase to see it here.';
        } else if (scriptStatus) {
          scriptStatus.textContent = '';
        }
        renderScriptSelect();
        return normalized;
      } catch (error) {
        console.warn('Failed to load scripts', error);
        scriptOptionsCache = [];
        if (scriptStatus) {
          const message = error?.message?.toLowerCase().includes('permission')
            ? 'Sign in to Supabase to browse your saved scripts.'
            : 'Unable to load scripts from Supabase.';
          scriptStatus.textContent = message;
        }
        renderScriptSelect();
        return [];
      }
    }

    function renderScriptSelect() {
      if (!scriptSelect) return;
      const options = scriptOptionsCache;
      scriptSelect.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = options.length ? 'Choose a script‚Ä¶' : 'No scripts available';
      scriptSelect.appendChild(placeholder);
      options.forEach(meta => {
        const option = document.createElement('option');
        option.value = meta.id;
        option.textContent = meta.name || 'Untitled script';
        scriptSelect.appendChild(option);
      });
      scriptSelect.disabled = !options.length;
      const active = state.currentScriptId;
      if (active && options.some(meta => meta.id === active)) {
        scriptSelect.value = active;
      }
      updateScriptPreview(scriptSelect.value || active || '');
    }

    function getSeasonById(seasonId) {
      return state.seasons.find(season => season.id === seasonId) || null;
    }

    function addSeason() {
      const season = {
        id: createId('season'),
        name: '',
        color: fallbackSeasonColor(state.seasons.length),
        summary: '',
        episodes: [],
      };
      state.seasons.push(season);
      renderSeasons();
      renderOutline();
      schedulePersist();
    }

    function removeSeason(seasonId) {
      const index = state.seasons.findIndex(season => season.id === seasonId);
      if (index === -1) return;
      state.seasons.splice(index, 1);
      renderSeasons();
      renderOutline();
      schedulePersist();
    }

    function updateSeason(seasonId, updates) {
      const season = getSeasonById(seasonId);
      if (!season) return;
      Object.assign(season, updates);
      renderOutline();
      schedulePersist();
    }

    function addEpisode(seasonId) {
      const season = getSeasonById(seasonId);
      if (!season) return;
      if (!Array.isArray(season.episodes)) {
        season.episodes = [];
      }
      season.episodes.push({
        id: createId('episode'),
        title: '',
        summary: '',
        notes: '',
      });
      renderSeasons();
      renderOutline();
      schedulePersist();
    }

    function updateEpisode(seasonId, episodeId, updates) {
      const season = getSeasonById(seasonId);
      if (!season || !Array.isArray(season.episodes)) return;
      const episode = season.episodes.find(item => item.id === episodeId);
      if (!episode) return;
      Object.assign(episode, updates);
      renderOutline();
      schedulePersist();
    }

    function removeEpisode(seasonId, episodeId) {
      const season = getSeasonById(seasonId);
      if (!season || !Array.isArray(season.episodes)) return;
      const index = season.episodes.findIndex(item => item.id === episodeId);
      if (index === -1) return;
      season.episodes.splice(index, 1);
      renderSeasons();
      renderOutline();
      schedulePersist();
    }

    function cacheLinkedScriptMeta(meta) {
      if (!meta || !meta.id) return;
      const existing = state.linkedScripts.find(item => item.id === meta.id);
      if (existing) {
        Object.assign(existing, meta);
      }
    }

    function linkSelectedScript() {
      const scriptId = selectedScriptId || scriptSelect?.value || '';
      if (!scriptId) {
        alert('Select a script to link.');
        return;
      }
      const meta = scriptOptionsCache.find(item => item.id === scriptId) || state.linkedScripts.find(item => item.id === scriptId);
      if (!meta) {
        alert('Unable to locate script metadata.');
        return;
      }
      cacheLinkedScriptMeta(meta);
      if (!state.linkedScripts.some(item => item.id === meta.id)) {
        state.linkedScripts.push(Object.assign({}, meta));
      }
      persistLinkedScripts();
      setActiveScript(meta.id, meta);
      renderLinkedScripts();
      if (scriptStatus) scriptStatus.textContent = 'Linked to story map.';
    }

    function setActiveScript(scriptId, meta, options = {}) {
      const { skipPersist = false } = options;
      const nextId = scriptId || null;
      if (persistTimer) {
        clearTimeout(persistTimer);
        persistTimer = null;
      }
      if (!skipPersist) {
        persistStoryState();
      }
      state.currentScriptId = nextId;
      state.currentScriptMeta = meta || scriptOptionsCache.find(item => item.id === scriptId) || state.linkedScripts.find(item => item.id === scriptId) || null;
      if (state.currentScriptMeta) {
        cacheLinkedScriptMeta(state.currentScriptMeta);
        persistLinkedScripts();
      }
      loadStoryState(nextId);
      renderLinkedScripts();
      updateScriptPreview(nextId || '');
      persistLastScriptId(nextId || '');
      if (scriptStatus) {
        scriptStatus.textContent = nextId ? `Active script: ${state.currentScriptMeta?.name || 'Untitled script'}` : 'Working offline';
      }
    }

    function handleLinkedScriptsClick(event) {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const item = target.closest('.linked-script');
      if (!item) return;
      const scriptId = item.dataset.scriptId;
      if (!scriptId) return;
      if (target.matches('[data-activate-script]')) {
        setActiveScript(scriptId);
        return;
      }
      if (target.matches('[data-remove-script]')) {
        const index = state.linkedScripts.findIndex(meta => meta.id === scriptId);
        if (index !== -1) {
          state.linkedScripts.splice(index, 1);
          persistLinkedScripts();
          if (state.currentScriptId === scriptId) {
            const nextId = state.linkedScripts[0]?.id || null;
            setActiveScript(nextId);
          } else {
            renderLinkedScripts();
          }
        }
      }
    }

    function handleSeasonListInteraction(event) {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const seasonSection = target.closest('[data-season-id]');
      if (!seasonSection) return;
      const seasonId = seasonSection.dataset.seasonId;
      if (!seasonId) return;
      if (target.matches('[data-remove-season]')) {
        removeSeason(seasonId);
        return;
      }
      if (target.matches('[data-add-episode]')) {
        addEpisode(seasonId);
        return;
      }
      const episodeCard = target.closest('[data-episode-id]');
      if (episodeCard) {
        const episodeId = episodeCard.dataset.episodeId;
        if (!episodeId) return;
        if (target.matches('[data-remove-episode]')) {
          removeEpisode(seasonId, episodeId);
          return;
        }
      }
    }

    function handleSeasonListInput(event) {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const seasonSection = target.closest('[data-season-id]');
      if (!seasonSection) return;
      const seasonId = seasonSection.dataset.seasonId;
      if (!seasonId) return;
      if (target.matches('[data-season-name]')) {
        updateSeason(seasonId, { name: target.value });
        return;
      }
      if (target.matches('[data-season-summary]')) {
        updateSeason(seasonId, { summary: target.value });
        return;
      }
      if (target.matches('[data-season-color]')) {
        updateSeason(seasonId, { color: target.value });
        return;
      }
      const episodeCard = target.closest('[data-episode-id]');
      if (!episodeCard) return;
      const episodeId = episodeCard.dataset.episodeId;
      if (!episodeId) return;
      if (target.matches('[data-episode-title]')) {
        updateEpisode(seasonId, episodeId, { title: target.value });
        return;
      }
      if (target.matches('[data-episode-summary]')) {
        updateEpisode(seasonId, episodeId, { summary: target.value });
        return;
      }
      if (target.matches('[data-episode-notes]')) {
        updateEpisode(seasonId, episodeId, { notes: target.value });
      }
    }

    function handleStoryInput(event) {
      const target = event.target;
      if (!(target instanceof HTMLInputElement || target instanceof HTMLTextAreaElement)) return;
      if (target === storyTitle) {
        state.title = target.value;
      } else if (target === storyLogline) {
        state.logline = target.value;
      } else if (target === storyLore) {
        state.lore = target.value;
      } else if (target === canonNotes) {
        state.canon = target.value;
      } else if (target === researchNotes) {
        state.research = target.value;
      }
      schedulePersist();
    }

    function handleScriptSelectChange(event) {
      const value = event.target.value;
      updateScriptPreview(value);
    }

    function loadLinkedScriptStateOnStart() {
      const last = getLastScriptId();
      if (last && state.linkedScripts.some(item => item.id === last)) {
        setActiveScript(last);
        return;
      }
      if (state.linkedScripts.length) {
        setActiveScript(state.linkedScripts[0].id);
      } else {
        setActiveScript(null);
      }
    }

    function handleSaveStoryClick() {
      persistStoryState();
      if (scriptStatus) {
        scriptStatus.textContent = 'Story map saved locally.';
      }
    }

    function init() {
      loadLinkedScriptsFromStorage();
      renderStoryInputs();
      renderSeasons();
      renderOutline();
      renderLinkedScripts();
      fetchScriptOptions();
      loadLinkedScriptStateOnStart();
      if (scriptSelect) {
        scriptSelect.addEventListener('change', handleScriptSelectChange);
      }
      if (seasonList) {
        seasonList.addEventListener('click', handleSeasonListInteraction);
        seasonList.addEventListener('input', handleSeasonListInput);
      }
      [storyTitle, storyLogline, storyLore, canonNotes, researchNotes].forEach(field => {
        if (!field) return;
        field.addEventListener('input', handleStoryInput);
      });
      [linkScriptButton, linkScriptHeroButton].filter(Boolean).forEach(button => {
        button.addEventListener('click', linkSelectedScript);
      });
      if (loadScriptButton) {
        loadScriptButton.addEventListener('click', () => {
          const scriptId = selectedScriptId || scriptSelect?.value || '';
          const targetId = scriptId || state.currentScriptId || null;
          const skipPersist = Boolean(targetId && targetId === state.currentScriptId);
          setActiveScript(targetId, null, { skipPersist });
        });
      }
      if (addSeasonHeroButton) addSeasonHeroButton.addEventListener('click', addSeason);
      if (addSeasonInlineButton) addSeasonInlineButton.addEventListener('click', addSeason);
      if (addSeasonFooterButton) addSeasonFooterButton.addEventListener('click', addSeason);
      if (refreshScriptsButton) refreshScriptsButton.addEventListener('click', () => fetchScriptOptions(true));
      if (saveStoryButton) saveStoryButton.addEventListener('click', handleSaveStoryClick);
      if (linkedScriptsList) linkedScriptsList.addEventListener('click', handleLinkedScriptsClick);
    }

    init();
  </script>

  <style>
    :root {
      --story-map-gradient: radial-gradient(circle at 20% -10%, rgba(79,123,255,0.28), transparent 45%), radial-gradient(circle at 80% 0%, rgba(16,185,129,0.18), transparent 50%), var(--surface);
    }
    .story-map-body {
      background: var(--story-map-gradient);
      color: var(--ink);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .story-map-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 32px;
      padding: 32px clamp(20px, 6vw, 64px) 80px;
    }
    .story-map-hero {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      align-items: center;
      gap: 32px;
      padding: clamp(24px, 4vw, 48px);
      background: linear-gradient(135deg, rgba(79,123,255,0.22), rgba(16,185,129,0.16));
      border-radius: 32px;
      border: 1px solid rgba(148,163,184,0.25);
      position: relative;
      overflow: hidden;
      box-shadow: 0 40px 120px rgba(15,23,42,0.32);
    }
    .story-map-hero__content h1 {
      font-size: clamp(32px, 5vw, 48px);
      margin-bottom: 8px;
    }
    .story-map-hero__content p {
      max-width: 520px;
      font-size: 1.1rem;
      line-height: 1.6;
    }
    .story-map-hero__badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(15,23,42,0.85);
      color: #f8fafc;
      padding: 6px 14px;
      border-radius: 999px;
      letter-spacing: 0.2px;
      font-size: 12px;
      text-transform: uppercase;
      margin-bottom: 12px;
    }
    .story-map-hero__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 24px;
    }
    .story-map-hero__preview {
      position: relative;
      min-height: 260px;
    }
    .story-map-hero__planet {
      position: absolute;
      inset: auto 0 0 auto;
      width: clamp(220px, 28vw, 320px);
      aspect-ratio: 1;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(251,191,36,0.8), rgba(79,123,255,0.4));
      filter: blur(0.6px);
      transform: translate(20%, 10%);
    }
    .story-map-hero__rings {
      position: absolute;
      inset: auto 0 0 10%;
      width: clamp(240px, 32vw, 360px);
      height: clamp(120px, 16vw, 180px);
      border-radius: 50%;
      border: 2px solid rgba(148,163,184,0.4);
      opacity: 0.6;
      transform: rotate(-12deg);
    }
    .story-map-hero__stars::before,
    .story-map-hero__stars::after {
      content: '';
      position: absolute;
      inset: 10% 0 0 0;
      background: radial-gradient(circle, rgba(255,255,255,0.75) 0, transparent 55%);
      width: 220px;
      height: 220px;
      opacity: 0.35;
      filter: blur(1px);
    }
    .story-map-hero__stars::after {
      inset: 20% 0 0 30%;
      width: 160px;
      height: 160px;
      opacity: 0.5;
    }
    .story-map-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: clamp(24px, 5vw, 48px);
    }
    @media (min-width: 1024px) {
      .story-map-grid {
        grid-template-columns: minmax(0, 1.75fr) minmax(280px, 0.85fr);
      }
    }
    .story-map-column {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .story-map-card {
      background: var(--panel);
      border-radius: 24px;
      padding: clamp(20px, 3vw, 28px);
      border: 1px solid rgba(148,163,184,0.18);
      box-shadow: 0 24px 60px rgba(15,23,42,0.18);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .story-map-card--overview {
      background: linear-gradient(160deg, rgba(79,123,255,0.16), rgba(15,23,42,0.85));
      color: #f8fafc;
      border: 1px solid rgba(148,163,184,0.28);
    }
    .story-map-card--scripts {
      background: linear-gradient(155deg, rgba(56,189,248,0.16), rgba(15,23,42,0.92));
      color: #f8fafc;
    }
    .story-map-card--notes {
      background: linear-gradient(155deg, rgba(168,85,247,0.16), rgba(15,23,42,0.9));
      color: #f8fafc;
    }
    .story-map-card__header {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: flex-start;
    }
    .story-map-card__header h2 {
      margin-bottom: 6px;
      font-size: 1.4rem;
    }
    .story-map-card__header-actions {
      display: flex;
      gap: 8px;
    }
    .story-map-card__body {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .story-map-card__body--stack {
      gap: 16px;
    }
    .story-map-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .story-map-field span {
      font-weight: 600;
      font-size: 0.9rem;
      letter-spacing: 0.2px;
    }
    .story-map-field input,
    .story-map-field textarea {
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.32);
      background: rgba(15,23,42,0.08);
      padding: 12px 16px;
      color: inherit;
      font: inherit;
    }
    .story-map-field textarea {
      resize: vertical;
      min-height: 64px;
    }
    .story-map-status {
      min-height: 24px;
      font-size: 0.85rem;
    }
    .story-map-script-preview {
      display: flex;
      gap: 16px;
      align-items: center;
      padding: 16px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(15,23,42,0.35);
    }
    .story-map-script-preview img {
      border-radius: 16px;
      width: 110px;
      aspect-ratio: 4 / 3;
      object-fit: cover;
      border: 1px solid rgba(148,163,184,0.35);
    }
    .story-map-script-meta h3 {
      margin-bottom: 6px;
      font-size: 1.1rem;
    }
    .story-map-card__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .story-map-cta {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(248,250,252,0.1);
      color: inherit;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease;
    }
    .story-map-cta:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 32px rgba(15,23,42,0.28);
      border-color: rgba(248,250,252,0.55);
    }
    .story-map-cta--secondary {
      background: rgba(79,123,255,0.18);
      border-color: rgba(248,250,252,0.45);
    }
    .story-map-cta--ghost {
      background: transparent;
      border-color: rgba(248,250,252,0.25);
    }
    .story-map-cta--dashed {
      border-style: dashed;
      width: 100%;
      background: rgba(15,23,42,0.06);
      color: var(--ink);
    }
    .story-map-cta--danger {
      background: rgba(239,68,68,0.16);
      border-color: rgba(239,68,68,0.45);
      color: #fee2e2;
    }
    .story-map-save {
      border-radius: 999px;
      border: 1px solid rgba(248,250,252,0.45);
      background: rgba(248,250,252,0.12);
      color: inherit;
      padding: 8px 16px;
      font-weight: 600;
      cursor: pointer;
    }
    .season-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .season-empty {
      text-align: center;
      padding: 32px;
      border: 1px dashed rgba(148,163,184,0.38);
      border-radius: 20px;
      color: var(--ink);
      background: rgba(15,23,42,0.04);
    }
    .season-card {
      border-radius: 20px;
      background: rgba(15,23,42,0.08);
      border: 1px solid rgba(148,163,184,0.28);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      position: relative;
      overflow: hidden;
    }
    .season-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, var(--season-accent, #5fa8ff), transparent 65%);
      opacity: 0.16;
      pointer-events: none;
    }
    .season-card__header,
    .season-card__body {
      position: relative;
      z-index: 1;
    }
    .season-card__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }
    .season-card__title {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .season-card__badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(15,23,42,0.8);
      color: #f8fafc;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      width: fit-content;
    }
    .season-card__input {
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      padding: 10px 14px;
      background: rgba(248,250,252,0.9);
      font-weight: 600;
      min-width: 0;
    }
    .season-card__actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .season-card__swatch {
      width: 40px;
      height: 32px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      padding: 2px;
      background: rgba(248,250,252,0.9);
      cursor: pointer;
    }
    .season-card__remove {
      background: rgba(15,23,42,0.75);
      color: #f8fafc;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
    }
    .season-card__field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: inherit;
    }
    .season-card__field textarea {
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      padding: 10px 14px;
      background: rgba(248,250,252,0.92);
      font: inherit;
    }
    .season-card__episodes {
      display: grid;
      gap: 14px;
    }
    .season-card__add {
      align-self: flex-start;
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.45);
      background: rgba(248,250,252,0.9);
      cursor: pointer;
    }
    .episode-card {
      background: rgba(248,250,252,0.9);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .episode-card__header {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .episode-card__badge {
      display: inline-flex;
      background: rgba(15,23,42,0.08);
      color: var(--ink);
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      letter-spacing: 0.2px;
    }
    .episode-card__input {
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.45);
      padding: 8px 12px;
      font-weight: 600;
    }
    .episode-card__remove {
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: rgba(15,23,42,0.55);
    }
    .episode-card__field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .episode-card__field textarea {
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.35);
      padding: 8px 12px;
      resize: vertical;
      font: inherit;
    }
    .episode-card__field--notes textarea {
      background: rgba(59,130,246,0.06);
    }
    .episode-empty {
      padding: 16px;
      border-radius: 12px;
      border: 1px dashed rgba(148,163,184,0.35);
      background: rgba(248,250,252,0.75);
      color: rgba(15,23,42,0.65);
    }
    .story-outline {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .outline-empty {
      padding: 18px;
      border: 1px dashed rgba(148,163,184,0.32);
      border-radius: 16px;
      background: rgba(15,23,42,0.06);
    }
    .outline-list {
      display: grid;
      gap: 18px;
      counter-reset: season-counter;
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .outline-season {
      border: 1px solid rgba(148,163,184,0.35);
      border-radius: 18px;
      padding: 18px;
      background: rgba(248,250,252,0.92);
      position: relative;
    }
    .outline-season::before {
      counter-increment: season-counter;
      content: 'Season ' counter(season-counter);
      position: absolute;
      top: 16px;
      right: 18px;
      font-size: 0.85rem;
      background: var(--season-accent, #5fa8ff);
      color: #0f172a;
      padding: 4px 12px;
      border-radius: 999px;
    }
    .outline-season__title {
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 6px;
    }
    .outline-season__summary {
      margin: 0 0 12px;
      color: rgba(15,23,42,0.75);
    }
    .outline-episodes {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 12px;
    }
    .outline-episode {
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.28);
      padding: 12px 14px;
      background: rgba(15,23,42,0.04);
    }
    .outline-episode__title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .outline-episode__summary {
      margin: 0;
      color: rgba(15,23,42,0.7);
    }
    .outline-episode__notes {
      margin: 8px 0 0;
      font-size: 0.85rem;
      color: rgba(15,23,42,0.75);
      font-style: italic;
    }
    .linked-scripts {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .linked-scripts__empty {
      padding: 20px;
      border-radius: 14px;
      border: 1px dashed rgba(248,250,252,0.35);
      background: rgba(15,23,42,0.18);
      color: rgba(248,250,252,0.9);
    }
    .linked-script {
      border-radius: 18px;
      border: 1px solid rgba(248,250,252,0.35);
      background: rgba(15,23,42,0.25);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .linked-script__header {
      display: flex;
      gap: 14px;
      align-items: center;
    }
    .linked-script__cover img {
      width: 72px;
      height: 72px;
      object-fit: cover;
      border-radius: 16px;
      border: 1px solid rgba(248,250,252,0.35);
    }
    .linked-script__actions {
      display: flex;
      gap: 10px;
    }
    .story-map-card--scripts select {
      border-radius: 12px;
      border: 1px solid rgba(248,250,252,0.4);
      background: rgba(15,23,42,0.55);
      color: inherit;
      padding: 10px 14px;
    }
    .story-map-card--scripts option {
      color: #0f172a;
    }
    .story-map-card--scripts textarea,
    .story-map-card--scripts input {
      background: rgba(15,23,42,0.55);
      border-color: rgba(248,250,252,0.32);
      color: inherit;
    }
    .story-map-card--notes textarea,
    .story-map-card--notes input {
      background: rgba(15,23,42,0.4);
      border-color: rgba(248,250,252,0.35);
      color: inherit;
    }
    .story-map-card--scripts .story-map-cta {
      border-color: rgba(248,250,252,0.45);
    }
    .story-map-card--scripts .story-map-cta--danger {
      border-color: rgba(239,68,68,0.55);
    }
    .story-map-card--scripts .story-map-cta--ghost {
      border-color: rgba(248,250,252,0.32);
    }
    .story-map-card--scripts .story-map-status {
      color: rgba(248,250,252,0.86);
    }
    .story-map-card--scripts .story-map-script-preview {
      background: rgba(15,23,42,0.55);
    }
    .story-map-card--scripts .story-map-script-preview img {
      border-color: rgba(248,250,252,0.45);
    }
    @media (max-width: 720px) {
      .story-map-hero {
        border-radius: 24px;
      }
      .story-map-card {
        border-radius: 20px;
      }
      .story-map-main {
        padding: 24px 16px 64px;
      }
    }
  </style>
</body>
</html>
