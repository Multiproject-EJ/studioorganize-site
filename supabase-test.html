<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Supabase Connection Tester — StudioOrganize</title>
  <link rel="stylesheet" href="/assets/styles.css" />
  <meta name="google-sheet-endpoint" content="">
  <style>
    :root {
      --tester-surface: var(--panel);
      --tester-surface-alt: var(--hud);
      --tester-border: var(--line);
      --tester-shadow: 0 32px 70px rgba(8, 15, 28, 0.6);
      --tester-shadow-soft: 0 22px 45px rgba(8, 15, 28, 0.45);
      --tester-input-bg: var(--field);
      --tester-input-border: var(--line);
      --tester-pill-bg: rgba(125, 211, 252, 0.18);
      --tester-pill-text: var(--brand);
      --tester-pill-error-bg: rgba(235, 87, 87, 0.22);
      --tester-pill-error-text: #ffb8c2;
      --tester-pill-success-bg: rgba(39, 174, 96, 0.26);
      --tester-pill-success-text: #73ffd3;
      --tester-log-bg: var(--dial);
      --tester-log-border: rgba(79, 123, 255, 0.2);
      --tester-log-color: var(--ink);
      --tester-note: var(--muted);
    }
    [data-theme="light"] {
      --tester-shadow: 0 24px 60px rgba(12, 20, 51, 0.16);
      --tester-shadow-soft: 0 18px 40px rgba(12, 20, 51, 0.12);
      --tester-pill-bg: rgba(37, 99, 235, 0.12);
      --tester-pill-text: #1e3a8a;
      --tester-pill-error-bg: rgba(235, 87, 87, 0.12);
      --tester-pill-error-text: #d42a2a;
      --tester-pill-success-bg: rgba(34, 197, 94, 0.14);
      --tester-pill-success-text: #15803d;
      --tester-log-bg: #0a1630;
      --tester-log-border: rgba(12, 20, 51, 0.12);
      --tester-log-color: #f4f7ff;
    }
    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .tester {
      max-width: 960px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
      display: grid;
      gap: 2rem;
    }
    .tester__intro {
      background: var(--tester-surface);
      border: 1px solid var(--tester-border);
      border-radius: 18px;
      padding: 1.75rem 1.9rem;
      box-shadow: var(--tester-shadow);
    }
    .tester__intro h1 {
      margin: 0 0 0.75rem;
      font-size: clamp(1.75rem, 2vw + 1rem, 2.5rem);
    }
    .tester__intro p {
      color: var(--tester-note);
      line-height: 1.6;
    }
    .tester__layout {
      display: grid;
      gap: 1.5rem;
    }
    .tester__auth-grid {
      display: grid;
      gap: 1.5rem;
    }
    @media (min-width: 860px) {
      .tester__layout {
        grid-template-columns: 1fr 1fr;
      }
      .tester__auth-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    .card {
      background: var(--tester-surface);
      border: 1px solid var(--tester-border);
      border-radius: 18px;
      padding: 1.5rem;
      box-shadow: var(--tester-shadow-soft);
      display: grid;
      gap: 1rem;
    }
    .card--interactive {
      position: relative;
      cursor: pointer;
      transition: box-shadow 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
    }
    .card--interactive::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      border: 2px solid transparent;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      pointer-events: none;
    }
    .card--interactive:hover::before {
      border-color: rgba(95, 168, 255, 0.5);
      box-shadow: 0 12px 32px rgba(79, 123, 255, 0.25);
    }
    .card--interactive[data-active="true"] {
      cursor: default;
    }
    .card--interactive[data-active="true"]::before {
      border-color: var(--acc);
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--acc) 40%, transparent);
    }
    .card--interactive[data-active="false"] {
      filter: grayscale(0.08) brightness(0.98);
    }
    .card--interactive[data-active="false"] form,
    .card--interactive[data-active="false"] .card__actions {
      opacity: 0.65;
    }
    .card--interactive[data-active="false"] input,
    .card--interactive[data-active="false"] textarea,
    .card--interactive[data-active="false"] button,
    .card--interactive[data-active="false"] select {
      pointer-events: none;
    }
    .card h2 {
      margin: 0;
      font-size: 1.25rem;
    }
    .card__actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    form {
      display: grid;
      gap: 0.75rem;
    }
    fieldset {
      border: 1px dashed var(--tester-border);
      border-radius: 14px;
      padding: 1rem;
      background: var(--tester-surface-alt);
      display: grid;
      gap: 0.75rem;
    }
    fieldset:disabled {
      opacity: 0.55;
    }
    label {
      display: grid;
      gap: 0.35rem;
      font-weight: 600;
    }
    input,
    textarea {
      font: inherit;
      padding: 0.65rem 0.75rem;
      border-radius: 10px;
      border: 1px solid var(--tester-input-border);
      background: var(--tester-input-bg);
      color: inherit;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    input:focus-visible,
    textarea:focus-visible {
      border-color: var(--acc);
      box-shadow: 0 0 0 2px rgba(95, 168, 255, 0.35);
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--acc) 32%, transparent);
      outline: none;
    }
    button {
      font: inherit;
      padding: 0.6rem 1rem;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: var(--cta-text);
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(79, 123, 255, 0.28);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    button[disabled] {
      cursor: not-allowed;
      opacity: 0.6;
    }
    button:not([disabled]):hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(79, 123, 255, 0.32);
    }
    button:focus-visible {
      outline: 2px solid var(--acc);
      outline-offset: 3px;
    }
    .btn-secondary {
      background: transparent;
      color: inherit;
      border: 1px solid var(--tester-input-border);
      box-shadow: none;
    }
    .log {
      background: var(--tester-log-bg);
      color: var(--tester-log-color);
      border-radius: 16px;
      padding: 1.25rem;
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      max-height: 400px;
      overflow: auto;
      white-space: pre-wrap;
      line-height: 1.4;
      border: 1px solid var(--tester-log-border);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
    }
    .status-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 1.5rem;
      align-items: center;
      font-size: 0.95rem;
    }
    .status-row strong {
      font-size: 1rem;
    }
    .form-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 0.6rem;
      font-weight: 600;
    }
    .form-checkbox input[type="checkbox"] {
      width: 1.1rem;
      height: 1.1rem;
      margin-top: 0.2rem;
    }
    .form-checkbox span {
      font-weight: 400;
      color: var(--tester-note);
      line-height: 1.45;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: var(--tester-pill-bg);
      color: var(--tester-pill-text);
      border-radius: 999px;
      padding: 0.25rem 0.9rem;
      font-weight: 600;
      border: 1px solid rgba(125, 211, 252, 0.3);
      border: 1px solid color-mix(in srgb, var(--tester-pill-text) 35%, transparent);
    }
    .status-pill[data-state="signed-out"] {
      background: var(--tester-pill-error-bg);
      color: var(--tester-pill-error-text);
      border-color: rgba(235, 87, 87, 0.28);
      border-color: color-mix(in srgb, var(--tester-pill-error-text) 30%, transparent);
    }
    .status-pill[data-state="signed-in"] {
      background: var(--tester-pill-success-bg);
      color: var(--tester-pill-success-text);
      border-color: rgba(115, 253, 208, 0.28);
      border-color: color-mix(in srgb, var(--tester-pill-success-text) 35%, transparent);
    }
    .developer-tools {
      display: grid;
      gap: 1rem;
    }
    .developer-toggle {
      justify-self: start;
      font: inherit;
      font-weight: 600;
      padding: 0.55rem 1.2rem;
      border-radius: 999px;
      border: 1px solid var(--tester-border);
      background: var(--tester-surface-alt);
      color: inherit;
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease, transform 0.2s ease;
      box-shadow: 0 12px 24px rgba(8, 15, 28, 0.15);
    }
    .developer-toggle:hover {
      border-color: var(--acc);
      transform: translateY(-1px);
    }
    .developer-toggle:focus-visible {
      outline: 2px solid var(--acc);
      outline-offset: 3px;
    }
    .developer-panels {
      display: grid;
      gap: 1.5rem;
    }
    .developer-panels[hidden] {
      display: none !important;
    }
    .note {
      font-size: 0.9rem;
      line-height: 1.55;
      color: var(--tester-note);
    }
    code {
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      padding: 0.15rem 0.4rem;
      border-radius: 6px;
      background: rgba(79, 123, 255, 0.12);
      background: color-mix(in srgb, var(--tester-border) 20%, transparent);
      border: 1px solid rgba(79, 123, 255, 0.25);
      border: 1px solid color-mix(in srgb, var(--tester-border) 45%, transparent);
      color: inherit;
    }
    @media (max-width: 600px) {
      .tester {
        padding: 1.75rem 1.25rem 3rem;
      }
      .tester__intro,
      .card {
        border-radius: 16px;
      }
    }
  </style>
</head>
<body>
  <header class="nav">
    <a class="brand brand--logo" href="/" aria-label="StudioOrganize home">
      <span class="brand__logo" aria-hidden="true"></span>
    </a>
    <nav class="menu">
      <div class="dropdown">
        <button class="dropbtn dropbtn--plain" type="button">Use Cases</button>
        <div class="dropdown-content">
          <a href="/use-cases/">All Use Cases</a>
          <a href="/use-cases/generate-ideas.html">Generate Ideas</a>
          <a href="/use-cases/screenplay.html">Screenplay Script</a>
          <a href="/use-cases/character-design.html">Character Design</a>
          <a href="/use-cases/set-design.html">Set / Production Design</a>
        </div>
      </div>
      <a class="menu__link menu__link--plain" href="https://finishthatstory.com" target="_blank" rel="noopener noreferrer">FinishThatStory.com</a>
      <div class="menu__actions">
        <button class="theme-toggle theme-toggle--icon" type="button" data-theme-toggle aria-pressed="false">
          <span class="sr-only">Toggle theme</span>
          <span class="theme-toggle__icon" aria-hidden="true" data-theme-icon>☀️</span>
        </button>
        <a class="menu__cta" href="https://studioorganize.com/supabase-test.html" data-auth-link>Sign up / Log in</a>
        <div class="dropdown" data-account-menu hidden>
          <button class="menu__cta" type="button" data-account-button>Account</button>
          <div class="dropdown-content">
            <a href="/account.html">My Creator Page</a>
            <a href="/product/personal.html">My Subscription</a>
            <a href="#" data-account-logout>Log out</a>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main class="tester">
    <div class="tester__auth-grid">
      <section class="card card--interactive" data-auth-card="signup" data-active="true" tabindex="0" role="group" aria-labelledby="auth-card-signup">
        <h2 id="auth-card-signup">Authentication</h2>
        <p class="note">The sign-up form stores your name in Supabase auth metadata. After confirming the account, sign in to test database queries.</p>

        <form id="signup-form">
          <fieldset>
            <legend>Sign up</legend>
            <label>
              Name
              <input type="text" name="name" autocomplete="name" placeholder="Ada Lovelace" />
            </label>
            <label>
              Email
              <input type="email" name="email" autocomplete="email" placeholder="you@example.com" required />
            </label>
            <label>
              Password
              <input type="password" name="password" autocomplete="new-password" minlength="8" placeholder="At least 8 characters" required />
            </label>
            <label class="form-checkbox">
              <input type="checkbox" name="marketing_opt_out" value="yes" />
              <span>I prefer <strong>not</strong> to receive updates about StudioOrganize sister products.</span>
            </label>
            <button type="submit">Send sign-up request</button>
          </fieldset>
        </form>
      </section>

      <section class="card card--interactive" data-auth-card="signin" data-active="false" tabindex="0" role="group" aria-labelledby="auth-card-signin">
        <h2 id="auth-card-signin">Sign in</h2>

        <form id="login-form">
          <fieldset>
            <legend class="sr-only">Sign in to an existing account</legend>
            <label>
              Email
              <input type="email" name="email" autocomplete="email" placeholder="you@example.com" required />
            </label>
            <label>
              Password
              <input type="password" name="password" autocomplete="current-password" required />
            </label>
            <div class="card__actions">
              <button type="submit">Sign in</button>
              <button type="button" class="btn-secondary" data-signout>Sign out</button>
            </div>
          </fieldset>
        </form>
      </section>
    </div>

    <div class="developer-tools">
      <button class="developer-toggle" type="button" data-dev-toggle data-label-show="Show developer tools" data-label-hide="Hide developer tools" aria-expanded="false" aria-controls="developer-panels">Show developer tools</button>
      <div class="developer-panels" id="developer-panels" data-dev-panels hidden>
        <section class="tester__intro">
          <h1>Supabase connection tester</h1>
          <p>This page creates a plain Supabase client with the project's anon key so we can quickly verify read and write access. Use the forms below to sign up or sign in, fetch your linked profile row, and create a throwaway scene record.</p>
          <div class="status-row">
            <strong>Session:</strong>
            <span class="status-pill" data-session-indicator data-state="signed-out">Signed out</span>
            <span data-session-details>No active session</span>
          </div>
        </section>

        <div class="tester__layout">
          <section class="card">
            <h2>Profile data</h2>
            <p class="note">These helpers call <code>public.profiles</code>. Row Level Security means you must be signed in before they return data.</p>

            <fieldset data-requires-auth disabled>
              <legend>Fetch current profile</legend>
              <button type="button" class="btn-secondary" data-fetch-profile>Load profile row</button>
            </fieldset>

            <form id="profile-form">
              <fieldset data-requires-auth disabled>
                <legend>Update profile</legend>
                <label>
                  Full name
                  <input type="text" name="full_name" placeholder="Grace Hopper" />
                </label>
                <label>
                  Studio name
                  <input type="text" name="studio_name" placeholder="StudioOrganize" />
                </label>
                <label>
                  Phone number
                  <input type="tel" name="phone" placeholder="123-456-7890" />
                </label>
                <button type="submit">Save profile details</button>
              </fieldset>
            </form>
          </section>

          <section class="card">
            <h2>Scene sandbox</h2>
            <p class="note">Scenes are tied to your profile via <code>owner_id</code>. Use these to confirm insert and select permissions on the new tables.</p>

            <form id="scene-form">
              <fieldset data-requires-auth disabled>
                <legend>Create a test scene</legend>
                <label>
                  Scene title
                  <input type="text" name="title" placeholder="INT. SOUNDSTAGE — DAY" required />
                </label>
                <label>
                  Synopsis
                  <textarea name="synopsis" rows="3" placeholder="Short overview of what happens..."></textarea>
                </label>
                <button type="submit">Insert scene</button>
              </fieldset>
            </form>

            <fieldset data-requires-auth disabled>
              <legend>Load latest scenes</legend>
              <button type="button" class="btn-secondary" data-load-scenes>Fetch scenes for current user</button>
            </fieldset>
          </section>
        </div>

        <section class="card">
          <h2>Event log</h2>
          <p class="note">Each action appends to the log below. Errors are highlighted so we can quickly spot permission issues.</p>
          <div class="log" data-log>Ready.</div>
        </section>
      </div>
    </div>
  </main>

  <script type="module" src="/assets/main.js"></script>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://ycgqgkwwitqunabowswi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InljZ3Fna3d3aXRxdW5hYm93c3dpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNTg2NTAsImV4cCI6MjA3NDczNDY1MH0.W0mKqZlHVn6tRYSyZ4VRK4zCpCPC1ICwqtqoWrQMBuU';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const logEl = document.querySelector('[data-log]');
    const sessionIndicator = document.querySelector('[data-session-indicator]');
    const sessionDetails = document.querySelector('[data-session-details]');
    const authRequiredBlocks = Array.from(document.querySelectorAll('[data-requires-auth]'));
    const signoutButton = document.querySelector('[data-signout]');
    const fetchProfileButton = document.querySelector('[data-fetch-profile]');
    const loadScenesButton = document.querySelector('[data-load-scenes]');
    const authLink = document.querySelector('[data-auth-link]');
    const accountMenu = document.querySelector('[data-account-menu]');
    const accountButton = document.querySelector('[data-account-button]');
    const accountLogoutLink = document.querySelector('[data-account-logout]');
    const sheetEndpoint = document.querySelector('meta[name="google-sheet-endpoint"]')?.content?.trim() || '';
    const authCards = Array.from(document.querySelectorAll('[data-auth-card]'));
    const devToggleButton = document.querySelector('[data-dev-toggle]');
    const devPanels = document.querySelector('[data-dev-panels]');

    function toggleElementVisibility(element, shouldShow) {
      if (!element) return;
      if (shouldShow) {
        element.hidden = false;
        element.removeAttribute('aria-hidden');
        element.style.display = '';
      } else {
        element.hidden = true;
        element.setAttribute('aria-hidden', 'true');
        element.style.display = 'none';
      }
    }

    const state = {
      session: null
    };

    function updateInteractiveCardState(card, isActive) {
      if (!card) return;
      card.dataset.active = isActive ? 'true' : 'false';
      card.classList.toggle('is-active', isActive);
      card.classList.toggle('is-inactive', !isActive);
      card.setAttribute('aria-selected', String(isActive));
      const focusableSelectors = 'input, textarea, button, select, a';
      const focusableElements = card.querySelectorAll(focusableSelectors);
      focusableElements.forEach((element) => {
        if (isActive) {
          if (Object.prototype.hasOwnProperty.call(element.dataset, 'prevTabindex')) {
            const previous = element.dataset.prevTabindex;
            if (previous) {
              element.setAttribute('tabindex', previous);
            } else {
              element.removeAttribute('tabindex');
            }
            delete element.dataset.prevTabindex;
          } else if (element.getAttribute('tabindex') === '-1') {
            element.removeAttribute('tabindex');
          }
          element.removeAttribute('aria-hidden');
        } else {
          if (!Object.prototype.hasOwnProperty.call(element.dataset, 'prevTabindex')) {
            const existing = element.getAttribute('tabindex');
            element.dataset.prevTabindex = existing ?? '';
          }
          element.setAttribute('tabindex', '-1');
          element.setAttribute('aria-hidden', 'true');
        }
      });
    }

    let activeAuthCard = authCards.find((card) => card.dataset.active === 'true') || null;

    function setActiveAuthCard(card) {
      if (!card || card === activeAuthCard) return;
      activeAuthCard = card;
      authCards.forEach((item) => updateInteractiveCardState(item, item === activeAuthCard));
    }

    if (authCards.length) {
      if (!activeAuthCard) {
        activeAuthCard = authCards[0];
      }
      authCards.forEach((card) => {
        if (!card.hasAttribute('role')) {
          card.setAttribute('role', 'group');
        }
        card.setAttribute('aria-selected', String(card === activeAuthCard));
        updateInteractiveCardState(card, card === activeAuthCard);
        card.addEventListener(
          'pointerdown',
          (event) => {
            if (card !== activeAuthCard && (event.button === 0 || event.pointerType === 'touch')) {
              setActiveAuthCard(card);
              event.preventDefault();
            }
          },
          true
        );
        card.addEventListener('click', (event) => {
          if (card !== activeAuthCard) {
            event.preventDefault();
          }
        });
        card.addEventListener('keydown', (event) => {
          if ((event.key === 'Enter' || event.key === ' ') && card !== activeAuthCard) {
            event.preventDefault();
            setActiveAuthCard(card);
          }
        });
        card.addEventListener('focus', () => {
          if (card !== activeAuthCard) {
            setActiveAuthCard(card);
          }
        });
      });
    }

    if (devToggleButton && devPanels) {
      const showLabel = devToggleButton.dataset.labelShow || 'Show developer tools';
      const hideLabel = devToggleButton.dataset.labelHide || 'Hide developer tools';

      const updateDeveloperToggleLabel = (expanded) => {
        devToggleButton.textContent = expanded ? hideLabel : showLabel;
      };

      updateDeveloperToggleLabel(false);

      devToggleButton.addEventListener('click', () => {
        const expanded = devToggleButton.getAttribute('aria-expanded') === 'true';
        const next = !expanded;
        devToggleButton.setAttribute('aria-expanded', String(next));
        devPanels.hidden = !next;
        updateDeveloperToggleLabel(next);
      });
    }

    function log(message, payload, level = 'info') {
      const time = new Date().toLocaleTimeString();
      let entry = `[${time}] ${message}`;
      if (payload !== undefined) {
        try {
          entry += `\n${JSON.stringify(payload, null, 2)}`;
        } catch (error) {
          entry += `\n${String(payload)}`;
        }
      }
      const wrapper = document.createElement('div');
      wrapper.textContent = entry;
      if (level === 'error') {
        wrapper.style.color = '#ff8b8b';
      } else if (level === 'success') {
        wrapper.style.color = '#73ffd3';
      }
      logEl.prepend(wrapper);
    }

    async function forwardSignupToSheet(details) {
      if (!sheetEndpoint) {
        log('Skipping Google Sheets capture because no endpoint is configured.');
        return;
      }
      try {
        const response = await fetch(sheetEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: details.name || '',
            email: details.email,
            marketingOptOut: details.marketingOptOut,
            consentCapturedAt: new Date().toISOString(),
            source: 'supabase-test-signup'
          })
        });
        if (!response.ok) {
          throw new Error(`Sheet endpoint responded with ${response.status}`);
        }
        log('Captured signup consent in Google Sheets.', null, 'success');
      } catch (error) {
        log('Failed to capture signup consent in Google Sheets.', error, 'error');
      }
    }

    function setAuthDependentState(isAuthed) {
      authRequiredBlocks.forEach((block) => {
        if (isAuthed) {
          block.removeAttribute('disabled');
        } else {
          block.setAttribute('disabled', '');
        }
      });
    }

    function updateSession(newSession) {
      state.session = newSession;
      if (newSession) {
        sessionIndicator.dataset.state = 'signed-in';
        sessionIndicator.textContent = 'Signed in';
        const email = newSession.user?.email || 'Unknown user';
        sessionDetails.textContent = `User: ${email}`;
        setAuthDependentState(true);
        toggleElementVisibility(authLink, false);
        toggleElementVisibility(accountMenu, true);
        if (accountButton) {
          accountButton.textContent = 'Account';
        }
      } else {
        sessionIndicator.dataset.state = 'signed-out';
        sessionIndicator.textContent = 'Signed out';
        sessionDetails.textContent = 'No active session';
        setAuthDependentState(false);
        toggleElementVisibility(authLink, true);
        toggleElementVisibility(accountMenu, false);
        if (accountButton) {
          accountButton.textContent = 'Account';
        }
      }
    }

    async function handleSignOut() {
      log('Signing out...');
      const { error } = await supabase.auth.signOut();
      if (error) {
        log('Sign-out failed', error, 'error');
        return;
      }
      log('Signed out.');
    }

    async function refreshSession() {
      const { data, error } = await supabase.auth.getSession();
      if (error) {
        log('Failed to fetch session', error, 'error');
        return;
      }
      updateSession(data.session ?? null);
    }

    supabase.auth.onAuthStateChange((_event, session) => {
      updateSession(session ?? null);
      log(`Auth state changed: ${session ? 'signed in' : 'signed out'}`);
    });

    const signupForm = document.querySelector('#signup-form');
    if (signupForm) {
      signupForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const form = event.currentTarget;
        const formData = new FormData(form);
        const email = (formData.get('email') || '').toString();
        const password = (formData.get('password') || '').toString();
        const name = (formData.get('name') || '').toString();
        const marketingOptOut = formData.get('marketing_opt_out') === 'yes';
        log('Submitting sign-up request...');
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            data: name ? { full_name: name } : {}
          }
        });
        if (error) {
          log('Sign-up failed', error, 'error');
          return;
        }
        log('Sign-up request sent. Check for confirmation email.', data, 'success');
        await forwardSignupToSheet({ name, email, marketingOptOut });
        form.reset();
      });
    }

    const loginForm = document.querySelector('#login-form');
    if (loginForm) {
      loginForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const form = event.currentTarget;
        const formData = new FormData(form);
        const email = formData.get('email');
        const password = formData.get('password');
        log('Attempting to sign in...');
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          log('Sign-in failed', error, 'error');
          return;
        }
        log('Signed in successfully.', data, 'success');
        window.location.href = '/account.html';
        form.reset();
      });
    }

    if (signoutButton) {
      signoutButton.addEventListener('click', () => {
        handleSignOut();
      });
    }

    if (accountLogoutLink) {
      accountLogoutLink.addEventListener('click', (event) => {
        event.preventDefault();
        handleSignOut();
      });
    }

    async function requireSession(actionDescription) {
      if (!state.session) {
        log(`${actionDescription} requires a signed-in user.`, null, 'error');
        return null;
      }
      return state.session;
    }

    if (fetchProfileButton) {
      fetchProfileButton.addEventListener('click', async () => {
        const session = await requireSession('Fetching the profile');
        if (!session) return;
        log('Loading profile row...');
        const { data, error } = await supabase
          .from('profiles')
          .select('id, email, full_name, studio_name, phone, created_at, updated_at')
          .eq('id', session.user.id)
          .maybeSingle();
        if (error) {
          log('Profile fetch failed', error, 'error');
          return;
        }
        log('Profile row loaded.', data, 'success');
      });
    }

    const profileForm = document.querySelector('#profile-form');
    if (profileForm) {
      profileForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const session = await requireSession('Updating the profile');
        if (!session) return;
        const form = event.currentTarget;
        const formData = new FormData(form);
        const payload = {};
        ['full_name', 'studio_name', 'phone'].forEach((field) => {
          const value = formData.get(field);
          payload[field] = value ? String(value) : null;
        });
        log('Saving profile details...', payload);
        const { data, error } = await supabase
          .from('profiles')
          .update(payload)
          .eq('id', session.user.id)
          .select()
          .maybeSingle();
        if (error) {
          log('Profile update failed', error, 'error');
          return;
        }
        log('Profile updated.', data, 'success');
        form.reset();
      });
    }

    const sceneForm = document.querySelector('#scene-form');
    if (sceneForm) {
      sceneForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const session = await requireSession('Creating a scene');
        if (!session) return;
        const form = event.currentTarget;
        const formData = new FormData(form);
        const title = String(formData.get('title'));
        const synopsis = formData.get('synopsis');
        const slug = title
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '')
          .slice(0, 64);
        const payload = {
          owner_id: session.user.id,
          title,
          synopsis: synopsis ? String(synopsis) : null,
          slug: slug || null,
          script_order: Math.floor(Math.random() * 100),
          cards: [],
          elements: [],
          sounds: []
        };
        log('Inserting scene...', payload);
        const { data, error } = await supabase
          .from('scenes')
          .insert(payload)
          .select()
          .maybeSingle();
        if (error) {
          log('Scene insert failed', error, 'error');
          return;
        }
        log('Scene inserted successfully.', data, 'success');
        form.reset();
      });
    }

    if (loadScenesButton) {
      loadScenesButton.addEventListener('click', async () => {
        const session = await requireSession('Loading scenes');
        if (!session) return;
        log('Fetching scenes for current user...');
        const { data, error } = await supabase
          .from('scenes')
          .select('id, title, synopsis, created_at, updated_at')
          .eq('owner_id', session.user.id)
          .order('created_at', { ascending: false })
          .limit(10);
        if (error) {
          log('Scene fetch failed', error, 'error');
          return;
        }
        log('Fetched scenes.', data ?? [], 'success');
      });
    }

    refreshSession().catch((error) => {
      log('Unexpected error while initializing session', error, 'error');
    });
  </script>
</body>
</html>
